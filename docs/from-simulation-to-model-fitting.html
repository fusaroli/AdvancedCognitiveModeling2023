<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 From simulation to model fitting | Advanced Cognitive Modeling Notes</title>
  <meta name="description" content="My notes for the advanced cognitive modeling course - 2026" />
  <meta name="generator" content="bookdown 0.46 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 From simulation to model fitting | Advanced Cognitive Modeling Notes" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="My notes for the advanced cognitive modeling course - 2026" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 From simulation to model fitting | Advanced Cognitive Modeling Notes" />
  
  <meta name="twitter:description" content="My notes for the advanced cognitive modeling course - 2026" />
  

<meta name="author" content="Riccardo Fusaroli" />


<meta name="date" content="2026-01-30" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="from-verbal-descriptions-to-formal-models.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="lib/css/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" href="lib/css/style.css" type="text/css" />
<link rel="stylesheet" href="lib/css/lesson.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Advanced Cognitive Modeling</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Advanced Cognitive Modeling</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#course-philosophy-and-approach"><i class="fa fa-check"></i><b>1.1</b> Course Philosophy and Approach</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#course-structure-and-learning-path"><i class="fa fa-check"></i><b>1.2</b> Course Structure and Learning Path</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#prerequisites-and-preparation"><i class="fa fa-check"></i><b>1.3</b> Prerequisites and Preparation</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#course-resources"><i class="fa fa-check"></i><b>1.4</b> Course Resources</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#about-these-notes"><i class="fa fa-check"></i><b>1.5</b> About These Notes</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="the-pizza-experiment.html"><a href="the-pizza-experiment.html"><i class="fa fa-check"></i><b>2</b> The Pizza Experiment</a>
<ul>
<li class="chapter" data-level="2.1" data-path="the-pizza-experiment.html"><a href="the-pizza-experiment.html#from-pizza-to-cognitive-models-an-introduction"><i class="fa fa-check"></i><b>2.1</b> From Pizza to Cognitive Models: An Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="the-pizza-experiment.html"><a href="the-pizza-experiment.html#why-start-with-pizza"><i class="fa fa-check"></i><b>2.2</b> Why Start with Pizza?</a></li>
<li class="chapter" data-level="2.3" data-path="the-pizza-experiment.html"><a href="the-pizza-experiment.html#learning-objectives"><i class="fa fa-check"></i><b>2.3</b> Learning Objectives</a></li>
<li class="chapter" data-level="2.4" data-path="the-pizza-experiment.html"><a href="the-pizza-experiment.html#part-1-exploring-the-pizza-stone-temperature-data"><i class="fa fa-check"></i><b>2.4</b> Part 1: Exploring the Pizza Stone Temperature Data</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="the-pizza-experiment.html"><a href="the-pizza-experiment.html#initial-data-visualization"><i class="fa fa-check"></i><b>2.4.1</b> Initial Data Visualization</a></li>
<li class="chapter" data-level="2.4.2" data-path="the-pizza-experiment.html"><a href="the-pizza-experiment.html#key-observations"><i class="fa fa-check"></i><b>2.4.2</b> Key Observations</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="the-pizza-experiment.html"><a href="the-pizza-experiment.html#part-2-initial-statistical-modeling"><i class="fa fa-check"></i><b>2.5</b> Part 2: Initial Statistical Modeling</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="the-pizza-experiment.html"><a href="the-pizza-experiment.html#model-setup-and-priors"><i class="fa fa-check"></i><b>2.5.1</b> Model Setup and Priors</a></li>
<li class="chapter" data-level="2.5.2" data-path="the-pizza-experiment.html"><a href="the-pizza-experiment.html#linear-mixed-effects-model"><i class="fa fa-check"></i><b>2.5.2</b> Linear Mixed-Effects Model</a></li>
<li class="chapter" data-level="2.5.3" data-path="the-pizza-experiment.html"><a href="the-pizza-experiment.html#lognormal-mixed-effects-model"><i class="fa fa-check"></i><b>2.5.3</b> Lognormal Mixed-Effects Model</a></li>
<li class="chapter" data-level="2.5.4" data-path="the-pizza-experiment.html"><a href="the-pizza-experiment.html#model-comparison-and-visualization"><i class="fa fa-check"></i><b>2.5.4</b> Model Comparison and Visualization</a></li>
<li class="chapter" data-level="2.5.5" data-path="the-pizza-experiment.html"><a href="the-pizza-experiment.html#model-assessment"><i class="fa fa-check"></i><b>2.5.5</b> Model Assessment</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="the-pizza-experiment.html"><a href="the-pizza-experiment.html#part-3-understanding-the-physics-model"><i class="fa fa-check"></i><b>2.6</b> Part 3: Understanding the Physics Model</a>
<ul>
<li class="chapter" data-level="2.6.1" data-path="the-pizza-experiment.html"><a href="the-pizza-experiment.html#the-basic-temperature-evolution-equation"><i class="fa fa-check"></i><b>2.6.1</b> The Basic Temperature Evolution Equation</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="the-pizza-experiment.html"><a href="the-pizza-experiment.html#part-4-implementing-the-physics-based-model"><i class="fa fa-check"></i><b>2.7</b> Part 4: Implementing the Physics-Based Model</a></li>
<li class="chapter" data-level="2.8" data-path="the-pizza-experiment.html"><a href="the-pizza-experiment.html#part-5-model-analysis-and-practical-applications"><i class="fa fa-check"></i><b>2.8</b> Part 5: Model Analysis and Practical Applications</a></li>
<li class="chapter" data-level="2.9" data-path="the-pizza-experiment.html"><a href="the-pizza-experiment.html#conclusion-from-pizza-to-cognitive-principles"><i class="fa fa-check"></i><b>2.9</b> Conclusion: From Pizza to Cognitive Principles</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html"><i class="fa fa-check"></i><b>3</b> Building Models of Strategic Decision-Making</a>
<ul>
<li class="chapter" data-level="3.1" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#learning-goals"><i class="fa fa-check"></i><b>3.1</b> Learning Goals</a></li>
<li class="chapter" data-level="3.2" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#introduction-observing-behavior-to-theorize-mechanisms"><i class="fa fa-check"></i><b>3.2</b> Introduction: Observing Behavior to Theorize Mechanisms</a></li>
<li class="chapter" data-level="3.3" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#the-matching-pennies-game"><i class="fa fa-check"></i><b>3.3</b> The Matching Pennies Game</a></li>
<li class="chapter" data-level="3.4" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#game-structure"><i class="fa fa-check"></i><b>3.4</b> Game Structure</a></li>
<li class="chapter" data-level="3.5" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#empirical-investigation"><i class="fa fa-check"></i><b>3.5</b> Empirical Investigation</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#data-collection-protocol"><i class="fa fa-check"></i><b>3.5.1</b> Data Collection Protocol</a></li>
<li class="chapter" data-level="3.5.2" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#initial-observations"><i class="fa fa-check"></i><b>3.5.2</b> Initial Observations</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#empirical-explorations"><i class="fa fa-check"></i><b>3.6</b> Empirical explorations</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#from-observation-to-theory-identifying-potential-mechanisms"><i class="fa fa-check"></i><b>3.6.1</b> From Observation to Theory: Identifying Potential Mechanisms</a></li>
<li class="chapter" data-level="3.6.2" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#the-distinction-between-participant-and-researcher-perspectives"><i class="fa fa-check"></i><b>3.6.2</b> The distinction between participant and researcher perspectives</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#candidate-verbal-models"><i class="fa fa-check"></i><b>3.7</b> Candidate Verbal Models</a>
<ul>
<li class="chapter" data-level="3.7.1" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#plausibility-check-cognitive-constraints"><i class="fa fa-check"></i><b>3.7.1</b> Plausibility Check: Cognitive Constraints</a></li>
<li class="chapter" data-level="3.7.2" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#relationships-between-models"><i class="fa fa-check"></i><b>3.7.2</b> Relationships Between Models</a></li>
<li class="chapter" data-level="3.7.3" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#handling-heterogeneity-mixture-models"><i class="fa fa-check"></i><b>3.7.3</b> Handling Heterogeneity: Mixture Models</a></li>
<li class="chapter" data-level="3.7.4" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#cognitive-modeling-vs.-traditional-statistical-approaches-e.g.-glm"><i class="fa fa-check"></i><b>3.7.4</b> Cognitive Modeling vs. Traditional Statistical Approaches (e.g., GLM)</a></li>
</ul></li>
<li class="chapter" data-level="3.8" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#conclusion-from-observations-to-verbal-theories"><i class="fa fa-check"></i><b>3.8</b> Conclusion: From Observations to Verbal Theories</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html"><i class="fa fa-check"></i><b>4</b> From verbal descriptions to formal models</a>
<ul>
<li class="chapter" data-level="4.1" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html#learning-goals-1"><i class="fa fa-check"></i><b>4.1</b> Learning Goals</a></li>
<li class="chapter" data-level="4.2" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html#the-value-of-formalization-and-simulation"><i class="fa fa-check"></i><b>4.2</b> The Value of Formalization and Simulation</a></li>
<li class="chapter" data-level="4.3" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html#defining-general-conditions"><i class="fa fa-check"></i><b>4.3</b> Defining general conditions</a></li>
<li class="chapter" data-level="4.4" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html#implementing-a-random-agent"><i class="fa fa-check"></i><b>4.4</b> Implementing a Random Agent</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html#encapsulating-the-agent-in-a-function"><i class="fa fa-check"></i><b>4.4.1</b> Encapsulating the Agent in a Function</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html#implementing-a-win-stay-lose-shift-wsls-agent"><i class="fa fa-check"></i><b>4.5</b> Implementing a Win-Stay-Lose-Shift (WSLS) Agent</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html#implementing-the-wsls-function"><i class="fa fa-check"></i><b>4.5.1</b> Implementing the WSLS Function</a></li>
<li class="chapter" data-level="4.5.2" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html#simulating-wsls-vs.-opponents"><i class="fa fa-check"></i><b>4.5.2</b> Simulating WSLS vs. Opponents</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html#scaling-up-the-virtual-experiment"><i class="fa fa-check"></i><b>4.6</b> Scaling Up: The Virtual Experiment</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html#visualizing-results"><i class="fa fa-check"></i><b>4.6.1</b> Visualizing Results</a></li>
<li class="chapter" data-level="4.6.2" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html#the-problem-of-inference"><i class="fa fa-check"></i><b>4.6.2</b> The Problem of Inference</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html"><i class="fa fa-check"></i><b>5</b> From simulation to model fitting</a>
<ul>
<li class="chapter" data-level="5.1" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#learning-goals-2"><i class="fa fa-check"></i><b>5.1</b> Learning Goals</a></li>
<li class="chapter" data-level="5.2" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#the-challenge-inferring-latent-parameters"><i class="fa fa-check"></i><b>5.2</b> The Challenge: Inferring Latent Parameters</a></li>
<li class="chapter" data-level="5.3" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#simulating-data"><i class="fa fa-check"></i><b>5.3</b> Simulating data</a></li>
<li class="chapter" data-level="5.4" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#building-our-first-stan-model-inferring-bias-rate"><i class="fa fa-check"></i><b>5.4</b> Building our First Stan Model: Inferring Bias Rate</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#model"><i class="fa fa-check"></i><b>5.4.1</b> Model</a></li>
<li class="chapter" data-level="5.4.2" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#assessing-model-quality"><i class="fa fa-check"></i><b>5.4.2</b> Assessing model quality</a></li>
<li class="chapter" data-level="5.4.3" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#summarizing-the-results"><i class="fa fa-check"></i><b>5.4.3</b> Summarizing the results</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#validating-the-model-parameter-recovery"><i class="fa fa-check"></i><b>5.5</b> Validating the Model: Parameter Recovery</a></li>
<li class="chapter" data-level="5.6" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#moving-beyond-simple-bias-memory-models"><i class="fa fa-check"></i><b>5.6</b> Moving Beyond Simple Bias: Memory Models</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#memory-model-1-glm-like-approach-external-predictor"><i class="fa fa-check"></i><b>5.6.1</b> Memory Model 1: GLM-like Approach (External Predictor)</a></li>
<li class="chapter" data-level="5.6.2" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#summarizing-the-results-1"><i class="fa fa-check"></i><b>5.6.2</b> Summarizing the results</a></li>
<li class="chapter" data-level="5.6.3" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#memory-model-2-internal-state-variable"><i class="fa fa-check"></i><b>5.6.3</b> Memory Model 2: Internal State Variable</a></li>
<li class="chapter" data-level="5.6.4" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#memory-model-3-exponential-forgetting-relation-to-rl"><i class="fa fa-check"></i><b>5.6.4</b> Memory Model 3: Exponential Forgetting (Relation to RL)</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#memory-model-4-bayesian-agent-optimal-updating"><i class="fa fa-check"></i><b>5.7</b> Memory Model 4: Bayesian Agent (Optimal Updating)</a></li>
<li class="chapter" data-level="5.8" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#relationship-to-rescorla-wagner"><i class="fa fa-check"></i><b>5.8</b> Relationship to Rescorla-Wagner</a>
<ul>
<li class="chapter" data-level="5.8.1" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#connection-to-kalman-filters"><i class="fa fa-check"></i><b>5.8.1</b> Connection to Kalman Filters</a></li>
<li class="chapter" data-level="5.8.2" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#connection-to-hierarchical-gaussian-filter-hgf"><i class="fa fa-check"></i><b>5.8.2</b> Connection to Hierarchical Gaussian Filter (HGF)</a></li>
<li class="chapter" data-level="5.8.3" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#implications-for-model-development"><i class="fa fa-check"></i><b>5.8.3</b> Implications for Model Development</a></li>
</ul></li>
<li class="chapter" data-level="5.9" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#conclusion-estimating-parameters-and-exploring-memory"><i class="fa fa-check"></i><b>5.9</b> Conclusion: Estimating Parameters and Exploring Memory</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Advanced Cognitive Modeling Notes</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="from-simulation-to-model-fitting" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">Chapter 5</span> From simulation to model fitting<a href="from-simulation-to-model-fitting.html#from-simulation-to-model-fitting" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In Chapter 3, we formalized verbal models into computational agents and explored their behavior through simulation by <em>setting</em> their parameters (like bias <code>rate</code> or WSLS rules). However, when analyzing real experimental data, we don’t know the true parameter values underlying a participant’s behavior. The core task shifts from simulation to <strong>parameter estimation</strong>: inferring the plausible values of model parameters <em>given</em> the observed data.</p>
<div id="learning-goals-2" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> Learning Goals<a href="from-simulation-to-model-fitting.html#learning-goals-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This chapter transitions from simulating predefined models (Chapter 3) to inferring model parameters from data using Bayesian methods. By the end of this chapter, you will be able to:</p>
<ul>
<li><strong>Understand Parameter Estimation:</strong> Grasp the core challenge of estimating unobservable model parameters (like cognitive biases or memory effects) from observable behavioral data (like choices).</li>
<li><strong>Implement Bayesian Models in Stan:</strong> Write basic Stan programs to specify cognitive models, including defining data, parameters, priors, and the likelihood function .</li>
<li><strong>Fit Models with <code>cmdstanr</code>:</strong> Use the <code>cmdstanr</code> interface to compile Stan models and sample from the posterior distribution of parameters.</li>
<li><strong>Interpret Model Output:</strong> Understand and visualize basic MCMC diagnostics (trace plots) and parameter estimates (posterior distributions, prior-posterior updates).</li>
<li><strong>Perform Parameter Recovery:</strong> Design and execute simulations to verify that your Stan model and fitting procedure can accurately recover known parameter values, a crucial step in model validation.</li>
<li><strong>Model Cognitive Processes:</strong> Apply these techniques to estimate parameters for simple cognitive strategies, including biased choice and different types of memory models (GLM-like, internal state, exponential forgetting, Bayesian updating).</li>
<li><strong>Understand Log-Odds:</strong> Appreciate the utility of the log-odds transformation for modeling probability parameters.</li>
</ul>
</div>
<div id="the-challenge-inferring-latent-parameters" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> The Challenge: Inferring Latent Parameters<a href="from-simulation-to-model-fitting.html#the-challenge-inferring-latent-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Why is this a challenge?
1. <strong>Parameters are Unseen:</strong> Cognitive parameters (like bias strength, memory decay, learning rate) are not directly observable; we must infer them from behavior (choices, RTs, etc.).
2. <strong>Behavior is Noisy:</strong> Human behavior is variable. Our models need to account for this noise while extracting the underlying parameter signal.
3. <strong>Model Plausibility:</strong> We need to determine not just <em>if</em> a model fits, but <em>how well</em> it fits, and whether the estimated parameter values are theoretically meaningful.</p>
<p>Consider the biased agent from Chapter 3. We simulated agents with a known <code>rate</code>. Now, imagine you only have the sequence of choices (the <code>h</code> data) from an unknown agent. How can you estimate the underlying <code>rate</code> that most likely generated those choices?</p>
<p><strong>Our Approach: Bayesian Inference with Stan</strong></p>
<p>This chapter introduces <strong>Bayesian inference</strong> as our primary tool for parameter estimation. As previewed in Chapter 1, the Bayesian approach allows us to combine prior knowledge about parameters with information from the observed data (likelihood) to arrive at an updated understanding (posterior distribution) of the parameters. We will use <strong>Stan</strong>, a powerful probabilistic programming language, implemented via the <code>cmdstanr</code> R package, to:</p>
<ol style="list-style-type: decimal">
<li><strong>Specify Models:</strong> Define our cognitive models formally, including parameters and their prior distributions.</li>
<li><strong>Fit Models:</strong> Use Stan’s algorithms (primarily Markov Chain Monte Carlo - MCMC) to sample from the posterior distribution of parameters given the data.</li>
<li><strong>Evaluate Fits:</strong> Examine the results to understand parameter estimates and their uncertainty.</li>
</ol>
<p>As a crucial validation step, we will first apply these methods to <strong>simulated data</strong>, where we know the true parameters. This allows us to check if our models and fitting procedures work correctly – a process called <strong>parameter recovery</strong>.</p>
</div>
<div id="simulating-data" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> Simulating data<a href="from-simulation-to-model-fitting.html#simulating-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>As usual we start with simulated data, where we know the underlying mechanisms and parameter values.</p>
<p>Simulated data are rarely enough (empirical data often offer unexpected challenges), but they are a great starting point to stress test your model: does the model reconstruct the right parameter values? Does it reproduce the overall patterns in the data?</p>
<p>Here we build a new simulation of random agents with bias and noise. The code and visualization is really nothing different from last chapter.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="from-simulation-to-model-fitting.html#cb43-1" tabindex="-1"></a><span class="co"># Flag to control whether to regenerate simulation/fitting results</span></span>
<span id="cb43-2"><a href="from-simulation-to-model-fitting.html#cb43-2" tabindex="-1"></a><span class="co"># Set to TRUE to rerun everything (takes time!), FALSE to load saved results.</span></span>
<span id="cb43-3"><a href="from-simulation-to-model-fitting.html#cb43-3" tabindex="-1"></a>regenerate_simulations <span class="ot">&lt;-</span> <span class="cn">FALSE</span> <span class="co"># Or TRUE</span></span>
<span id="cb43-4"><a href="from-simulation-to-model-fitting.html#cb43-4" tabindex="-1"></a></span>
<span id="cb43-5"><a href="from-simulation-to-model-fitting.html#cb43-5" tabindex="-1"></a><span class="co"># Load required packages using pacman::p_load</span></span>
<span id="cb43-6"><a href="from-simulation-to-model-fitting.html#cb43-6" tabindex="-1"></a><span class="co"># This function installs packages if missing, then loads them.</span></span>
<span id="cb43-7"><a href="from-simulation-to-model-fitting.html#cb43-7" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb43-8"><a href="from-simulation-to-model-fitting.html#cb43-8" tabindex="-1"></a>  tidyverse,    <span class="co"># Data manipulation and plotting (ggplot2, dplyr)</span></span>
<span id="cb43-9"><a href="from-simulation-to-model-fitting.html#cb43-9" tabindex="-1"></a>  here,         <span class="co"># Robust file path management (optional but recommended)</span></span>
<span id="cb43-10"><a href="from-simulation-to-model-fitting.html#cb43-10" tabindex="-1"></a>  posterior,    <span class="co"># Working with posterior distributions</span></span>
<span id="cb43-11"><a href="from-simulation-to-model-fitting.html#cb43-11" tabindex="-1"></a>  cmdstanr,     <span class="co"># Interface to Stan</span></span>
<span id="cb43-12"><a href="from-simulation-to-model-fitting.html#cb43-12" tabindex="-1"></a>  brms,         <span class="co"># High-level interface for Bayesian models (used briefly)</span></span>
<span id="cb43-13"><a href="from-simulation-to-model-fitting.html#cb43-13" tabindex="-1"></a>  tidybayes,    <span class="co"># Tidy manipulation of Bayesian model output</span></span>
<span id="cb43-14"><a href="from-simulation-to-model-fitting.html#cb43-14" tabindex="-1"></a>  furrr,        <span class="co"># Parallel processing for parameter recovery</span></span>
<span id="cb43-15"><a href="from-simulation-to-model-fitting.html#cb43-15" tabindex="-1"></a>  future        <span class="co"># Backend for furrr</span></span>
<span id="cb43-16"><a href="from-simulation-to-model-fitting.html#cb43-16" tabindex="-1"></a>)</span>
<span id="cb43-17"><a href="from-simulation-to-model-fitting.html#cb43-17" tabindex="-1"></a></span>
<span id="cb43-18"><a href="from-simulation-to-model-fitting.html#cb43-18" tabindex="-1"></a><span class="co"># Optional: Set a default ggplot theme</span></span>
<span id="cb43-19"><a href="from-simulation-to-model-fitting.html#cb43-19" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_classic</span>())</span>
<span id="cb43-20"><a href="from-simulation-to-model-fitting.html#cb43-20" tabindex="-1"></a></span>
<span id="cb43-21"><a href="from-simulation-to-model-fitting.html#cb43-21" tabindex="-1"></a><span class="co"># --- Simulate Data for Fitting ---</span></span>
<span id="cb43-22"><a href="from-simulation-to-model-fitting.html#cb43-22" tabindex="-1"></a><span class="co"># Goal: Generate data from known models/parameters to test our fitting procedures.</span></span>
<span id="cb43-23"><a href="from-simulation-to-model-fitting.html#cb43-23" tabindex="-1"></a></span>
<span id="cb43-24"><a href="from-simulation-to-model-fitting.html#cb43-24" tabindex="-1"></a>trials <span class="ot">&lt;-</span> <span class="dv">120</span> <span class="co"># Number of trials per simulated agent</span></span>
<span id="cb43-25"><a href="from-simulation-to-model-fitting.html#cb43-25" tabindex="-1"></a></span>
<span id="cb43-26"><a href="from-simulation-to-model-fitting.html#cb43-26" tabindex="-1"></a><span class="co"># Define the agent function (copied/adapted from Chapter 3 for self-containment)</span></span>
<span id="cb43-27"><a href="from-simulation-to-model-fitting.html#cb43-27" tabindex="-1"></a><span class="co"># This agent chooses &#39;1&#39; with probability &#39;rate&#39;, potentially adding noise.</span></span>
<span id="cb43-28"><a href="from-simulation-to-model-fitting.html#cb43-28" tabindex="-1"></a>RandomAgentNoise_f <span class="ot">&lt;-</span> <span class="cf">function</span>(rate, noise) {</span>
<span id="cb43-29"><a href="from-simulation-to-model-fitting.html#cb43-29" tabindex="-1"></a>  <span class="co"># Ensure rate is probability (in case log-odds are passed, though not here)</span></span>
<span id="cb43-30"><a href="from-simulation-to-model-fitting.html#cb43-30" tabindex="-1"></a>  rate_prob <span class="ot">&lt;-</span> <span class="fu">plogis</span>(rate) <span class="co"># Assumes rate might be log-odds; use identity if rate is already probability</span></span>
<span id="cb43-31"><a href="from-simulation-to-model-fitting.html#cb43-31" tabindex="-1"></a>  choice <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">1</span>, <span class="dv">1</span>, rate_prob) <span class="co"># Base choice</span></span>
<span id="cb43-32"><a href="from-simulation-to-model-fitting.html#cb43-32" tabindex="-1"></a>  <span class="cf">if</span> (noise <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&lt;</span> noise) { <span class="co"># Check if noise occurs</span></span>
<span id="cb43-33"><a href="from-simulation-to-model-fitting.html#cb43-33" tabindex="-1"></a>    choice <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.5</span>) <span class="co"># Override with random 50/50 choice</span></span>
<span id="cb43-34"><a href="from-simulation-to-model-fitting.html#cb43-34" tabindex="-1"></a>  }</span>
<span id="cb43-35"><a href="from-simulation-to-model-fitting.html#cb43-35" tabindex="-1"></a>  <span class="fu">return</span>(choice)</span>
<span id="cb43-36"><a href="from-simulation-to-model-fitting.html#cb43-36" tabindex="-1"></a>}</span>
<span id="cb43-37"><a href="from-simulation-to-model-fitting.html#cb43-37" tabindex="-1"></a></span>
<span id="cb43-38"><a href="from-simulation-to-model-fitting.html#cb43-38" tabindex="-1"></a><span class="co"># --- Generate Data Across Different Conditions ---</span></span>
<span id="cb43-39"><a href="from-simulation-to-model-fitting.html#cb43-39" tabindex="-1"></a><span class="co"># Define relative paths for saving/loading simulation data</span></span>
<span id="cb43-40"><a href="from-simulation-to-model-fitting.html#cb43-40" tabindex="-1"></a>sim_data_dir <span class="ot">&lt;-</span> <span class="st">&quot;simdata&quot;</span> <span class="co"># Assumes a &#39;simdata&#39; subdirectory</span></span>
<span id="cb43-41"><a href="from-simulation-to-model-fitting.html#cb43-41" tabindex="-1"></a>sim_data_file <span class="ot">&lt;-</span> <span class="fu">here</span>(sim_data_dir, <span class="st">&quot;04_randomnoise.csv&quot;</span>) </span>
<span id="cb43-42"><a href="from-simulation-to-model-fitting.html#cb43-42" tabindex="-1"></a></span>
<span id="cb43-43"><a href="from-simulation-to-model-fitting.html#cb43-43" tabindex="-1"></a><span class="co"># Create directory if it doesn&#39;t exist</span></span>
<span id="cb43-44"><a href="from-simulation-to-model-fitting.html#cb43-44" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(sim_data_dir)) <span class="fu">dir.create</span>(sim_data_dir)</span>
<span id="cb43-45"><a href="from-simulation-to-model-fitting.html#cb43-45" tabindex="-1"></a></span>
<span id="cb43-46"><a href="from-simulation-to-model-fitting.html#cb43-46" tabindex="-1"></a><span class="cf">if</span> (regenerate_simulations <span class="sc">||</span> <span class="sc">!</span><span class="fu">file.exists</span>(sim_data_file)) {</span>
<span id="cb43-47"><a href="from-simulation-to-model-fitting.html#cb43-47" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Generating new simulation data...</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb43-48"><a href="from-simulation-to-model-fitting.html#cb43-48" tabindex="-1"></a>  <span class="co"># Use expand_grid for cleaner parameter combinations</span></span>
<span id="cb43-49"><a href="from-simulation-to-model-fitting.html#cb43-49" tabindex="-1"></a>  param_grid <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb43-50"><a href="from-simulation-to-model-fitting.html#cb43-50" tabindex="-1"></a>    <span class="at">noise =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="fl">0.1</span>), <span class="co"># Noise levels</span></span>
<span id="cb43-51"><a href="from-simulation-to-model-fitting.html#cb43-51" tabindex="-1"></a>    <span class="at">rate =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>)     <span class="co"># Bias rate levels (probability scale)</span></span>
<span id="cb43-52"><a href="from-simulation-to-model-fitting.html#cb43-52" tabindex="-1"></a>  )</span>
<span id="cb43-53"><a href="from-simulation-to-model-fitting.html#cb43-53" tabindex="-1"></a></span>
<span id="cb43-54"><a href="from-simulation-to-model-fitting.html#cb43-54" tabindex="-1"></a>  <span class="co"># Use map_dfr for efficient simulation across parameters</span></span>
<span id="cb43-55"><a href="from-simulation-to-model-fitting.html#cb43-55" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">pmap_dfr</span>(param_grid, <span class="cf">function</span>(noise, rate) {</span>
<span id="cb43-56"><a href="from-simulation-to-model-fitting.html#cb43-56" tabindex="-1"></a>    <span class="co"># Simulate choices for one agent/condition</span></span>
<span id="cb43-57"><a href="from-simulation-to-model-fitting.html#cb43-57" tabindex="-1"></a>    choices <span class="ot">&lt;-</span> <span class="fu">map_int</span>(<span class="dv">1</span><span class="sc">:</span>trials, <span class="sc">~</span><span class="fu">RandomAgentNoise_f</span>(<span class="fu">qlogis</span>(rate), noise)) <span class="co"># Convert rate to log-odds for function if needed</span></span>
<span id="cb43-58"><a href="from-simulation-to-model-fitting.html#cb43-58" tabindex="-1"></a>    <span class="co"># Create tibble for this condition</span></span>
<span id="cb43-59"><a href="from-simulation-to-model-fitting.html#cb43-59" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb43-60"><a href="from-simulation-to-model-fitting.html#cb43-60" tabindex="-1"></a>      <span class="at">trial =</span> <span class="dv">1</span><span class="sc">:</span>trials,</span>
<span id="cb43-61"><a href="from-simulation-to-model-fitting.html#cb43-61" tabindex="-1"></a>      <span class="at">choice =</span> choices,</span>
<span id="cb43-62"><a href="from-simulation-to-model-fitting.html#cb43-62" tabindex="-1"></a>      <span class="at">true_rate =</span> rate, <span class="co"># Store the true rate used for generation</span></span>
<span id="cb43-63"><a href="from-simulation-to-model-fitting.html#cb43-63" tabindex="-1"></a>      <span class="at">true_noise =</span> noise <span class="co"># Store the true noise used</span></span>
<span id="cb43-64"><a href="from-simulation-to-model-fitting.html#cb43-64" tabindex="-1"></a>    )</span>
<span id="cb43-65"><a href="from-simulation-to-model-fitting.html#cb43-65" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span></span>
<span id="cb43-66"><a href="from-simulation-to-model-fitting.html#cb43-66" tabindex="-1"></a>  <span class="co"># Calculate cumulative rate for visualization</span></span>
<span id="cb43-67"><a href="from-simulation-to-model-fitting.html#cb43-67" tabindex="-1"></a>  <span class="fu">group_by</span>(true_rate, true_noise) <span class="sc">%&gt;%</span></span>
<span id="cb43-68"><a href="from-simulation-to-model-fitting.html#cb43-68" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cumulative_rate =</span> <span class="fu">cumsum</span>(choice) <span class="sc">/</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb43-69"><a href="from-simulation-to-model-fitting.html#cb43-69" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb43-70"><a href="from-simulation-to-model-fitting.html#cb43-70" tabindex="-1"></a></span>
<span id="cb43-71"><a href="from-simulation-to-model-fitting.html#cb43-71" tabindex="-1"></a>  <span class="co"># Save the generated data</span></span>
<span id="cb43-72"><a href="from-simulation-to-model-fitting.html#cb43-72" tabindex="-1"></a>  <span class="fu">write_csv</span>(d, sim_data_file)</span>
<span id="cb43-73"><a href="from-simulation-to-model-fitting.html#cb43-73" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Generated new simulation data and saved to&quot;</span>, sim_data_file, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb43-74"><a href="from-simulation-to-model-fitting.html#cb43-74" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb43-75"><a href="from-simulation-to-model-fitting.html#cb43-75" tabindex="-1"></a>  <span class="co"># Load existing simulation data</span></span>
<span id="cb43-76"><a href="from-simulation-to-model-fitting.html#cb43-76" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(sim_data_file)</span>
<span id="cb43-77"><a href="from-simulation-to-model-fitting.html#cb43-77" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Loaded existing simulation data from&quot;</span>, sim_data_file, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb43-78"><a href="from-simulation-to-model-fitting.html#cb43-78" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Loaded existing simulation data from /Users/au209589/Dropbox/Teaching/AdvancedCognitiveModeling23_book/simdata/04_randomnoise.csv</code></pre>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="from-simulation-to-model-fitting.html#cb45-1" tabindex="-1"></a><span class="co"># --- Visualize Simulated Data ---</span></span>
<span id="cb45-2"><a href="from-simulation-to-model-fitting.html#cb45-2" tabindex="-1"></a><span class="co"># Plot cumulative rate, faceted by noise level</span></span>
<span id="cb45-3"><a href="from-simulation-to-model-fitting.html#cb45-3" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(d, <span class="fu">aes</span>(<span class="at">x =</span> trial, <span class="at">y =</span> cumulative_rate, <span class="at">group =</span> true_rate, <span class="at">color =</span> true_rate)) <span class="sc">+</span></span>
<span id="cb45-4"><a href="from-simulation-to-model-fitting.html#cb45-4" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb45-5"><a href="from-simulation-to-model-fitting.html#cb45-5" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb45-6"><a href="from-simulation-to-model-fitting.html#cb45-6" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>() <span class="sc">+</span> <span class="co"># Use perceptually uniform color scale</span></span>
<span id="cb45-7"><a href="from-simulation-to-model-fitting.html#cb45-7" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span><span class="fu">paste</span>(<span class="st">&quot;Noise =&quot;</span>, true_noise)) <span class="sc">+</span> <span class="co"># Facet by noise level</span></span>
<span id="cb45-8"><a href="from-simulation-to-model-fitting.html#cb45-8" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb45-9"><a href="from-simulation-to-model-fitting.html#cb45-9" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Simulated Choice Behavior (Cumulative Rate)&quot;</span>,</span>
<span id="cb45-10"><a href="from-simulation-to-model-fitting.html#cb45-10" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;Agents with different bias rates and noise levels&quot;</span>,</span>
<span id="cb45-11"><a href="from-simulation-to-model-fitting.html#cb45-11" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Trial Number&quot;</span>,</span>
<span id="cb45-12"><a href="from-simulation-to-model-fitting.html#cb45-12" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Cumulative Proportion Choosing &#39;Right&#39;&quot;</span>,</span>
<span id="cb45-13"><a href="from-simulation-to-model-fitting.html#cb45-13" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;True Bias Rate&quot;</span></span>
<span id="cb45-14"><a href="from-simulation-to-model-fitting.html#cb45-14" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb45-15"><a href="from-simulation-to-model-fitting.html#cb45-15" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb45-16"><a href="from-simulation-to-model-fitting.html#cb45-16" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb45-17"><a href="from-simulation-to-model-fitting.html#cb45-17" tabindex="-1"></a></span>
<span id="cb45-18"><a href="from-simulation-to-model-fitting.html#cb45-18" tabindex="-1"></a><span class="fu">print</span>(p1)</span></code></pre></div>
<p><img src="series_files/figure-html/04%20simulating%20data-1.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
</div>
<div id="building-our-first-stan-model-inferring-bias-rate" class="section level2 hasAnchor" number="5.4">
<h2><span class="header-section-number">5.4</span> Building our First Stan Model: Inferring Bias Rate<a href="from-simulation-to-model-fitting.html#building-our-first-stan-model-inferring-bias-rate" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>N.B. Refer to the video and slides for the step by step build-up of the Stan code.</p>
<p>Let’s use Stan to estimate the underlying bias <code>rate</code> (which we’ll call <code>theta</code> in the model) from just the sequence of choices (<code>h</code>) generated by one of our simulated agents. We’ll start with a simple case: an agent with <code>rate = 0.8</code> and <code>noise = 0</code>.</p>
<p><strong>Preparing Data for Stan</strong>
Why a list? Well, dataframes (now tibbles) are amazing. But they have a big drawback: they require each variable to have the same length. Lists do not have that limitation, they are more flexible. So, lists. We’ll have to learn how to live with them.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="from-simulation-to-model-fitting.html#cb46-1" tabindex="-1"></a><span class="co"># Subset data for one specific agent simulation (rate=0.8, noise=0)</span></span>
<span id="cb46-2"><a href="from-simulation-to-model-fitting.html#cb46-2" tabindex="-1"></a>d1 <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> <span class="fu">filter</span>(true_rate <span class="sc">==</span> <span class="fl">0.8</span>, true_noise <span class="sc">==</span> <span class="fl">0.0</span>) <span class="co"># Make sure noise level matches</span></span>
<span id="cb46-3"><a href="from-simulation-to-model-fitting.html#cb46-3" tabindex="-1"></a></span>
<span id="cb46-4"><a href="from-simulation-to-model-fitting.html#cb46-4" tabindex="-1"></a><span class="co"># Stan requires data in a list format</span></span>
<span id="cb46-5"><a href="from-simulation-to-model-fitting.html#cb46-5" tabindex="-1"></a>data_for_stan <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb46-6"><a href="from-simulation-to-model-fitting.html#cb46-6" tabindex="-1"></a>  <span class="at">n =</span> trials,     <span class="co"># Number of trials (integer)</span></span>
<span id="cb46-7"><a href="from-simulation-to-model-fitting.html#cb46-7" tabindex="-1"></a>  <span class="at">h =</span> d1<span class="sc">$</span>choice   <span class="co"># Vector of choices (0s and 1s) for this agent</span></span>
<span id="cb46-8"><a href="from-simulation-to-model-fitting.html#cb46-8" tabindex="-1"></a>)</span>
<span id="cb46-9"><a href="from-simulation-to-model-fitting.html#cb46-9" tabindex="-1"></a></span>
<span id="cb46-10"><a href="from-simulation-to-model-fitting.html#cb46-10" tabindex="-1"></a><span class="fu">str</span>(data_for_stan) <span class="co"># Show the structure of the list</span></span></code></pre></div>
<pre><code>## List of 2
##  $ n: num 120
##  $ h: num [1:120] 1 1 1 1 1 1 0 1 1 1 ...</code></pre>
<div id="model" class="section level3 hasAnchor" number="5.4.1">
<h3><span class="header-section-number">5.4.1</span> Model<a href="from-simulation-to-model-fitting.html#model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We write the stan code within the R code (so I can show it to you more easily), then we save it as a stan file, which can be loaded at a later stage in order to compile it. [Missing: more info on compiling etc.]</p>
<p>Remember that the minimal Stan model requires 3 chunks, one specifying the data it will need as input; one specifying the parameters to be estimated; one specifying the model within which the parameters appear, and the priors for those parameters.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="from-simulation-to-model-fitting.html#cb48-1" tabindex="-1"></a><span class="co"># This R chunk defines the Stan code as a string and writes it to a file.</span></span>
<span id="cb48-2"><a href="from-simulation-to-model-fitting.html#cb48-2" tabindex="-1"></a><span class="co"># It&#39;s marked eval=FALSE because we don&#39;t run the R code defining the string here,</span></span>
<span id="cb48-3"><a href="from-simulation-to-model-fitting.html#cb48-3" tabindex="-1"></a><span class="co"># but the Stan code itself IS the important content.</span></span>
<span id="cb48-4"><a href="from-simulation-to-model-fitting.html#cb48-4" tabindex="-1"></a></span>
<span id="cb48-5"><a href="from-simulation-to-model-fitting.html#cb48-5" tabindex="-1"></a>stan_model_code <span class="ot">&lt;-</span> <span class="st">&quot;</span></span>
<span id="cb48-6"><a href="from-simulation-to-model-fitting.html#cb48-6" tabindex="-1"></a><span class="st">// Stan Model: Simple Bernoulli for Bias Estimation</span></span>
<span id="cb48-7"><a href="from-simulation-to-model-fitting.html#cb48-7" tabindex="-1"></a><span class="st">// Goal: Estimate the underlying probability (theta) of choosing 1 (&#39;right&#39;)</span></span>
<span id="cb48-8"><a href="from-simulation-to-model-fitting.html#cb48-8" tabindex="-1"></a><span class="st">//       given a sequence of binary choices.</span></span>
<span id="cb48-9"><a href="from-simulation-to-model-fitting.html#cb48-9" tabindex="-1"></a></span>
<span id="cb48-10"><a href="from-simulation-to-model-fitting.html#cb48-10" tabindex="-1"></a><span class="st">// 1. Data Block: Declares the data Stan expects from R</span></span>
<span id="cb48-11"><a href="from-simulation-to-model-fitting.html#cb48-11" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb48-12"><a href="from-simulation-to-model-fitting.html#cb48-12" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;        // Number of trials (must be at least 1)</span></span>
<span id="cb48-13"><a href="from-simulation-to-model-fitting.html#cb48-13" tabindex="-1"></a><span class="st">  array[n] int&lt;lower=0, upper=1&gt; h; // Array &#39;h&#39; of length &#39;n&#39; containing choices (0 or 1)</span></span>
<span id="cb48-14"><a href="from-simulation-to-model-fitting.html#cb48-14" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb48-15"><a href="from-simulation-to-model-fitting.html#cb48-15" tabindex="-1"></a></span>
<span id="cb48-16"><a href="from-simulation-to-model-fitting.html#cb48-16" tabindex="-1"></a><span class="st">// 2. Parameters Block: Declares the parameters the model will estimate</span></span>
<span id="cb48-17"><a href="from-simulation-to-model-fitting.html#cb48-17" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb48-18"><a href="from-simulation-to-model-fitting.html#cb48-18" tabindex="-1"></a><span class="st">  real&lt;lower=0, upper=1&gt; theta; // The bias parameter (probability), constrained between 0 and 1</span></span>
<span id="cb48-19"><a href="from-simulation-to-model-fitting.html#cb48-19" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb48-20"><a href="from-simulation-to-model-fitting.html#cb48-20" tabindex="-1"></a></span>
<span id="cb48-21"><a href="from-simulation-to-model-fitting.html#cb48-21" tabindex="-1"></a><span class="st">// 3. Model Block: Defines the priors and the likelihood</span></span>
<span id="cb48-22"><a href="from-simulation-to-model-fitting.html#cb48-22" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb48-23"><a href="from-simulation-to-model-fitting.html#cb48-23" tabindex="-1"></a><span class="st">  // Prior: Our belief about theta *before* seeing the data.</span></span>
<span id="cb48-24"><a href="from-simulation-to-model-fitting.html#cb48-24" tabindex="-1"></a><span class="st">  // We use a Beta(1, 1) prior, which is equivalent to a Uniform(0, 1) distribution.</span></span>
<span id="cb48-25"><a href="from-simulation-to-model-fitting.html#cb48-25" tabindex="-1"></a><span class="st">  // This represents maximal prior ignorance about the bias.</span></span>
<span id="cb48-26"><a href="from-simulation-to-model-fitting.html#cb48-26" tabindex="-1"></a><span class="st">  // &#39;target +=&#39; adds the log-probability density to the overall model log-probability.</span></span>
<span id="cb48-27"><a href="from-simulation-to-model-fitting.html#cb48-27" tabindex="-1"></a><span class="st">  target += beta_lpdf(theta | 1, 1); // lpdf = log probability density function</span></span>
<span id="cb48-28"><a href="from-simulation-to-model-fitting.html#cb48-28" tabindex="-1"></a></span>
<span id="cb48-29"><a href="from-simulation-to-model-fitting.html#cb48-29" tabindex="-1"></a><span class="st">  // Likelihood: How the data &#39;h&#39; depend on the parameter &#39;theta&#39;.</span></span>
<span id="cb48-30"><a href="from-simulation-to-model-fitting.html#cb48-30" tabindex="-1"></a><span class="st">  // We model each choice &#39;h&#39; as a Bernoulli trial with success probability &#39;theta&#39;.</span></span>
<span id="cb48-31"><a href="from-simulation-to-model-fitting.html#cb48-31" tabindex="-1"></a><span class="st">  // The model assesses how likely the observed sequence &#39;h&#39; is given a value of &#39;theta&#39;.</span></span>
<span id="cb48-32"><a href="from-simulation-to-model-fitting.html#cb48-32" tabindex="-1"></a><span class="st">  target += bernoulli_lpmf(h | theta); // lpmf = log probability mass function (for discrete data)</span></span>
<span id="cb48-33"><a href="from-simulation-to-model-fitting.html#cb48-33" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb48-34"><a href="from-simulation-to-model-fitting.html#cb48-34" tabindex="-1"></a></span>
<span id="cb48-35"><a href="from-simulation-to-model-fitting.html#cb48-35" tabindex="-1"></a><span class="st">// 4. Generated Quantities Block (Optional but useful)</span></span>
<span id="cb48-36"><a href="from-simulation-to-model-fitting.html#cb48-36" tabindex="-1"></a><span class="st">// Code here is executed *after* sampling, using the estimated parameter values.</span></span>
<span id="cb48-37"><a href="from-simulation-to-model-fitting.html#cb48-37" tabindex="-1"></a><span class="st">// Useful for calculating derived quantities or predictions.</span></span>
<span id="cb48-38"><a href="from-simulation-to-model-fitting.html#cb48-38" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb48-39"><a href="from-simulation-to-model-fitting.html#cb48-39" tabindex="-1"></a><span class="st">  // Example: Simulate a new dataset based on the estimated theta</span></span>
<span id="cb48-40"><a href="from-simulation-to-model-fitting.html#cb48-40" tabindex="-1"></a><span class="st">  array[n] int h_pred = bernoulli_rng(rep_vector(theta, n)); // _rng = random number generation</span></span>
<span id="cb48-41"><a href="from-simulation-to-model-fitting.html#cb48-41" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb48-42"><a href="from-simulation-to-model-fitting.html#cb48-42" tabindex="-1"></a><span class="st">&quot;</span></span>
<span id="cb48-43"><a href="from-simulation-to-model-fitting.html#cb48-43" tabindex="-1"></a><span class="co"># Define relative path for Stan model file</span></span>
<span id="cb48-44"><a href="from-simulation-to-model-fitting.html#cb48-44" tabindex="-1"></a>stan_model_dir <span class="ot">&lt;-</span> <span class="st">&quot;stan&quot;</span></span>
<span id="cb48-45"><a href="from-simulation-to-model-fitting.html#cb48-45" tabindex="-1"></a>stan_file_bernoulli <span class="ot">&lt;-</span> <span class="fu">here</span>(stan_model_dir, <span class="st">&quot;04_SimpleBernoulli.stan&quot;</span>)</span>
<span id="cb48-46"><a href="from-simulation-to-model-fitting.html#cb48-46" tabindex="-1"></a></span>
<span id="cb48-47"><a href="from-simulation-to-model-fitting.html#cb48-47" tabindex="-1"></a><span class="co"># Create directory if needed</span></span>
<span id="cb48-48"><a href="from-simulation-to-model-fitting.html#cb48-48" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(stan_model_dir)) <span class="fu">dir.create</span>(stan_model_dir)</span>
<span id="cb48-49"><a href="from-simulation-to-model-fitting.html#cb48-49" tabindex="-1"></a></span>
<span id="cb48-50"><a href="from-simulation-to-model-fitting.html#cb48-50" tabindex="-1"></a><span class="co"># Write the Stan code to the file</span></span>
<span id="cb48-51"><a href="from-simulation-to-model-fitting.html#cb48-51" tabindex="-1"></a><span class="fu">writeLines</span>(stan_model_code, stan_file_bernoulli)</span>
<span id="cb48-52"><a href="from-simulation-to-model-fitting.html#cb48-52" tabindex="-1"></a></span>
<span id="cb48-53"><a href="from-simulation-to-model-fitting.html#cb48-53" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Stan model written to:&quot;</span>, stan_file_bernoulli, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Stan model written to: /Users/au209589/Dropbox/Teaching/AdvancedCognitiveModeling23_book/stan/04_SimpleBernoulli.stan</code></pre>
<p>Compiling and Fitting the Stan Model</p>
<p>Now we use cmdstanr to compile this model (translating it into efficient C++ code) and then run the MCMC sampler to get posterior estimates for theta.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="from-simulation-to-model-fitting.html#cb50-1" tabindex="-1"></a><span class="do">## --- Compile and Fit ---</span></span>
<span id="cb50-2"><a href="from-simulation-to-model-fitting.html#cb50-2" tabindex="-1"></a><span class="co"># Specify model file path</span></span>
<span id="cb50-3"><a href="from-simulation-to-model-fitting.html#cb50-3" tabindex="-1"></a>stan_file_bernoulli <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;stan&quot;</span>, <span class="st">&quot;04_SimpleBernoulli.stan&quot;</span>)</span>
<span id="cb50-4"><a href="from-simulation-to-model-fitting.html#cb50-4" tabindex="-1"></a><span class="co"># Define path for saving fitted model object</span></span>
<span id="cb50-5"><a href="from-simulation-to-model-fitting.html#cb50-5" tabindex="-1"></a>stan_results_dir <span class="ot">&lt;-</span> <span class="st">&quot;simmodels&quot;</span></span>
<span id="cb50-6"><a href="from-simulation-to-model-fitting.html#cb50-6" tabindex="-1"></a>model_file_bernoulli <span class="ot">&lt;-</span> <span class="fu">here</span>(stan_results_dir, <span class="st">&quot;04_SimpleBernoulli.rds&quot;</span>)</span>
<span id="cb50-7"><a href="from-simulation-to-model-fitting.html#cb50-7" tabindex="-1"></a></span>
<span id="cb50-8"><a href="from-simulation-to-model-fitting.html#cb50-8" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(stan_results_dir)) <span class="fu">dir.create</span>(stan_results_dir)</span>
<span id="cb50-9"><a href="from-simulation-to-model-fitting.html#cb50-9" tabindex="-1"></a></span>
<span id="cb50-10"><a href="from-simulation-to-model-fitting.html#cb50-10" tabindex="-1"></a><span class="cf">if</span> (regenerate_simulations <span class="sc">||</span> <span class="sc">!</span><span class="fu">file.exists</span>(model_file_bernoulli)) {</span>
<span id="cb50-11"><a href="from-simulation-to-model-fitting.html#cb50-11" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Compiling and fitting Stan model (Bernoulli)...</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb50-12"><a href="from-simulation-to-model-fitting.html#cb50-12" tabindex="-1"></a>  <span class="co"># Compile the Stan model (only needs to be done once unless code changes)</span></span>
<span id="cb50-13"><a href="from-simulation-to-model-fitting.html#cb50-13" tabindex="-1"></a>  mod_bernoulli <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(stan_file_bernoulli,</span>
<span id="cb50-14"><a href="from-simulation-to-model-fitting.html#cb50-14" tabindex="-1"></a>                                 <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">FALSE</span>), <span class="co"># Enable threading</span></span>
<span id="cb50-15"><a href="from-simulation-to-model-fitting.html#cb50-15" tabindex="-1"></a>                                 <span class="at">stanc_options =</span> <span class="fu">list</span>(<span class="st">&quot;O1&quot;</span>)) <span class="co"># Basic optimization</span></span>
<span id="cb50-16"><a href="from-simulation-to-model-fitting.html#cb50-16" tabindex="-1"></a></span>
<span id="cb50-17"><a href="from-simulation-to-model-fitting.html#cb50-17" tabindex="-1"></a>  <span class="co"># Sample from the posterior distribution using MCMC</span></span>
<span id="cb50-18"><a href="from-simulation-to-model-fitting.html#cb50-18" tabindex="-1"></a>  fit_bernoulli <span class="ot">&lt;-</span> mod_bernoulli<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb50-19"><a href="from-simulation-to-model-fitting.html#cb50-19" tabindex="-1"></a>    <span class="at">data =</span> data_for_stan,          <span class="co"># The data list we prepared</span></span>
<span id="cb50-20"><a href="from-simulation-to-model-fitting.html#cb50-20" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">123</span>,                    <span class="co"># For reproducible MCMC sampling</span></span>
<span id="cb50-21"><a href="from-simulation-to-model-fitting.html#cb50-21" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">4</span>,                    <span class="co"># Number of parallel Markov chains (recommend 4)</span></span>
<span id="cb50-22"><a href="from-simulation-to-model-fitting.html#cb50-22" tabindex="-1"></a>    <span class="at">parallel_chains =</span> <span class="fu">min</span>(<span class="dv">4</span>, future<span class="sc">::</span><span class="fu">availableCores</span>()), <span class="co"># Run chains in parallel</span></span>
<span id="cb50-23"><a href="from-simulation-to-model-fitting.html#cb50-23" tabindex="-1"></a>    <span class="co">#threads_per_chain = 1,         # For within-chain parallelization (usually 1 is fine)</span></span>
<span id="cb50-24"><a href="from-simulation-to-model-fitting.html#cb50-24" tabindex="-1"></a>    <span class="at">iter_warmup =</span> <span class="dv">1000</span>,            <span class="co"># Number of warmup iterations per chain (discarded)</span></span>
<span id="cb50-25"><a href="from-simulation-to-model-fitting.html#cb50-25" tabindex="-1"></a>    <span class="at">iter_sampling =</span> <span class="dv">2000</span>,          <span class="co"># Number of sampling iterations per chain (kept)</span></span>
<span id="cb50-26"><a href="from-simulation-to-model-fitting.html#cb50-26" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">500</span>,                 <span class="co"># How often to print progress updates</span></span>
<span id="cb50-27"><a href="from-simulation-to-model-fitting.html#cb50-27" tabindex="-1"></a>    <span class="at">max_treedepth =</span> <span class="dv">10</span>,            <span class="co"># Controls complexity of MCMC steps (adjust if needed)</span></span>
<span id="cb50-28"><a href="from-simulation-to-model-fitting.html#cb50-28" tabindex="-1"></a>    <span class="at">adapt_delta =</span> <span class="fl">0.8</span>              <span class="co"># Target acceptance rate (adjust if divergences occur)</span></span>
<span id="cb50-29"><a href="from-simulation-to-model-fitting.html#cb50-29" tabindex="-1"></a>  )</span>
<span id="cb50-30"><a href="from-simulation-to-model-fitting.html#cb50-30" tabindex="-1"></a></span>
<span id="cb50-31"><a href="from-simulation-to-model-fitting.html#cb50-31" tabindex="-1"></a>  <span class="co"># Save the fitted model object</span></span>
<span id="cb50-32"><a href="from-simulation-to-model-fitting.html#cb50-32" tabindex="-1"></a>  fit_bernoulli<span class="sc">$</span><span class="fu">save_object</span>(<span class="at">file =</span> model_file_bernoulli)</span>
<span id="cb50-33"><a href="from-simulation-to-model-fitting.html#cb50-33" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Model fit completed and saved to:&quot;</span>, model_file_bernoulli, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb50-34"><a href="from-simulation-to-model-fitting.html#cb50-34" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb50-35"><a href="from-simulation-to-model-fitting.html#cb50-35" tabindex="-1"></a>  <span class="co"># Load existing fitted model object</span></span>
<span id="cb50-36"><a href="from-simulation-to-model-fitting.html#cb50-36" tabindex="-1"></a>  fit_bernoulli <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(model_file_bernoulli)</span>
<span id="cb50-37"><a href="from-simulation-to-model-fitting.html#cb50-37" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Loaded existing model fit from:&quot;</span>, model_file_bernoulli, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb50-38"><a href="from-simulation-to-model-fitting.html#cb50-38" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Loaded existing model fit from: /Users/au209589/Dropbox/Teaching/AdvancedCognitiveModeling23_book/simmodels/04_SimpleBernoulli.rds</code></pre>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="from-simulation-to-model-fitting.html#cb52-1" tabindex="-1"></a><span class="co"># --- Examine Results ---</span></span>
<span id="cb52-2"><a href="from-simulation-to-model-fitting.html#cb52-2" tabindex="-1"></a><span class="co"># Print summary statistics (mean, median, SD, quantiles, diagnostics like Rhat, ESS)</span></span>
<span id="cb52-3"><a href="from-simulation-to-model-fitting.html#cb52-3" tabindex="-1"></a>fit_bernoulli<span class="sc">$</span><span class="fu">summary</span>()</span></code></pre></div>
<pre><code>## # A tibble: 122 × 10
##    variable     mean  median     sd    mad      q5     q95  rhat ess_bulk ess_tail
##    &lt;chr&gt;       &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1 lp__      -70.7   -70.4   0.728  0.312  -72.2   -70.2   1.00     3744.    3744.
##  2 theta       0.736   0.738 0.0399 0.0400   0.670   0.799 1.00     3082.    3634.
##  3 h_pred[1]   0.735   1     0.441  0        0       1     1.00     7946.      NA 
##  4 h_pred[2]   0.732   1     0.443  0        0       1     1.000    7758.      NA 
##  5 h_pred[3]   0.741   1     0.438  0        0       1     1.000    8030.      NA 
##  6 h_pred[4]   0.736   1     0.441  0        0       1     1.00     7392.      NA 
##  7 h_pred[5]   0.733   1     0.442  0        0       1     1.000    8172.      NA 
##  8 h_pred[6]   0.737   1     0.441  0        0       1     1.000    7830.      NA 
##  9 h_pred[7]   0.734   1     0.442  0        0       1     1.000    7956.      NA 
## 10 h_pred[8]   0.737   1     0.440  0        0       1     1.000    7914.      NA 
## # ℹ 112 more rows</code></pre>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="from-simulation-to-model-fitting.html#cb54-1" tabindex="-1"></a><span class="co"># Check MCMC diagnostics visually</span></span>
<span id="cb54-2"><a href="from-simulation-to-model-fitting.html#cb54-2" tabindex="-1"></a><span class="fu">mcmc_trace</span>(fit_bernoulli<span class="sc">$</span><span class="fu">draws</span>(<span class="st">&quot;theta&quot;</span>)) <span class="co"># Trace plot for theta</span></span></code></pre></div>
<p><img src="series_files/figure-html/04%20fit%20the%20biased%20model-1.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="from-simulation-to-model-fitting.html#cb55-1" tabindex="-1"></a><span class="co"># Plot the posterior distribution vs. prior</span></span>
<span id="cb55-2"><a href="from-simulation-to-model-fitting.html#cb55-2" tabindex="-1"></a>draws_df <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(fit_bernoulli<span class="sc">$</span><span class="fu">draws</span>(<span class="st">&quot;theta&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb55-3"><a href="from-simulation-to-model-fitting.html#cb55-3" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="at">theta_prior =</span> <span class="fu">rbeta</span>(<span class="fu">n</span>(), <span class="dv">1</span>, <span class="dv">1</span>)) <span class="co"># Generate prior samples</span></span>
<span id="cb55-4"><a href="from-simulation-to-model-fitting.html#cb55-4" tabindex="-1"></a></span>
<span id="cb55-5"><a href="from-simulation-to-model-fitting.html#cb55-5" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df) <span class="sc">+</span></span>
<span id="cb55-6"><a href="from-simulation-to-model-fitting.html#cb55-6" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(theta, <span class="at">fill =</span> <span class="st">&quot;Posterior&quot;</span>), <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb55-7"><a href="from-simulation-to-model-fitting.html#cb55-7" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(theta_prior, <span class="at">fill =</span> <span class="st">&quot;Prior&quot;</span>), <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb55-8"><a href="from-simulation-to-model-fitting.html#cb55-8" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">0.8</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span> <span class="co"># True value</span></span>
<span id="cb55-9"><a href="from-simulation-to-model-fitting.html#cb55-9" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Posterior&quot;</span> <span class="ot">=</span> <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;Prior&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>)) <span class="sc">+</span></span>
<span id="cb55-10"><a href="from-simulation-to-model-fitting.html#cb55-10" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb55-11"><a href="from-simulation-to-model-fitting.html#cb55-11" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Prior-Posterior Update Check (Theta)&quot;</span>,</span>
<span id="cb55-12"><a href="from-simulation-to-model-fitting.html#cb55-12" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;Data shifts belief from uniform prior towards true value (0.8)&quot;</span>,</span>
<span id="cb55-13"><a href="from-simulation-to-model-fitting.html#cb55-13" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;Theta (Probability of Choosing Right)&quot;</span>,</span>
<span id="cb55-14"><a href="from-simulation-to-model-fitting.html#cb55-14" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>,</span>
<span id="cb55-15"><a href="from-simulation-to-model-fitting.html#cb55-15" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">&quot;Distribution&quot;</span></span>
<span id="cb55-16"><a href="from-simulation-to-model-fitting.html#cb55-16" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb55-17"><a href="from-simulation-to-model-fitting.html#cb55-17" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img src="series_files/figure-html/04%20fit%20the%20biased%20model-2.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
</div>
<div id="assessing-model-quality" class="section level3 hasAnchor" number="5.4.2">
<h3><span class="header-section-number">5.4.2</span> Assessing model quality<a href="from-simulation-to-model-fitting.html#assessing-model-quality" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Then we need to look more in the details at the quality of the estimation:
* the markov chains
* how the prior and the posterior estimates relate to each other (whether the prior is constraining the posterior estimate)</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="from-simulation-to-model-fitting.html#cb56-1" tabindex="-1"></a><span class="co"># Check if samples_biased exists</span></span>
<span id="cb56-2"><a href="from-simulation-to-model-fitting.html#cb56-2" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;samples_biased&quot;</span>)) {</span>
<span id="cb56-3"><a href="from-simulation-to-model-fitting.html#cb56-3" tabindex="-1"></a>  model_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;simmodels&quot;</span>,<span class="st">&quot;04_SimpleBernoulli.rds&quot;</span>)</span>
<span id="cb56-4"><a href="from-simulation-to-model-fitting.html#cb56-4" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(model_file)) {</span>
<span id="cb56-5"><a href="from-simulation-to-model-fitting.html#cb56-5" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;Loading biased model samples...</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb56-6"><a href="from-simulation-to-model-fitting.html#cb56-6" tabindex="-1"></a>    samples_biased <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(model_file)</span>
<span id="cb56-7"><a href="from-simulation-to-model-fitting.html#cb56-7" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;Available parameters:&quot;</span>, <span class="fu">paste</span>(<span class="fu">colnames</span>(<span class="fu">as_draws_df</span>(samples_biased<span class="sc">$</span><span class="fu">draws</span>())), <span class="at">collapse =</span> <span class="st">&quot;, &quot;</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb56-8"><a href="from-simulation-to-model-fitting.html#cb56-8" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb56-9"><a href="from-simulation-to-model-fitting.html#cb56-9" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;Model file not found. Set regenerate_simulations=TRUE to create it.</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb56-10"><a href="from-simulation-to-model-fitting.html#cb56-10" tabindex="-1"></a>    <span class="co"># Provide dummy data or skip the remaining code</span></span>
<span id="cb56-11"><a href="from-simulation-to-model-fitting.html#cb56-11" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">knit_exit</span>()</span>
<span id="cb56-12"><a href="from-simulation-to-model-fitting.html#cb56-12" tabindex="-1"></a>  }</span>
<span id="cb56-13"><a href="from-simulation-to-model-fitting.html#cb56-13" tabindex="-1"></a>}</span>
<span id="cb56-14"><a href="from-simulation-to-model-fitting.html#cb56-14" tabindex="-1"></a></span>
<span id="cb56-15"><a href="from-simulation-to-model-fitting.html#cb56-15" tabindex="-1"></a><span class="co"># Extract posterior samples and include sampling of the prior:</span></span>
<span id="cb56-16"><a href="from-simulation-to-model-fitting.html#cb56-16" tabindex="-1"></a>draws_df_biased <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(samples_biased<span class="sc">$</span><span class="fu">draws</span>())</span>
<span id="cb56-17"><a href="from-simulation-to-model-fitting.html#cb56-17" tabindex="-1"></a></span>
<span id="cb56-18"><a href="from-simulation-to-model-fitting.html#cb56-18" tabindex="-1"></a><span class="co"># Explicitly extract parameters</span></span>
<span id="cb56-19"><a href="from-simulation-to-model-fitting.html#cb56-19" tabindex="-1"></a>theta_param <span class="ot">&lt;-</span> draws_df_biased<span class="sc">$</span>theta</span>
<span id="cb56-20"><a href="from-simulation-to-model-fitting.html#cb56-20" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Successfully extracted theta parameter with&quot;</span>, <span class="fu">length</span>(theta_param), <span class="st">&quot;values</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Successfully extracted theta parameter with 8000 values</code></pre>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="from-simulation-to-model-fitting.html#cb58-1" tabindex="-1"></a><span class="co"># Checking the model&#39;s chains</span></span>
<span id="cb58-2"><a href="from-simulation-to-model-fitting.html#cb58-2" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df_biased, <span class="fu">aes</span>(.iteration, theta, <span class="at">group =</span> .chain, <span class="at">color =</span> .chain)) <span class="sc">+</span></span>
<span id="cb58-3"><a href="from-simulation-to-model-fitting.html#cb58-3" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb58-4"><a href="from-simulation-to-model-fitting.html#cb58-4" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="series_files/figure-html/04%20biased%20model%20quality-1.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="from-simulation-to-model-fitting.html#cb59-1" tabindex="-1"></a><span class="co"># add a prior for theta (ugly, but we&#39;ll do better soon)</span></span>
<span id="cb59-2"><a href="from-simulation-to-model-fitting.html#cb59-2" tabindex="-1"></a>draws_df_biased <span class="ot">&lt;-</span> draws_df_biased <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb59-3"><a href="from-simulation-to-model-fitting.html#cb59-3" tabindex="-1"></a>  <span class="at">theta_prior =</span> <span class="fu">rbeta</span>(<span class="fu">nrow</span>(draws_df_biased), <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb59-4"><a href="from-simulation-to-model-fitting.html#cb59-4" tabindex="-1"></a>)</span>
<span id="cb59-5"><a href="from-simulation-to-model-fitting.html#cb59-5" tabindex="-1"></a></span>
<span id="cb59-6"><a href="from-simulation-to-model-fitting.html#cb59-6" tabindex="-1"></a><span class="co"># Now let&#39;s plot the density for theta (prior and posterior)</span></span>
<span id="cb59-7"><a href="from-simulation-to-model-fitting.html#cb59-7" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df_biased) <span class="sc">+</span></span>
<span id="cb59-8"><a href="from-simulation-to-model-fitting.html#cb59-8" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(theta), <span class="at">fill =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb59-9"><a href="from-simulation-to-model-fitting.html#cb59-9" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(theta_prior), <span class="at">fill =</span> <span class="st">&quot;red&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb59-10"><a href="from-simulation-to-model-fitting.html#cb59-10" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">0.8</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb59-11"><a href="from-simulation-to-model-fitting.html#cb59-11" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Rate&quot;</span>) <span class="sc">+</span></span>
<span id="cb59-12"><a href="from-simulation-to-model-fitting.html#cb59-12" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Posterior Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb59-13"><a href="from-simulation-to-model-fitting.html#cb59-13" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="series_files/figure-html/04%20biased%20model%20quality-2.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
<p>As we can see from the posterior estimates and the prior posterior update check, our model is doing a decent job. It doesn’t exactly reconstruct the rate of 0.8, but 0.755 is pretty close and 0.8 is included within the credible interval.</p>
<p>Now we build the same model, but using the log odds scale for the theta parameter, which will become useful later when we condition theta on variables and build multilevel models (as we can do what we want in a log odds space and it will always be bound between 0 and 1).</p>
<p><strong>Alternative Parameterization: Log-Odds Scale</strong></p>
<p>While estimating <code>theta</code> directly as a probability (0-1) is intuitive, it can sometimes be computationally advantageous or necessary for more complex models (like multilevel models in Chapter 6) to estimate parameters on an <em>unbounded</em> scale. The <strong>logit</strong> (log-odds) transformation converts a probability <span class="math-inline">p</span> (from 0 to 1) to log-odds (from <span class="math-inline">-\infty</span> to <span class="math-inline">+\infty</span>):
<span class="math-block">\text{logit}<span class="math inline">\(p\)</span> = \log\left<span class="math inline">\(\\frac\{p\}\{1\-p\}\\right\)</span></span>
The inverse transformation (logistic function or <code>inv_logit</code>) converts log-odds back to probability:
<span class="math-block">\text{inv_logit}<span class="math inline">\(x\)</span> = \frac{1}{1 + \exp<span class="math inline">\(\-x\)</span>}</span>
We can rewrite our Stan model to estimate <code>theta</code> on the log-odds scale. This often improves sampling efficiency and makes it easier to specify priors (e.g., using a Normal distribution on the unbounded log-odds scale).</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="from-simulation-to-model-fitting.html#cb60-1" tabindex="-1"></a><span class="co"># Stan code using logit parameterization</span></span>
<span id="cb60-2"><a href="from-simulation-to-model-fitting.html#cb60-2" tabindex="-1"></a>stan_model_logit_code <span class="ot">&lt;-</span> <span class="st">&quot;</span></span>
<span id="cb60-3"><a href="from-simulation-to-model-fitting.html#cb60-3" tabindex="-1"></a><span class="st">// Stan Model: Simple Bernoulli (Logit Parameterization)</span></span>
<span id="cb60-4"><a href="from-simulation-to-model-fitting.html#cb60-4" tabindex="-1"></a><span class="st">// Estimate theta on the log-odds scale</span></span>
<span id="cb60-5"><a href="from-simulation-to-model-fitting.html#cb60-5" tabindex="-1"></a></span>
<span id="cb60-6"><a href="from-simulation-to-model-fitting.html#cb60-6" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb60-7"><a href="from-simulation-to-model-fitting.html#cb60-7" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb60-8"><a href="from-simulation-to-model-fitting.html#cb60-8" tabindex="-1"></a><span class="st">  array[n] int&lt;lower=0, upper=1&gt; h;</span></span>
<span id="cb60-9"><a href="from-simulation-to-model-fitting.html#cb60-9" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb60-10"><a href="from-simulation-to-model-fitting.html#cb60-10" tabindex="-1"></a></span>
<span id="cb60-11"><a href="from-simulation-to-model-fitting.html#cb60-11" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb60-12"><a href="from-simulation-to-model-fitting.html#cb60-12" tabindex="-1"></a><span class="st">  real theta_logit; // Parameter is now on the unbounded log-odds scale</span></span>
<span id="cb60-13"><a href="from-simulation-to-model-fitting.html#cb60-13" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb60-14"><a href="from-simulation-to-model-fitting.html#cb60-14" tabindex="-1"></a></span>
<span id="cb60-15"><a href="from-simulation-to-model-fitting.html#cb60-15" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb60-16"><a href="from-simulation-to-model-fitting.html#cb60-16" tabindex="-1"></a><span class="st">  // Prior on log-odds scale (e.g., Normal(0, 1))</span></span>
<span id="cb60-17"><a href="from-simulation-to-model-fitting.html#cb60-17" tabindex="-1"></a><span class="st">  // Normal(0, 1) on log-odds corresponds roughly to a diffuse prior on probability scale</span></span>
<span id="cb60-18"><a href="from-simulation-to-model-fitting.html#cb60-18" tabindex="-1"></a><span class="st">  target += normal_lpdf(theta_logit | 0, 1);</span></span>
<span id="cb60-19"><a href="from-simulation-to-model-fitting.html#cb60-19" tabindex="-1"></a></span>
<span id="cb60-20"><a href="from-simulation-to-model-fitting.html#cb60-20" tabindex="-1"></a><span class="st">  // Likelihood using the logit version of the Bernoulli PMF</span></span>
<span id="cb60-21"><a href="from-simulation-to-model-fitting.html#cb60-21" tabindex="-1"></a><span class="st">  // This tells Stan that theta_logit is on the log-odds scale</span></span>
<span id="cb60-22"><a href="from-simulation-to-model-fitting.html#cb60-22" tabindex="-1"></a><span class="st">  target += bernoulli_logit_lpmf(h | theta_logit);</span></span>
<span id="cb60-23"><a href="from-simulation-to-model-fitting.html#cb60-23" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb60-24"><a href="from-simulation-to-model-fitting.html#cb60-24" tabindex="-1"></a></span>
<span id="cb60-25"><a href="from-simulation-to-model-fitting.html#cb60-25" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb60-26"><a href="from-simulation-to-model-fitting.html#cb60-26" tabindex="-1"></a><span class="st">  // Convert estimate back to probability scale for easier interpretation</span></span>
<span id="cb60-27"><a href="from-simulation-to-model-fitting.html#cb60-27" tabindex="-1"></a><span class="st">  real&lt;lower=0, upper=1&gt; theta = inv_logit(theta_logit);</span></span>
<span id="cb60-28"><a href="from-simulation-to-model-fitting.html#cb60-28" tabindex="-1"></a></span>
<span id="cb60-29"><a href="from-simulation-to-model-fitting.html#cb60-29" tabindex="-1"></a><span class="st">  // Also generate prior sample on probability scale for comparison</span></span>
<span id="cb60-30"><a href="from-simulation-to-model-fitting.html#cb60-30" tabindex="-1"></a><span class="st">  real&lt;lower=0, upper=1&gt; theta_prior = inv_logit(normal_rng(0, 1));</span></span>
<span id="cb60-31"><a href="from-simulation-to-model-fitting.html#cb60-31" tabindex="-1"></a></span>
<span id="cb60-32"><a href="from-simulation-to-model-fitting.html#cb60-32" tabindex="-1"></a><span class="st">  // Predictions can still be generated using the probability scale theta</span></span>
<span id="cb60-33"><a href="from-simulation-to-model-fitting.html#cb60-33" tabindex="-1"></a><span class="st">  array[n] int h_pred = bernoulli_rng(rep_vector(theta, n));</span></span>
<span id="cb60-34"><a href="from-simulation-to-model-fitting.html#cb60-34" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb60-35"><a href="from-simulation-to-model-fitting.html#cb60-35" tabindex="-1"></a><span class="st">&quot;</span></span>
<span id="cb60-36"><a href="from-simulation-to-model-fitting.html#cb60-36" tabindex="-1"></a><span class="co"># Define file path</span></span>
<span id="cb60-37"><a href="from-simulation-to-model-fitting.html#cb60-37" tabindex="-1"></a>stan_file_logit <span class="ot">&lt;-</span> <span class="fu">here</span>(stan_model_dir, <span class="st">&quot;04_SimpleBernoulli_logodds.stan&quot;</span>)</span>
<span id="cb60-38"><a href="from-simulation-to-model-fitting.html#cb60-38" tabindex="-1"></a><span class="co"># Write the Stan code to the file</span></span>
<span id="cb60-39"><a href="from-simulation-to-model-fitting.html#cb60-39" tabindex="-1"></a><span class="fu">writeLines</span>(stan_model_logit_code, stan_file_logit)</span>
<span id="cb60-40"><a href="from-simulation-to-model-fitting.html#cb60-40" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Stan model (logit) written to:&quot;</span>, stan_file_logit, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb60-41"><a href="from-simulation-to-model-fitting.html#cb60-41" tabindex="-1"></a></span>
<span id="cb60-42"><a href="from-simulation-to-model-fitting.html#cb60-42" tabindex="-1"></a><span class="do">## With the logit format</span></span>
<span id="cb60-43"><a href="from-simulation-to-model-fitting.html#cb60-43" tabindex="-1"></a><span class="do">## Specify where the model is</span></span>
<span id="cb60-44"><a href="from-simulation-to-model-fitting.html#cb60-44" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;stan&quot;</span>, <span class="st">&quot;04_SimpleBernoulli_logodds.stan&quot;</span>)</span>
<span id="cb60-45"><a href="from-simulation-to-model-fitting.html#cb60-45" tabindex="-1"></a></span>
<span id="cb60-46"><a href="from-simulation-to-model-fitting.html#cb60-46" tabindex="-1"></a><span class="co"># File path for saved model</span></span>
<span id="cb60-47"><a href="from-simulation-to-model-fitting.html#cb60-47" tabindex="-1"></a>model_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;simmodels&quot;</span>,<span class="st">&quot;04_SimpleBernoulli_logodds.rds&quot;</span>)</span>
<span id="cb60-48"><a href="from-simulation-to-model-fitting.html#cb60-48" tabindex="-1"></a></span>
<span id="cb60-49"><a href="from-simulation-to-model-fitting.html#cb60-49" tabindex="-1"></a><span class="co"># Check if we need to rerun the simulation</span></span>
<span id="cb60-50"><a href="from-simulation-to-model-fitting.html#cb60-50" tabindex="-1"></a><span class="cf">if</span> (regenerate_simulations <span class="sc">||</span> <span class="sc">!</span><span class="fu">file.exists</span>(model_file)) {</span>
<span id="cb60-51"><a href="from-simulation-to-model-fitting.html#cb60-51" tabindex="-1"></a>  <span class="co"># Compile the model</span></span>
<span id="cb60-52"><a href="from-simulation-to-model-fitting.html#cb60-52" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(file, </span>
<span id="cb60-53"><a href="from-simulation-to-model-fitting.html#cb60-53" tabindex="-1"></a>                       <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">FALSE</span>),</span>
<span id="cb60-54"><a href="from-simulation-to-model-fitting.html#cb60-54" tabindex="-1"></a>                       <span class="at">stanc_options =</span> <span class="fu">list</span>(<span class="st">&quot;O1&quot;</span>))</span>
<span id="cb60-55"><a href="from-simulation-to-model-fitting.html#cb60-55" tabindex="-1"></a>  </span>
<span id="cb60-56"><a href="from-simulation-to-model-fitting.html#cb60-56" tabindex="-1"></a>  <span class="co"># The following command calls Stan with specific options.</span></span>
<span id="cb60-57"><a href="from-simulation-to-model-fitting.html#cb60-57" tabindex="-1"></a>  samples_biased_logodds <span class="ot">&lt;-</span> mod<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb60-58"><a href="from-simulation-to-model-fitting.html#cb60-58" tabindex="-1"></a>    <span class="at">data =</span> data_for_stan,</span>
<span id="cb60-59"><a href="from-simulation-to-model-fitting.html#cb60-59" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb60-60"><a href="from-simulation-to-model-fitting.html#cb60-60" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb60-61"><a href="from-simulation-to-model-fitting.html#cb60-61" tabindex="-1"></a>    <span class="at">parallel_chains =</span> <span class="dv">2</span>,</span>
<span id="cb60-62"><a href="from-simulation-to-model-fitting.html#cb60-62" tabindex="-1"></a>    <span class="co">#threads_per_chain = 1,</span></span>
<span id="cb60-63"><a href="from-simulation-to-model-fitting.html#cb60-63" tabindex="-1"></a>    <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb60-64"><a href="from-simulation-to-model-fitting.html#cb60-64" tabindex="-1"></a>    <span class="at">iter_sampling =</span> <span class="dv">2000</span>,</span>
<span id="cb60-65"><a href="from-simulation-to-model-fitting.html#cb60-65" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">0</span>,</span>
<span id="cb60-66"><a href="from-simulation-to-model-fitting.html#cb60-66" tabindex="-1"></a>    <span class="at">max_treedepth =</span> <span class="dv">20</span>,</span>
<span id="cb60-67"><a href="from-simulation-to-model-fitting.html#cb60-67" tabindex="-1"></a>    <span class="at">adapt_delta =</span> <span class="fl">0.99</span>,</span>
<span id="cb60-68"><a href="from-simulation-to-model-fitting.html#cb60-68" tabindex="-1"></a>  )</span>
<span id="cb60-69"><a href="from-simulation-to-model-fitting.html#cb60-69" tabindex="-1"></a>  </span>
<span id="cb60-70"><a href="from-simulation-to-model-fitting.html#cb60-70" tabindex="-1"></a>  <span class="co"># Save the fitted model</span></span>
<span id="cb60-71"><a href="from-simulation-to-model-fitting.html#cb60-71" tabindex="-1"></a>  samples_biased_logodds<span class="sc">$</span><span class="fu">save_object</span>(<span class="at">file =</span> model_file)</span>
<span id="cb60-72"><a href="from-simulation-to-model-fitting.html#cb60-72" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Generated new model fit and saved to&quot;</span>, model_file, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb60-73"><a href="from-simulation-to-model-fitting.html#cb60-73" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb60-74"><a href="from-simulation-to-model-fitting.html#cb60-74" tabindex="-1"></a>  <span class="co"># Load existing results</span></span>
<span id="cb60-75"><a href="from-simulation-to-model-fitting.html#cb60-75" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Loading biased model (log-odds) samples...</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb60-76"><a href="from-simulation-to-model-fitting.html#cb60-76" tabindex="-1"></a>  samples_biased_logodds <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(model_file)</span>
<span id="cb60-77"><a href="from-simulation-to-model-fitting.html#cb60-77" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Available parameters:&quot;</span>, <span class="fu">paste</span>(<span class="fu">colnames</span>(<span class="fu">as_draws_df</span>(samples_biased_logodds<span class="sc">$</span><span class="fu">draws</span>())), <span class="at">collapse =</span> <span class="st">&quot;, &quot;</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb60-78"><a href="from-simulation-to-model-fitting.html#cb60-78" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Loaded existing model fit from&quot;</span>, model_file, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb60-79"><a href="from-simulation-to-model-fitting.html#cb60-79" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="summarizing-the-results" class="section level3 hasAnchor" number="5.4.3">
<h3><span class="header-section-number">5.4.3</span> Summarizing the results<a href="from-simulation-to-model-fitting.html#summarizing-the-results" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="from-simulation-to-model-fitting.html#cb61-1" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;samples_biased_logodds&quot;</span>)) {</span>
<span id="cb61-2"><a href="from-simulation-to-model-fitting.html#cb61-2" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Loading biased model (log-odds) samples...</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb61-3"><a href="from-simulation-to-model-fitting.html#cb61-3" tabindex="-1"></a>  samples_biased_logodds <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">here</span>(<span class="st">&quot;simmodels&quot;</span>,<span class="st">&quot;04_SimpleBernoulli_logodds.rds&quot;</span>))</span>
<span id="cb61-4"><a href="from-simulation-to-model-fitting.html#cb61-4" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Available parameters:&quot;</span>, <span class="fu">paste</span>(<span class="fu">colnames</span>(<span class="fu">as_draws_df</span>(samples_biased_logodds<span class="sc">$</span><span class="fu">draws</span>())), <span class="at">collapse =</span> <span class="st">&quot;, &quot;</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb61-5"><a href="from-simulation-to-model-fitting.html#cb61-5" tabindex="-1"></a>}</span>
<span id="cb61-6"><a href="from-simulation-to-model-fitting.html#cb61-6" tabindex="-1"></a></span>
<span id="cb61-7"><a href="from-simulation-to-model-fitting.html#cb61-7" tabindex="-1"></a><span class="co"># Extract posterior samples and include sampling of the prior:</span></span>
<span id="cb61-8"><a href="from-simulation-to-model-fitting.html#cb61-8" tabindex="-1"></a>draws_df_biased_logodds <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(samples_biased_logodds<span class="sc">$</span><span class="fu">draws</span>()) </span>
<span id="cb61-9"><a href="from-simulation-to-model-fitting.html#cb61-9" tabindex="-1"></a></span>
<span id="cb61-10"><a href="from-simulation-to-model-fitting.html#cb61-10" tabindex="-1"></a><span class="co"># Explicitly extract theta parameter</span></span>
<span id="cb61-11"><a href="from-simulation-to-model-fitting.html#cb61-11" tabindex="-1"></a>theta_param_logodds <span class="ot">&lt;-</span> draws_df_biased_logodds<span class="sc">$</span>theta</span>
<span id="cb61-12"><a href="from-simulation-to-model-fitting.html#cb61-12" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Successfully extracted theta parameter with&quot;</span>, <span class="fu">length</span>(theta_param_logodds), <span class="st">&quot;values</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Successfully extracted theta parameter with 4000 values</code></pre>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="from-simulation-to-model-fitting.html#cb63-1" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df_biased_logodds, <span class="fu">aes</span>(.iteration, theta, <span class="at">group =</span> .chain, <span class="at">color =</span> .chain)) <span class="sc">+</span></span>
<span id="cb63-2"><a href="from-simulation-to-model-fitting.html#cb63-2" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb63-3"><a href="from-simulation-to-model-fitting.html#cb63-3" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="series_files/figure-html/04%20biased%20model%20log-odds%20quality%20assessment-1.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="from-simulation-to-model-fitting.html#cb64-1" tabindex="-1"></a><span class="co"># add a prior for theta (ugly, but we&#39;ll do better soon)</span></span>
<span id="cb64-2"><a href="from-simulation-to-model-fitting.html#cb64-2" tabindex="-1"></a>draws_df_biased_logodds <span class="ot">&lt;-</span> draws_df_biased_logodds <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb64-3"><a href="from-simulation-to-model-fitting.html#cb64-3" tabindex="-1"></a>  <span class="at">theta_prior =</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(draws_df_biased_logodds), <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb64-4"><a href="from-simulation-to-model-fitting.html#cb64-4" tabindex="-1"></a>)</span>
<span id="cb64-5"><a href="from-simulation-to-model-fitting.html#cb64-5" tabindex="-1"></a></span>
<span id="cb64-6"><a href="from-simulation-to-model-fitting.html#cb64-6" tabindex="-1"></a><span class="co"># Now let&#39;s plot the density for theta (prior and posterior)</span></span>
<span id="cb64-7"><a href="from-simulation-to-model-fitting.html#cb64-7" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df_biased_logodds) <span class="sc">+</span></span>
<span id="cb64-8"><a href="from-simulation-to-model-fitting.html#cb64-8" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(theta), <span class="at">fill =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb64-9"><a href="from-simulation-to-model-fitting.html#cb64-9" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(theta_prior), <span class="at">fill =</span> <span class="st">&quot;red&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb64-10"><a href="from-simulation-to-model-fitting.html#cb64-10" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">1.38</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb64-11"><a href="from-simulation-to-model-fitting.html#cb64-11" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Rate&quot;</span>) <span class="sc">+</span></span>
<span id="cb64-12"><a href="from-simulation-to-model-fitting.html#cb64-12" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Posterior Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb64-13"><a href="from-simulation-to-model-fitting.html#cb64-13" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="series_files/figure-html/04%20biased%20model%20log-odds%20quality%20assessment-2.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="from-simulation-to-model-fitting.html#cb65-1" tabindex="-1"></a><span class="co"># Summary</span></span>
<span id="cb65-2"><a href="from-simulation-to-model-fitting.html#cb65-2" tabindex="-1"></a>samples_biased_logodds<span class="sc">$</span><span class="fu">summary</span>()</span></code></pre></div>
<pre><code>## # A tibble: 124 × 10
##    variable       mean  median     sd    mad      q5     q95  rhat ess_bulk ess_tail
##    &lt;chr&gt;         &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1 lp__        -70.5   -70.2   0.765  0.301  -72.0   -70.0   1.00     1346.    1038.
##  2 theta_logit   1.01    1.01  0.205  0.201    0.677   1.35  1.00      848.     987.
##  3 theta         0.731   0.733 0.0398 0.0392   0.663   0.794 1.00      848.     987.
##  4 theta_prior   0.500   0.500 0.209  0.239    0.161   0.831 1.00     4067.    3949.
##  5 h_pred[1]     0.740   1     0.439  0        0       1     1.000    3838.      NA 
##  6 h_pred[2]     0.725   1     0.446  0        0       1     1.00     3857.      NA 
##  7 h_pred[3]     0.73    1     0.444  0        0       1     1.000    3713.      NA 
##  8 h_pred[4]     0.743   1     0.437  0        0       1     1.00     3543.      NA 
##  9 h_pred[5]     0.733   1     0.443  0        0       1     1.000    3592.      NA 
## 10 h_pred[6]     0.746   1     0.435  0        0       1     1.000    3579.      NA 
## # ℹ 114 more rows</code></pre>
<p>We can see that the results are very similar.</p>
</div>
</div>
<div id="validating-the-model-parameter-recovery" class="section level2 hasAnchor" number="5.5">
<h2><span class="header-section-number">5.5</span> Validating the Model: Parameter Recovery<a href="from-simulation-to-model-fitting.html#validating-the-model-parameter-recovery" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Before using a model on real data, it’s crucial to verify that it can accurately recover known parameters from simulated data. This process, called <strong>parameter recovery</strong>, involves:
1. Simulating datasets with known ground truth parameter values (as we did earlier).
2. Fitting the model to these simulated datasets.
3. Comparing the model’s estimated parameters to the true values used in simulation.
If the model consistently recovers the true parameters across different simulation conditions (e.g., different true rates, different noise levels), we gain confidence in its validity.</p>
<p><strong>Setting up Parallel Recovery</strong></p>
<p>Parameter recovery involves fitting the model many times. To speed this up, we use parallel processing with the <code>future</code> and <code>furrr</code> packages.</p>
<p>First we need to define the function that will define the operations to be run on each core separately, here we simulate the data according to a seed, a n of trials, a rate and a noise, and then we fit the model to them.
Second, we need to create a tibble of the seeds, n of trials, rate and noise values that should be simulated.
Third, we use future_pmap_dfr to run the function on each row of the tibble above separately on a different core. Note that I set the system to split across 4 parallel cores (to work on my computer without clogging it). Do change it according to the system you are using. Note that if you have 40 “jobs” (rows of the tibble, sets of parameter values to run), using e.g. 32 cores will not substantially speed things more than using 20.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="from-simulation-to-model-fitting.html#cb67-1" tabindex="-1"></a><span class="co"># --- Parameter Recovery Setup ---</span></span>
<span id="cb67-2"><a href="from-simulation-to-model-fitting.html#cb67-2" tabindex="-1"></a></span>
<span id="cb67-3"><a href="from-simulation-to-model-fitting.html#cb67-3" tabindex="-1"></a><span class="co"># Define paths using here()</span></span>
<span id="cb67-4"><a href="from-simulation-to-model-fitting.html#cb67-4" tabindex="-1"></a>stan_file_logit <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;stan&quot;</span>, <span class="st">&quot;04_SimpleBernoulli_logodds.stan&quot;</span>) </span>
<span id="cb67-5"><a href="from-simulation-to-model-fitting.html#cb67-5" tabindex="-1"></a>exe_dir_logit   <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;simmodels&quot;</span>) <span class="co"># Persistent folder for the executable</span></span>
<span id="cb67-6"><a href="from-simulation-to-model-fitting.html#cb67-6" tabindex="-1"></a></span>
<span id="cb67-7"><a href="from-simulation-to-model-fitting.html#cb67-7" tabindex="-1"></a><span class="co"># Ensure directories exist</span></span>
<span id="cb67-8"><a href="from-simulation-to-model-fitting.html#cb67-8" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">here</span>(<span class="st">&quot;stan&quot;</span>))) <span class="fu">dir.create</span>(<span class="fu">here</span>(<span class="st">&quot;stan&quot;</span>))</span>
<span id="cb67-9"><a href="from-simulation-to-model-fitting.html#cb67-9" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(exe_dir_logit)) <span class="fu">dir.create</span>(exe_dir_logit)</span>
<span id="cb67-10"><a href="from-simulation-to-model-fitting.html#cb67-10" tabindex="-1"></a></span>
<span id="cb67-11"><a href="from-simulation-to-model-fitting.html#cb67-11" tabindex="-1"></a><span class="co"># compile to persisting directory all parallel workers can acces</span></span>
<span id="cb67-12"><a href="from-simulation-to-model-fitting.html#cb67-12" tabindex="-1"></a>mod_logit <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(</span>
<span id="cb67-13"><a href="from-simulation-to-model-fitting.html#cb67-13" tabindex="-1"></a>  stan_file_logit,</span>
<span id="cb67-14"><a href="from-simulation-to-model-fitting.html#cb67-14" tabindex="-1"></a>  <span class="at">dir =</span> exe_dir_logit,  </span>
<span id="cb67-15"><a href="from-simulation-to-model-fitting.html#cb67-15" tabindex="-1"></a>  <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">FALSE</span>),</span>
<span id="cb67-16"><a href="from-simulation-to-model-fitting.html#cb67-16" tabindex="-1"></a>  <span class="at">stanc_options =</span> <span class="fu">list</span>(<span class="st">&quot;O1&quot;</span>)</span>
<span id="cb67-17"><a href="from-simulation-to-model-fitting.html#cb67-17" tabindex="-1"></a>)</span>
<span id="cb67-18"><a href="from-simulation-to-model-fitting.html#cb67-18" tabindex="-1"></a></span>
<span id="cb67-19"><a href="from-simulation-to-model-fitting.html#cb67-19" tabindex="-1"></a><span class="co"># Define relative path for recovery results</span></span>
<span id="cb67-20"><a href="from-simulation-to-model-fitting.html#cb67-20" tabindex="-1"></a>recovery_file <span class="ot">&lt;-</span> <span class="fu">here</span>(sim_data_dir, <span class="st">&quot;04_recovery_logit.csv&quot;</span>)</span>
<span id="cb67-21"><a href="from-simulation-to-model-fitting.html#cb67-21" tabindex="-1"></a></span>
<span id="cb67-22"><a href="from-simulation-to-model-fitting.html#cb67-22" tabindex="-1"></a><span class="co"># Function to simulate data AND fit the model for one condition</span></span>
<span id="cb67-23"><a href="from-simulation-to-model-fitting.html#cb67-23" tabindex="-1"></a><span class="co"># This function will be run in parallel for different parameter combinations.</span></span>
<span id="cb67-24"><a href="from-simulation-to-model-fitting.html#cb67-24" tabindex="-1"></a>sim_and_fit <span class="ot">&lt;-</span> <span class="cf">function</span>(seed, n_trials, true_rate, true_noise, stan_model) {</span>
<span id="cb67-25"><a href="from-simulation-to-model-fitting.html#cb67-25" tabindex="-1"></a>  <span class="co"># 1. Simulate data for this specific condition</span></span>
<span id="cb67-26"><a href="from-simulation-to-model-fitting.html#cb67-26" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed) <span class="co"># Ensure reproducibility for this specific run</span></span>
<span id="cb67-27"><a href="from-simulation-to-model-fitting.html#cb67-27" tabindex="-1"></a>  <span class="co"># We need to generate choices based on rate (probability) and noise</span></span>
<span id="cb67-28"><a href="from-simulation-to-model-fitting.html#cb67-28" tabindex="-1"></a>  rate_logit <span class="ot">=</span> <span class="fu">qlogis</span>(true_rate) <span class="co"># Convert true rate to logit for the agent function if needed</span></span>
<span id="cb67-29"><a href="from-simulation-to-model-fitting.html#cb67-29" tabindex="-1"></a>  sim_choices <span class="ot">&lt;-</span> <span class="fu">map_int</span>(<span class="dv">1</span><span class="sc">:</span>n_trials, <span class="sc">~</span><span class="fu">RandomAgentNoise_f</span>(rate_logit, true_noise))</span>
<span id="cb67-30"><a href="from-simulation-to-model-fitting.html#cb67-30" tabindex="-1"></a></span>
<span id="cb67-31"><a href="from-simulation-to-model-fitting.html#cb67-31" tabindex="-1"></a>  <span class="co"># 2. Prepare data for Stan</span></span>
<span id="cb67-32"><a href="from-simulation-to-model-fitting.html#cb67-32" tabindex="-1"></a>  stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">n =</span> n_trials, <span class="at">h =</span> sim_choices)</span>
<span id="cb67-33"><a href="from-simulation-to-model-fitting.html#cb67-33" tabindex="-1"></a></span>
<span id="cb67-34"><a href="from-simulation-to-model-fitting.html#cb67-34" tabindex="-1"></a>  <span class="co"># 3. Fit the Stan model</span></span>
<span id="cb67-35"><a href="from-simulation-to-model-fitting.html#cb67-35" tabindex="-1"></a>  <span class="co"># Use the pre-compiled model object passed as an argument</span></span>
<span id="cb67-36"><a href="from-simulation-to-model-fitting.html#cb67-36" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> stan_model<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb67-37"><a href="from-simulation-to-model-fitting.html#cb67-37" tabindex="-1"></a>    <span class="at">data =</span> stan_data,</span>
<span id="cb67-38"><a href="from-simulation-to-model-fitting.html#cb67-38" tabindex="-1"></a>    <span class="at">seed =</span> seed <span class="sc">+</span> <span class="dv">1000</span>, <span class="co"># Separate seed for fitting</span></span>
<span id="cb67-39"><a href="from-simulation-to-model-fitting.html#cb67-39" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">1</span>,         <span class="co"># Use 1 chain for speed in recovery study (can use more)</span></span>
<span id="cb67-40"><a href="from-simulation-to-model-fitting.html#cb67-40" tabindex="-1"></a>    <span class="at">threads_per_chain =</span> <span class="dv">1</span>,</span>
<span id="cb67-41"><a href="from-simulation-to-model-fitting.html#cb67-41" tabindex="-1"></a>    <span class="at">iter_warmup =</span> <span class="dv">500</span>,  <span class="co"># Fewer iterations for speed</span></span>
<span id="cb67-42"><a href="from-simulation-to-model-fitting.html#cb67-42" tabindex="-1"></a>    <span class="at">iter_sampling =</span> <span class="dv">1000</span>,</span>
<span id="cb67-43"><a href="from-simulation-to-model-fitting.html#cb67-43" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">0</span>,        <span class="co"># Suppress verbose output</span></span>
<span id="cb67-44"><a href="from-simulation-to-model-fitting.html#cb67-44" tabindex="-1"></a>    <span class="at">adapt_delta =</span> <span class="fl">0.9</span>   <span class="co"># Maintain reasonable adaptation</span></span>
<span id="cb67-45"><a href="from-simulation-to-model-fitting.html#cb67-45" tabindex="-1"></a>  )</span>
<span id="cb67-46"><a href="from-simulation-to-model-fitting.html#cb67-46" tabindex="-1"></a></span>
<span id="cb67-47"><a href="from-simulation-to-model-fitting.html#cb67-47" tabindex="-1"></a>  <span class="co"># 4. Extract results (posterior mean of theta)</span></span>
<span id="cb67-48"><a href="from-simulation-to-model-fitting.html#cb67-48" tabindex="-1"></a>  est_theta <span class="ot">&lt;-</span> fit<span class="sc">$</span><span class="fu">summary</span>(<span class="st">&quot;theta&quot;</span>)<span class="sc">$</span>mean <span class="co"># Get posterior mean on probability scale</span></span>
<span id="cb67-49"><a href="from-simulation-to-model-fitting.html#cb67-49" tabindex="-1"></a></span>
<span id="cb67-50"><a href="from-simulation-to-model-fitting.html#cb67-50" tabindex="-1"></a>  <span class="co"># 5. Return tibble with true vs. estimated values</span></span>
<span id="cb67-51"><a href="from-simulation-to-model-fitting.html#cb67-51" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb67-52"><a href="from-simulation-to-model-fitting.html#cb67-52" tabindex="-1"></a>    <span class="at">true_rate =</span> true_rate,</span>
<span id="cb67-53"><a href="from-simulation-to-model-fitting.html#cb67-53" tabindex="-1"></a>    <span class="at">true_noise =</span> true_noise,</span>
<span id="cb67-54"><a href="from-simulation-to-model-fitting.html#cb67-54" tabindex="-1"></a>    <span class="at">estimated_rate =</span> est_theta,</span>
<span id="cb67-55"><a href="from-simulation-to-model-fitting.html#cb67-55" tabindex="-1"></a>    <span class="at">seed =</span> seed,</span>
<span id="cb67-56"><a href="from-simulation-to-model-fitting.html#cb67-56" tabindex="-1"></a>    <span class="at">n_trials =</span> n_trials</span>
<span id="cb67-57"><a href="from-simulation-to-model-fitting.html#cb67-57" tabindex="-1"></a>  )</span>
<span id="cb67-58"><a href="from-simulation-to-model-fitting.html#cb67-58" tabindex="-1"></a>}</span>
<span id="cb67-59"><a href="from-simulation-to-model-fitting.html#cb67-59" tabindex="-1"></a></span>
<span id="cb67-60"><a href="from-simulation-to-model-fitting.html#cb67-60" tabindex="-1"></a><span class="co"># --- Define Recovery Grid ---</span></span>
<span id="cb67-61"><a href="from-simulation-to-model-fitting.html#cb67-61" tabindex="-1"></a><span class="co"># Set up combinations of parameters to test</span></span>
<span id="cb67-62"><a href="from-simulation-to-model-fitting.html#cb67-62" tabindex="-1"></a>recovery_grid <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb67-63"><a href="from-simulation-to-model-fitting.html#cb67-63" tabindex="-1"></a>  <span class="at">true_rate =</span> <span class="fu">seq</span>(<span class="fl">0.1</span>, <span class="fl">0.9</span>, <span class="fl">0.2</span>), <span class="co"># Test various true bias rates</span></span>
<span id="cb67-64"><a href="from-simulation-to-model-fitting.html#cb67-64" tabindex="-1"></a>  <span class="at">true_noise =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.4</span>, <span class="fl">0.2</span>),  <span class="co"># Test various noise levels</span></span>
<span id="cb67-65"><a href="from-simulation-to-model-fitting.html#cb67-65" tabindex="-1"></a>  <span class="at">n_trials =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">120</span>),          <span class="co"># Test effect of sample size</span></span>
<span id="cb67-66"><a href="from-simulation-to-model-fitting.html#cb67-66" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>                     <span class="co"># Run multiple simulations per condition</span></span>
<span id="cb67-67"><a href="from-simulation-to-model-fitting.html#cb67-67" tabindex="-1"></a>)</span>
<span id="cb67-68"><a href="from-simulation-to-model-fitting.html#cb67-68" tabindex="-1"></a></span>
<span id="cb67-69"><a href="from-simulation-to-model-fitting.html#cb67-69" tabindex="-1"></a><span class="co"># --- Run Recovery in Parallel ---</span></span>
<span id="cb67-70"><a href="from-simulation-to-model-fitting.html#cb67-70" tabindex="-1"></a><span class="co"># Set up parallel plan (use slightly fewer cores than available)</span></span>
<span id="cb67-71"><a href="from-simulation-to-model-fitting.html#cb67-71" tabindex="-1"></a><span class="co"># plan(multisession, workers = availableCores() - 1)</span></span>
<span id="cb67-72"><a href="from-simulation-to-model-fitting.html#cb67-72" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> <span class="dv">4</span>) <span class="co"># Example: use 4 cores</span></span>
<span id="cb67-73"><a href="from-simulation-to-model-fitting.html#cb67-73" tabindex="-1"></a></span>
<span id="cb67-74"><a href="from-simulation-to-model-fitting.html#cb67-74" tabindex="-1"></a><span class="cf">if</span> (regenerate_simulations <span class="sc">||</span> <span class="sc">!</span><span class="fu">file.exists</span>(recovery_file)) {</span>
<span id="cb67-75"><a href="from-simulation-to-model-fitting.html#cb67-75" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Running parameter recovery simulation...</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb67-76"><a href="from-simulation-to-model-fitting.html#cb67-76" tabindex="-1"></a>  <span class="co"># Use future_pmap_dfr to run sim_and_fit for each row in recovery_grid</span></span>
<span id="cb67-77"><a href="from-simulation-to-model-fitting.html#cb67-77" tabindex="-1"></a>  recovery_results <span class="ot">&lt;-</span> <span class="fu">future_pmap_dfr</span>(</span>
<span id="cb67-78"><a href="from-simulation-to-model-fitting.html#cb67-78" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">seed =</span> recovery_grid<span class="sc">$</span>seed,</span>
<span id="cb67-79"><a href="from-simulation-to-model-fitting.html#cb67-79" tabindex="-1"></a>         <span class="at">n_trials =</span> recovery_grid<span class="sc">$</span>n_trials,</span>
<span id="cb67-80"><a href="from-simulation-to-model-fitting.html#cb67-80" tabindex="-1"></a>         <span class="at">true_rate =</span> recovery_grid<span class="sc">$</span>true_rate,</span>
<span id="cb67-81"><a href="from-simulation-to-model-fitting.html#cb67-81" tabindex="-1"></a>         <span class="at">true_noise =</span> recovery_grid<span class="sc">$</span>true_noise),</span>
<span id="cb67-82"><a href="from-simulation-to-model-fitting.html#cb67-82" tabindex="-1"></a>    sim_and_fit, <span class="co"># The function to run</span></span>
<span id="cb67-83"><a href="from-simulation-to-model-fitting.html#cb67-83" tabindex="-1"></a>    <span class="at">stan_model =</span> mod_logit, <span class="co"># Pass the compiled model object</span></span>
<span id="cb67-84"><a href="from-simulation-to-model-fitting.html#cb67-84" tabindex="-1"></a>    <span class="at">.options =</span> <span class="fu">furrr_options</span>(<span class="at">seed =</span> <span class="cn">TRUE</span>), <span class="co"># Ensure reproducibility across cores</span></span>
<span id="cb67-85"><a href="from-simulation-to-model-fitting.html#cb67-85" tabindex="-1"></a>    <span class="at">.progress =</span> <span class="cn">TRUE</span> <span class="co"># Show progress bar</span></span>
<span id="cb67-86"><a href="from-simulation-to-model-fitting.html#cb67-86" tabindex="-1"></a>  )</span>
<span id="cb67-87"><a href="from-simulation-to-model-fitting.html#cb67-87" tabindex="-1"></a>  <span class="co"># Save results</span></span>
<span id="cb67-88"><a href="from-simulation-to-model-fitting.html#cb67-88" tabindex="-1"></a>  <span class="fu">write_csv</span>(recovery_results, recovery_file)</span>
<span id="cb67-89"><a href="from-simulation-to-model-fitting.html#cb67-89" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Parameter recovery finished and results saved to:&quot;</span>, recovery_file, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb67-90"><a href="from-simulation-to-model-fitting.html#cb67-90" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb67-91"><a href="from-simulation-to-model-fitting.html#cb67-91" tabindex="-1"></a>  <span class="co"># Load existing results</span></span>
<span id="cb67-92"><a href="from-simulation-to-model-fitting.html#cb67-92" tabindex="-1"></a>  recovery_results <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(recovery_file)</span>
<span id="cb67-93"><a href="from-simulation-to-model-fitting.html#cb67-93" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Loaded existing parameter recovery results from:&quot;</span>, recovery_file, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb67-94"><a href="from-simulation-to-model-fitting.html#cb67-94" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Loaded existing parameter recovery results from: /Users/au209589/Dropbox/Teaching/AdvancedCognitiveModeling23_book/simdata/04_recovery_logit.csv</code></pre>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="from-simulation-to-model-fitting.html#cb69-1" tabindex="-1"></a><span class="co"># --- Visualize Recovery Results ---</span></span>
<span id="cb69-2"><a href="from-simulation-to-model-fitting.html#cb69-2" tabindex="-1"></a><span class="fu">ggplot</span>(recovery_results, <span class="fu">aes</span>(<span class="at">x =</span> true_rate, <span class="at">y =</span> estimated_rate)) <span class="sc">+</span></span>
<span id="cb69-3"><a href="from-simulation-to-model-fitting.html#cb69-3" tabindex="-1"></a>  <span class="co"># geom_jitter shows individual simulation results, alpha for density</span></span>
<span id="cb69-4"><a href="from-simulation-to-model-fitting.html#cb69-4" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">factor</span>(n_trials)), <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">width =</span> <span class="fl">0.02</span>) <span class="sc">+</span></span>
<span id="cb69-5"><a href="from-simulation-to-model-fitting.html#cb69-5" tabindex="-1"></a>  <span class="co"># geom_smooth shows the average trend</span></span>
<span id="cb69-6"><a href="from-simulation-to-model-fitting.html#cb69-6" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="fu">aes</span>(<span class="at">linetype =</span> <span class="fu">factor</span>(n_trials)), <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb69-7"><a href="from-simulation-to-model-fitting.html#cb69-7" tabindex="-1"></a>  <span class="co"># Add y=x line for perfect recovery reference</span></span>
<span id="cb69-8"><a href="from-simulation-to-model-fitting.html#cb69-8" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb69-9"><a href="from-simulation-to-model-fitting.html#cb69-9" tabindex="-1"></a>  <span class="co"># Facet by noise level and number of trials</span></span>
<span id="cb69-10"><a href="from-simulation-to-model-fitting.html#cb69-10" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="fu">paste</span>(<span class="st">&quot;Noise =&quot;</span>, true_noise) <span class="sc">~</span> <span class="fu">paste</span>(<span class="st">&quot;N Trials =&quot;</span>, n_trials)) <span class="sc">+</span></span>
<span id="cb69-11"><a href="from-simulation-to-model-fitting.html#cb69-11" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">end =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb69-12"><a href="from-simulation-to-model-fitting.html#cb69-12" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb69-13"><a href="from-simulation-to-model-fitting.html#cb69-13" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Parameter Recovery: Estimated vs. True Bias Rate&quot;</span>,</span>
<span id="cb69-14"><a href="from-simulation-to-model-fitting.html#cb69-14" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&quot;Red dashed line = perfect recovery. Points = individual simulations.&quot;</span>,</span>
<span id="cb69-15"><a href="from-simulation-to-model-fitting.html#cb69-15" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&quot;True Bias Rate (theta)&quot;</span>,</span>
<span id="cb69-16"><a href="from-simulation-to-model-fitting.html#cb69-16" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&quot;Estimated Bias Rate (Posterior Mean)&quot;</span>,</span>
<span id="cb69-17"><a href="from-simulation-to-model-fitting.html#cb69-17" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">&quot;N Trials&quot;</span>,</span>
<span id="cb69-18"><a href="from-simulation-to-model-fitting.html#cb69-18" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&quot;N Trials&quot;</span></span>
<span id="cb69-19"><a href="from-simulation-to-model-fitting.html#cb69-19" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb69-20"><a href="from-simulation-to-model-fitting.html#cb69-20" tabindex="-1"></a>  <span class="fu">coord_fixed</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span> <span class="co"># Ensure axes are comparable</span></span>
<span id="cb69-21"><a href="from-simulation-to-model-fitting.html#cb69-21" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb69-22"><a href="from-simulation-to-model-fitting.html#cb69-22" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span></code></pre></div>
<p><img src="series_files/figure-html/04-parameter-recovery-setup-1.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
<p>There’s much to be said about the final plot, but for now let’s just say that it looks good. We can reconstruct in a nice ordered way true rate values. However, our ability to do so decreases with the increase in noise. So far no surprises. Wait, you say, shouldn’t we actually model the generative process, that is, include noise in the Stan model? Gold star, there! But let’s wait a bit before we get there, we’ll need mixture models.</p>
</div>
<div id="moving-beyond-simple-bias-memory-models" class="section level2 hasAnchor" number="5.6">
<h2><span class="header-section-number">5.6</span> Moving Beyond Simple Bias: Memory Models<a href="from-simulation-to-model-fitting.html#moving-beyond-simple-bias-memory-models" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The simple biased agent model assumes choices are independent over time, influenced only by a fixed <code>theta</code>. However, behavior is often history-dependent. Let’s explore models where the choice probability <code>theta</code> on trial <em>t</em> depends on previous events.</p>
<div id="memory-model-1-glm-like-approach-external-predictor" class="section level3 hasAnchor" number="5.6.1">
<h3><span class="header-section-number">5.6.1</span> Memory Model 1: GLM-like Approach (External Predictor)<a href="from-simulation-to-model-fitting.html#memory-model-1-glm-like-approach-external-predictor" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>One way to incorporate memory is to treat a summary of past events as an external predictor influencing the current choice probability, similar to a predictor in a Generalized Linear Model (GLM).</p>
<p>Let’s assume the choice probability <code>theta</code> depends on the <strong>cumulative rate of the opponent’s ‘right’ choices</strong> observed up to the <em>previous</em> trial.To make the variable more intuitive we code previous rate - which is bound to a probability 0-1 space - into log-odds via a logit link/transformation. In this way a previous rate with more left than right choices will result in a negative value, thereby decreasing our propensity to choose right; and one with more right than left choices will result in a positive value, thereby increasing our propensity to choose right.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="from-simulation-to-model-fitting.html#cb70-1" tabindex="-1"></a><span class="co"># We subset to only include no noise and a specific rate</span></span>
<span id="cb70-2"><a href="from-simulation-to-model-fitting.html#cb70-2" tabindex="-1"></a>d1 <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb70-3"><a href="from-simulation-to-model-fitting.html#cb70-3" tabindex="-1"></a>  <span class="fu">subset</span>(true_noise <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> true_rate <span class="sc">==</span> <span class="fl">0.8</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb70-4"><a href="from-simulation-to-model-fitting.html#cb70-4" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Other =</span> choice) <span class="sc">%&gt;%</span> </span>
<span id="cb70-5"><a href="from-simulation-to-model-fitting.html#cb70-5" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cumulativerate =</span> <span class="fu">lag</span>(cumulative_rate, <span class="dv">1</span>))</span>
<span id="cb70-6"><a href="from-simulation-to-model-fitting.html#cb70-6" tabindex="-1"></a></span>
<span id="cb70-7"><a href="from-simulation-to-model-fitting.html#cb70-7" tabindex="-1"></a>d1<span class="sc">$</span>cumulativerate[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="co"># no prior info at first trial</span></span>
<span id="cb70-8"><a href="from-simulation-to-model-fitting.html#cb70-8" tabindex="-1"></a>d1<span class="sc">$</span>cumulativerate[d1<span class="sc">$</span>cumulativerate <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="fl">0.01</span></span>
<span id="cb70-9"><a href="from-simulation-to-model-fitting.html#cb70-9" tabindex="-1"></a>d1<span class="sc">$</span>cumulativerate[d1<span class="sc">$</span>cumulativerate <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fl">0.99</span></span>
<span id="cb70-10"><a href="from-simulation-to-model-fitting.html#cb70-10" tabindex="-1"></a></span>
<span id="cb70-11"><a href="from-simulation-to-model-fitting.html#cb70-11" tabindex="-1"></a><span class="co"># Now we create the memory agent with a coefficient of 1 (in log odds)</span></span>
<span id="cb70-12"><a href="from-simulation-to-model-fitting.html#cb70-12" tabindex="-1"></a>MemoryAgent_f <span class="ot">&lt;-</span> <span class="cf">function</span>(bias, beta, cumulativerate){</span>
<span id="cb70-13"><a href="from-simulation-to-model-fitting.html#cb70-13" tabindex="-1"></a>    choice <span class="ot">=</span> <span class="fu">rbinom</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="fu">inv_logit_scaled</span>(bias <span class="sc">+</span> beta <span class="sc">*</span> <span class="fu">logit_scaled</span>(cumulativerate)))</span>
<span id="cb70-14"><a href="from-simulation-to-model-fitting.html#cb70-14" tabindex="-1"></a>  <span class="fu">return</span>(choice)</span>
<span id="cb70-15"><a href="from-simulation-to-model-fitting.html#cb70-15" tabindex="-1"></a>}</span>
<span id="cb70-16"><a href="from-simulation-to-model-fitting.html#cb70-16" tabindex="-1"></a></span>
<span id="cb70-17"><a href="from-simulation-to-model-fitting.html#cb70-17" tabindex="-1"></a>d1<span class="sc">$</span>Self[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">RandomAgentNoise_f</span>(<span class="fl">0.5</span>, <span class="dv">0</span>)</span>
<span id="cb70-18"><a href="from-simulation-to-model-fitting.html#cb70-18" tabindex="-1"></a></span>
<span id="cb70-19"><a href="from-simulation-to-model-fitting.html#cb70-19" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>trials) {</span>
<span id="cb70-20"><a href="from-simulation-to-model-fitting.html#cb70-20" tabindex="-1"></a>  d1<span class="sc">$</span>Self[i] <span class="ot">&lt;-</span> <span class="fu">MemoryAgent_f</span>(<span class="at">bias =</span> <span class="dv">0</span>, <span class="at">beta =</span> <span class="dv">1</span>, d1<span class="sc">$</span>cumulativerate[i])</span>
<span id="cb70-21"><a href="from-simulation-to-model-fitting.html#cb70-21" tabindex="-1"></a>}</span>
<span id="cb70-22"><a href="from-simulation-to-model-fitting.html#cb70-22" tabindex="-1"></a></span>
<span id="cb70-23"><a href="from-simulation-to-model-fitting.html#cb70-23" tabindex="-1"></a><span class="do">## Create the data</span></span>
<span id="cb70-24"><a href="from-simulation-to-model-fitting.html#cb70-24" tabindex="-1"></a>data_memory <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb70-25"><a href="from-simulation-to-model-fitting.html#cb70-25" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">120</span>,</span>
<span id="cb70-26"><a href="from-simulation-to-model-fitting.html#cb70-26" tabindex="-1"></a>  <span class="at">h =</span> d1<span class="sc">$</span>Self,</span>
<span id="cb70-27"><a href="from-simulation-to-model-fitting.html#cb70-27" tabindex="-1"></a>  <span class="at">memory =</span> d1<span class="sc">$</span>cumulativerate <span class="co"># this creates the new parameter: the rate of right hands so far in log-odds</span></span>
<span id="cb70-28"><a href="from-simulation-to-model-fitting.html#cb70-28" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="from-simulation-to-model-fitting.html#cb71-1" tabindex="-1"></a>stan_model <span class="ot">&lt;-</span> <span class="st">&quot;</span></span>
<span id="cb71-2"><a href="from-simulation-to-model-fitting.html#cb71-2" tabindex="-1"></a><span class="st">// The input (data) for the model. n of trials and h for (right and left) hand</span></span>
<span id="cb71-3"><a href="from-simulation-to-model-fitting.html#cb71-3" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb71-4"><a href="from-simulation-to-model-fitting.html#cb71-4" tabindex="-1"></a><span class="st"> int&lt;lower=1&gt; n;</span></span>
<span id="cb71-5"><a href="from-simulation-to-model-fitting.html#cb71-5" tabindex="-1"></a><span class="st"> array[n] int h;</span></span>
<span id="cb71-6"><a href="from-simulation-to-model-fitting.html#cb71-6" tabindex="-1"></a><span class="st"> vector[n] memory; // here we add the new variable between 0.01 and .99</span></span>
<span id="cb71-7"><a href="from-simulation-to-model-fitting.html#cb71-7" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb71-8"><a href="from-simulation-to-model-fitting.html#cb71-8" tabindex="-1"></a></span>
<span id="cb71-9"><a href="from-simulation-to-model-fitting.html#cb71-9" tabindex="-1"></a><span class="st">// The parameters accepted by the model. </span></span>
<span id="cb71-10"><a href="from-simulation-to-model-fitting.html#cb71-10" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb71-11"><a href="from-simulation-to-model-fitting.html#cb71-11" tabindex="-1"></a><span class="st">  real bias; // how likely is the agent to pick right when the previous rate has no information (50-50)?</span></span>
<span id="cb71-12"><a href="from-simulation-to-model-fitting.html#cb71-12" tabindex="-1"></a><span class="st">  real beta; // how strongly is previous rate impacting the decision?</span></span>
<span id="cb71-13"><a href="from-simulation-to-model-fitting.html#cb71-13" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb71-14"><a href="from-simulation-to-model-fitting.html#cb71-14" tabindex="-1"></a></span>
<span id="cb71-15"><a href="from-simulation-to-model-fitting.html#cb71-15" tabindex="-1"></a><span class="st">// The model to be estimated. </span></span>
<span id="cb71-16"><a href="from-simulation-to-model-fitting.html#cb71-16" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb71-17"><a href="from-simulation-to-model-fitting.html#cb71-17" tabindex="-1"></a><span class="st">  // priors</span></span>
<span id="cb71-18"><a href="from-simulation-to-model-fitting.html#cb71-18" tabindex="-1"></a><span class="st">  target += normal_lpdf(bias | 0, .3);</span></span>
<span id="cb71-19"><a href="from-simulation-to-model-fitting.html#cb71-19" tabindex="-1"></a><span class="st">  target += normal_lpdf(beta | 0, .5);</span></span>
<span id="cb71-20"><a href="from-simulation-to-model-fitting.html#cb71-20" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb71-21"><a href="from-simulation-to-model-fitting.html#cb71-21" tabindex="-1"></a><span class="st">  // model</span></span>
<span id="cb71-22"><a href="from-simulation-to-model-fitting.html#cb71-22" tabindex="-1"></a><span class="st">  target += bernoulli_logit_lpmf(h | bias + beta * logit(memory));</span></span>
<span id="cb71-23"><a href="from-simulation-to-model-fitting.html#cb71-23" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb71-24"><a href="from-simulation-to-model-fitting.html#cb71-24" tabindex="-1"></a><span class="st">&quot;</span></span>
<span id="cb71-25"><a href="from-simulation-to-model-fitting.html#cb71-25" tabindex="-1"></a><span class="fu">write_stan_file</span>(</span>
<span id="cb71-26"><a href="from-simulation-to-model-fitting.html#cb71-26" tabindex="-1"></a>  stan_model,</span>
<span id="cb71-27"><a href="from-simulation-to-model-fitting.html#cb71-27" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">&quot;stan/&quot;</span>,</span>
<span id="cb71-28"><a href="from-simulation-to-model-fitting.html#cb71-28" tabindex="-1"></a>  <span class="at">basename =</span> <span class="st">&quot;04_MemoryBernoulli.stan&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;/Users/au209589/Dropbox/Teaching/AdvancedCognitiveModeling23_book/stan/04_MemoryBernoulli.stan&quot;</code></pre>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="from-simulation-to-model-fitting.html#cb73-1" tabindex="-1"></a><span class="do">## Specify where the model is</span></span>
<span id="cb73-2"><a href="from-simulation-to-model-fitting.html#cb73-2" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;stan&quot;</span>,<span class="st">&quot;04_MemoryBernoulli.stan&quot;</span>)</span>
<span id="cb73-3"><a href="from-simulation-to-model-fitting.html#cb73-3" tabindex="-1"></a></span>
<span id="cb73-4"><a href="from-simulation-to-model-fitting.html#cb73-4" tabindex="-1"></a><span class="co"># File path for saved model</span></span>
<span id="cb73-5"><a href="from-simulation-to-model-fitting.html#cb73-5" tabindex="-1"></a>model_file_memory <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;simmodels&quot;</span>, <span class="st">&quot;04_MemoryBernoulli.rds&quot;</span>)</span>
<span id="cb73-6"><a href="from-simulation-to-model-fitting.html#cb73-6" tabindex="-1"></a></span>
<span id="cb73-7"><a href="from-simulation-to-model-fitting.html#cb73-7" tabindex="-1"></a><span class="co"># Check if we need to rerun the simulation</span></span>
<span id="cb73-8"><a href="from-simulation-to-model-fitting.html#cb73-8" tabindex="-1"></a><span class="cf">if</span> (regenerate_simulations <span class="sc">||</span> <span class="sc">!</span><span class="fu">file.exists</span>(model_file_memory)) {</span>
<span id="cb73-9"><a href="from-simulation-to-model-fitting.html#cb73-9" tabindex="-1"></a>  <span class="co"># Compile the model</span></span>
<span id="cb73-10"><a href="from-simulation-to-model-fitting.html#cb73-10" tabindex="-1"></a>  mod_memory <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(file, </span>
<span id="cb73-11"><a href="from-simulation-to-model-fitting.html#cb73-11" tabindex="-1"></a>                       <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">FALSE</span>),</span>
<span id="cb73-12"><a href="from-simulation-to-model-fitting.html#cb73-12" tabindex="-1"></a>                       <span class="at">stanc_options =</span> <span class="fu">list</span>(<span class="st">&quot;O1&quot;</span>))</span>
<span id="cb73-13"><a href="from-simulation-to-model-fitting.html#cb73-13" tabindex="-1"></a>  </span>
<span id="cb73-14"><a href="from-simulation-to-model-fitting.html#cb73-14" tabindex="-1"></a>  <span class="co"># The following command calls Stan with specific options.</span></span>
<span id="cb73-15"><a href="from-simulation-to-model-fitting.html#cb73-15" tabindex="-1"></a>  samples_memory <span class="ot">&lt;-</span> mod_memory<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb73-16"><a href="from-simulation-to-model-fitting.html#cb73-16" tabindex="-1"></a>    <span class="at">data =</span> data_memory,</span>
<span id="cb73-17"><a href="from-simulation-to-model-fitting.html#cb73-17" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb73-18"><a href="from-simulation-to-model-fitting.html#cb73-18" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb73-19"><a href="from-simulation-to-model-fitting.html#cb73-19" tabindex="-1"></a>    <span class="at">parallel_chains =</span> <span class="dv">2</span>,</span>
<span id="cb73-20"><a href="from-simulation-to-model-fitting.html#cb73-20" tabindex="-1"></a>    <span class="at">threads_per_chain =</span> <span class="dv">1</span>,</span>
<span id="cb73-21"><a href="from-simulation-to-model-fitting.html#cb73-21" tabindex="-1"></a>    <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb73-22"><a href="from-simulation-to-model-fitting.html#cb73-22" tabindex="-1"></a>    <span class="at">iter_sampling =</span> <span class="dv">1000</span>,</span>
<span id="cb73-23"><a href="from-simulation-to-model-fitting.html#cb73-23" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">0</span>,</span>
<span id="cb73-24"><a href="from-simulation-to-model-fitting.html#cb73-24" tabindex="-1"></a>    <span class="at">max_treedepth =</span> <span class="dv">20</span>,</span>
<span id="cb73-25"><a href="from-simulation-to-model-fitting.html#cb73-25" tabindex="-1"></a>    <span class="at">adapt_delta =</span> <span class="fl">0.99</span>,</span>
<span id="cb73-26"><a href="from-simulation-to-model-fitting.html#cb73-26" tabindex="-1"></a>  )</span>
<span id="cb73-27"><a href="from-simulation-to-model-fitting.html#cb73-27" tabindex="-1"></a>  </span>
<span id="cb73-28"><a href="from-simulation-to-model-fitting.html#cb73-28" tabindex="-1"></a>  <span class="co"># Save the fitted model</span></span>
<span id="cb73-29"><a href="from-simulation-to-model-fitting.html#cb73-29" tabindex="-1"></a>  samples_memory<span class="sc">$</span><span class="fu">save_object</span>(<span class="at">file =</span> model_file_memory)</span>
<span id="cb73-30"><a href="from-simulation-to-model-fitting.html#cb73-30" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Generated new model fit and saved to&quot;</span>, model_file_memory, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb73-31"><a href="from-simulation-to-model-fitting.html#cb73-31" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb73-32"><a href="from-simulation-to-model-fitting.html#cb73-32" tabindex="-1"></a>  <span class="co"># Load existing results</span></span>
<span id="cb73-33"><a href="from-simulation-to-model-fitting.html#cb73-33" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Loading memory model samples...</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb73-34"><a href="from-simulation-to-model-fitting.html#cb73-34" tabindex="-1"></a>  samples_memory <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(model_file_memory)</span>
<span id="cb73-35"><a href="from-simulation-to-model-fitting.html#cb73-35" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Available parameters:&quot;</span>, <span class="fu">paste</span>(<span class="fu">colnames</span>(<span class="fu">as_draws_df</span>(samples_memory<span class="sc">$</span><span class="fu">draws</span>())), <span class="at">collapse=</span><span class="st">&quot;, &quot;</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb73-36"><a href="from-simulation-to-model-fitting.html#cb73-36" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Loaded existing model fit from&quot;</span>, model_file_memory, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb73-37"><a href="from-simulation-to-model-fitting.html#cb73-37" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Loading memory model samples...
## Available parameters: lp__, bias, beta, .chain, .iteration, .draw 
## Loaded existing model fit from /Users/au209589/Dropbox/Teaching/AdvancedCognitiveModeling23_book/simmodels/04_MemoryBernoulli.rds</code></pre>
</div>
<div id="summarizing-the-results-1" class="section level3 hasAnchor" number="5.6.2">
<h3><span class="header-section-number">5.6.2</span> Summarizing the results<a href="from-simulation-to-model-fitting.html#summarizing-the-results-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="from-simulation-to-model-fitting.html#cb75-1" tabindex="-1"></a><span class="co"># Check if samples_memory exists</span></span>
<span id="cb75-2"><a href="from-simulation-to-model-fitting.html#cb75-2" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;samples_memory&quot;</span>)) {</span>
<span id="cb75-3"><a href="from-simulation-to-model-fitting.html#cb75-3" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Loading memory model samples...</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb75-4"><a href="from-simulation-to-model-fitting.html#cb75-4" tabindex="-1"></a>  samples_memory <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">here</span>(<span class="st">&quot;simmodels&quot;</span>, <span class="st">&quot;04_MemoryBernoulli.rds&quot;</span>))</span>
<span id="cb75-5"><a href="from-simulation-to-model-fitting.html#cb75-5" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Available parameters:&quot;</span>, <span class="fu">paste</span>(<span class="fu">colnames</span>(<span class="fu">as_draws_df</span>(samples_memory<span class="sc">$</span><span class="fu">draws</span>())), <span class="at">collapse =</span> <span class="st">&quot;, &quot;</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb75-6"><a href="from-simulation-to-model-fitting.html#cb75-6" tabindex="-1"></a>}</span>
<span id="cb75-7"><a href="from-simulation-to-model-fitting.html#cb75-7" tabindex="-1"></a></span>
<span id="cb75-8"><a href="from-simulation-to-model-fitting.html#cb75-8" tabindex="-1"></a><span class="co"># Extract posterior samples and include sampling of the prior:</span></span>
<span id="cb75-9"><a href="from-simulation-to-model-fitting.html#cb75-9" tabindex="-1"></a>draws_df_memory <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(samples_memory<span class="sc">$</span><span class="fu">draws</span>()) </span>
<span id="cb75-10"><a href="from-simulation-to-model-fitting.html#cb75-10" tabindex="-1"></a></span>
<span id="cb75-11"><a href="from-simulation-to-model-fitting.html#cb75-11" tabindex="-1"></a><span class="co"># Explicitly extract parameters</span></span>
<span id="cb75-12"><a href="from-simulation-to-model-fitting.html#cb75-12" tabindex="-1"></a>bias_param <span class="ot">&lt;-</span> draws_df_memory<span class="sc">$</span>bias</span>
<span id="cb75-13"><a href="from-simulation-to-model-fitting.html#cb75-13" tabindex="-1"></a>beta_param <span class="ot">&lt;-</span> draws_df_memory<span class="sc">$</span>beta</span>
<span id="cb75-14"><a href="from-simulation-to-model-fitting.html#cb75-14" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Successfully extracted&quot;</span>, <span class="fu">length</span>(bias_param), <span class="st">&quot;values for bias parameter</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Successfully extracted 2000 values for bias parameter</code></pre>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="from-simulation-to-model-fitting.html#cb77-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Successfully extracted&quot;</span>, <span class="fu">length</span>(beta_param), <span class="st">&quot;values for beta parameter</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Successfully extracted 2000 values for beta parameter</code></pre>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="from-simulation-to-model-fitting.html#cb79-1" tabindex="-1"></a><span class="co"># Trace plot for bias</span></span>
<span id="cb79-2"><a href="from-simulation-to-model-fitting.html#cb79-2" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df_memory, <span class="fu">aes</span>(.iteration, bias, <span class="at">group =</span> .chain, <span class="at">color =</span> .chain)) <span class="sc">+</span></span>
<span id="cb79-3"><a href="from-simulation-to-model-fitting.html#cb79-3" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb79-4"><a href="from-simulation-to-model-fitting.html#cb79-4" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Trace plot for bias parameter&quot;</span>) <span class="sc">+</span></span>
<span id="cb79-5"><a href="from-simulation-to-model-fitting.html#cb79-5" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="series_files/figure-html/04%20memory%20model%20log-odds%20quality%20assessment-1.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="from-simulation-to-model-fitting.html#cb80-1" tabindex="-1"></a><span class="co"># Trace plot for beta</span></span>
<span id="cb80-2"><a href="from-simulation-to-model-fitting.html#cb80-2" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df_memory, <span class="fu">aes</span>(.iteration, beta, <span class="at">group =</span> .chain, <span class="at">color =</span> .chain)) <span class="sc">+</span></span>
<span id="cb80-3"><a href="from-simulation-to-model-fitting.html#cb80-3" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb80-4"><a href="from-simulation-to-model-fitting.html#cb80-4" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Trace plot for beta parameter&quot;</span>) <span class="sc">+</span></span>
<span id="cb80-5"><a href="from-simulation-to-model-fitting.html#cb80-5" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="series_files/figure-html/04%20memory%20model%20log-odds%20quality%20assessment-2.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="from-simulation-to-model-fitting.html#cb81-1" tabindex="-1"></a><span class="co"># add prior distributions</span></span>
<span id="cb81-2"><a href="from-simulation-to-model-fitting.html#cb81-2" tabindex="-1"></a>draws_df_memory <span class="ot">&lt;-</span> draws_df_memory <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb81-3"><a href="from-simulation-to-model-fitting.html#cb81-3" tabindex="-1"></a>  <span class="at">bias_prior =</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(draws_df_memory), <span class="dv">0</span>, .<span class="dv">3</span>),</span>
<span id="cb81-4"><a href="from-simulation-to-model-fitting.html#cb81-4" tabindex="-1"></a>  <span class="at">beta_prior =</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(draws_df_memory), <span class="dv">0</span>, .<span class="dv">5</span>)</span>
<span id="cb81-5"><a href="from-simulation-to-model-fitting.html#cb81-5" tabindex="-1"></a>)</span>
<span id="cb81-6"><a href="from-simulation-to-model-fitting.html#cb81-6" tabindex="-1"></a></span>
<span id="cb81-7"><a href="from-simulation-to-model-fitting.html#cb81-7" tabindex="-1"></a><span class="co"># Now let&#39;s plot the density for bias (prior and posterior)</span></span>
<span id="cb81-8"><a href="from-simulation-to-model-fitting.html#cb81-8" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df_memory) <span class="sc">+</span></span>
<span id="cb81-9"><a href="from-simulation-to-model-fitting.html#cb81-9" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(bias), <span class="at">fill =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb81-10"><a href="from-simulation-to-model-fitting.html#cb81-10" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(bias_prior), <span class="at">fill =</span> <span class="st">&quot;red&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb81-11"><a href="from-simulation-to-model-fitting.html#cb81-11" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb81-12"><a href="from-simulation-to-model-fitting.html#cb81-12" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Prior-Posterior Update for Bias Parameter&quot;</span>,</span>
<span id="cb81-13"><a href="from-simulation-to-model-fitting.html#cb81-13" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">&quot;Blue: posterior, Red: prior, Dashed: true value&quot;</span>) <span class="sc">+</span></span>
<span id="cb81-14"><a href="from-simulation-to-model-fitting.html#cb81-14" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Bias&quot;</span>) <span class="sc">+</span></span>
<span id="cb81-15"><a href="from-simulation-to-model-fitting.html#cb81-15" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Posterior Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb81-16"><a href="from-simulation-to-model-fitting.html#cb81-16" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="series_files/figure-html/04%20memory%20model%20log-odds%20quality%20assessment-3.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="from-simulation-to-model-fitting.html#cb82-1" tabindex="-1"></a><span class="co"># Now let&#39;s plot the density for beta (prior and posterior)</span></span>
<span id="cb82-2"><a href="from-simulation-to-model-fitting.html#cb82-2" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df_memory) <span class="sc">+</span></span>
<span id="cb82-3"><a href="from-simulation-to-model-fitting.html#cb82-3" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(beta), <span class="at">fill =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb82-4"><a href="from-simulation-to-model-fitting.html#cb82-4" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(beta_prior), <span class="at">fill =</span> <span class="st">&quot;red&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb82-5"><a href="from-simulation-to-model-fitting.html#cb82-5" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb82-6"><a href="from-simulation-to-model-fitting.html#cb82-6" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Prior-Posterior Update for Beta Parameter&quot;</span>,</span>
<span id="cb82-7"><a href="from-simulation-to-model-fitting.html#cb82-7" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">&quot;Blue: posterior, Red: prior, Dashed: true value&quot;</span>) <span class="sc">+</span></span>
<span id="cb82-8"><a href="from-simulation-to-model-fitting.html#cb82-8" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Beta&quot;</span>) <span class="sc">+</span></span>
<span id="cb82-9"><a href="from-simulation-to-model-fitting.html#cb82-9" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Posterior Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb82-10"><a href="from-simulation-to-model-fitting.html#cb82-10" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="series_files/figure-html/04%20memory%20model%20log-odds%20quality%20assessment-4.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="from-simulation-to-model-fitting.html#cb83-1" tabindex="-1"></a><span class="co"># Print summary</span></span>
<span id="cb83-2"><a href="from-simulation-to-model-fitting.html#cb83-2" tabindex="-1"></a>samples_memory<span class="sc">$</span><span class="fu">summary</span>()</span></code></pre></div>
<pre><code>## # A tibble: 3 × 10
##   variable     mean   median    sd   mad      q5     q95  rhat ess_bulk ess_tail
##   &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
## 1 lp__     -62.8    -62.5    0.900 0.639 -64.5   -61.9    1.01     646.    1034.
## 2 bias       0.0587   0.0597 0.234 0.231  -0.325   0.456  1.00     658.     728.
## 3 beta       0.869    0.869  0.215 0.217   0.506   1.22   1.00     678.     875.</code></pre>
<p>We can see that the model has now estimated both the bias and the role of previous memory. Bias should reflect the bias in the setup (0.5 which in log odds is 0), and the beta coefficient for memory (roughly 1). More on the quality checks of the models in the next chapter.</p>
</div>
<div id="memory-model-2-internal-state-variable" class="section level3 hasAnchor" number="5.6.3">
<h3><span class="header-section-number">5.6.3</span> Memory Model 2: Internal State Variable<a href="from-simulation-to-model-fitting.html#memory-model-2-internal-state-variable" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Instead of feeding memory as external data, we can model it as an internal state that updates within the model using Stan’s <code>transformed parameters</code> block. This approach is more flexible for implementing specific learning or forgetting rules. Here, we model memory as the running average of the opponent’s choices.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="from-simulation-to-model-fitting.html#cb85-1" tabindex="-1"></a><span class="do">## Create the data</span></span>
<span id="cb85-2"><a href="from-simulation-to-model-fitting.html#cb85-2" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb85-3"><a href="from-simulation-to-model-fitting.html#cb85-3" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">120</span>,</span>
<span id="cb85-4"><a href="from-simulation-to-model-fitting.html#cb85-4" tabindex="-1"></a>  <span class="at">h =</span> d1<span class="sc">$</span>Self,</span>
<span id="cb85-5"><a href="from-simulation-to-model-fitting.html#cb85-5" tabindex="-1"></a>  <span class="at">other =</span> d1<span class="sc">$</span>Other</span>
<span id="cb85-6"><a href="from-simulation-to-model-fitting.html#cb85-6" tabindex="-1"></a>)</span>
<span id="cb85-7"><a href="from-simulation-to-model-fitting.html#cb85-7" tabindex="-1"></a></span>
<span id="cb85-8"><a href="from-simulation-to-model-fitting.html#cb85-8" tabindex="-1"></a>stan_model <span class="ot">&lt;-</span> <span class="st">&quot;</span></span>
<span id="cb85-9"><a href="from-simulation-to-model-fitting.html#cb85-9" tabindex="-1"></a><span class="st">// Memory-based choice model with prior and posterior predictions</span></span>
<span id="cb85-10"><a href="from-simulation-to-model-fitting.html#cb85-10" tabindex="-1"></a></span>
<span id="cb85-11"><a href="from-simulation-to-model-fitting.html#cb85-11" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb85-12"><a href="from-simulation-to-model-fitting.html#cb85-12" tabindex="-1"></a><span class="st"> int&lt;lower=1&gt; n;</span></span>
<span id="cb85-13"><a href="from-simulation-to-model-fitting.html#cb85-13" tabindex="-1"></a><span class="st"> array[n] int h;</span></span>
<span id="cb85-14"><a href="from-simulation-to-model-fitting.html#cb85-14" tabindex="-1"></a><span class="st"> array[n] int other;</span></span>
<span id="cb85-15"><a href="from-simulation-to-model-fitting.html#cb85-15" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb85-16"><a href="from-simulation-to-model-fitting.html#cb85-16" tabindex="-1"></a></span>
<span id="cb85-17"><a href="from-simulation-to-model-fitting.html#cb85-17" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb85-18"><a href="from-simulation-to-model-fitting.html#cb85-18" tabindex="-1"></a><span class="st">  real bias;</span></span>
<span id="cb85-19"><a href="from-simulation-to-model-fitting.html#cb85-19" tabindex="-1"></a><span class="st">  real beta;</span></span>
<span id="cb85-20"><a href="from-simulation-to-model-fitting.html#cb85-20" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb85-21"><a href="from-simulation-to-model-fitting.html#cb85-21" tabindex="-1"></a></span>
<span id="cb85-22"><a href="from-simulation-to-model-fitting.html#cb85-22" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb85-23"><a href="from-simulation-to-model-fitting.html#cb85-23" tabindex="-1"></a><span class="st">  vector[n] memory;</span></span>
<span id="cb85-24"><a href="from-simulation-to-model-fitting.html#cb85-24" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb85-25"><a href="from-simulation-to-model-fitting.html#cb85-25" tabindex="-1"></a><span class="st">  for (trial in 1:n) {</span></span>
<span id="cb85-26"><a href="from-simulation-to-model-fitting.html#cb85-26" tabindex="-1"></a><span class="st">    if (trial == 1) {</span></span>
<span id="cb85-27"><a href="from-simulation-to-model-fitting.html#cb85-27" tabindex="-1"></a><span class="st">      memory[trial] = 0.5;</span></span>
<span id="cb85-28"><a href="from-simulation-to-model-fitting.html#cb85-28" tabindex="-1"></a><span class="st">    } </span></span>
<span id="cb85-29"><a href="from-simulation-to-model-fitting.html#cb85-29" tabindex="-1"></a><span class="st">    if (trial &lt; n) {</span></span>
<span id="cb85-30"><a href="from-simulation-to-model-fitting.html#cb85-30" tabindex="-1"></a><span class="st">      memory[trial + 1] = memory[trial] + ((other[trial] - memory[trial]) / (trial + 1));</span></span>
<span id="cb85-31"><a href="from-simulation-to-model-fitting.html#cb85-31" tabindex="-1"></a><span class="st">      if (memory[trial + 1] == 0) { memory[trial + 1] = 0.01; }</span></span>
<span id="cb85-32"><a href="from-simulation-to-model-fitting.html#cb85-32" tabindex="-1"></a><span class="st">      if (memory[trial + 1] == 1) { memory[trial + 1] = 0.99; }</span></span>
<span id="cb85-33"><a href="from-simulation-to-model-fitting.html#cb85-33" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb85-34"><a href="from-simulation-to-model-fitting.html#cb85-34" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb85-35"><a href="from-simulation-to-model-fitting.html#cb85-35" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb85-36"><a href="from-simulation-to-model-fitting.html#cb85-36" tabindex="-1"></a></span>
<span id="cb85-37"><a href="from-simulation-to-model-fitting.html#cb85-37" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb85-38"><a href="from-simulation-to-model-fitting.html#cb85-38" tabindex="-1"></a><span class="st">  // Priors</span></span>
<span id="cb85-39"><a href="from-simulation-to-model-fitting.html#cb85-39" tabindex="-1"></a><span class="st">  target += normal_lpdf(bias | 0, .3);</span></span>
<span id="cb85-40"><a href="from-simulation-to-model-fitting.html#cb85-40" tabindex="-1"></a><span class="st">  target += normal_lpdf(beta | 0, .5);</span></span>
<span id="cb85-41"><a href="from-simulation-to-model-fitting.html#cb85-41" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb85-42"><a href="from-simulation-to-model-fitting.html#cb85-42" tabindex="-1"></a><span class="st">  // Likelihood</span></span>
<span id="cb85-43"><a href="from-simulation-to-model-fitting.html#cb85-43" tabindex="-1"></a><span class="st">  for (trial in 1:n) {</span></span>
<span id="cb85-44"><a href="from-simulation-to-model-fitting.html#cb85-44" tabindex="-1"></a><span class="st">    target += bernoulli_logit_lpmf(h[trial] | bias + beta * logit(memory[trial]));</span></span>
<span id="cb85-45"><a href="from-simulation-to-model-fitting.html#cb85-45" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb85-46"><a href="from-simulation-to-model-fitting.html#cb85-46" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb85-47"><a href="from-simulation-to-model-fitting.html#cb85-47" tabindex="-1"></a></span>
<span id="cb85-48"><a href="from-simulation-to-model-fitting.html#cb85-48" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb85-49"><a href="from-simulation-to-model-fitting.html#cb85-49" tabindex="-1"></a><span class="st">  // Generate prior samples</span></span>
<span id="cb85-50"><a href="from-simulation-to-model-fitting.html#cb85-50" tabindex="-1"></a><span class="st">  real bias_prior = normal_rng(0, .3);</span></span>
<span id="cb85-51"><a href="from-simulation-to-model-fitting.html#cb85-51" tabindex="-1"></a><span class="st">  real beta_prior = normal_rng(0, .5);</span></span>
<span id="cb85-52"><a href="from-simulation-to-model-fitting.html#cb85-52" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb85-53"><a href="from-simulation-to-model-fitting.html#cb85-53" tabindex="-1"></a><span class="st">  // Variables for predictions</span></span>
<span id="cb85-54"><a href="from-simulation-to-model-fitting.html#cb85-54" tabindex="-1"></a><span class="st">  array[n] int prior_preds;</span></span>
<span id="cb85-55"><a href="from-simulation-to-model-fitting.html#cb85-55" tabindex="-1"></a><span class="st">  array[n] int posterior_preds;</span></span>
<span id="cb85-56"><a href="from-simulation-to-model-fitting.html#cb85-56" tabindex="-1"></a><span class="st">  vector[n] memory_prior;</span></span>
<span id="cb85-57"><a href="from-simulation-to-model-fitting.html#cb85-57" tabindex="-1"></a><span class="st">  vector[n] log_lik;</span></span>
<span id="cb85-58"><a href="from-simulation-to-model-fitting.html#cb85-58" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb85-59"><a href="from-simulation-to-model-fitting.html#cb85-59" tabindex="-1"></a><span class="st">  // Generate predictions at different memory levels</span></span>
<span id="cb85-60"><a href="from-simulation-to-model-fitting.html#cb85-60" tabindex="-1"></a><span class="st">  array[3] real memory_levels = {0.2, 0.5, 0.8}; // Low, neutral, and high memory</span></span>
<span id="cb85-61"><a href="from-simulation-to-model-fitting.html#cb85-61" tabindex="-1"></a><span class="st">  array[3] int prior_preds_memory;</span></span>
<span id="cb85-62"><a href="from-simulation-to-model-fitting.html#cb85-62" tabindex="-1"></a><span class="st">  array[3] int posterior_preds_memory;</span></span>
<span id="cb85-63"><a href="from-simulation-to-model-fitting.html#cb85-63" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb85-64"><a href="from-simulation-to-model-fitting.html#cb85-64" tabindex="-1"></a><span class="st">  // Generate predictions from prior for each memory level</span></span>
<span id="cb85-65"><a href="from-simulation-to-model-fitting.html#cb85-65" tabindex="-1"></a><span class="st">  for (i in 1:3) {</span></span>
<span id="cb85-66"><a href="from-simulation-to-model-fitting.html#cb85-66" tabindex="-1"></a><span class="st">    real logit_memory = logit(memory_levels[i]);</span></span>
<span id="cb85-67"><a href="from-simulation-to-model-fitting.html#cb85-67" tabindex="-1"></a><span class="st">    prior_preds_memory[i] = bernoulli_logit_rng(bias_prior + beta_prior * logit_memory);</span></span>
<span id="cb85-68"><a href="from-simulation-to-model-fitting.html#cb85-68" tabindex="-1"></a><span class="st">    posterior_preds_memory[i] = bernoulli_logit_rng(bias + beta * logit_memory);</span></span>
<span id="cb85-69"><a href="from-simulation-to-model-fitting.html#cb85-69" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb85-70"><a href="from-simulation-to-model-fitting.html#cb85-70" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb85-71"><a href="from-simulation-to-model-fitting.html#cb85-71" tabindex="-1"></a><span class="st">  // Generate predictions from prior</span></span>
<span id="cb85-72"><a href="from-simulation-to-model-fitting.html#cb85-72" tabindex="-1"></a><span class="st">  memory_prior[1] = 0.5;</span></span>
<span id="cb85-73"><a href="from-simulation-to-model-fitting.html#cb85-73" tabindex="-1"></a><span class="st">  for (trial in 1:n) {</span></span>
<span id="cb85-74"><a href="from-simulation-to-model-fitting.html#cb85-74" tabindex="-1"></a><span class="st">    if (trial == 1) {</span></span>
<span id="cb85-75"><a href="from-simulation-to-model-fitting.html#cb85-75" tabindex="-1"></a><span class="st">      prior_preds[trial] = bernoulli_logit_rng(bias_prior + beta_prior * logit(memory_prior[trial]));</span></span>
<span id="cb85-76"><a href="from-simulation-to-model-fitting.html#cb85-76" tabindex="-1"></a><span class="st">    } else {</span></span>
<span id="cb85-77"><a href="from-simulation-to-model-fitting.html#cb85-77" tabindex="-1"></a><span class="st">      memory_prior[trial] = memory_prior[trial-1] + ((other[trial-1] - memory_prior[trial-1]) / trial);</span></span>
<span id="cb85-78"><a href="from-simulation-to-model-fitting.html#cb85-78" tabindex="-1"></a><span class="st">      if (memory_prior[trial] == 0) { memory_prior[trial] = 0.01; }</span></span>
<span id="cb85-79"><a href="from-simulation-to-model-fitting.html#cb85-79" tabindex="-1"></a><span class="st">      if (memory_prior[trial] == 1) { memory_prior[trial] = 0.99; }</span></span>
<span id="cb85-80"><a href="from-simulation-to-model-fitting.html#cb85-80" tabindex="-1"></a><span class="st">      prior_preds[trial] = bernoulli_logit_rng(bias_prior + beta_prior * logit(memory_prior[trial]));</span></span>
<span id="cb85-81"><a href="from-simulation-to-model-fitting.html#cb85-81" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb85-82"><a href="from-simulation-to-model-fitting.html#cb85-82" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb85-83"><a href="from-simulation-to-model-fitting.html#cb85-83" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb85-84"><a href="from-simulation-to-model-fitting.html#cb85-84" tabindex="-1"></a><span class="st">  // Generate predictions from posterior</span></span>
<span id="cb85-85"><a href="from-simulation-to-model-fitting.html#cb85-85" tabindex="-1"></a><span class="st">  for (trial in 1:n) {</span></span>
<span id="cb85-86"><a href="from-simulation-to-model-fitting.html#cb85-86" tabindex="-1"></a><span class="st">    posterior_preds[trial] = bernoulli_logit_rng(bias + beta * logit(memory[trial]));</span></span>
<span id="cb85-87"><a href="from-simulation-to-model-fitting.html#cb85-87" tabindex="-1"></a><span class="st">    log_lik[trial] = bernoulli_logit_lpmf(h[trial] | bias + beta * logit(memory[trial]));</span></span>
<span id="cb85-88"><a href="from-simulation-to-model-fitting.html#cb85-88" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb85-89"><a href="from-simulation-to-model-fitting.html#cb85-89" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb85-90"><a href="from-simulation-to-model-fitting.html#cb85-90" tabindex="-1"></a><span class="st">&quot;</span></span>
<span id="cb85-91"><a href="from-simulation-to-model-fitting.html#cb85-91" tabindex="-1"></a></span>
<span id="cb85-92"><a href="from-simulation-to-model-fitting.html#cb85-92" tabindex="-1"></a><span class="fu">write_stan_file</span>(</span>
<span id="cb85-93"><a href="from-simulation-to-model-fitting.html#cb85-93" tabindex="-1"></a>  stan_model,</span>
<span id="cb85-94"><a href="from-simulation-to-model-fitting.html#cb85-94" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">&quot;stan/&quot;</span>,</span>
<span id="cb85-95"><a href="from-simulation-to-model-fitting.html#cb85-95" tabindex="-1"></a>  <span class="at">basename =</span> <span class="st">&quot;04_InternalMemory.stan&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;/Users/au209589/Dropbox/Teaching/AdvancedCognitiveModeling23_book/stan/04_InternalMemory.stan&quot;</code></pre>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="from-simulation-to-model-fitting.html#cb87-1" tabindex="-1"></a><span class="do">## Specify where the model is</span></span>
<span id="cb87-2"><a href="from-simulation-to-model-fitting.html#cb87-2" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;stan&quot;</span>, <span class="st">&quot;04_InternalMemory.stan&quot;</span>)</span>
<span id="cb87-3"><a href="from-simulation-to-model-fitting.html#cb87-3" tabindex="-1"></a></span>
<span id="cb87-4"><a href="from-simulation-to-model-fitting.html#cb87-4" tabindex="-1"></a><span class="co"># File path for saved model</span></span>
<span id="cb87-5"><a href="from-simulation-to-model-fitting.html#cb87-5" tabindex="-1"></a>model_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;simmodels&quot;</span>, <span class="st">&quot;04_InternalMemory.rds&quot;</span>)</span>
<span id="cb87-6"><a href="from-simulation-to-model-fitting.html#cb87-6" tabindex="-1"></a></span>
<span id="cb87-7"><a href="from-simulation-to-model-fitting.html#cb87-7" tabindex="-1"></a><span class="co"># Check if we need to rerun the simulation</span></span>
<span id="cb87-8"><a href="from-simulation-to-model-fitting.html#cb87-8" tabindex="-1"></a><span class="cf">if</span> (regenerate_simulations <span class="sc">||</span> <span class="sc">!</span><span class="fu">file.exists</span>(model_file)) {</span>
<span id="cb87-9"><a href="from-simulation-to-model-fitting.html#cb87-9" tabindex="-1"></a>  <span class="co"># Compile the model</span></span>
<span id="cb87-10"><a href="from-simulation-to-model-fitting.html#cb87-10" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(file, </span>
<span id="cb87-11"><a href="from-simulation-to-model-fitting.html#cb87-11" tabindex="-1"></a>                       <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">FALSE</span>),</span>
<span id="cb87-12"><a href="from-simulation-to-model-fitting.html#cb87-12" tabindex="-1"></a>                       <span class="at">stanc_options =</span> <span class="fu">list</span>(<span class="st">&quot;O1&quot;</span>))</span>
<span id="cb87-13"><a href="from-simulation-to-model-fitting.html#cb87-13" tabindex="-1"></a>  </span>
<span id="cb87-14"><a href="from-simulation-to-model-fitting.html#cb87-14" tabindex="-1"></a>  <span class="co"># The following command calls Stan with specific options.</span></span>
<span id="cb87-15"><a href="from-simulation-to-model-fitting.html#cb87-15" tabindex="-1"></a>  samples_memory_internal <span class="ot">&lt;-</span> mod<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb87-16"><a href="from-simulation-to-model-fitting.html#cb87-16" tabindex="-1"></a>    <span class="at">data =</span> data,</span>
<span id="cb87-17"><a href="from-simulation-to-model-fitting.html#cb87-17" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb87-18"><a href="from-simulation-to-model-fitting.html#cb87-18" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">1</span>,</span>
<span id="cb87-19"><a href="from-simulation-to-model-fitting.html#cb87-19" tabindex="-1"></a>    <span class="at">parallel_chains =</span> <span class="dv">2</span>,</span>
<span id="cb87-20"><a href="from-simulation-to-model-fitting.html#cb87-20" tabindex="-1"></a>    <span class="at">threads_per_chain =</span> <span class="dv">1</span>,</span>
<span id="cb87-21"><a href="from-simulation-to-model-fitting.html#cb87-21" tabindex="-1"></a>    <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb87-22"><a href="from-simulation-to-model-fitting.html#cb87-22" tabindex="-1"></a>    <span class="at">iter_sampling =</span> <span class="dv">1000</span>,</span>
<span id="cb87-23"><a href="from-simulation-to-model-fitting.html#cb87-23" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">0</span>,</span>
<span id="cb87-24"><a href="from-simulation-to-model-fitting.html#cb87-24" tabindex="-1"></a>    <span class="at">max_treedepth =</span> <span class="dv">20</span>,</span>
<span id="cb87-25"><a href="from-simulation-to-model-fitting.html#cb87-25" tabindex="-1"></a>    <span class="at">adapt_delta =</span> <span class="fl">0.99</span>,</span>
<span id="cb87-26"><a href="from-simulation-to-model-fitting.html#cb87-26" tabindex="-1"></a>  )</span>
<span id="cb87-27"><a href="from-simulation-to-model-fitting.html#cb87-27" tabindex="-1"></a>  </span>
<span id="cb87-28"><a href="from-simulation-to-model-fitting.html#cb87-28" tabindex="-1"></a>  <span class="co"># Save the fitted model</span></span>
<span id="cb87-29"><a href="from-simulation-to-model-fitting.html#cb87-29" tabindex="-1"></a>  samples_memory_internal<span class="sc">$</span><span class="fu">save_object</span>(<span class="at">file =</span> model_file)</span>
<span id="cb87-30"><a href="from-simulation-to-model-fitting.html#cb87-30" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Generated new model fit and saved to&quot;</span>, model_file, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb87-31"><a href="from-simulation-to-model-fitting.html#cb87-31" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb87-32"><a href="from-simulation-to-model-fitting.html#cb87-32" tabindex="-1"></a>  <span class="co"># Load existing results</span></span>
<span id="cb87-33"><a href="from-simulation-to-model-fitting.html#cb87-33" tabindex="-1"></a>  samples_memory_internal <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(model_file)</span>
<span id="cb87-34"><a href="from-simulation-to-model-fitting.html#cb87-34" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Loaded existing model fit from&quot;</span>, model_file, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb87-35"><a href="from-simulation-to-model-fitting.html#cb87-35" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Loaded existing model fit from /Users/au209589/Dropbox/Teaching/AdvancedCognitiveModeling23_book/simmodels/04_InternalMemory.rds</code></pre>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="from-simulation-to-model-fitting.html#cb89-1" tabindex="-1"></a>draws_df <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(samples_memory_internal<span class="sc">$</span><span class="fu">draws</span>())</span>
<span id="cb89-2"><a href="from-simulation-to-model-fitting.html#cb89-2" tabindex="-1"></a></span>
<span id="cb89-3"><a href="from-simulation-to-model-fitting.html#cb89-3" tabindex="-1"></a><span class="co"># 1. Check chain convergence</span></span>
<span id="cb89-4"><a href="from-simulation-to-model-fitting.html#cb89-4" tabindex="-1"></a><span class="co"># Plot traces for main parameters</span></span>
<span id="cb89-5"><a href="from-simulation-to-model-fitting.html#cb89-5" tabindex="-1"></a><span class="fu">mcmc_trace</span>(draws_df, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;bias&quot;</span>, <span class="st">&quot;beta&quot;</span>)) <span class="sc">+</span></span>
<span id="cb89-6"><a href="from-simulation-to-model-fitting.html#cb89-6" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb89-7"><a href="from-simulation-to-model-fitting.html#cb89-7" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Parameter Traces Across Chains&quot;</span>)</span></code></pre></div>
<p><img src="series_files/figure-html/04%20internal%20memory%20stan%20model-1.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="from-simulation-to-model-fitting.html#cb90-1" tabindex="-1"></a><span class="co"># Plot rank histograms to check mixing</span></span>
<span id="cb90-2"><a href="from-simulation-to-model-fitting.html#cb90-2" tabindex="-1"></a><span class="fu">mcmc_rank_hist</span>(draws_df, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;bias&quot;</span>, <span class="st">&quot;beta&quot;</span>))</span></code></pre></div>
<p><img src="series_files/figure-html/04%20internal%20memory%20stan%20model-2.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="from-simulation-to-model-fitting.html#cb91-1" tabindex="-1"></a><span class="co"># 2. Prior-Posterior Update Check</span></span>
<span id="cb91-2"><a href="from-simulation-to-model-fitting.html#cb91-2" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb91-3"><a href="from-simulation-to-model-fitting.html#cb91-3" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> draws_df, <span class="fu">aes</span>(bias, <span class="at">fill =</span> <span class="st">&quot;Posterior&quot;</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb91-4"><a href="from-simulation-to-model-fitting.html#cb91-4" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> draws_df, <span class="fu">aes</span>(bias_prior, <span class="at">fill =</span> <span class="st">&quot;Prior&quot;</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb91-5"><a href="from-simulation-to-model-fitting.html#cb91-5" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb91-6"><a href="from-simulation-to-model-fitting.html#cb91-6" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Prior&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>, <span class="st">&quot;Posterior&quot;</span> <span class="ot">=</span> <span class="st">&quot;blue&quot;</span>)) <span class="sc">+</span></span>
<span id="cb91-7"><a href="from-simulation-to-model-fitting.html#cb91-7" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb91-8"><a href="from-simulation-to-model-fitting.html#cb91-8" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Prior-Posterior Update: Bias Parameter&quot;</span>)</span>
<span id="cb91-9"><a href="from-simulation-to-model-fitting.html#cb91-9" tabindex="-1"></a></span>
<span id="cb91-10"><a href="from-simulation-to-model-fitting.html#cb91-10" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb91-11"><a href="from-simulation-to-model-fitting.html#cb91-11" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> draws_df, <span class="fu">aes</span>(beta, <span class="at">fill =</span> <span class="st">&quot;Posterior&quot;</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb91-12"><a href="from-simulation-to-model-fitting.html#cb91-12" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> draws_df, <span class="fu">aes</span>(beta_prior, <span class="at">fill =</span> <span class="st">&quot;Prior&quot;</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb91-13"><a href="from-simulation-to-model-fitting.html#cb91-13" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb91-14"><a href="from-simulation-to-model-fitting.html#cb91-14" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Prior&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>, <span class="st">&quot;Posterior&quot;</span> <span class="ot">=</span> <span class="st">&quot;blue&quot;</span>)) <span class="sc">+</span></span>
<span id="cb91-15"><a href="from-simulation-to-model-fitting.html#cb91-15" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb91-16"><a href="from-simulation-to-model-fitting.html#cb91-16" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Prior-Posterior Update: Beta Parameter&quot;</span>)</span>
<span id="cb91-17"><a href="from-simulation-to-model-fitting.html#cb91-17" tabindex="-1"></a></span>
<span id="cb91-18"><a href="from-simulation-to-model-fitting.html#cb91-18" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb91-19"><a href="from-simulation-to-model-fitting.html#cb91-19" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> draws_df, <span class="fu">aes</span>(bias, beta), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb91-20"><a href="from-simulation-to-model-fitting.html#cb91-20" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb91-21"><a href="from-simulation-to-model-fitting.html#cb91-21" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Correlation&quot;</span>)</span>
<span id="cb91-22"><a href="from-simulation-to-model-fitting.html#cb91-22" tabindex="-1"></a></span>
<span id="cb91-23"><a href="from-simulation-to-model-fitting.html#cb91-23" tabindex="-1"></a>p1 <span class="sc">+</span> p2 <span class="sc">+</span> p3</span></code></pre></div>
<p><img src="series_files/figure-html/04%20internal%20memory%20stan%20model-3.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="from-simulation-to-model-fitting.html#cb92-1" tabindex="-1"></a><span class="co"># First let&#39;s properly extract and organize our posterior predictions</span></span>
<span id="cb92-2"><a href="from-simulation-to-model-fitting.html#cb92-2" tabindex="-1"></a>posterior_predictions <span class="ot">&lt;-</span> draws_df <span class="sc">%&gt;%</span></span>
<span id="cb92-3"><a href="from-simulation-to-model-fitting.html#cb92-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;posterior_preds[&quot;</span>)) <span class="sc">%&gt;%</span> <span class="co"># Select all posterior prediction columns</span></span>
<span id="cb92-4"><a href="from-simulation-to-model-fitting.html#cb92-4" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), </span>
<span id="cb92-5"><a href="from-simulation-to-model-fitting.html#cb92-5" tabindex="-1"></a>              <span class="at">names_to =</span> <span class="st">&quot;trial&quot;</span>,</span>
<span id="cb92-6"><a href="from-simulation-to-model-fitting.html#cb92-6" tabindex="-1"></a>              <span class="at">values_to =</span> <span class="st">&quot;prediction&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb92-7"><a href="from-simulation-to-model-fitting.html#cb92-7" tabindex="-1"></a>  <span class="co"># Clean up the trial number from the Stan array notation</span></span>
<span id="cb92-8"><a href="from-simulation-to-model-fitting.html#cb92-8" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trial =</span> <span class="fu">as.numeric</span>(<span class="fu">str_extract</span>(trial, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">d+&quot;</span>)))</span>
<span id="cb92-9"><a href="from-simulation-to-model-fitting.html#cb92-9" tabindex="-1"></a></span>
<span id="cb92-10"><a href="from-simulation-to-model-fitting.html#cb92-10" tabindex="-1"></a><span class="co"># Calculate summary statistics for posterior predictions</span></span>
<span id="cb92-11"><a href="from-simulation-to-model-fitting.html#cb92-11" tabindex="-1"></a>posterior_summary <span class="ot">&lt;-</span> posterior_predictions <span class="sc">%&gt;%</span></span>
<span id="cb92-12"><a href="from-simulation-to-model-fitting.html#cb92-12" tabindex="-1"></a>  <span class="fu">group_by</span>(trial) <span class="sc">%&gt;%</span></span>
<span id="cb92-13"><a href="from-simulation-to-model-fitting.html#cb92-13" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb92-14"><a href="from-simulation-to-model-fitting.html#cb92-14" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(prediction),</span>
<span id="cb92-15"><a href="from-simulation-to-model-fitting.html#cb92-15" tabindex="-1"></a>    <span class="at">lower =</span> <span class="fu">quantile</span>(prediction, <span class="fl">0.025</span>),</span>
<span id="cb92-16"><a href="from-simulation-to-model-fitting.html#cb92-16" tabindex="-1"></a>    <span class="at">upper =</span> <span class="fu">quantile</span>(prediction, <span class="fl">0.975</span>)</span>
<span id="cb92-17"><a href="from-simulation-to-model-fitting.html#cb92-17" tabindex="-1"></a>  )</span>
<span id="cb92-18"><a href="from-simulation-to-model-fitting.html#cb92-18" tabindex="-1"></a></span>
<span id="cb92-19"><a href="from-simulation-to-model-fitting.html#cb92-19" tabindex="-1"></a><span class="co"># Do the same for prior predictions</span></span>
<span id="cb92-20"><a href="from-simulation-to-model-fitting.html#cb92-20" tabindex="-1"></a>prior_predictions <span class="ot">&lt;-</span> draws_df <span class="sc">%&gt;%</span></span>
<span id="cb92-21"><a href="from-simulation-to-model-fitting.html#cb92-21" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;prior_preds[&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb92-22"><a href="from-simulation-to-model-fitting.html#cb92-22" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), </span>
<span id="cb92-23"><a href="from-simulation-to-model-fitting.html#cb92-23" tabindex="-1"></a>              <span class="at">names_to =</span> <span class="st">&quot;trial&quot;</span>,</span>
<span id="cb92-24"><a href="from-simulation-to-model-fitting.html#cb92-24" tabindex="-1"></a>              <span class="at">values_to =</span> <span class="st">&quot;prediction&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb92-25"><a href="from-simulation-to-model-fitting.html#cb92-25" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trial =</span> <span class="fu">as.numeric</span>(<span class="fu">str_extract</span>(trial, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">d+&quot;</span>)))</span>
<span id="cb92-26"><a href="from-simulation-to-model-fitting.html#cb92-26" tabindex="-1"></a></span>
<span id="cb92-27"><a href="from-simulation-to-model-fitting.html#cb92-27" tabindex="-1"></a>prior_summary <span class="ot">&lt;-</span> prior_predictions <span class="sc">%&gt;%</span></span>
<span id="cb92-28"><a href="from-simulation-to-model-fitting.html#cb92-28" tabindex="-1"></a>  <span class="fu">group_by</span>(trial) <span class="sc">%&gt;%</span></span>
<span id="cb92-29"><a href="from-simulation-to-model-fitting.html#cb92-29" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb92-30"><a href="from-simulation-to-model-fitting.html#cb92-30" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(prediction),</span>
<span id="cb92-31"><a href="from-simulation-to-model-fitting.html#cb92-31" tabindex="-1"></a>    <span class="at">lower =</span> <span class="fu">quantile</span>(prediction, <span class="fl">0.025</span>),</span>
<span id="cb92-32"><a href="from-simulation-to-model-fitting.html#cb92-32" tabindex="-1"></a>    <span class="at">upper =</span> <span class="fu">quantile</span>(prediction, <span class="fl">0.975</span>)</span>
<span id="cb92-33"><a href="from-simulation-to-model-fitting.html#cb92-33" tabindex="-1"></a>  )</span>
<span id="cb92-34"><a href="from-simulation-to-model-fitting.html#cb92-34" tabindex="-1"></a></span>
<span id="cb92-35"><a href="from-simulation-to-model-fitting.html#cb92-35" tabindex="-1"></a><span class="co"># Now let&#39;s create our visualization</span></span>
<span id="cb92-36"><a href="from-simulation-to-model-fitting.html#cb92-36" tabindex="-1"></a><span class="co"># First the prior predictive check</span></span>
<span id="cb92-37"><a href="from-simulation-to-model-fitting.html#cb92-37" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb92-38"><a href="from-simulation-to-model-fitting.html#cb92-38" tabindex="-1"></a>  <span class="co"># Add prior prediction interval</span></span>
<span id="cb92-39"><a href="from-simulation-to-model-fitting.html#cb92-39" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> prior_summary,</span>
<span id="cb92-40"><a href="from-simulation-to-model-fitting.html#cb92-40" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> trial, <span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper),</span>
<span id="cb92-41"><a href="from-simulation-to-model-fitting.html#cb92-41" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">fill =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb92-42"><a href="from-simulation-to-model-fitting.html#cb92-42" tabindex="-1"></a>  <span class="co"># Add mean prior prediction</span></span>
<span id="cb92-43"><a href="from-simulation-to-model-fitting.html#cb92-43" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> prior_summary,</span>
<span id="cb92-44"><a href="from-simulation-to-model-fitting.html#cb92-44" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> trial, <span class="at">y =</span> mean),</span>
<span id="cb92-45"><a href="from-simulation-to-model-fitting.html#cb92-45" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb92-46"><a href="from-simulation-to-model-fitting.html#cb92-46" tabindex="-1"></a>  <span class="co"># Add actual data points</span></span>
<span id="cb92-47"><a href="from-simulation-to-model-fitting.html#cb92-47" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">trial =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(data<span class="sc">$</span>h), </span>
<span id="cb92-48"><a href="from-simulation-to-model-fitting.html#cb92-48" tabindex="-1"></a>                          <span class="at">choice =</span> data<span class="sc">$</span>h),</span>
<span id="cb92-49"><a href="from-simulation-to-model-fitting.html#cb92-49" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> trial, <span class="at">y =</span> choice),</span>
<span id="cb92-50"><a href="from-simulation-to-model-fitting.html#cb92-50" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb92-51"><a href="from-simulation-to-model-fitting.html#cb92-51" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Prior Predictive Check&quot;</span>,</span>
<span id="cb92-52"><a href="from-simulation-to-model-fitting.html#cb92-52" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Trial&quot;</span>,</span>
<span id="cb92-53"><a href="from-simulation-to-model-fitting.html#cb92-53" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Choice (0/1)&quot;</span>) <span class="sc">+</span></span>
<span id="cb92-54"><a href="from-simulation-to-model-fitting.html#cb92-54" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb92-55"><a href="from-simulation-to-model-fitting.html#cb92-55" tabindex="-1"></a></span>
<span id="cb92-56"><a href="from-simulation-to-model-fitting.html#cb92-56" tabindex="-1"></a><span class="co"># Then the posterior predictive check</span></span>
<span id="cb92-57"><a href="from-simulation-to-model-fitting.html#cb92-57" tabindex="-1"></a>p5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb92-58"><a href="from-simulation-to-model-fitting.html#cb92-58" tabindex="-1"></a>  <span class="co"># Add posterior prediction interval</span></span>
<span id="cb92-59"><a href="from-simulation-to-model-fitting.html#cb92-59" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> posterior_summary,</span>
<span id="cb92-60"><a href="from-simulation-to-model-fitting.html#cb92-60" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> trial, <span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper),</span>
<span id="cb92-61"><a href="from-simulation-to-model-fitting.html#cb92-61" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">fill =</span> <span class="st">&quot;blue&quot;</span>) <span class="sc">+</span></span>
<span id="cb92-62"><a href="from-simulation-to-model-fitting.html#cb92-62" tabindex="-1"></a>  <span class="co"># Add mean posterior prediction</span></span>
<span id="cb92-63"><a href="from-simulation-to-model-fitting.html#cb92-63" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> posterior_summary,</span>
<span id="cb92-64"><a href="from-simulation-to-model-fitting.html#cb92-64" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> trial, <span class="at">y =</span> mean),</span>
<span id="cb92-65"><a href="from-simulation-to-model-fitting.html#cb92-65" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>) <span class="sc">+</span></span>
<span id="cb92-66"><a href="from-simulation-to-model-fitting.html#cb92-66" tabindex="-1"></a>  <span class="co"># Add actual data points</span></span>
<span id="cb92-67"><a href="from-simulation-to-model-fitting.html#cb92-67" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">trial =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(data<span class="sc">$</span>h), </span>
<span id="cb92-68"><a href="from-simulation-to-model-fitting.html#cb92-68" tabindex="-1"></a>                          <span class="at">choice =</span> data<span class="sc">$</span>h),</span>
<span id="cb92-69"><a href="from-simulation-to-model-fitting.html#cb92-69" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> trial, <span class="at">y =</span> choice),</span>
<span id="cb92-70"><a href="from-simulation-to-model-fitting.html#cb92-70" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb92-71"><a href="from-simulation-to-model-fitting.html#cb92-71" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Posterior Predictive Check&quot;</span>,</span>
<span id="cb92-72"><a href="from-simulation-to-model-fitting.html#cb92-72" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Trial&quot;</span>,</span>
<span id="cb92-73"><a href="from-simulation-to-model-fitting.html#cb92-73" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Choice (0/1)&quot;</span>) <span class="sc">+</span></span>
<span id="cb92-74"><a href="from-simulation-to-model-fitting.html#cb92-74" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb92-75"><a href="from-simulation-to-model-fitting.html#cb92-75" tabindex="-1"></a></span>
<span id="cb92-76"><a href="from-simulation-to-model-fitting.html#cb92-76" tabindex="-1"></a><span class="co"># Display plots side by side</span></span>
<span id="cb92-77"><a href="from-simulation-to-model-fitting.html#cb92-77" tabindex="-1"></a>p4 <span class="sc">+</span> p5</span></code></pre></div>
<p><img src="series_files/figure-html/04%20internal%20memory%20stan%20model-4.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="from-simulation-to-model-fitting.html#cb93-1" tabindex="-1"></a><span class="co"># First, let&#39;s calculate the total number of 1s predicted in each posterior sample</span></span>
<span id="cb93-2"><a href="from-simulation-to-model-fitting.html#cb93-2" tabindex="-1"></a>posterior_totals <span class="ot">&lt;-</span> draws_df <span class="sc">%&gt;%</span></span>
<span id="cb93-3"><a href="from-simulation-to-model-fitting.html#cb93-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;posterior_preds[&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb93-4"><a href="from-simulation-to-model-fitting.html#cb93-4" tabindex="-1"></a>  <span class="co"># Sum across rows to get total 1s per sample</span></span>
<span id="cb93-5"><a href="from-simulation-to-model-fitting.html#cb93-5" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_ones =</span> <span class="fu">rowSums</span>(.)) </span>
<span id="cb93-6"><a href="from-simulation-to-model-fitting.html#cb93-6" tabindex="-1"></a></span>
<span id="cb93-7"><a href="from-simulation-to-model-fitting.html#cb93-7" tabindex="-1"></a><span class="co"># Do the same for prior predictions</span></span>
<span id="cb93-8"><a href="from-simulation-to-model-fitting.html#cb93-8" tabindex="-1"></a>prior_totals <span class="ot">&lt;-</span> draws_df <span class="sc">%&gt;%</span></span>
<span id="cb93-9"><a href="from-simulation-to-model-fitting.html#cb93-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;prior_preds[&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb93-10"><a href="from-simulation-to-model-fitting.html#cb93-10" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_ones =</span> <span class="fu">rowSums</span>(.))</span>
<span id="cb93-11"><a href="from-simulation-to-model-fitting.html#cb93-11" tabindex="-1"></a></span>
<span id="cb93-12"><a href="from-simulation-to-model-fitting.html#cb93-12" tabindex="-1"></a><span class="co"># Calculate actual number of 1s in the data</span></span>
<span id="cb93-13"><a href="from-simulation-to-model-fitting.html#cb93-13" tabindex="-1"></a>actual_ones <span class="ot">&lt;-</span> <span class="fu">sum</span>(data<span class="sc">$</span>h)</span>
<span id="cb93-14"><a href="from-simulation-to-model-fitting.html#cb93-14" tabindex="-1"></a></span>
<span id="cb93-15"><a href="from-simulation-to-model-fitting.html#cb93-15" tabindex="-1"></a><span class="co"># Create visualization comparing distributions</span></span>
<span id="cb93-16"><a href="from-simulation-to-model-fitting.html#cb93-16" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb93-17"><a href="from-simulation-to-model-fitting.html#cb93-17" tabindex="-1"></a>  <span class="co"># Prior predictive distribution</span></span>
<span id="cb93-18"><a href="from-simulation-to-model-fitting.html#cb93-18" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> prior_totals, </span>
<span id="cb93-19"><a href="from-simulation-to-model-fitting.html#cb93-19" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> total_ones, <span class="at">fill =</span> <span class="st">&quot;Prior&quot;</span>), </span>
<span id="cb93-20"><a href="from-simulation-to-model-fitting.html#cb93-20" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb93-21"><a href="from-simulation-to-model-fitting.html#cb93-21" tabindex="-1"></a>  <span class="co"># Posterior predictive distribution</span></span>
<span id="cb93-22"><a href="from-simulation-to-model-fitting.html#cb93-22" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> posterior_totals, </span>
<span id="cb93-23"><a href="from-simulation-to-model-fitting.html#cb93-23" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> total_ones, <span class="at">fill =</span> <span class="st">&quot;Posterior&quot;</span>), </span>
<span id="cb93-24"><a href="from-simulation-to-model-fitting.html#cb93-24" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb93-25"><a href="from-simulation-to-model-fitting.html#cb93-25" tabindex="-1"></a>  <span class="co"># Vertical line for actual data</span></span>
<span id="cb93-26"><a href="from-simulation-to-model-fitting.html#cb93-26" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> actual_ones, </span>
<span id="cb93-27"><a href="from-simulation-to-model-fitting.html#cb93-27" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, </span>
<span id="cb93-28"><a href="from-simulation-to-model-fitting.html#cb93-28" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb93-29"><a href="from-simulation-to-model-fitting.html#cb93-29" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb93-30"><a href="from-simulation-to-model-fitting.html#cb93-30" tabindex="-1"></a>  <span class="co"># Aesthetics</span></span>
<span id="cb93-31"><a href="from-simulation-to-model-fitting.html#cb93-31" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Prior&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>, <span class="st">&quot;Posterior&quot;</span> <span class="ot">=</span> <span class="st">&quot;blue&quot;</span>),</span>
<span id="cb93-32"><a href="from-simulation-to-model-fitting.html#cb93-32" tabindex="-1"></a>                   <span class="at">name =</span> <span class="st">&quot;Distribution&quot;</span>) <span class="sc">+</span></span>
<span id="cb93-33"><a href="from-simulation-to-model-fitting.html#cb93-33" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Distribution of Predicted Successes (1s) out of 120 Trials&quot;</span>,</span>
<span id="cb93-34"><a href="from-simulation-to-model-fitting.html#cb93-34" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">&quot;Comparing Prior, Posterior and Actual Data&quot;</span>,</span>
<span id="cb93-35"><a href="from-simulation-to-model-fitting.html#cb93-35" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Number of 1s&quot;</span>,</span>
<span id="cb93-36"><a href="from-simulation-to-model-fitting.html#cb93-36" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb93-37"><a href="from-simulation-to-model-fitting.html#cb93-37" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb93-38"><a href="from-simulation-to-model-fitting.html#cb93-38" tabindex="-1"></a>  <span class="co"># Add annotation for actual value</span></span>
<span id="cb93-39"><a href="from-simulation-to-model-fitting.html#cb93-39" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">&quot;text&quot;</span>, </span>
<span id="cb93-40"><a href="from-simulation-to-model-fitting.html#cb93-40" tabindex="-1"></a>           <span class="at">x =</span> actual_ones, </span>
<span id="cb93-41"><a href="from-simulation-to-model-fitting.html#cb93-41" tabindex="-1"></a>           <span class="at">y =</span> <span class="dv">0</span>, </span>
<span id="cb93-42"><a href="from-simulation-to-model-fitting.html#cb93-42" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">&quot;Actual:&quot;</span>, actual_ones),</span>
<span id="cb93-43"><a href="from-simulation-to-model-fitting.html#cb93-43" tabindex="-1"></a>           <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>)</span></code></pre></div>
<p><img src="series_files/figure-html/04%20internal%20memory%20stan%20model-5.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="from-simulation-to-model-fitting.html#cb94-1" tabindex="-1"></a><span class="co"># Let&#39;s also print summary statistics</span></span>
<span id="cb94-2"><a href="from-simulation-to-model-fitting.html#cb94-2" tabindex="-1"></a>prior_summary <span class="ot">&lt;-</span> prior_totals <span class="sc">%&gt;%</span></span>
<span id="cb94-3"><a href="from-simulation-to-model-fitting.html#cb94-3" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb94-4"><a href="from-simulation-to-model-fitting.html#cb94-4" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(total_ones),</span>
<span id="cb94-5"><a href="from-simulation-to-model-fitting.html#cb94-5" tabindex="-1"></a>    <span class="at">sd =</span> <span class="fu">sd</span>(total_ones),</span>
<span id="cb94-6"><a href="from-simulation-to-model-fitting.html#cb94-6" tabindex="-1"></a>    <span class="at">q025 =</span> <span class="fu">quantile</span>(total_ones, <span class="fl">0.025</span>),</span>
<span id="cb94-7"><a href="from-simulation-to-model-fitting.html#cb94-7" tabindex="-1"></a>    <span class="at">q975 =</span> <span class="fu">quantile</span>(total_ones, <span class="fl">0.975</span>)</span>
<span id="cb94-8"><a href="from-simulation-to-model-fitting.html#cb94-8" tabindex="-1"></a>  )</span>
<span id="cb94-9"><a href="from-simulation-to-model-fitting.html#cb94-9" tabindex="-1"></a></span>
<span id="cb94-10"><a href="from-simulation-to-model-fitting.html#cb94-10" tabindex="-1"></a>posterior_summary <span class="ot">&lt;-</span> posterior_totals <span class="sc">%&gt;%</span></span>
<span id="cb94-11"><a href="from-simulation-to-model-fitting.html#cb94-11" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb94-12"><a href="from-simulation-to-model-fitting.html#cb94-12" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(total_ones),</span>
<span id="cb94-13"><a href="from-simulation-to-model-fitting.html#cb94-13" tabindex="-1"></a>    <span class="at">sd =</span> <span class="fu">sd</span>(total_ones),</span>
<span id="cb94-14"><a href="from-simulation-to-model-fitting.html#cb94-14" tabindex="-1"></a>    <span class="at">q025 =</span> <span class="fu">quantile</span>(total_ones, <span class="fl">0.025</span>),</span>
<span id="cb94-15"><a href="from-simulation-to-model-fitting.html#cb94-15" tabindex="-1"></a>    <span class="at">q975 =</span> <span class="fu">quantile</span>(total_ones, <span class="fl">0.975</span>)</span>
<span id="cb94-16"><a href="from-simulation-to-model-fitting.html#cb94-16" tabindex="-1"></a>  )</span>
<span id="cb94-17"><a href="from-simulation-to-model-fitting.html#cb94-17" tabindex="-1"></a></span>
<span id="cb94-18"><a href="from-simulation-to-model-fitting.html#cb94-18" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&quot;Prior predictive summary:&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;Prior predictive summary:&quot;</code></pre>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="from-simulation-to-model-fitting.html#cb96-1" tabindex="-1"></a><span class="fu">print</span>(prior_summary)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 4
##    mean    sd  q025  q975
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  59.1  19.2    22    96</code></pre>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="from-simulation-to-model-fitting.html#cb98-1" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&quot;Posterior predictive summary:&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;Posterior predictive summary:&quot;</code></pre>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="from-simulation-to-model-fitting.html#cb100-1" tabindex="-1"></a><span class="fu">print</span>(posterior_summary)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 4
##    mean    sd  q025  q975
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  91.3  6.19    79   103</code></pre>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="from-simulation-to-model-fitting.html#cb102-1" tabindex="-1"></a><span class="co"># First let&#39;s calculate predicted probabilities for each draw and memory level</span></span>
<span id="cb102-2"><a href="from-simulation-to-model-fitting.html#cb102-2" tabindex="-1"></a>predicted_probs <span class="ot">&lt;-</span> draws_df <span class="sc">%&gt;%</span></span>
<span id="cb102-3"><a href="from-simulation-to-model-fitting.html#cb102-3" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb102-4"><a href="from-simulation-to-model-fitting.html#cb102-4" tabindex="-1"></a>    <span class="co"># Calculate probability of choosing right for each memory level</span></span>
<span id="cb102-5"><a href="from-simulation-to-model-fitting.html#cb102-5" tabindex="-1"></a>    <span class="co"># using the logistic function on our parameter estimates</span></span>
<span id="cb102-6"><a href="from-simulation-to-model-fitting.html#cb102-6" tabindex="-1"></a>    <span class="at">prob_low =</span> <span class="fu">inv_logit_scaled</span>(bias <span class="sc">+</span> beta <span class="sc">*</span> <span class="fu">logit_scaled</span>(<span class="fl">0.2</span>)),</span>
<span id="cb102-7"><a href="from-simulation-to-model-fitting.html#cb102-7" tabindex="-1"></a>    <span class="at">prob_mid =</span> <span class="fu">inv_logit_scaled</span>(bias <span class="sc">+</span> beta <span class="sc">*</span> <span class="fu">logit_scaled</span>(<span class="fl">0.5</span>)),</span>
<span id="cb102-8"><a href="from-simulation-to-model-fitting.html#cb102-8" tabindex="-1"></a>    <span class="at">prob_high =</span> <span class="fu">inv_logit_scaled</span>(bias <span class="sc">+</span> beta <span class="sc">*</span> <span class="fu">logit_scaled</span>(<span class="fl">0.8</span>))</span>
<span id="cb102-9"><a href="from-simulation-to-model-fitting.html#cb102-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb102-10"><a href="from-simulation-to-model-fitting.html#cb102-10" tabindex="-1"></a>  <span class="co"># Reshape to long format for easier plotting</span></span>
<span id="cb102-11"><a href="from-simulation-to-model-fitting.html#cb102-11" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb102-12"><a href="from-simulation-to-model-fitting.html#cb102-12" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">&quot;prob_&quot;</span>),</span>
<span id="cb102-13"><a href="from-simulation-to-model-fitting.html#cb102-13" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">&quot;memory_level&quot;</span>,</span>
<span id="cb102-14"><a href="from-simulation-to-model-fitting.html#cb102-14" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">&quot;probability&quot;</span></span>
<span id="cb102-15"><a href="from-simulation-to-model-fitting.html#cb102-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb102-16"><a href="from-simulation-to-model-fitting.html#cb102-16" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb102-17"><a href="from-simulation-to-model-fitting.html#cb102-17" tabindex="-1"></a>    <span class="at">memory_value =</span> <span class="fu">case_when</span>(</span>
<span id="cb102-18"><a href="from-simulation-to-model-fitting.html#cb102-18" tabindex="-1"></a>      memory_level <span class="sc">==</span> <span class="st">&quot;prob_low&quot;</span> <span class="sc">~</span> <span class="fl">0.2</span>,</span>
<span id="cb102-19"><a href="from-simulation-to-model-fitting.html#cb102-19" tabindex="-1"></a>      memory_level <span class="sc">==</span> <span class="st">&quot;prob_mid&quot;</span> <span class="sc">~</span> <span class="fl">0.5</span>,</span>
<span id="cb102-20"><a href="from-simulation-to-model-fitting.html#cb102-20" tabindex="-1"></a>      memory_level <span class="sc">==</span> <span class="st">&quot;prob_high&quot;</span> <span class="sc">~</span> <span class="fl">0.8</span></span>
<span id="cb102-21"><a href="from-simulation-to-model-fitting.html#cb102-21" tabindex="-1"></a>    )</span>
<span id="cb102-22"><a href="from-simulation-to-model-fitting.html#cb102-22" tabindex="-1"></a>  )</span>
<span id="cb102-23"><a href="from-simulation-to-model-fitting.html#cb102-23" tabindex="-1"></a></span>
<span id="cb102-24"><a href="from-simulation-to-model-fitting.html#cb102-24" tabindex="-1"></a><span class="co"># Do the same for prior predictions</span></span>
<span id="cb102-25"><a href="from-simulation-to-model-fitting.html#cb102-25" tabindex="-1"></a>prior_probs <span class="ot">&lt;-</span> draws_df <span class="sc">%&gt;%</span></span>
<span id="cb102-26"><a href="from-simulation-to-model-fitting.html#cb102-26" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb102-27"><a href="from-simulation-to-model-fitting.html#cb102-27" tabindex="-1"></a>    <span class="at">prob_low =</span> <span class="fu">inv_logit_scaled</span>(bias_prior <span class="sc">+</span> beta_prior <span class="sc">*</span> <span class="fu">logit_scaled</span>(<span class="fl">0.2</span>)),</span>
<span id="cb102-28"><a href="from-simulation-to-model-fitting.html#cb102-28" tabindex="-1"></a>    <span class="at">prob_mid =</span> <span class="fu">inv_logit_scaled</span>(bias_prior <span class="sc">+</span> beta_prior <span class="sc">*</span> <span class="fu">logit_scaled</span>(<span class="fl">0.5</span>)),</span>
<span id="cb102-29"><a href="from-simulation-to-model-fitting.html#cb102-29" tabindex="-1"></a>    <span class="at">prob_high =</span> <span class="fu">inv_logit_scaled</span>(bias_prior <span class="sc">+</span> beta_prior <span class="sc">*</span> <span class="fu">logit_scaled</span>(<span class="fl">0.8</span>))</span>
<span id="cb102-30"><a href="from-simulation-to-model-fitting.html#cb102-30" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb102-31"><a href="from-simulation-to-model-fitting.html#cb102-31" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb102-32"><a href="from-simulation-to-model-fitting.html#cb102-32" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">&quot;prob_&quot;</span>),</span>
<span id="cb102-33"><a href="from-simulation-to-model-fitting.html#cb102-33" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">&quot;memory_level&quot;</span>,</span>
<span id="cb102-34"><a href="from-simulation-to-model-fitting.html#cb102-34" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">&quot;probability&quot;</span></span>
<span id="cb102-35"><a href="from-simulation-to-model-fitting.html#cb102-35" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb102-36"><a href="from-simulation-to-model-fitting.html#cb102-36" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb102-37"><a href="from-simulation-to-model-fitting.html#cb102-37" tabindex="-1"></a>    <span class="at">memory_value =</span> <span class="fu">case_when</span>(</span>
<span id="cb102-38"><a href="from-simulation-to-model-fitting.html#cb102-38" tabindex="-1"></a>      memory_level <span class="sc">==</span> <span class="st">&quot;prob_low&quot;</span> <span class="sc">~</span> <span class="fl">0.2</span>,</span>
<span id="cb102-39"><a href="from-simulation-to-model-fitting.html#cb102-39" tabindex="-1"></a>      memory_level <span class="sc">==</span> <span class="st">&quot;prob_mid&quot;</span> <span class="sc">~</span> <span class="fl">0.5</span>,</span>
<span id="cb102-40"><a href="from-simulation-to-model-fitting.html#cb102-40" tabindex="-1"></a>      memory_level <span class="sc">==</span> <span class="st">&quot;prob_high&quot;</span> <span class="sc">~</span> <span class="fl">0.8</span></span>
<span id="cb102-41"><a href="from-simulation-to-model-fitting.html#cb102-41" tabindex="-1"></a>    )</span>
<span id="cb102-42"><a href="from-simulation-to-model-fitting.html#cb102-42" tabindex="-1"></a>  )</span>
<span id="cb102-43"><a href="from-simulation-to-model-fitting.html#cb102-43" tabindex="-1"></a></span>
<span id="cb102-44"><a href="from-simulation-to-model-fitting.html#cb102-44" tabindex="-1"></a><span class="co"># Create visualization with density plots</span></span>
<span id="cb102-45"><a href="from-simulation-to-model-fitting.html#cb102-45" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb102-46"><a href="from-simulation-to-model-fitting.html#cb102-46" tabindex="-1"></a>  <span class="co"># Add prior distributions</span></span>
<span id="cb102-47"><a href="from-simulation-to-model-fitting.html#cb102-47" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> prior_probs,</span>
<span id="cb102-48"><a href="from-simulation-to-model-fitting.html#cb102-48" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> probability, <span class="at">fill =</span> <span class="st">&quot;Prior&quot;</span>),</span>
<span id="cb102-49"><a href="from-simulation-to-model-fitting.html#cb102-49" tabindex="-1"></a>               <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb102-50"><a href="from-simulation-to-model-fitting.html#cb102-50" tabindex="-1"></a>  <span class="co"># Add posterior distributions</span></span>
<span id="cb102-51"><a href="from-simulation-to-model-fitting.html#cb102-51" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> predicted_probs,</span>
<span id="cb102-52"><a href="from-simulation-to-model-fitting.html#cb102-52" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> probability, <span class="at">fill =</span> <span class="st">&quot;Posterior&quot;</span>),</span>
<span id="cb102-53"><a href="from-simulation-to-model-fitting.html#cb102-53" tabindex="-1"></a>               <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb102-54"><a href="from-simulation-to-model-fitting.html#cb102-54" tabindex="-1"></a>  <span class="co"># Separate by memory level</span></span>
<span id="cb102-55"><a href="from-simulation-to-model-fitting.html#cb102-55" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>memory_value, </span>
<span id="cb102-56"><a href="from-simulation-to-model-fitting.html#cb102-56" tabindex="-1"></a>             <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">memory_value =</span> <span class="fu">c</span>(</span>
<span id="cb102-57"><a href="from-simulation-to-model-fitting.html#cb102-57" tabindex="-1"></a>               <span class="st">&quot;0.2&quot;</span> <span class="ot">=</span> <span class="st">&quot;Low Memory (20% Right)&quot;</span>,</span>
<span id="cb102-58"><a href="from-simulation-to-model-fitting.html#cb102-58" tabindex="-1"></a>               <span class="st">&quot;0.5&quot;</span> <span class="ot">=</span> <span class="st">&quot;Neutral Memory (50% Right)&quot;</span>,</span>
<span id="cb102-59"><a href="from-simulation-to-model-fitting.html#cb102-59" tabindex="-1"></a>               <span class="st">&quot;0.8&quot;</span> <span class="ot">=</span> <span class="st">&quot;High Memory (80% Right)&quot;</span></span>
<span id="cb102-60"><a href="from-simulation-to-model-fitting.html#cb102-60" tabindex="-1"></a>             ))) <span class="sc">+</span></span>
<span id="cb102-61"><a href="from-simulation-to-model-fitting.html#cb102-61" tabindex="-1"></a>  <span class="co"># Aesthetics</span></span>
<span id="cb102-62"><a href="from-simulation-to-model-fitting.html#cb102-62" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Prior&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>, <span class="st">&quot;Posterior&quot;</span> <span class="ot">=</span> <span class="st">&quot;blue&quot;</span>),</span>
<span id="cb102-63"><a href="from-simulation-to-model-fitting.html#cb102-63" tabindex="-1"></a>                   <span class="at">name =</span> <span class="st">&quot;Distribution&quot;</span>) <span class="sc">+</span></span>
<span id="cb102-64"><a href="from-simulation-to-model-fitting.html#cb102-64" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Distribution of Predicted Probabilities at Different Memory Levels&quot;</span>,</span>
<span id="cb102-65"><a href="from-simulation-to-model-fitting.html#cb102-65" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Probability of Choosing Right&quot;</span>,</span>
<span id="cb102-66"><a href="from-simulation-to-model-fitting.html#cb102-66" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb102-67"><a href="from-simulation-to-model-fitting.html#cb102-67" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb102-68"><a href="from-simulation-to-model-fitting.html#cb102-68" tabindex="-1"></a></span>
<span id="cb102-69"><a href="from-simulation-to-model-fitting.html#cb102-69" tabindex="-1"></a><span class="co"># Alternative visualization using violin plots</span></span>
<span id="cb102-70"><a href="from-simulation-to-model-fitting.html#cb102-70" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb102-71"><a href="from-simulation-to-model-fitting.html#cb102-71" tabindex="-1"></a>  <span class="co"># Add prior distributions</span></span>
<span id="cb102-72"><a href="from-simulation-to-model-fitting.html#cb102-72" tabindex="-1"></a>  <span class="fu">geom_violin</span>(<span class="at">data =</span> prior_probs,</span>
<span id="cb102-73"><a href="from-simulation-to-model-fitting.html#cb102-73" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(memory_value), <span class="at">y =</span> probability, <span class="at">fill =</span> <span class="st">&quot;Prior&quot;</span>),</span>
<span id="cb102-74"><a href="from-simulation-to-model-fitting.html#cb102-74" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb102-75"><a href="from-simulation-to-model-fitting.html#cb102-75" tabindex="-1"></a>  <span class="co"># Add posterior distributions</span></span>
<span id="cb102-76"><a href="from-simulation-to-model-fitting.html#cb102-76" tabindex="-1"></a>  <span class="fu">geom_violin</span>(<span class="at">data =</span> predicted_probs,</span>
<span id="cb102-77"><a href="from-simulation-to-model-fitting.html#cb102-77" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(memory_value), <span class="at">y =</span> probability, <span class="at">fill =</span> <span class="st">&quot;Posterior&quot;</span>),</span>
<span id="cb102-78"><a href="from-simulation-to-model-fitting.html#cb102-78" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb102-79"><a href="from-simulation-to-model-fitting.html#cb102-79" tabindex="-1"></a>  <span class="co"># Aesthetics</span></span>
<span id="cb102-80"><a href="from-simulation-to-model-fitting.html#cb102-80" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Prior&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>, <span class="st">&quot;Posterior&quot;</span> <span class="ot">=</span> <span class="st">&quot;blue&quot;</span>),</span>
<span id="cb102-81"><a href="from-simulation-to-model-fitting.html#cb102-81" tabindex="-1"></a>                   <span class="at">name =</span> <span class="st">&quot;Distribution&quot;</span>) <span class="sc">+</span></span>
<span id="cb102-82"><a href="from-simulation-to-model-fitting.html#cb102-82" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Low</span><span class="sc">\n</span><span class="st">(20% Right)&quot;</span>, <span class="st">&quot;Neutral</span><span class="sc">\n</span><span class="st">(50% Right)&quot;</span>, <span class="st">&quot;High</span><span class="sc">\n</span><span class="st">(80% Right)&quot;</span>)) <span class="sc">+</span></span>
<span id="cb102-83"><a href="from-simulation-to-model-fitting.html#cb102-83" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Distribution of Predicted Probabilities by Memory Level&quot;</span>,</span>
<span id="cb102-84"><a href="from-simulation-to-model-fitting.html#cb102-84" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Memory Level&quot;</span>,</span>
<span id="cb102-85"><a href="from-simulation-to-model-fitting.html#cb102-85" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Probability of Choosing Right&quot;</span>) <span class="sc">+</span></span>
<span id="cb102-86"><a href="from-simulation-to-model-fitting.html#cb102-86" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb102-87"><a href="from-simulation-to-model-fitting.html#cb102-87" tabindex="-1"></a></span>
<span id="cb102-88"><a href="from-simulation-to-model-fitting.html#cb102-88" tabindex="-1"></a><span class="co"># Display both visualizations</span></span>
<span id="cb102-89"><a href="from-simulation-to-model-fitting.html#cb102-89" tabindex="-1"></a>p1 <span class="sc">/</span> p2</span></code></pre></div>
<p><img src="series_files/figure-html/04%20internal%20memory%20stan%20model-6.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="from-simulation-to-model-fitting.html#cb103-1" tabindex="-1"></a><span class="co"># 4. Check for divergences</span></span>
<span id="cb103-2"><a href="from-simulation-to-model-fitting.html#cb103-2" tabindex="-1"></a><span class="co"># Extract divergent transitions</span></span>
<span id="cb103-3"><a href="from-simulation-to-model-fitting.html#cb103-3" tabindex="-1"></a>n_div <span class="ot">&lt;-</span> <span class="fu">sum</span>(draws_df<span class="sc">$</span>.divergent)</span>
<span id="cb103-4"><a href="from-simulation-to-model-fitting.html#cb103-4" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&quot;Number of divergent transitions:&quot;</span>, n_div))</span></code></pre></div>
<pre><code>## [1] &quot;Number of divergent transitions: 0&quot;</code></pre>
<p>Now that we know how to model memory as an internal state, we can play with making the update discount the past, setting a parameter that indicates after how many trials memory is lost, etc.</p>
</div>
<div id="memory-model-3-exponential-forgetting-relation-to-rl" class="section level3 hasAnchor" number="5.6.4">
<h3><span class="header-section-number">5.6.4</span> Memory Model 3: Exponential Forgetting (Relation to RL)<a href="from-simulation-to-model-fitting.html#memory-model-3-exponential-forgetting-relation-to-rl" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A more cognitively plausible memory model incorporates forgetting, where recent events have more influence than distant ones. This can be implemented by adding a <code>forgetting</code> parameter (often called a learning rate, α, in RL) that controls the weight of the most recent outcome versus the previous memory state.</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="from-simulation-to-model-fitting.html#cb105-1" tabindex="-1"></a>stan_model <span class="ot">&lt;-</span> <span class="st">&quot;</span></span>
<span id="cb105-2"><a href="from-simulation-to-model-fitting.html#cb105-2" tabindex="-1"></a><span class="st">// The input (data) for the model. n of trials and h for (right and left) hand</span></span>
<span id="cb105-3"><a href="from-simulation-to-model-fitting.html#cb105-3" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb105-4"><a href="from-simulation-to-model-fitting.html#cb105-4" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb105-5"><a href="from-simulation-to-model-fitting.html#cb105-5" tabindex="-1"></a><span class="st">  array[n] int h;</span></span>
<span id="cb105-6"><a href="from-simulation-to-model-fitting.html#cb105-6" tabindex="-1"></a><span class="st">  array[n] int other;</span></span>
<span id="cb105-7"><a href="from-simulation-to-model-fitting.html#cb105-7" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb105-8"><a href="from-simulation-to-model-fitting.html#cb105-8" tabindex="-1"></a></span>
<span id="cb105-9"><a href="from-simulation-to-model-fitting.html#cb105-9" tabindex="-1"></a><span class="st">// The parameters accepted by the model. </span></span>
<span id="cb105-10"><a href="from-simulation-to-model-fitting.html#cb105-10" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb105-11"><a href="from-simulation-to-model-fitting.html#cb105-11" tabindex="-1"></a><span class="st">  real bias; // how likely is the agent to pick right when the previous rate has no information (50-50)?</span></span>
<span id="cb105-12"><a href="from-simulation-to-model-fitting.html#cb105-12" tabindex="-1"></a><span class="st">  real beta; // how strongly is previous rate impacting the decision?</span></span>
<span id="cb105-13"><a href="from-simulation-to-model-fitting.html#cb105-13" tabindex="-1"></a><span class="st">  real&lt;lower=0, upper=1&gt; forgetting;</span></span>
<span id="cb105-14"><a href="from-simulation-to-model-fitting.html#cb105-14" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb105-15"><a href="from-simulation-to-model-fitting.html#cb105-15" tabindex="-1"></a></span>
<span id="cb105-16"><a href="from-simulation-to-model-fitting.html#cb105-16" tabindex="-1"></a><span class="st">// The model to be estimated. </span></span>
<span id="cb105-17"><a href="from-simulation-to-model-fitting.html#cb105-17" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb105-18"><a href="from-simulation-to-model-fitting.html#cb105-18" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb105-19"><a href="from-simulation-to-model-fitting.html#cb105-19" tabindex="-1"></a><span class="st">  vector[n] memory;</span></span>
<span id="cb105-20"><a href="from-simulation-to-model-fitting.html#cb105-20" tabindex="-1"></a><span class="st">  // Priors</span></span>
<span id="cb105-21"><a href="from-simulation-to-model-fitting.html#cb105-21" tabindex="-1"></a><span class="st">  target += beta_lpdf(forgetting | 1, 1);</span></span>
<span id="cb105-22"><a href="from-simulation-to-model-fitting.html#cb105-22" tabindex="-1"></a><span class="st">  target += normal_lpdf(bias | 0, .3);</span></span>
<span id="cb105-23"><a href="from-simulation-to-model-fitting.html#cb105-23" tabindex="-1"></a><span class="st">  target += normal_lpdf(beta | 0, .5);</span></span>
<span id="cb105-24"><a href="from-simulation-to-model-fitting.html#cb105-24" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb105-25"><a href="from-simulation-to-model-fitting.html#cb105-25" tabindex="-1"></a><span class="st">  // Model, looping to keep track of memory</span></span>
<span id="cb105-26"><a href="from-simulation-to-model-fitting.html#cb105-26" tabindex="-1"></a><span class="st">  for (trial in 1:n) {</span></span>
<span id="cb105-27"><a href="from-simulation-to-model-fitting.html#cb105-27" tabindex="-1"></a><span class="st">    if (trial == 1) {</span></span>
<span id="cb105-28"><a href="from-simulation-to-model-fitting.html#cb105-28" tabindex="-1"></a><span class="st">      memory[trial] = 0.5;</span></span>
<span id="cb105-29"><a href="from-simulation-to-model-fitting.html#cb105-29" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb105-30"><a href="from-simulation-to-model-fitting.html#cb105-30" tabindex="-1"></a><span class="st">    target += bernoulli_logit_lpmf(h[trial] | bias + beta * logit(memory[trial]));</span></span>
<span id="cb105-31"><a href="from-simulation-to-model-fitting.html#cb105-31" tabindex="-1"></a><span class="st">    if (trial &lt; n){</span></span>
<span id="cb105-32"><a href="from-simulation-to-model-fitting.html#cb105-32" tabindex="-1"></a><span class="st">      memory[trial + 1] = (1 - forgetting) * memory[trial] + forgetting * other[trial];</span></span>
<span id="cb105-33"><a href="from-simulation-to-model-fitting.html#cb105-33" tabindex="-1"></a><span class="st">      if (memory[trial + 1] == 0){memory[trial + 1] = 0.01;}</span></span>
<span id="cb105-34"><a href="from-simulation-to-model-fitting.html#cb105-34" tabindex="-1"></a><span class="st">      if (memory[trial + 1] == 1){memory[trial + 1] = 0.99;}</span></span>
<span id="cb105-35"><a href="from-simulation-to-model-fitting.html#cb105-35" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb105-36"><a href="from-simulation-to-model-fitting.html#cb105-36" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb105-37"><a href="from-simulation-to-model-fitting.html#cb105-37" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb105-38"><a href="from-simulation-to-model-fitting.html#cb105-38" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb105-39"><a href="from-simulation-to-model-fitting.html#cb105-39" tabindex="-1"></a><span class="st">&quot;</span></span>
<span id="cb105-40"><a href="from-simulation-to-model-fitting.html#cb105-40" tabindex="-1"></a><span class="fu">write_stan_file</span>(</span>
<span id="cb105-41"><a href="from-simulation-to-model-fitting.html#cb105-41" tabindex="-1"></a>  stan_model,</span>
<span id="cb105-42"><a href="from-simulation-to-model-fitting.html#cb105-42" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">&quot;stan/&quot;</span>,</span>
<span id="cb105-43"><a href="from-simulation-to-model-fitting.html#cb105-43" tabindex="-1"></a>  <span class="at">basename =</span> <span class="st">&quot;04_InternalMemory2.stan&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;/Users/au209589/Dropbox/Teaching/AdvancedCognitiveModeling23_book/stan/04_InternalMemory2.stan&quot;</code></pre>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="from-simulation-to-model-fitting.html#cb107-1" tabindex="-1"></a><span class="do">## Specify where the model is</span></span>
<span id="cb107-2"><a href="from-simulation-to-model-fitting.html#cb107-2" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;stan&quot;</span>,<span class="st">&quot;04_InternalMemory2.stan&quot;</span>)</span>
<span id="cb107-3"><a href="from-simulation-to-model-fitting.html#cb107-3" tabindex="-1"></a></span>
<span id="cb107-4"><a href="from-simulation-to-model-fitting.html#cb107-4" tabindex="-1"></a><span class="co"># File path for saved model</span></span>
<span id="cb107-5"><a href="from-simulation-to-model-fitting.html#cb107-5" tabindex="-1"></a>model_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;simmodels&quot;</span>,<span class="st">&quot;04_InternalMemory2.rds&quot;</span>)</span>
<span id="cb107-6"><a href="from-simulation-to-model-fitting.html#cb107-6" tabindex="-1"></a></span>
<span id="cb107-7"><a href="from-simulation-to-model-fitting.html#cb107-7" tabindex="-1"></a><span class="co"># Check if we need to rerun the simulation</span></span>
<span id="cb107-8"><a href="from-simulation-to-model-fitting.html#cb107-8" tabindex="-1"></a><span class="cf">if</span> (regenerate_simulations <span class="sc">||</span> <span class="sc">!</span><span class="fu">file.exists</span>(model_file)) {</span>
<span id="cb107-9"><a href="from-simulation-to-model-fitting.html#cb107-9" tabindex="-1"></a>  <span class="co"># Compile the model</span></span>
<span id="cb107-10"><a href="from-simulation-to-model-fitting.html#cb107-10" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(file, </span>
<span id="cb107-11"><a href="from-simulation-to-model-fitting.html#cb107-11" tabindex="-1"></a>                       <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">FALSE</span>),</span>
<span id="cb107-12"><a href="from-simulation-to-model-fitting.html#cb107-12" tabindex="-1"></a>                       <span class="at">stanc_options =</span> <span class="fu">list</span>(<span class="st">&quot;O1&quot;</span>))</span>
<span id="cb107-13"><a href="from-simulation-to-model-fitting.html#cb107-13" tabindex="-1"></a>  </span>
<span id="cb107-14"><a href="from-simulation-to-model-fitting.html#cb107-14" tabindex="-1"></a>  <span class="co"># The following command calls Stan with specific options.</span></span>
<span id="cb107-15"><a href="from-simulation-to-model-fitting.html#cb107-15" tabindex="-1"></a>  samples_memory_forgetting <span class="ot">&lt;-</span> mod<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb107-16"><a href="from-simulation-to-model-fitting.html#cb107-16" tabindex="-1"></a>    <span class="at">data =</span> data,</span>
<span id="cb107-17"><a href="from-simulation-to-model-fitting.html#cb107-17" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb107-18"><a href="from-simulation-to-model-fitting.html#cb107-18" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">1</span>,</span>
<span id="cb107-19"><a href="from-simulation-to-model-fitting.html#cb107-19" tabindex="-1"></a>    <span class="at">parallel_chains =</span> <span class="dv">2</span>,</span>
<span id="cb107-20"><a href="from-simulation-to-model-fitting.html#cb107-20" tabindex="-1"></a>    <span class="at">threads_per_chain =</span> <span class="dv">1</span>,</span>
<span id="cb107-21"><a href="from-simulation-to-model-fitting.html#cb107-21" tabindex="-1"></a>    <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb107-22"><a href="from-simulation-to-model-fitting.html#cb107-22" tabindex="-1"></a>    <span class="at">iter_sampling =</span> <span class="dv">1000</span>,</span>
<span id="cb107-23"><a href="from-simulation-to-model-fitting.html#cb107-23" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">0</span>,</span>
<span id="cb107-24"><a href="from-simulation-to-model-fitting.html#cb107-24" tabindex="-1"></a>    <span class="at">max_treedepth =</span> <span class="dv">20</span>,</span>
<span id="cb107-25"><a href="from-simulation-to-model-fitting.html#cb107-25" tabindex="-1"></a>    <span class="at">adapt_delta =</span> <span class="fl">0.99</span>,</span>
<span id="cb107-26"><a href="from-simulation-to-model-fitting.html#cb107-26" tabindex="-1"></a>  )</span>
<span id="cb107-27"><a href="from-simulation-to-model-fitting.html#cb107-27" tabindex="-1"></a>  </span>
<span id="cb107-28"><a href="from-simulation-to-model-fitting.html#cb107-28" tabindex="-1"></a>  <span class="co"># Save the fitted model</span></span>
<span id="cb107-29"><a href="from-simulation-to-model-fitting.html#cb107-29" tabindex="-1"></a>  samples_memory_forgetting<span class="sc">$</span><span class="fu">save_object</span>(<span class="at">file =</span> model_file)</span>
<span id="cb107-30"><a href="from-simulation-to-model-fitting.html#cb107-30" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Generated new model fit and saved to&quot;</span>, model_file, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb107-31"><a href="from-simulation-to-model-fitting.html#cb107-31" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb107-32"><a href="from-simulation-to-model-fitting.html#cb107-32" tabindex="-1"></a>  <span class="co"># Load existing results</span></span>
<span id="cb107-33"><a href="from-simulation-to-model-fitting.html#cb107-33" tabindex="-1"></a>  samples_memory_forgetting <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(model_file)</span>
<span id="cb107-34"><a href="from-simulation-to-model-fitting.html#cb107-34" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Loaded existing model fit from&quot;</span>, model_file, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb107-35"><a href="from-simulation-to-model-fitting.html#cb107-35" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Loaded existing model fit from /Users/au209589/Dropbox/Teaching/AdvancedCognitiveModeling23_book/simmodels/04_InternalMemory2.rds</code></pre>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="from-simulation-to-model-fitting.html#cb109-1" tabindex="-1"></a>samples_memory_forgetting<span class="sc">$</span><span class="fu">summary</span>()</span></code></pre></div>
<pre><code>## # A tibble: 4 × 10
##   variable      mean  median    sd    mad        q5     q95  rhat ess_bulk ess_tail
##   &lt;chr&gt;        &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
## 1 lp__       -68.8   -68.4   1.28  1.00   -71.3     -67.4   0.999     345.     388.
## 2 bias         0.373   0.380 0.225 0.235    0.00137   0.756 1.00      298.     347.
## 3 beta         0.679   0.676 0.286 0.301    0.197     1.15  0.999     253.     340.
## 4 forgetting   0.175   0.151 0.103 0.0673   0.0677    0.356 1.01      325.     282.</code></pre>
<p>The memory model we’ve implemented can be seen as part of a broader family of models that track and update beliefs based on incoming evidence. Let’s explore how it relates to some key frameworks.</p>
</div>
</div>
<div id="memory-model-4-bayesian-agent-optimal-updating" class="section level2 hasAnchor" number="5.7">
<h2><span class="header-section-number">5.7</span> Memory Model 4: Bayesian Agent (Optimal Updating)<a href="from-simulation-to-model-fitting.html#memory-model-4-bayesian-agent-optimal-updating" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A fully Bayesian agent wouldn’t just track the rate but maintain a full probability distribution (a Beta distribution) over the likely bias of the opponent, updating it optimally according to Bayes’ rule after each observation.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="from-simulation-to-model-fitting.html#cb111-1" tabindex="-1"></a>stan_model <span class="ot">&lt;-</span> <span class="st">&quot;</span></span>
<span id="cb111-2"><a href="from-simulation-to-model-fitting.html#cb111-2" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb111-3"><a href="from-simulation-to-model-fitting.html#cb111-3" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;  // number of trials</span></span>
<span id="cb111-4"><a href="from-simulation-to-model-fitting.html#cb111-4" tabindex="-1"></a><span class="st">  array[n] int h;  // agent&#39;s choices (0 or 1)</span></span>
<span id="cb111-5"><a href="from-simulation-to-model-fitting.html#cb111-5" tabindex="-1"></a><span class="st">  array[n] int other;  // other player&#39;s choices (0 or 1)</span></span>
<span id="cb111-6"><a href="from-simulation-to-model-fitting.html#cb111-6" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb111-7"><a href="from-simulation-to-model-fitting.html#cb111-7" tabindex="-1"></a></span>
<span id="cb111-8"><a href="from-simulation-to-model-fitting.html#cb111-8" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb111-9"><a href="from-simulation-to-model-fitting.html#cb111-9" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; alpha_prior;  // Prior alpha parameter</span></span>
<span id="cb111-10"><a href="from-simulation-to-model-fitting.html#cb111-10" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; beta_prior;   // Prior beta parameter</span></span>
<span id="cb111-11"><a href="from-simulation-to-model-fitting.html#cb111-11" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb111-12"><a href="from-simulation-to-model-fitting.html#cb111-12" tabindex="-1"></a></span>
<span id="cb111-13"><a href="from-simulation-to-model-fitting.html#cb111-13" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb111-14"><a href="from-simulation-to-model-fitting.html#cb111-14" tabindex="-1"></a><span class="st">  vector[n] alpha;  // Alpha parameter at each trial</span></span>
<span id="cb111-15"><a href="from-simulation-to-model-fitting.html#cb111-15" tabindex="-1"></a><span class="st">  vector[n] beta;   // Beta parameter at each trial</span></span>
<span id="cb111-16"><a href="from-simulation-to-model-fitting.html#cb111-16" tabindex="-1"></a><span class="st">  vector[n] rate;   // Expected rate at each trial</span></span>
<span id="cb111-17"><a href="from-simulation-to-model-fitting.html#cb111-17" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb111-18"><a href="from-simulation-to-model-fitting.html#cb111-18" tabindex="-1"></a><span class="st">  // Initialize with prior</span></span>
<span id="cb111-19"><a href="from-simulation-to-model-fitting.html#cb111-19" tabindex="-1"></a><span class="st">  alpha[1] = alpha_prior;</span></span>
<span id="cb111-20"><a href="from-simulation-to-model-fitting.html#cb111-20" tabindex="-1"></a><span class="st">  beta[1] = beta_prior;</span></span>
<span id="cb111-21"><a href="from-simulation-to-model-fitting.html#cb111-21" tabindex="-1"></a><span class="st">  rate[1] = alpha[1] / (alpha[1] + beta[1]);</span></span>
<span id="cb111-22"><a href="from-simulation-to-model-fitting.html#cb111-22" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb111-23"><a href="from-simulation-to-model-fitting.html#cb111-23" tabindex="-1"></a><span class="st">  // Sequential updating of Beta distribution</span></span>
<span id="cb111-24"><a href="from-simulation-to-model-fitting.html#cb111-24" tabindex="-1"></a><span class="st">  for(t in 2:n) {</span></span>
<span id="cb111-25"><a href="from-simulation-to-model-fitting.html#cb111-25" tabindex="-1"></a><span class="st">    // Update Beta parameters based on previous observation</span></span>
<span id="cb111-26"><a href="from-simulation-to-model-fitting.html#cb111-26" tabindex="-1"></a><span class="st">    alpha[t] = alpha[t-1] + other[t-1];</span></span>
<span id="cb111-27"><a href="from-simulation-to-model-fitting.html#cb111-27" tabindex="-1"></a><span class="st">    beta[t] = beta[t-1] + (1 - other[t-1]);</span></span>
<span id="cb111-28"><a href="from-simulation-to-model-fitting.html#cb111-28" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb111-29"><a href="from-simulation-to-model-fitting.html#cb111-29" tabindex="-1"></a><span class="st">    // Calculate expected rate</span></span>
<span id="cb111-30"><a href="from-simulation-to-model-fitting.html#cb111-30" tabindex="-1"></a><span class="st">    rate[t] = alpha[t] / (alpha[t] + beta[t]);</span></span>
<span id="cb111-31"><a href="from-simulation-to-model-fitting.html#cb111-31" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb111-32"><a href="from-simulation-to-model-fitting.html#cb111-32" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb111-33"><a href="from-simulation-to-model-fitting.html#cb111-33" tabindex="-1"></a></span>
<span id="cb111-34"><a href="from-simulation-to-model-fitting.html#cb111-34" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb111-35"><a href="from-simulation-to-model-fitting.html#cb111-35" tabindex="-1"></a><span class="st">  // Priors on hyperparameters</span></span>
<span id="cb111-36"><a href="from-simulation-to-model-fitting.html#cb111-36" tabindex="-1"></a><span class="st">  target += gamma_lpdf(alpha_prior | 2, 1);</span></span>
<span id="cb111-37"><a href="from-simulation-to-model-fitting.html#cb111-37" tabindex="-1"></a><span class="st">  target += gamma_lpdf(beta_prior | 2, 1);</span></span>
<span id="cb111-38"><a href="from-simulation-to-model-fitting.html#cb111-38" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb111-39"><a href="from-simulation-to-model-fitting.html#cb111-39" tabindex="-1"></a><span class="st">  // Agent&#39;s choices follow current rate estimates</span></span>
<span id="cb111-40"><a href="from-simulation-to-model-fitting.html#cb111-40" tabindex="-1"></a><span class="st">  for(t in 1:n) {</span></span>
<span id="cb111-41"><a href="from-simulation-to-model-fitting.html#cb111-41" tabindex="-1"></a><span class="st">    target += bernoulli_lpmf(h[t] | rate[t]);</span></span>
<span id="cb111-42"><a href="from-simulation-to-model-fitting.html#cb111-42" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb111-43"><a href="from-simulation-to-model-fitting.html#cb111-43" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb111-44"><a href="from-simulation-to-model-fitting.html#cb111-44" tabindex="-1"></a></span>
<span id="cb111-45"><a href="from-simulation-to-model-fitting.html#cb111-45" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb111-46"><a href="from-simulation-to-model-fitting.html#cb111-46" tabindex="-1"></a><span class="st">  array[n] int prior_preds;</span></span>
<span id="cb111-47"><a href="from-simulation-to-model-fitting.html#cb111-47" tabindex="-1"></a><span class="st">  array[n] int posterior_preds;</span></span>
<span id="cb111-48"><a href="from-simulation-to-model-fitting.html#cb111-48" tabindex="-1"></a><span class="st">  real initial_rate = alpha_prior / (alpha_prior + beta_prior);</span></span>
<span id="cb111-49"><a href="from-simulation-to-model-fitting.html#cb111-49" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb111-50"><a href="from-simulation-to-model-fitting.html#cb111-50" tabindex="-1"></a><span class="st">  // Prior predictions use initial rate</span></span>
<span id="cb111-51"><a href="from-simulation-to-model-fitting.html#cb111-51" tabindex="-1"></a><span class="st">  for(t in 1:n) {</span></span>
<span id="cb111-52"><a href="from-simulation-to-model-fitting.html#cb111-52" tabindex="-1"></a><span class="st">    prior_preds[t] = bernoulli_rng(initial_rate);</span></span>
<span id="cb111-53"><a href="from-simulation-to-model-fitting.html#cb111-53" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb111-54"><a href="from-simulation-to-model-fitting.html#cb111-54" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb111-55"><a href="from-simulation-to-model-fitting.html#cb111-55" tabindex="-1"></a><span class="st">  // Posterior predictions use sequentially updated rates</span></span>
<span id="cb111-56"><a href="from-simulation-to-model-fitting.html#cb111-56" tabindex="-1"></a><span class="st">  for(t in 1:n) {</span></span>
<span id="cb111-57"><a href="from-simulation-to-model-fitting.html#cb111-57" tabindex="-1"></a><span class="st">    posterior_preds[t] = bernoulli_rng(rate[t]);</span></span>
<span id="cb111-58"><a href="from-simulation-to-model-fitting.html#cb111-58" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb111-59"><a href="from-simulation-to-model-fitting.html#cb111-59" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb111-60"><a href="from-simulation-to-model-fitting.html#cb111-60" tabindex="-1"></a><span class="st">&quot;</span></span>
<span id="cb111-61"><a href="from-simulation-to-model-fitting.html#cb111-61" tabindex="-1"></a><span class="fu">write_stan_file</span>(</span>
<span id="cb111-62"><a href="from-simulation-to-model-fitting.html#cb111-62" tabindex="-1"></a>  stan_model,</span>
<span id="cb111-63"><a href="from-simulation-to-model-fitting.html#cb111-63" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">&quot;stan/&quot;</span>,</span>
<span id="cb111-64"><a href="from-simulation-to-model-fitting.html#cb111-64" tabindex="-1"></a>  <span class="at">basename =</span> <span class="st">&quot;04_BayesianMemory.stan&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;/Users/au209589/Dropbox/Teaching/AdvancedCognitiveModeling23_book/stan/04_BayesianMemory.stan&quot;</code></pre>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="from-simulation-to-model-fitting.html#cb113-1" tabindex="-1"></a><span class="do">## Specify where the model is</span></span>
<span id="cb113-2"><a href="from-simulation-to-model-fitting.html#cb113-2" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;stan&quot;</span>,<span class="st">&quot;04_BayesianMemory.stan&quot;</span>)</span>
<span id="cb113-3"><a href="from-simulation-to-model-fitting.html#cb113-3" tabindex="-1"></a></span>
<span id="cb113-4"><a href="from-simulation-to-model-fitting.html#cb113-4" tabindex="-1"></a><span class="co"># File path for saved model</span></span>
<span id="cb113-5"><a href="from-simulation-to-model-fitting.html#cb113-5" tabindex="-1"></a>model_file <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">&quot;simmodels&quot;</span>,<span class="st">&quot;04_BayesianMemory.rds&quot;</span>)</span>
<span id="cb113-6"><a href="from-simulation-to-model-fitting.html#cb113-6" tabindex="-1"></a></span>
<span id="cb113-7"><a href="from-simulation-to-model-fitting.html#cb113-7" tabindex="-1"></a><span class="co"># Check if we need to rerun the simulation</span></span>
<span id="cb113-8"><a href="from-simulation-to-model-fitting.html#cb113-8" tabindex="-1"></a><span class="cf">if</span> (regenerate_simulations <span class="sc">||</span> <span class="sc">!</span><span class="fu">file.exists</span>(model_file)) {</span>
<span id="cb113-9"><a href="from-simulation-to-model-fitting.html#cb113-9" tabindex="-1"></a>  <span class="co"># Compile the model</span></span>
<span id="cb113-10"><a href="from-simulation-to-model-fitting.html#cb113-10" tabindex="-1"></a>  mod <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(file, </span>
<span id="cb113-11"><a href="from-simulation-to-model-fitting.html#cb113-11" tabindex="-1"></a>                       <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">FALSE</span>),</span>
<span id="cb113-12"><a href="from-simulation-to-model-fitting.html#cb113-12" tabindex="-1"></a>                       <span class="at">stanc_options =</span> <span class="fu">list</span>(<span class="st">&quot;O1&quot;</span>))</span>
<span id="cb113-13"><a href="from-simulation-to-model-fitting.html#cb113-13" tabindex="-1"></a>  </span>
<span id="cb113-14"><a href="from-simulation-to-model-fitting.html#cb113-14" tabindex="-1"></a>  <span class="co"># The following command calls Stan with specific options.</span></span>
<span id="cb113-15"><a href="from-simulation-to-model-fitting.html#cb113-15" tabindex="-1"></a>  samples_memory_bayes <span class="ot">&lt;-</span> mod<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb113-16"><a href="from-simulation-to-model-fitting.html#cb113-16" tabindex="-1"></a>    <span class="at">data =</span> data,</span>
<span id="cb113-17"><a href="from-simulation-to-model-fitting.html#cb113-17" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb113-18"><a href="from-simulation-to-model-fitting.html#cb113-18" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">1</span>,</span>
<span id="cb113-19"><a href="from-simulation-to-model-fitting.html#cb113-19" tabindex="-1"></a>    <span class="at">parallel_chains =</span> <span class="dv">2</span>,</span>
<span id="cb113-20"><a href="from-simulation-to-model-fitting.html#cb113-20" tabindex="-1"></a>    <span class="at">threads_per_chain =</span> <span class="dv">1</span>,</span>
<span id="cb113-21"><a href="from-simulation-to-model-fitting.html#cb113-21" tabindex="-1"></a>    <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb113-22"><a href="from-simulation-to-model-fitting.html#cb113-22" tabindex="-1"></a>    <span class="at">iter_sampling =</span> <span class="dv">1000</span>,</span>
<span id="cb113-23"><a href="from-simulation-to-model-fitting.html#cb113-23" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">0</span>,</span>
<span id="cb113-24"><a href="from-simulation-to-model-fitting.html#cb113-24" tabindex="-1"></a>    <span class="at">max_treedepth =</span> <span class="dv">20</span>,</span>
<span id="cb113-25"><a href="from-simulation-to-model-fitting.html#cb113-25" tabindex="-1"></a>    <span class="at">adapt_delta =</span> <span class="fl">0.99</span>,</span>
<span id="cb113-26"><a href="from-simulation-to-model-fitting.html#cb113-26" tabindex="-1"></a>  )</span>
<span id="cb113-27"><a href="from-simulation-to-model-fitting.html#cb113-27" tabindex="-1"></a>  </span>
<span id="cb113-28"><a href="from-simulation-to-model-fitting.html#cb113-28" tabindex="-1"></a>  <span class="co"># Save the fitted model</span></span>
<span id="cb113-29"><a href="from-simulation-to-model-fitting.html#cb113-29" tabindex="-1"></a>  samples_memory_bayes<span class="sc">$</span><span class="fu">save_object</span>(<span class="at">file =</span> model_file)</span>
<span id="cb113-30"><a href="from-simulation-to-model-fitting.html#cb113-30" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Generated new model fit and saved to&quot;</span>, model_file, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb113-31"><a href="from-simulation-to-model-fitting.html#cb113-31" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb113-32"><a href="from-simulation-to-model-fitting.html#cb113-32" tabindex="-1"></a>  <span class="co"># Load existing results</span></span>
<span id="cb113-33"><a href="from-simulation-to-model-fitting.html#cb113-33" tabindex="-1"></a>  samples_memory_bayes <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(model_file)</span>
<span id="cb113-34"><a href="from-simulation-to-model-fitting.html#cb113-34" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Loaded existing model fit from&quot;</span>, model_file, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb113-35"><a href="from-simulation-to-model-fitting.html#cb113-35" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## Loaded existing model fit from /Users/au209589/Dropbox/Teaching/AdvancedCognitiveModeling23_book/simmodels/04_BayesianMemory.rds</code></pre>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="from-simulation-to-model-fitting.html#cb115-1" tabindex="-1"></a>samples_memory_bayes<span class="sc">$</span><span class="fu">summary</span>() </span></code></pre></div>
<pre><code>## # A tibble: 604 × 10
##    variable       mean  median    sd   mad      q5    q95  rhat ess_bulk ess_tail
##    &lt;chr&gt;         &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1 lp__        -63.8   -63.4   1.05  0.675 -66.1   -62.9  1.00      238.     336.
##  2 alpha_prior   2.71    2.47  1.65  1.40    0.602   5.75 0.999     448.     485.
##  3 beta_prior    0.679   0.572 0.485 0.403   0.134   1.60 1.000     352.     204.
##  4 alpha[1]      2.71    2.47  1.65  1.40    0.602   5.75 0.999     448.     485.
##  5 alpha[2]      3.71    3.47  1.65  1.40    1.60    6.75 0.999     448.     485.
##  6 alpha[3]      4.71    4.47  1.65  1.40    2.60    7.75 0.999     448.     485.
##  7 alpha[4]      5.71    5.47  1.65  1.40    3.60    8.75 0.999     448.     485.
##  8 alpha[5]      6.71    6.47  1.65  1.40    4.60    9.75 0.999     448.     485.
##  9 alpha[6]      7.71    7.47  1.65  1.40    5.60   10.8  0.999     448.     485.
## 10 alpha[7]      8.71    8.47  1.65  1.40    6.60   11.8  0.999     448.     485.
## # ℹ 594 more rows</code></pre>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="from-simulation-to-model-fitting.html#cb117-1" tabindex="-1"></a><span class="co"># Extract draws</span></span>
<span id="cb117-2"><a href="from-simulation-to-model-fitting.html#cb117-2" tabindex="-1"></a>draws_df <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(samples_memory_bayes<span class="sc">$</span><span class="fu">draws</span>())</span>
<span id="cb117-3"><a href="from-simulation-to-model-fitting.html#cb117-3" tabindex="-1"></a></span>
<span id="cb117-4"><a href="from-simulation-to-model-fitting.html#cb117-4" tabindex="-1"></a><span class="co"># First let&#39;s look at the priors</span></span>
<span id="cb117-5"><a href="from-simulation-to-model-fitting.html#cb117-5" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df) <span class="sc">+</span></span>
<span id="cb117-6"><a href="from-simulation-to-model-fitting.html#cb117-6" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(alpha_prior), <span class="at">fill =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb117-7"><a href="from-simulation-to-model-fitting.html#cb117-7" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(beta_prior), <span class="at">fill =</span> <span class="st">&quot;red&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb117-8"><a href="from-simulation-to-model-fitting.html#cb117-8" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb117-9"><a href="from-simulation-to-model-fitting.html#cb117-9" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Prior Distributions&quot;</span>,</span>
<span id="cb117-10"><a href="from-simulation-to-model-fitting.html#cb117-10" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Parameter Value&quot;</span>,</span>
<span id="cb117-11"><a href="from-simulation-to-model-fitting.html#cb117-11" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>)</span></code></pre></div>
<p><img src="series_files/figure-html/04%20bayesian%20memory%20stan%20model-1.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="from-simulation-to-model-fitting.html#cb118-1" tabindex="-1"></a><span class="co"># Now let&#39;s look at how the rate evolves over trials</span></span>
<span id="cb118-2"><a href="from-simulation-to-model-fitting.html#cb118-2" tabindex="-1"></a><span class="co"># First melt the rate values across trials into long format</span></span>
<span id="cb118-3"><a href="from-simulation-to-model-fitting.html#cb118-3" tabindex="-1"></a>rate_df <span class="ot">&lt;-</span> draws_df <span class="sc">%&gt;%</span></span>
<span id="cb118-4"><a href="from-simulation-to-model-fitting.html#cb118-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;rate[&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb118-5"><a href="from-simulation-to-model-fitting.html#cb118-5" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), </span>
<span id="cb118-6"><a href="from-simulation-to-model-fitting.html#cb118-6" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">&quot;trial&quot;</span>,</span>
<span id="cb118-7"><a href="from-simulation-to-model-fitting.html#cb118-7" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">&quot;rate&quot;</span>,</span>
<span id="cb118-8"><a href="from-simulation-to-model-fitting.html#cb118-8" tabindex="-1"></a>               <span class="at">names_pattern =</span> <span class="st">&quot;rate</span><span class="sc">\\</span><span class="st">[(</span><span class="sc">\\</span><span class="st">d+)</span><span class="sc">\\</span><span class="st">]&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb118-9"><a href="from-simulation-to-model-fitting.html#cb118-9" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trial =</span> <span class="fu">as.numeric</span>(trial))</span>
<span id="cb118-10"><a href="from-simulation-to-model-fitting.html#cb118-10" tabindex="-1"></a></span>
<span id="cb118-11"><a href="from-simulation-to-model-fitting.html#cb118-11" tabindex="-1"></a><span class="co"># Calculate summary statistics for each trial</span></span>
<span id="cb118-12"><a href="from-simulation-to-model-fitting.html#cb118-12" tabindex="-1"></a>rate_summary <span class="ot">&lt;-</span> rate_df <span class="sc">%&gt;%</span></span>
<span id="cb118-13"><a href="from-simulation-to-model-fitting.html#cb118-13" tabindex="-1"></a>  <span class="fu">group_by</span>(trial) <span class="sc">%&gt;%</span></span>
<span id="cb118-14"><a href="from-simulation-to-model-fitting.html#cb118-14" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb118-15"><a href="from-simulation-to-model-fitting.html#cb118-15" tabindex="-1"></a>    <span class="at">mean_rate =</span> <span class="fu">mean</span>(rate),</span>
<span id="cb118-16"><a href="from-simulation-to-model-fitting.html#cb118-16" tabindex="-1"></a>    <span class="at">lower =</span> <span class="fu">quantile</span>(rate, <span class="fl">0.025</span>),</span>
<span id="cb118-17"><a href="from-simulation-to-model-fitting.html#cb118-17" tabindex="-1"></a>    <span class="at">upper =</span> <span class="fu">quantile</span>(rate, <span class="fl">0.975</span>)</span>
<span id="cb118-18"><a href="from-simulation-to-model-fitting.html#cb118-18" tabindex="-1"></a>  )</span>
<span id="cb118-19"><a href="from-simulation-to-model-fitting.html#cb118-19" tabindex="-1"></a></span>
<span id="cb118-20"><a href="from-simulation-to-model-fitting.html#cb118-20" tabindex="-1"></a></span>
<span id="cb118-21"><a href="from-simulation-to-model-fitting.html#cb118-21" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">trial =</span> <span class="fu">seq</span>(<span class="dv">120</span>), <span class="at">choices =</span> data<span class="sc">$</span>other)</span>
<span id="cb118-22"><a href="from-simulation-to-model-fitting.html#cb118-22" tabindex="-1"></a></span>
<span id="cb118-23"><a href="from-simulation-to-model-fitting.html#cb118-23" tabindex="-1"></a><span class="co"># Plot the evolution of rate estimates</span></span>
<span id="cb118-24"><a href="from-simulation-to-model-fitting.html#cb118-24" tabindex="-1"></a><span class="fu">ggplot</span>(rate_summary, <span class="fu">aes</span>(<span class="at">x =</span> trial)) <span class="sc">+</span></span>
<span id="cb118-25"><a href="from-simulation-to-model-fitting.html#cb118-25" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper), <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb118-26"><a href="from-simulation-to-model-fitting.html#cb118-26" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean_rate), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>) <span class="sc">+</span></span>
<span id="cb118-27"><a href="from-simulation-to-model-fitting.html#cb118-27" tabindex="-1"></a>  <span class="co"># Add true data points</span></span>
<span id="cb118-28"><a href="from-simulation-to-model-fitting.html#cb118-28" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> plot_data, </span>
<span id="cb118-29"><a href="from-simulation-to-model-fitting.html#cb118-29" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> trial, <span class="at">y =</span> choices), <span class="at">color =</span> <span class="st">&quot;orange&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb118-30"><a href="from-simulation-to-model-fitting.html#cb118-30" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb118-31"><a href="from-simulation-to-model-fitting.html#cb118-31" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Evolution of Rate Estimates&quot;</span>,</span>
<span id="cb118-32"><a href="from-simulation-to-model-fitting.html#cb118-32" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Trial&quot;</span>,</span>
<span id="cb118-33"><a href="from-simulation-to-model-fitting.html#cb118-33" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Rate&quot;</span>,</span>
<span id="cb118-34"><a href="from-simulation-to-model-fitting.html#cb118-34" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">&quot;Blue line: posterior mean, Gray band: 95% CI&quot;</span>) <span class="sc">+</span></span>
<span id="cb118-35"><a href="from-simulation-to-model-fitting.html#cb118-35" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span></code></pre></div>
<p><img src="series_files/figure-html/04%20bayesian%20memory%20stan%20model-2.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="from-simulation-to-model-fitting.html#cb119-1" tabindex="-1"></a><span class="co"># Let&#39;s also look at the correlation between alpha and beta parameters</span></span>
<span id="cb119-2"><a href="from-simulation-to-model-fitting.html#cb119-2" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df) <span class="sc">+</span></span>
<span id="cb119-3"><a href="from-simulation-to-model-fitting.html#cb119-3" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(alpha_prior, beta_prior), <span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb119-4"><a href="from-simulation-to-model-fitting.html#cb119-4" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb119-5"><a href="from-simulation-to-model-fitting.html#cb119-5" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Correlation between Alpha and Beta Parameters&quot;</span>,</span>
<span id="cb119-6"><a href="from-simulation-to-model-fitting.html#cb119-6" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Alpha&quot;</span>,</span>
<span id="cb119-7"><a href="from-simulation-to-model-fitting.html#cb119-7" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Beta&quot;</span>)</span></code></pre></div>
<p><img src="series_files/figure-html/04%20bayesian%20memory%20stan%20model-3.png" alt="" width="80%" style="display: block; margin: auto;" /></p>
</div>
<div id="relationship-to-rescorla-wagner" class="section level2 hasAnchor" number="5.8">
<h2><span class="header-section-number">5.8</span> Relationship to Rescorla-Wagner<a href="from-simulation-to-model-fitting.html#relationship-to-rescorla-wagner" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The Rescorla-Wagner model of learning follows the form:</p>
<p>V(t+1) = V(t) + α(λ - V(t))</p>
<p>where:</p>
<ul>
<li><p>V(t) is the current estimate</p></li>
<li><p>α is the learning rate</p></li>
<li><p>λ is the observed outcome</p></li>
<li><p>(λ - V(t)) is the prediction error</p></li>
</ul>
<p>Our memory model with forgetting parameter follows a very similar structure:</p>
<p>memory(t+1) = (1-forgetting) * memory(t) + forgetting * outcome(t)</p>
<p>This can be rewritten as:</p>
<p>memory(t+1) = memory(t) + forgetting * (outcome(t) - memory(t))</p>
<p>Making the parallel clear: our forgetting parameter acts exactly as the learning rate α in Rescorla-Wagner and the models are equivalent.</p>
<div id="connection-to-kalman-filters" class="section level3 hasAnchor" number="5.8.1">
<h3><span class="header-section-number">5.8.1</span> Connection to Kalman Filters<a href="from-simulation-to-model-fitting.html#connection-to-kalman-filters" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Our memory model updates beliefs about the probability of right-hand choices using a weighted average of past observations. This is conceptually similar to how a Kalman filter works, though simpler:</p>
<ul>
<li><p>Kalman filters maintain both an estimate and uncertainty about that estimate</p></li>
<li><p>They optimally weight new evidence based on relative uncertainty</p></li>
<li><p>Our forgetting model uses a fixed weighting scheme (1/trial or the forgetting parameter)</p></li>
<li><p>The Bayesian Agent (<code>04_BayesianMemory.stan</code>) captures uncertainty via the Beta distribution, similar in spirit but simpler than a Kalman filter.</p></li>
</ul>
</div>
<div id="connection-to-hierarchical-gaussian-filter-hgf" class="section level3 hasAnchor" number="5.8.2">
<h3><span class="header-section-number">5.8.2</span> Connection to Hierarchical Gaussian Filter (HGF)<a href="from-simulation-to-model-fitting.html#connection-to-hierarchical-gaussian-filter-hgf" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The HGF extends these ideas by:</p>
<ul>
<li><p>Tracking beliefs at multiple levels</p></li>
<li><p>Allowing learning rates to vary over time</p></li>
<li><p>Explicitly modeling environmental volatility</p></li>
</ul>
<p>Our model could be seen as the simplest case of an HGF where:</p>
<ul>
<li><p>We only track one level (probability of right-hand choice)</p></li>
<li><p>Have a fixed learning rate (forgetting parameter)</p></li>
<li><p>Don’t explicitly model environmental volatility</p></li>
</ul>
</div>
<div id="implications-for-model-development" class="section level3 hasAnchor" number="5.8.3">
<h3><span class="header-section-number">5.8.3</span> Implications for Model Development<a href="from-simulation-to-model-fitting.html#implications-for-model-development" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Understanding these relationships helps us think about how models relate to each other and to extend our model:</p>
<ul>
<li><p>We could add uncertainty estimates to get Kalman-like behavior</p></li>
<li><p>We could make the forgetting parameter dynamic to capture changing learning rates</p></li>
<li><p>We could add multiple levels to track both immediate probabilities and longer-term trends</p></li>
</ul>
<p>Each extension would make the model more flexible but also more complex to fit to data. The choice depends on our specific research questions and available data.</p>
</div>
</div>
<div id="conclusion-estimating-parameters-and-exploring-memory" class="section level2 hasAnchor" number="5.9">
<h2><span class="header-section-number">5.9</span> Conclusion: Estimating Parameters and Exploring Memory<a href="from-simulation-to-model-fitting.html#conclusion-estimating-parameters-and-exploring-memory" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This chapter marked a crucial transition from simulating models with known parameters to the core task of <strong>parameter estimation</strong>: inferring plausible parameter values from observed data using Bayesian inference and Stan.</p>
<p>We learned how to:
* <strong>Specify Bayesian models</strong> in Stan, defining data, parameters, priors, and likelihoods.
* <strong>Fit models</strong> using <code>cmdstanr</code> to obtain posterior distributions for parameters like choice bias (<code>theta</code>).
* <strong>Utilize transformations</strong> like log-odds for computational benefits and flexible prior specification.
* <strong>Validate our fitting procedure</strong> through <strong>parameter recovery</strong>, ensuring our models can retrieve known values from simulated data.
* <strong>Implement different cognitive models</strong> for history-dependent choice, exploring various ways to represent <strong>memory</strong>: as an external predictor, an internal updating state, incorporating exponential forgetting (linking to Reinforcement Learning principles), and even as a fully Bayesian belief update.
* <strong>Recognize connections</strong> between these models and broader frameworks like Kalman filters and HGF.</p>
<p>By fitting these models, we moved beyond simply describing behavior (like the cumulative rates in Chapter 3) to quantifying underlying latent parameters (like <code>bias</code>, <code>beta</code>, <code>forgetting</code>).</p>
<p>However, fitting a model and recovering parameters is only part of the story. How do we know if the model is actually <em>good</em>? How well does it capture the patterns in the data beyond just the average parameter values? How sensitive are our conclusions to the specific priors we chose? These questions lead directly to the topic of <strong>model quality assessment</strong>, which we will tackle in the next chapter using techniques like prior/posterior predictive checks and sensitivity analyses.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="from-verbal-descriptions-to-formal-models.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/fusaroli/AdvancedCognitiveModeling/edit/master/04-InferringRates.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": ["series.pdf"],
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
