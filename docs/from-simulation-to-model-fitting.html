<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 From simulation to model fitting | 07-MixtureModels</title>
  <meta name="description" content="My notes for the advanced cognitive modeling course - 2025" />
  <meta name="generator" content="bookdown 0.42 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 From simulation to model fitting | 07-MixtureModels" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="My notes for the advanced cognitive modeling course - 2025" />
  <meta name="github-repo" content="openscapes/series" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 From simulation to model fitting | 07-MixtureModels" />
  
  <meta name="twitter:description" content="My notes for the advanced cognitive modeling course - 2025" />
  

<meta name="author" content="Riccardo Fusaroli" />


<meta name="date" content="2023-03-13" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="from-verbal-descriptions-to-formal-models.html"/>
<link rel="next" href="model-quality-assessment.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="lib/css/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" href="lib/css/style.css" type="text/css" />
<link rel="stylesheet" href="lib/css/lesson.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Advanced Cognitive Modeling</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Advanced Cognitive Modeling</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#course-philosophy-and-approach"><i class="fa fa-check"></i><b>1.1</b> Course Philosophy and Approach</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#course-structure-and-learning-path"><i class="fa fa-check"></i><b>1.2</b> Course Structure and Learning Path</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#prerequisites-and-preparation"><i class="fa fa-check"></i><b>1.3</b> Prerequisites and Preparation</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#course-resources"><i class="fa fa-check"></i><b>1.4</b> Course Resources</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#about-these-notes"><i class="fa fa-check"></i><b>1.5</b> About These Notes</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="foundations.html"><a href="foundations.html"><i class="fa fa-check"></i><b>2</b> Foundations</a>
<ul>
<li class="chapter" data-level="2.1" data-path="foundations.html"><a href="foundations.html#from-pizza-to-cognitive-models-an-introduction"><i class="fa fa-check"></i><b>2.1</b> From Pizza to Cognitive Models: An Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="foundations.html"><a href="foundations.html#why-start-with-pizza"><i class="fa fa-check"></i><b>2.2</b> Why Start with Pizza?</a></li>
<li class="chapter" data-level="2.3" data-path="foundations.html"><a href="foundations.html#learning-objectives"><i class="fa fa-check"></i><b>2.3</b> Learning Objectives</a></li>
<li class="chapter" data-level="2.4" data-path="foundations.html"><a href="foundations.html#part-1-exploring-the-pizza-stone-temperature-data"><i class="fa fa-check"></i><b>2.4</b> Part 1: Exploring the Pizza Stone Temperature Data</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="foundations.html"><a href="foundations.html#initial-data-visualization"><i class="fa fa-check"></i><b>2.4.1</b> Initial Data Visualization</a></li>
<li class="chapter" data-level="2.4.2" data-path="foundations.html"><a href="foundations.html#key-observations"><i class="fa fa-check"></i><b>2.4.2</b> Key Observations</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="foundations.html"><a href="foundations.html#part-2-initial-statistical-modeling"><i class="fa fa-check"></i><b>2.5</b> Part 2: Initial Statistical Modeling</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="foundations.html"><a href="foundations.html#model-setup-and-priors"><i class="fa fa-check"></i><b>2.5.1</b> Model Setup and Priors</a></li>
<li class="chapter" data-level="2.5.2" data-path="foundations.html"><a href="foundations.html#linear-mixed-effects-model"><i class="fa fa-check"></i><b>2.5.2</b> Linear Mixed-Effects Model</a></li>
<li class="chapter" data-level="2.5.3" data-path="foundations.html"><a href="foundations.html#lognormal-mixed-effects-model"><i class="fa fa-check"></i><b>2.5.3</b> Lognormal Mixed-Effects Model</a></li>
<li class="chapter" data-level="2.5.4" data-path="foundations.html"><a href="foundations.html#model-comparison-and-visualization"><i class="fa fa-check"></i><b>2.5.4</b> Model Comparison and Visualization</a></li>
<li class="chapter" data-level="2.5.5" data-path="foundations.html"><a href="foundations.html#model-assessment"><i class="fa fa-check"></i><b>2.5.5</b> Model Assessment</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="foundations.html"><a href="foundations.html#part-3-understanding-the-physics-model"><i class="fa fa-check"></i><b>2.6</b> Part 3: Understanding the Physics Model</a>
<ul>
<li class="chapter" data-level="2.6.1" data-path="foundations.html"><a href="foundations.html#the-basic-temperature-evolution-equation"><i class="fa fa-check"></i><b>2.6.1</b> The Basic Temperature Evolution Equation</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="foundations.html"><a href="foundations.html#part-4-implementing-the-physics-based-model"><i class="fa fa-check"></i><b>2.7</b> Part 4: Implementing the Physics-Based Model</a></li>
<li class="chapter" data-level="2.8" data-path="foundations.html"><a href="foundations.html#part-5-model-analysis-and-practical-applications"><i class="fa fa-check"></i><b>2.8</b> Part 5: Model Analysis and Practical Applications</a></li>
<li class="chapter" data-level="2.9" data-path="foundations.html"><a href="foundations.html#conclusion-from-pizza-to-principles"><i class="fa fa-check"></i><b>2.9</b> Conclusion: From Pizza to Principles</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html"><i class="fa fa-check"></i><b>3</b> Building Models of Strategic Decision-Making</a>
<ul>
<li class="chapter" data-level="3.1" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#learning-goals"><i class="fa fa-check"></i><b>3.1</b> Learning goals</a></li>
<li class="chapter" data-level="3.2" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#introduction"><i class="fa fa-check"></i><b>3.2</b> Introduction</a></li>
<li class="chapter" data-level="3.3" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#the-matching-pennies-game"><i class="fa fa-check"></i><b>3.3</b> The Matching Pennies Game</a></li>
<li class="chapter" data-level="3.4" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#game-structure"><i class="fa fa-check"></i><b>3.4</b> Game Structure</a></li>
<li class="chapter" data-level="3.5" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#empirical-investigation"><i class="fa fa-check"></i><b>3.5</b> Empirical Investigation</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#data-collection-protocol"><i class="fa fa-check"></i><b>3.5.1</b> Data Collection Protocol</a></li>
<li class="chapter" data-level="3.5.2" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#initial-observations"><i class="fa fa-check"></i><b>3.5.2</b> Initial Observations</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#empirical-explorations"><i class="fa fa-check"></i><b>3.6</b> Empirical explorations</a></li>
<li class="chapter" data-level="3.7" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#notes-from-previous-years"><i class="fa fa-check"></i><b>3.7</b> Notes from previous years</a>
<ul>
<li class="chapter" data-level="3.7.1" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#from-observation-to-theory"><i class="fa fa-check"></i><b>3.7.1</b> From Observation to Theory</a></li>
<li class="chapter" data-level="3.7.2" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#core-modeling-considerations"><i class="fa fa-check"></i><b>3.7.2</b> Core Modeling Considerations</a></li>
<li class="chapter" data-level="3.7.3" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#the-distinction-between-participant-and-researcher-perspectives"><i class="fa fa-check"></i><b>3.7.3</b> The distinction between participant and researcher perspectives</a></li>
</ul></li>
<li class="chapter" data-level="3.8" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#building-formal-models"><i class="fa fa-check"></i><b>3.8</b> Building Formal Models</a>
<ul>
<li class="chapter" data-level="3.8.1" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#random-choice-model"><i class="fa fa-check"></i><b>3.8.1</b> Random Choice Model</a></li>
<li class="chapter" data-level="3.8.2" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#immediate-reaction-win-stay-lose-shift"><i class="fa fa-check"></i><b>3.8.2</b> Immediate reaction (Win-Stay-Lose-Shift)</a></li>
<li class="chapter" data-level="3.8.3" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#keep-track-of-the-bias-perfect-memory"><i class="fa fa-check"></i><b>3.8.3</b> Keep track of the bias (perfect memory)</a></li>
<li class="chapter" data-level="3.8.4" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#keep-track-of-the-bias-imperfect-memory"><i class="fa fa-check"></i><b>3.8.4</b> Keep track of the bias (imperfect memory)</a></li>
<li class="chapter" data-level="3.8.5" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#reinforcement-learning"><i class="fa fa-check"></i><b>3.8.5</b> Reinforcement learning</a></li>
<li class="chapter" data-level="3.8.6" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#k-tom"><i class="fa fa-check"></i><b>3.8.6</b> k-ToM</a></li>
<li class="chapter" data-level="3.8.7" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#other-possible-strategies"><i class="fa fa-check"></i><b>3.8.7</b> Other possible strategies</a></li>
</ul></li>
<li class="chapter" data-level="3.9" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#cognitive-constraints"><i class="fa fa-check"></i><b>3.9</b> Cognitive constraints</a>
<ul>
<li class="chapter" data-level="3.9.1" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#memory"><i class="fa fa-check"></i><b>3.9.1</b> Memory</a></li>
<li class="chapter" data-level="3.9.2" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#perseveration"><i class="fa fa-check"></i><b>3.9.2</b> Perseveration</a></li>
<li class="chapter" data-level="3.9.3" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#errors"><i class="fa fa-check"></i><b>3.9.3</b> Errors</a></li>
</ul></li>
<li class="chapter" data-level="3.10" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#continuity-between-models"><i class="fa fa-check"></i><b>3.10</b> Continuity between models</a></li>
<li class="chapter" data-level="3.11" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#mixture-of-strategies"><i class="fa fa-check"></i><b>3.11</b> Mixture of strategies</a></li>
<li class="chapter" data-level="3.12" data-path="building-models-of-strategic-decision-making.html"><a href="building-models-of-strategic-decision-making.html#differences-from-more-traditional-general-linear-model-based-approaches"><i class="fa fa-check"></i><b>3.12</b> Differences from more traditional (general linear model-based) approaches</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html"><i class="fa fa-check"></i><b>4</b> From verbal descriptions to formal models</a>
<ul>
<li class="chapter" data-level="4.1" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html#learning-goals-1"><i class="fa fa-check"></i><b>4.1</b> Learning Goals</a></li>
<li class="chapter" data-level="4.2" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html#the-value-of-formalization"><i class="fa fa-check"></i><b>4.2</b> The Value of Formalization</a></li>
<li class="chapter" data-level="4.3" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html#defining-general-conditions"><i class="fa fa-check"></i><b>4.3</b> Defining general conditions</a></li>
<li class="chapter" data-level="4.4" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html#implementing-a-random-agent"><i class="fa fa-check"></i><b>4.4</b> Implementing a random agent</a></li>
<li class="chapter" data-level="4.5" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html#implementing-a-win-stay-lose-shift-agent"><i class="fa fa-check"></i><b>4.5</b> Implementing a Win-Stay-Lose-Shift agent</a></li>
<li class="chapter" data-level="4.6" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html#now-we-scale-it-up"><i class="fa fa-check"></i><b>4.6</b> Now we scale it up</a>
<ul>
<li class="chapter" data-level="4.6.1" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html#and-we-visualize-it"><i class="fa fa-check"></i><b>4.6.1</b> And we visualize it</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="from-verbal-descriptions-to-formal-models.html"><a href="from-verbal-descriptions-to-formal-models.html#conclusion"><i class="fa fa-check"></i><b>4.7</b> Conclusion</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html"><i class="fa fa-check"></i><b>5</b> From simulation to model fitting</a>
<ul>
<li class="chapter" data-level="5.1" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#learning-goals-2"><i class="fa fa-check"></i><b>5.1</b> Learning Goals</a></li>
<li class="chapter" data-level="5.2" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#the-challenge-of-model-fitting"><i class="fa fa-check"></i><b>5.2</b> The Challenge of Model Fitting</a></li>
<li class="chapter" data-level="5.3" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#simulating-data"><i class="fa fa-check"></i><b>5.3</b> Simulating data</a></li>
<li class="chapter" data-level="5.4" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#building-our-basic-model-in-stan"><i class="fa fa-check"></i><b>5.4</b> Building our basic model in Stan</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#data"><i class="fa fa-check"></i><b>5.4.1</b> Data</a></li>
<li class="chapter" data-level="5.4.2" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#model"><i class="fa fa-check"></i><b>5.4.2</b> Model</a></li>
<li class="chapter" data-level="5.4.3" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#compiling-and-fitting-the-model"><i class="fa fa-check"></i><b>5.4.3</b> Compiling and fitting the model</a></li>
<li class="chapter" data-level="5.4.4" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#summarizing-the-model"><i class="fa fa-check"></i><b>5.4.4</b> Summarizing the model</a></li>
<li class="chapter" data-level="5.4.5" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#assessing-model-quality"><i class="fa fa-check"></i><b>5.4.5</b> Assessing model quality</a></li>
<li class="chapter" data-level="5.4.6" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#summarizing-the-results"><i class="fa fa-check"></i><b>5.4.6</b> Summarizing the results</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#parameter-recovery"><i class="fa fa-check"></i><b>5.5</b> Parameter recovery</a></li>
<li class="chapter" data-level="5.6" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#the-memory-model-conditioning-theta"><i class="fa fa-check"></i><b>5.6</b> The memory model: conditioning theta</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#summarizing-the-results-1"><i class="fa fa-check"></i><b>5.6.1</b> Summarizing the results</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#memory-agent-with-internal-parameter"><i class="fa fa-check"></i><b>5.7</b> Memory agent with internal parameter</a>
<ul>
<li class="chapter" data-level="5.7.1" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#trying-out-a-more-complex-memory-model-with-a-rate-of-forgetting-that-exponentially-discounts-the-past"><i class="fa fa-check"></i><b>5.7.1</b> Trying out a more complex memory model, with a rate of forgetting that exponentially discounts the past</a></li>
<li class="chapter" data-level="5.7.2" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#connection-to-kalman-filters"><i class="fa fa-check"></i><b>5.7.2</b> Connection to Kalman Filters</a></li>
</ul></li>
<li class="chapter" data-level="5.8" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#relationship-to-rescorla-wagner"><i class="fa fa-check"></i><b>5.8</b> Relationship to Rescorla-Wagner</a>
<ul>
<li class="chapter" data-level="5.8.1" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#connection-to-hierarchical-gaussian-filter-hgf"><i class="fa fa-check"></i><b>5.8.1</b> Connection to Hierarchical Gaussian Filter (HGF)</a></li>
<li class="chapter" data-level="5.8.2" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#implications-for-model-development"><i class="fa fa-check"></i><b>5.8.2</b> Implications for Model Development</a></li>
</ul></li>
<li class="chapter" data-level="5.9" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#bayesian-memory-agent"><i class="fa fa-check"></i><b>5.9</b> Bayesian memory agent</a></li>
<li class="chapter" data-level="5.10" data-path="from-simulation-to-model-fitting.html"><a href="from-simulation-to-model-fitting.html#conclusion-from-simple-models-to-complex-cognitive-processes"><i class="fa fa-check"></i><b>5.10</b> Conclusion: From Simple Models to Complex Cognitive Processes</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="model-quality-assessment.html"><a href="model-quality-assessment.html"><i class="fa fa-check"></i><b>6</b> Model Quality Assessment</a>
<ul>
<li class="chapter" data-level="6.1" data-path="model-quality-assessment.html"><a href="model-quality-assessment.html#introduction-1"><i class="fa fa-check"></i><b>6.1</b> Introduction</a></li>
<li class="chapter" data-level="6.2" data-path="model-quality-assessment.html"><a href="model-quality-assessment.html#generating-and-plotting-additional-variables"><i class="fa fa-check"></i><b>6.2</b> Generating and plotting additional variables</a></li>
<li class="chapter" data-level="6.3" data-path="model-quality-assessment.html"><a href="model-quality-assessment.html#assessing-priors"><i class="fa fa-check"></i><b>6.3</b> Assessing priors</a></li>
<li class="chapter" data-level="6.4" data-path="model-quality-assessment.html"><a href="model-quality-assessment.html#prior-predictive-checks"><i class="fa fa-check"></i><b>6.4</b> Prior Predictive Checks</a></li>
<li class="chapter" data-level="6.5" data-path="model-quality-assessment.html"><a href="model-quality-assessment.html#posterior-predictive-checks"><i class="fa fa-check"></i><b>6.5</b> Posterior Predictive Checks</a></li>
<li class="chapter" data-level="6.6" data-path="model-quality-assessment.html"><a href="model-quality-assessment.html#prior-sensitivity-analysis"><i class="fa fa-check"></i><b>6.6</b> Prior sensitivity analysis</a></li>
<li class="chapter" data-level="6.7" data-path="model-quality-assessment.html"><a href="model-quality-assessment.html#the-memory-model"><i class="fa fa-check"></i><b>6.7</b> The memory model</a></li>
<li class="chapter" data-level="6.8" data-path="model-quality-assessment.html"><a href="model-quality-assessment.html#prior-sensitivity-check-for-the-memory-model"><i class="fa fa-check"></i><b>6.8</b> Prior sensitivity check for the memory model</a></li>
<li class="chapter" data-level="6.9" data-path="model-quality-assessment.html"><a href="model-quality-assessment.html#conclusion-1"><i class="fa fa-check"></i><b>6.9</b> Conclusion</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><i class="fa fa-check"></i><b>7</b> Individual Differences in Cognitive Strategies (Multilevel modeling)</a>
<ul>
<li class="chapter" data-level="7.1" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#introduction-2"><i class="fa fa-check"></i><b>7.1</b> Introduction</a></li>
<li class="chapter" data-level="7.2" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#learning-objectives-1"><i class="fa fa-check"></i><b>7.2</b> Learning Objectives</a></li>
<li class="chapter" data-level="7.3" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#the-value-of-multilevel-modeling"><i class="fa fa-check"></i><b>7.3</b> The Value of Multilevel Modeling</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#complete-pooling"><i class="fa fa-check"></i><b>7.3.1</b> Complete Pooling</a></li>
<li class="chapter" data-level="7.3.2" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#no-pooling"><i class="fa fa-check"></i><b>7.3.2</b> No Pooling</a></li>
<li class="chapter" data-level="7.3.3" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#partial-pooling-multilevel-modeling"><i class="fa fa-check"></i><b>7.3.3</b> Partial Pooling (Multilevel Modeling)</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#graphical-model-visualization"><i class="fa fa-check"></i><b>7.4</b> Graphical Model Visualization</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#biased-agent-model"><i class="fa fa-check"></i><b>7.4.1</b> Biased Agent Model</a></li>
<li class="chapter" data-level="7.4.2" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#memory-agent-model"><i class="fa fa-check"></i><b>7.4.2</b> Memory Agent Model</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#generating-the-agents"><i class="fa fa-check"></i><b>7.5</b> Generating the agents</a></li>
<li class="chapter" data-level="7.6" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#plotting-the-agents"><i class="fa fa-check"></i><b>7.6</b> Plotting the agents</a></li>
<li class="chapter" data-level="7.7" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#coding-the-multilevel-agents"><i class="fa fa-check"></i><b>7.7</b> Coding the multilevel agents</a>
<ul>
<li class="chapter" data-level="7.7.1" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#multilevel-random"><i class="fa fa-check"></i><b>7.7.1</b> Multilevel random</a></li>
</ul></li>
<li class="chapter" data-level="7.8" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#multilevel-random-agent-model"><i class="fa fa-check"></i><b>7.8</b> Multilevel Random Agent Model</a>
<ul>
<li class="chapter" data-level="7.8.1" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#assessing-multilevel-random-agents"><i class="fa fa-check"></i><b>7.8.1</b> Assessing multilevel random agents</a></li>
</ul></li>
<li class="chapter" data-level="7.9" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#lets-look-at-individuals"><i class="fa fa-check"></i><b>7.9</b> Let’s look at individuals</a></li>
<li class="chapter" data-level="7.10" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#prior-sensitivity-checks"><i class="fa fa-check"></i><b>7.10</b> Prior sensitivity checks</a></li>
<li class="chapter" data-level="7.11" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#parameter-recovery-1"><i class="fa fa-check"></i><b>7.11</b> Parameter recovery</a></li>
<li class="chapter" data-level="7.12" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#multilevel-memory-agent-model"><i class="fa fa-check"></i><b>7.12</b> Multilevel Memory Agent Model</a>
<ul>
<li class="chapter" data-level="7.12.1" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#assessing-multilevel-memory"><i class="fa fa-check"></i><b>7.12.1</b> Assessing multilevel memory</a></li>
<li class="chapter" data-level="7.12.2" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#diagnosing-the-issue-with-bias-and-beta"><i class="fa fa-check"></i><b>7.12.2</b> Diagnosing the issue with bias and beta</a></li>
<li class="chapter" data-level="7.12.3" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#multilevel-memory-with-non-centered-parameterization"><i class="fa fa-check"></i><b>7.12.3</b> Multilevel memory with non centered parameterization</a></li>
<li class="chapter" data-level="7.12.4" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#assessing-multilevel-memory-1"><i class="fa fa-check"></i><b>7.12.4</b> Assessing multilevel memory</a></li>
<li class="chapter" data-level="7.12.5" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#multilevel-memory-with-correlation-between-parameters"><i class="fa fa-check"></i><b>7.12.5</b> Multilevel memory with correlation between parameters</a></li>
<li class="chapter" data-level="7.12.6" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#assessing-multilevel-memory-2"><i class="fa fa-check"></i><b>7.12.6</b> Assessing multilevel memory</a></li>
<li class="chapter" data-level="7.12.7" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#section"><i class="fa fa-check"></i><b>7.12.7</b> </a></li>
</ul></li>
<li class="chapter" data-level="7.13" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#comparing-pooling-approaches"><i class="fa fa-check"></i><b>7.13</b> Comparing Pooling Approaches</a></li>
<li class="chapter" data-level="7.14" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#comparing-pooling-approaches-1"><i class="fa fa-check"></i><b>7.14</b> Comparing Pooling Approaches</a></li>
<li class="chapter" data-level="7.15" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#multilevel-modeling-cheatsheet"><i class="fa fa-check"></i><b>7.15</b> Multilevel Modeling Cheatsheet</a>
<ul>
<li class="chapter" data-level="7.15.1" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#when-to-use-each-pooling-approach"><i class="fa fa-check"></i><b>7.15.1</b> When to Use Each Pooling Approach:</a></li>
<li class="chapter" data-level="7.15.2" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#parameter-recovery-rules-of-thumb"><i class="fa fa-check"></i><b>7.15.2</b> Parameter Recovery Rules of Thumb:</a></li>
</ul></li>
<li class="chapter" data-level="7.16" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#conclusion-the-power-and-challenges-of-multilevel-modeling"><i class="fa fa-check"></i><b>7.16</b> Conclusion: The Power and Challenges of Multilevel Modeling</a></li>
<li class="chapter" data-level="7.17" data-path="individual-differences-in-cognitive-strategies-multilevel-modeling.html"><a href="individual-differences-in-cognitive-strategies-multilevel-modeling.html#exercises-just-some-ideas"><i class="fa fa-check"></i><b>7.17</b> Exercises (just some ideas)</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="model-comparison-in-cognitive-science.html"><a href="model-comparison-in-cognitive-science.html"><i class="fa fa-check"></i><b>8</b> Model Comparison in Cognitive Science</a>
<ul>
<li class="chapter" data-level="8.1" data-path="model-comparison-in-cognitive-science.html"><a href="model-comparison-in-cognitive-science.html#learning-objectives-2"><i class="fa fa-check"></i><b>8.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="8.2" data-path="model-comparison-in-cognitive-science.html"><a href="model-comparison-in-cognitive-science.html#why-compare-models"><i class="fa fa-check"></i><b>8.2</b> Why Compare Models?</a></li>
<li class="chapter" data-level="8.3" data-path="model-comparison-in-cognitive-science.html"><a href="model-comparison-in-cognitive-science.html#define-parameters"><i class="fa fa-check"></i><b>8.3</b> Define parameters</a></li>
<li class="chapter" data-level="8.4" data-path="model-comparison-in-cognitive-science.html"><a href="model-comparison-in-cognitive-science.html#define-biased-and-memory-agents"><i class="fa fa-check"></i><b>8.4</b> Define biased and memory agents</a></li>
<li class="chapter" data-level="8.5" data-path="model-comparison-in-cognitive-science.html"><a href="model-comparison-in-cognitive-science.html#generating-the-agents-1"><i class="fa fa-check"></i><b>8.5</b> Generating the agents</a></li>
<li class="chapter" data-level="8.6" data-path="model-comparison-in-cognitive-science.html"><a href="model-comparison-in-cognitive-science.html#prep-the-data"><i class="fa fa-check"></i><b>8.6</b> Prep the data</a></li>
<li class="chapter" data-level="8.7" data-path="model-comparison-in-cognitive-science.html"><a href="model-comparison-in-cognitive-science.html#log-posterior-likelihood"><i class="fa fa-check"></i><b>8.7</b> Log posterior likelihood</a></li>
<li class="chapter" data-level="8.8" data-path="model-comparison-in-cognitive-science.html"><a href="model-comparison-in-cognitive-science.html#create-the-models-multilevel-biased-agents"><i class="fa fa-check"></i><b>8.8</b> Create the models: multilevel biased agents</a></li>
<li class="chapter" data-level="8.9" data-path="model-comparison-in-cognitive-science.html"><a href="model-comparison-in-cognitive-science.html#multilevel-memory-model"><i class="fa fa-check"></i><b>8.9</b> Multilevel memory model</a></li>
<li class="chapter" data-level="8.10" data-path="model-comparison-in-cognitive-science.html"><a href="model-comparison-in-cognitive-science.html#fitting-the-models-to-the-data"><i class="fa fa-check"></i><b>8.10</b> Fitting the models to the data</a></li>
<li class="chapter" data-level="8.11" data-path="model-comparison-in-cognitive-science.html"><a href="model-comparison-in-cognitive-science.html#calculating-the-expected-log-predictive-density-of-a-model"><i class="fa fa-check"></i><b>8.11</b> Calculating the expected log predictive density of a model</a>
<ul>
<li class="chapter" data-level="8.11.1" data-path="model-comparison-in-cognitive-science.html"><a href="model-comparison-in-cognitive-science.html#rant-on-internal-vs-external-validity"><i class="fa fa-check"></i><b>8.11.1</b> Rant on internal vs external validity</a></li>
</ul></li>
<li class="chapter" data-level="8.12" data-path="model-comparison-in-cognitive-science.html"><a href="model-comparison-in-cognitive-science.html#implementing-cross-validation"><i class="fa fa-check"></i><b>8.12</b> Implementing Cross-Validation</a>
<ul>
<li class="chapter" data-level="8.12.1" data-path="model-comparison-in-cognitive-science.html"><a href="model-comparison-in-cognitive-science.html#create-cross-validation-ready-stan-model-for-biased-agents"><i class="fa fa-check"></i><b>8.12.1</b> Create cross-validation ready stan model for biased agents</a></li>
<li class="chapter" data-level="8.12.2" data-path="model-comparison-in-cognitive-science.html"><a href="model-comparison-in-cognitive-science.html#create-cross-validation-ready-stan-model-for-memory-agents"><i class="fa fa-check"></i><b>8.12.2</b> Create cross-validation ready stan model for memory agents</a></li>
</ul></li>
<li class="chapter" data-level="8.13" data-path="model-comparison-in-cognitive-science.html"><a href="model-comparison-in-cognitive-science.html#calculating-elpd-and-comparing"><i class="fa fa-check"></i><b>8.13</b> Calculating elpd and comparing</a></li>
<li class="chapter" data-level="8.14" data-path="model-comparison-in-cognitive-science.html"><a href="model-comparison-in-cognitive-science.html#limitations-of-model-comparison-techniques"><i class="fa fa-check"></i><b>8.14</b> Limitations of model comparison techniques</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="mixture-models.html"><a href="mixture-models.html"><i class="fa fa-check"></i><b>9</b> Mixture models</a>
<ul>
<li class="chapter" data-level="9.0.1" data-path="mixture-models.html"><a href="mixture-models.html#load-the-dataset"><i class="fa fa-check"></i><b>9.0.1</b> Load the dataset</a></li>
<li class="chapter" data-level="9.1" data-path="mixture-models.html"><a href="mixture-models.html#stan-model-mixing-biased-and-noise"><i class="fa fa-check"></i><b>9.1</b> Stan model mixing biased and noise</a></li>
<li class="chapter" data-level="9.2" data-path="mixture-models.html"><a href="mixture-models.html#fitting-and-assessing-the-model"><i class="fa fa-check"></i><b>9.2</b> Fitting and assessing the model</a></li>
<li class="chapter" data-level="9.3" data-path="mixture-models.html"><a href="mixture-models.html#basic-evaluation"><i class="fa fa-check"></i><b>9.3</b> Basic evaluation</a></li>
<li class="chapter" data-level="9.4" data-path="mixture-models.html"><a href="mixture-models.html#multilevel-mixture-model"><i class="fa fa-check"></i><b>9.4</b> Multilevel mixture model</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">07-MixtureModels</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="from-simulation-to-model-fitting" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">Chapter 5</span> From simulation to model fitting<a href="from-simulation-to-model-fitting.html#from-simulation-to-model-fitting" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This chapter introduces essential techniques for moving from theoretical models to empirical validation. Building on our implementation of decision-making agents, we now tackle the challenge of determining whether these models accurately describe observed behavior.</p>
<div id="learning-goals-2" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> Learning Goals<a href="from-simulation-to-model-fitting.html#learning-goals-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>After completing this chapter, you will be able to:</p>
<ul>
<li><p>Design and implement Bayesian parameter estimation for cognitive models using Stan</p></li>
<li><p>Create and interpret prior and posterior predictive checks to validate model behavior</p></li>
<li><p>Evaluate model quality through systematic parameter recovery studies</p></li>
</ul>
</div>
<div id="the-challenge-of-model-fitting" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> The Challenge of Model Fitting<a href="from-simulation-to-model-fitting.html#the-challenge-of-model-fitting" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Understanding human behavior requires more than just implementing plausible models - we must determine whether these models actually capture meaningful empirical patterns. Consider our biased agent model that tends to favor one choice over another. While we can specify different levels of bias in our simulations, real-world application requires determining what bias values best explain observed behavior, and for instance whether a pharmacological manipulation can affect the bias.</p>
<p>Bayesian inference provides a powerful framework for this challenge. It allows us to:</p>
<ul>
<li><p>Express our prior beliefs about reasonable parameter values</p></li>
<li><p>Update these beliefs based on observed data</p></li>
<li><p>Quantify uncertainty in our parameter estimates</p></li>
<li><p>Generate predictions that account for parameter uncertainty</p></li>
</ul>
</div>
<div id="simulating-data" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> Simulating data<a href="from-simulation-to-model-fitting.html#simulating-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>As usual we start with simulated data, where we know the underlying mechanisms and parameter values.</p>
<p>Simulated data are rarely enough (empirical data often offer unexpected challenges), but they are a great starting point to stress test your model: does the model reconstruct the right parameter values? Does it reproduce the overall patterns in the data?</p>
<p>Here we build a new simulation of random agents with bias and noise. The code and visualization is really nothing different from last chapter.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="from-simulation-to-model-fitting.html#cb50-1" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidyverse,</span>
<span id="cb50-2"><a href="from-simulation-to-model-fitting.html#cb50-2" tabindex="-1"></a>        here,</span>
<span id="cb50-3"><a href="from-simulation-to-model-fitting.html#cb50-3" tabindex="-1"></a>        posterior,</span>
<span id="cb50-4"><a href="from-simulation-to-model-fitting.html#cb50-4" tabindex="-1"></a>        cmdstanr,</span>
<span id="cb50-5"><a href="from-simulation-to-model-fitting.html#cb50-5" tabindex="-1"></a>        brms, tidybayes)</span>
<span id="cb50-6"><a href="from-simulation-to-model-fitting.html#cb50-6" tabindex="-1"></a></span>
<span id="cb50-7"><a href="from-simulation-to-model-fitting.html#cb50-7" tabindex="-1"></a>trials <span class="ot">&lt;-</span> <span class="dv">120</span></span>
<span id="cb50-8"><a href="from-simulation-to-model-fitting.html#cb50-8" tabindex="-1"></a></span>
<span id="cb50-9"><a href="from-simulation-to-model-fitting.html#cb50-9" tabindex="-1"></a>RandomAgentNoise_f <span class="ot">&lt;-</span> <span class="cf">function</span>(rate, noise) {</span>
<span id="cb50-10"><a href="from-simulation-to-model-fitting.html#cb50-10" tabindex="-1"></a></span>
<span id="cb50-11"><a href="from-simulation-to-model-fitting.html#cb50-11" tabindex="-1"></a>  choice <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">1</span>, <span class="dv">1</span>, rate) <span class="co"># generating noiseless choices</span></span>
<span id="cb50-12"><a href="from-simulation-to-model-fitting.html#cb50-12" tabindex="-1"></a>  </span>
<span id="cb50-13"><a href="from-simulation-to-model-fitting.html#cb50-13" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">rbinom</span>(<span class="dv">1</span>, <span class="dv">1</span>, noise) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb50-14"><a href="from-simulation-to-model-fitting.html#cb50-14" tabindex="-1"></a>    choice <span class="ot">=</span> <span class="fu">rbinom</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.5</span>) <span class="co"># introducing noise</span></span>
<span id="cb50-15"><a href="from-simulation-to-model-fitting.html#cb50-15" tabindex="-1"></a>  }</span>
<span id="cb50-16"><a href="from-simulation-to-model-fitting.html#cb50-16" tabindex="-1"></a>  </span>
<span id="cb50-17"><a href="from-simulation-to-model-fitting.html#cb50-17" tabindex="-1"></a>  <span class="fu">return</span>(choice)</span>
<span id="cb50-18"><a href="from-simulation-to-model-fitting.html#cb50-18" tabindex="-1"></a>}</span>
<span id="cb50-19"><a href="from-simulation-to-model-fitting.html#cb50-19" tabindex="-1"></a></span>
<span id="cb50-20"><a href="from-simulation-to-model-fitting.html#cb50-20" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb50-21"><a href="from-simulation-to-model-fitting.html#cb50-21" tabindex="-1"></a><span class="cf">for</span> (noise <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="fl">0.1</span>)) { <span class="co"># looping through noise levels</span></span>
<span id="cb50-22"><a href="from-simulation-to-model-fitting.html#cb50-22" tabindex="-1"></a></span>
<span id="cb50-23"><a href="from-simulation-to-model-fitting.html#cb50-23" tabindex="-1"></a>  <span class="cf">for</span> (rate <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>)) { <span class="co"># looping through rate levels</span></span>
<span id="cb50-24"><a href="from-simulation-to-model-fitting.html#cb50-24" tabindex="-1"></a>    randomChoice <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, trials)</span>
<span id="cb50-25"><a href="from-simulation-to-model-fitting.html#cb50-25" tabindex="-1"></a>    </span>
<span id="cb50-26"><a href="from-simulation-to-model-fitting.html#cb50-26" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="fu">seq</span>(trials)) { <span class="co"># looping through trials (to make it homologous to more reactive models)</span></span>
<span id="cb50-27"><a href="from-simulation-to-model-fitting.html#cb50-27" tabindex="-1"></a>      randomChoice[t] <span class="ot">&lt;-</span> <span class="fu">RandomAgentNoise_f</span>(rate, noise)</span>
<span id="cb50-28"><a href="from-simulation-to-model-fitting.html#cb50-28" tabindex="-1"></a>    }</span>
<span id="cb50-29"><a href="from-simulation-to-model-fitting.html#cb50-29" tabindex="-1"></a>    temp <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">trial =</span> <span class="fu">seq</span>(trials), <span class="at">choice =</span> randomChoice, rate, noise)</span>
<span id="cb50-30"><a href="from-simulation-to-model-fitting.html#cb50-30" tabindex="-1"></a>    temp<span class="sc">$</span>cumulativerate <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(temp<span class="sc">$</span>choice) <span class="sc">/</span> <span class="fu">seq_along</span>(temp<span class="sc">$</span>choice)</span>
<span id="cb50-31"><a href="from-simulation-to-model-fitting.html#cb50-31" tabindex="-1"></a></span>
<span id="cb50-32"><a href="from-simulation-to-model-fitting.html#cb50-32" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;d&quot;</span>)) {</span>
<span id="cb50-33"><a href="from-simulation-to-model-fitting.html#cb50-33" tabindex="-1"></a>      d <span class="ot">&lt;-</span> <span class="fu">rbind</span>(d, temp)</span>
<span id="cb50-34"><a href="from-simulation-to-model-fitting.html#cb50-34" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb50-35"><a href="from-simulation-to-model-fitting.html#cb50-35" tabindex="-1"></a>      d <span class="ot">&lt;-</span> temp</span>
<span id="cb50-36"><a href="from-simulation-to-model-fitting.html#cb50-36" tabindex="-1"></a>    }</span>
<span id="cb50-37"><a href="from-simulation-to-model-fitting.html#cb50-37" tabindex="-1"></a>  }</span>
<span id="cb50-38"><a href="from-simulation-to-model-fitting.html#cb50-38" tabindex="-1"></a>}</span>
<span id="cb50-39"><a href="from-simulation-to-model-fitting.html#cb50-39" tabindex="-1"></a></span>
<span id="cb50-40"><a href="from-simulation-to-model-fitting.html#cb50-40" tabindex="-1"></a><span class="fu">write_csv</span>(d, <span class="st">&quot;simdata/W3_randomnoise.csv&quot;</span>)</span>
<span id="cb50-41"><a href="from-simulation-to-model-fitting.html#cb50-41" tabindex="-1"></a></span>
<span id="cb50-42"><a href="from-simulation-to-model-fitting.html#cb50-42" tabindex="-1"></a><span class="co"># Now we visualize it </span></span>
<span id="cb50-43"><a href="from-simulation-to-model-fitting.html#cb50-43" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(d, <span class="fu">aes</span>(trial, cumulativerate, <span class="at">group =</span> rate, <span class="at">color =</span> rate)) <span class="sc">+</span> </span>
<span id="cb50-44"><a href="from-simulation-to-model-fitting.html#cb50-44" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb50-45"><a href="from-simulation-to-model-fitting.html#cb50-45" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span> </span>
<span id="cb50-46"><a href="from-simulation-to-model-fitting.html#cb50-46" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb50-47"><a href="from-simulation-to-model-fitting.html#cb50-47" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(.<span class="sc">~</span>noise) <span class="sc">+</span> </span>
<span id="cb50-48"><a href="from-simulation-to-model-fitting.html#cb50-48" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb50-49"><a href="from-simulation-to-model-fitting.html#cb50-49" tabindex="-1"></a>p1</span></code></pre></div>
<p><img src="series_files/figure-html/03%20simulating%20data-1.png" width="80%" style="display: block; margin: auto;" /></p>
</div>
<div id="building-our-basic-model-in-stan" class="section level2 hasAnchor" number="5.4">
<h2><span class="header-section-number">5.4</span> Building our basic model in Stan<a href="from-simulation-to-model-fitting.html#building-our-basic-model-in-stan" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>N.B. Refer to the video and slides for the step by step build-up of the Stan code.</p>
<p>Now we subset to a simple case, no noise and rate of 0.8, to focus on the Stan model.
We make it into the right format for Stan, build the Stan model, and fit it.</p>
<div id="data" class="section level3 hasAnchor" number="5.4.1">
<h3><span class="header-section-number">5.4.1</span> Data<a href="from-simulation-to-model-fitting.html#data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here we define the data and format it for Stan. Stan likes data as a list. Why a list? Well, dataframes (now tibbles) are amazing. But they have a big drawback: they require each variable to have the same length. Lists do not have that limitation, they are more flexible. So, lists. We’ll have to learn how to live with them.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="from-simulation-to-model-fitting.html#cb51-1" tabindex="-1"></a>d1 <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> <span class="fu">subset</span>(noise <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> rate <span class="sc">==</span> <span class="fl">0.8</span>)</span>
<span id="cb51-2"><a href="from-simulation-to-model-fitting.html#cb51-2" tabindex="-1"></a></span>
<span id="cb51-3"><a href="from-simulation-to-model-fitting.html#cb51-3" tabindex="-1"></a><span class="do">## Create the data. N.B. note the two variables have different lengths: 1 for n, n for h.</span></span>
<span id="cb51-4"><a href="from-simulation-to-model-fitting.html#cb51-4" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb51-5"><a href="from-simulation-to-model-fitting.html#cb51-5" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">120</span>,  <span class="co"># n of trials</span></span>
<span id="cb51-6"><a href="from-simulation-to-model-fitting.html#cb51-6" tabindex="-1"></a>  <span class="at">h =</span> d1<span class="sc">$</span>choice <span class="co"># sequence of choices (h stands for hand)</span></span>
<span id="cb51-7"><a href="from-simulation-to-model-fitting.html#cb51-7" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="model" class="section level3 hasAnchor" number="5.4.2">
<h3><span class="header-section-number">5.4.2</span> Model<a href="from-simulation-to-model-fitting.html#model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We write the stan code within the R code (so I can show it to you more easily), then we save it as a stan file, which can be loaded at a later stage in order to compile it. [Missing: more info on compiling etc.]</p>
<p>Remember that the minimal Stan model requires 3 chunks, one specifying the data it will need as input; one specifying the parameters to be estimated; one specifying the model within which the parameters appear, and the priors for those parameters.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="from-simulation-to-model-fitting.html#cb52-1" tabindex="-1"></a>stan_model <span class="ot">&lt;-</span> <span class="st">&quot;</span></span>
<span id="cb52-2"><a href="from-simulation-to-model-fitting.html#cb52-2" tabindex="-1"></a><span class="st">// This model infers a random bias from a sequences of 1s and 0s (right and left hand choices)</span></span>
<span id="cb52-3"><a href="from-simulation-to-model-fitting.html#cb52-3" tabindex="-1"></a></span>
<span id="cb52-4"><a href="from-simulation-to-model-fitting.html#cb52-4" tabindex="-1"></a><span class="st">// The input (data) for the model. n of trials and the sequence of choices (right as 1, left as 0)</span></span>
<span id="cb52-5"><a href="from-simulation-to-model-fitting.html#cb52-5" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb52-6"><a href="from-simulation-to-model-fitting.html#cb52-6" tabindex="-1"></a><span class="st"> int&lt;lower=1&gt; n; // n of trials</span></span>
<span id="cb52-7"><a href="from-simulation-to-model-fitting.html#cb52-7" tabindex="-1"></a><span class="st"> array[n] int h; // sequence of choices (right as 1, left as 0) as long as n</span></span>
<span id="cb52-8"><a href="from-simulation-to-model-fitting.html#cb52-8" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb52-9"><a href="from-simulation-to-model-fitting.html#cb52-9" tabindex="-1"></a></span>
<span id="cb52-10"><a href="from-simulation-to-model-fitting.html#cb52-10" tabindex="-1"></a><span class="st">// The parameters that the model needs to estimate (theta)</span></span>
<span id="cb52-11"><a href="from-simulation-to-model-fitting.html#cb52-11" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb52-12"><a href="from-simulation-to-model-fitting.html#cb52-12" tabindex="-1"></a><span class="st">  real&lt;lower=0, upper=1&gt; theta; // rate or theta is a probability and therefore bound between 0 and 1 </span></span>
<span id="cb52-13"><a href="from-simulation-to-model-fitting.html#cb52-13" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb52-14"><a href="from-simulation-to-model-fitting.html#cb52-14" tabindex="-1"></a></span>
<span id="cb52-15"><a href="from-simulation-to-model-fitting.html#cb52-15" tabindex="-1"></a><span class="st">// The model to be estimated (a bernoulli, parameter theta, prior on the theta)</span></span>
<span id="cb52-16"><a href="from-simulation-to-model-fitting.html#cb52-16" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb52-17"><a href="from-simulation-to-model-fitting.html#cb52-17" tabindex="-1"></a><span class="st">  // The prior for theta is a beta distribution alpha of 1, beta of 1, equivalent to a uniform between 0 and 1 </span></span>
<span id="cb52-18"><a href="from-simulation-to-model-fitting.html#cb52-18" tabindex="-1"></a><span class="st">  target += beta_lpdf(theta | 1, 1);</span></span>
<span id="cb52-19"><a href="from-simulation-to-model-fitting.html#cb52-19" tabindex="-1"></a><span class="st">  // N.B. you could also define the parameters of the priors as variables to be found in the data</span></span>
<span id="cb52-20"><a href="from-simulation-to-model-fitting.html#cb52-20" tabindex="-1"></a><span class="st">  // target += beta_lpdf(theta | beta_alpha, beta_beta); BUT remember to add beta_alpha and beta_beta to the data list</span></span>
<span id="cb52-21"><a href="from-simulation-to-model-fitting.html#cb52-21" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb52-22"><a href="from-simulation-to-model-fitting.html#cb52-22" tabindex="-1"></a><span class="st">  // The model consists of a bernoulli distribution (binomial w 1 trial only) with a rate theta</span></span>
<span id="cb52-23"><a href="from-simulation-to-model-fitting.html#cb52-23" tabindex="-1"></a><span class="st">  target += bernoulli_lpmf(h | theta);</span></span>
<span id="cb52-24"><a href="from-simulation-to-model-fitting.html#cb52-24" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb52-25"><a href="from-simulation-to-model-fitting.html#cb52-25" tabindex="-1"></a><span class="st">&quot;</span></span>
<span id="cb52-26"><a href="from-simulation-to-model-fitting.html#cb52-26" tabindex="-1"></a><span class="fu">write_stan_file</span>(</span>
<span id="cb52-27"><a href="from-simulation-to-model-fitting.html#cb52-27" tabindex="-1"></a>  stan_model,</span>
<span id="cb52-28"><a href="from-simulation-to-model-fitting.html#cb52-28" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">&quot;stan/&quot;</span>,</span>
<span id="cb52-29"><a href="from-simulation-to-model-fitting.html#cb52-29" tabindex="-1"></a>  <span class="at">basename =</span> <span class="st">&quot;W3_SimpleBernoulli.stan&quot;</span>)</span></code></pre></div>
</div>
<div id="compiling-and-fitting-the-model" class="section level3 hasAnchor" number="5.4.3">
<h3><span class="header-section-number">5.4.3</span> Compiling and fitting the model<a href="from-simulation-to-model-fitting.html#compiling-and-fitting-the-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="from-simulation-to-model-fitting.html#cb53-1" tabindex="-1"></a><span class="do">## Specify where the model is</span></span>
<span id="cb53-2"><a href="from-simulation-to-model-fitting.html#cb53-2" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">&quot;stan/W3_SimpleBernoulli.stan&quot;</span>)</span>
<span id="cb53-3"><a href="from-simulation-to-model-fitting.html#cb53-3" tabindex="-1"></a></span>
<span id="cb53-4"><a href="from-simulation-to-model-fitting.html#cb53-4" tabindex="-1"></a><span class="co"># Compile the model</span></span>
<span id="cb53-5"><a href="from-simulation-to-model-fitting.html#cb53-5" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(file, </span>
<span id="cb53-6"><a href="from-simulation-to-model-fitting.html#cb53-6" tabindex="-1"></a>                     <span class="co"># this specifies we can parallelize the gradient estimations on multiple cores</span></span>
<span id="cb53-7"><a href="from-simulation-to-model-fitting.html#cb53-7" tabindex="-1"></a>                     <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">TRUE</span>), </span>
<span id="cb53-8"><a href="from-simulation-to-model-fitting.html#cb53-8" tabindex="-1"></a>                     <span class="co"># this is a trick to make it faster</span></span>
<span id="cb53-9"><a href="from-simulation-to-model-fitting.html#cb53-9" tabindex="-1"></a>                     <span class="at">stanc_options =</span> <span class="fu">list</span>(<span class="st">&quot;O1&quot;</span>)) </span>
<span id="cb53-10"><a href="from-simulation-to-model-fitting.html#cb53-10" tabindex="-1"></a></span>
<span id="cb53-11"><a href="from-simulation-to-model-fitting.html#cb53-11" tabindex="-1"></a><span class="co"># The following command calls Stan with specific options.</span></span>
<span id="cb53-12"><a href="from-simulation-to-model-fitting.html#cb53-12" tabindex="-1"></a>samples <span class="ot">&lt;-</span> mod<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb53-13"><a href="from-simulation-to-model-fitting.html#cb53-13" tabindex="-1"></a>  <span class="at">data =</span> data, <span class="co"># the data :-)</span></span>
<span id="cb53-14"><a href="from-simulation-to-model-fitting.html#cb53-14" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span>,  <span class="co"># a seed, so I always get the same results</span></span>
<span id="cb53-15"><a href="from-simulation-to-model-fitting.html#cb53-15" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">2</span>,  <span class="co"># how many chains should I fit (to check whether they give the same results)</span></span>
<span id="cb53-16"><a href="from-simulation-to-model-fitting.html#cb53-16" tabindex="-1"></a>  <span class="at">parallel_chains =</span> <span class="dv">2</span>, <span class="co"># how many of the chains can be run in parallel?</span></span>
<span id="cb53-17"><a href="from-simulation-to-model-fitting.html#cb53-17" tabindex="-1"></a>  <span class="at">threads_per_chain =</span> <span class="dv">2</span>, <span class="co"># distribute gradient estimations within chain across multiple cores</span></span>
<span id="cb53-18"><a href="from-simulation-to-model-fitting.html#cb53-18" tabindex="-1"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>,  <span class="co"># warmup iterations through which hyperparameters (steps and step length) are adjusted</span></span>
<span id="cb53-19"><a href="from-simulation-to-model-fitting.html#cb53-19" tabindex="-1"></a>  <span class="at">iter_sampling =</span> <span class="dv">2000</span>, <span class="co"># total number of iterations</span></span>
<span id="cb53-20"><a href="from-simulation-to-model-fitting.html#cb53-20" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">0</span>,  <span class="co"># how often to show that iterations have been run</span></span>
<span id="cb53-21"><a href="from-simulation-to-model-fitting.html#cb53-21" tabindex="-1"></a>  <span class="at">output_dir =</span> <span class="st">&quot;simmodels&quot;</span>, <span class="co"># saves the samples as csv so it can be later loaded</span></span>
<span id="cb53-22"><a href="from-simulation-to-model-fitting.html#cb53-22" tabindex="-1"></a>  <span class="at">max_treedepth =</span> <span class="dv">20</span>, <span class="co"># how many steps in the future to check to avoid u-turns</span></span>
<span id="cb53-23"><a href="from-simulation-to-model-fitting.html#cb53-23" tabindex="-1"></a>  <span class="at">adapt_delta =</span> <span class="fl">0.99</span>, <span class="co"># how high a learning rate to adjust hyperparameters during warmup</span></span>
<span id="cb53-24"><a href="from-simulation-to-model-fitting.html#cb53-24" tabindex="-1"></a>)</span>
<span id="cb53-25"><a href="from-simulation-to-model-fitting.html#cb53-25" tabindex="-1"></a></span>
<span id="cb53-26"><a href="from-simulation-to-model-fitting.html#cb53-26" tabindex="-1"></a><span class="co"># Same the fitted model</span></span>
<span id="cb53-27"><a href="from-simulation-to-model-fitting.html#cb53-27" tabindex="-1"></a>samples<span class="sc">$</span><span class="fu">save_object</span>(<span class="st">&quot;simmodels/W3_SimpleBernoulli.rds&quot;</span>)</span></code></pre></div>
</div>
<div id="summarizing-the-model" class="section level3 hasAnchor" number="5.4.4">
<h3><span class="header-section-number">5.4.4</span> Summarizing the model<a href="from-simulation-to-model-fitting.html#summarizing-the-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now the model is ready to be assessed. First we simply generate a summary of the estimates to have a first idea.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="from-simulation-to-model-fitting.html#cb54-1" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;simmodels/W3_SimpleBernoulli.rds&quot;</span>)</span>
<span id="cb54-2"><a href="from-simulation-to-model-fitting.html#cb54-2" tabindex="-1"></a></span>
<span id="cb54-3"><a href="from-simulation-to-model-fitting.html#cb54-3" tabindex="-1"></a>samples<span class="sc">$</span><span class="fu">summary</span>() <span class="co"># summarize the model</span></span></code></pre></div>
<pre><code>## # A tibble: 2 × 10
##   variable    mean  median     sd    mad      q5     q95  rhat ess_bulk ess_tail
##   &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
## 1 lp__     -54.9   -54.7   0.739  0.324  -56.4   -54.4    1.00     991.     987.
## 2 theta      0.835   0.837 0.0342 0.0340   0.775   0.887  1.00    1117.    1012.</code></pre>
</div>
<div id="assessing-model-quality" class="section level3 hasAnchor" number="5.4.5">
<h3><span class="header-section-number">5.4.5</span> Assessing model quality<a href="from-simulation-to-model-fitting.html#assessing-model-quality" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Then we need to look more in the details at the quality of the estimation:
* the markov chains
* how the prior and the posterior estimates relate to each other (whether the prior is constraining the posterior estimate)</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="from-simulation-to-model-fitting.html#cb56-1" tabindex="-1"></a><span class="co"># Extract posterior samples and include sampling of the prior:</span></span>
<span id="cb56-2"><a href="from-simulation-to-model-fitting.html#cb56-2" tabindex="-1"></a>draws_df <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(samples<span class="sc">$</span><span class="fu">draws</span>())</span>
<span id="cb56-3"><a href="from-simulation-to-model-fitting.html#cb56-3" tabindex="-1"></a></span>
<span id="cb56-4"><a href="from-simulation-to-model-fitting.html#cb56-4" tabindex="-1"></a><span class="co"># Checking the model&#39;s chains</span></span>
<span id="cb56-5"><a href="from-simulation-to-model-fitting.html#cb56-5" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df, <span class="fu">aes</span>(.iteration, theta, <span class="at">group =</span> .chain, <span class="at">color =</span> .chain)) <span class="sc">+</span></span>
<span id="cb56-6"><a href="from-simulation-to-model-fitting.html#cb56-6" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb56-7"><a href="from-simulation-to-model-fitting.html#cb56-7" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="series_files/figure-html/03%20biased%20model%20quality-1.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="from-simulation-to-model-fitting.html#cb57-1" tabindex="-1"></a><span class="co"># add a prior for theta (ugly, but we&#39;ll do better soon)</span></span>
<span id="cb57-2"><a href="from-simulation-to-model-fitting.html#cb57-2" tabindex="-1"></a>draws_df <span class="ot">&lt;-</span> draws_df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb57-3"><a href="from-simulation-to-model-fitting.html#cb57-3" tabindex="-1"></a>  <span class="at">theta_prior =</span> <span class="fu">rbeta</span>(<span class="fu">nrow</span>(draws_df), <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb57-4"><a href="from-simulation-to-model-fitting.html#cb57-4" tabindex="-1"></a>)</span>
<span id="cb57-5"><a href="from-simulation-to-model-fitting.html#cb57-5" tabindex="-1"></a></span>
<span id="cb57-6"><a href="from-simulation-to-model-fitting.html#cb57-6" tabindex="-1"></a><span class="co"># Now let&#39;s plot the density for theta (prior and posterior)</span></span>
<span id="cb57-7"><a href="from-simulation-to-model-fitting.html#cb57-7" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df) <span class="sc">+</span></span>
<span id="cb57-8"><a href="from-simulation-to-model-fitting.html#cb57-8" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(theta), <span class="at">fill =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb57-9"><a href="from-simulation-to-model-fitting.html#cb57-9" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(theta_prior), <span class="at">fill =</span> <span class="st">&quot;red&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb57-10"><a href="from-simulation-to-model-fitting.html#cb57-10" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">0.8</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb57-11"><a href="from-simulation-to-model-fitting.html#cb57-11" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Rate&quot;</span>) <span class="sc">+</span></span>
<span id="cb57-12"><a href="from-simulation-to-model-fitting.html#cb57-12" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Posterior Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb57-13"><a href="from-simulation-to-model-fitting.html#cb57-13" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="series_files/figure-html/03%20biased%20model%20quality-2.png" width="80%" style="display: block; margin: auto;" /></p>
<p>As we can see from the posterior estimates and the prior posterior update check, our model is doing a decent job. It doesn’t exactly reconstruct the rate of 0.8, but 0.755 is pretty close and 0.8 is included within the credible interval.</p>
<p>Now we build the same model, but using the log odds scale for the theta parameter, which will become useful later when we condition theta on variables and build multilevel models (as we can do what we want in a log odds space and it will always be bound between 0 and 1).</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="from-simulation-to-model-fitting.html#cb58-1" tabindex="-1"></a>stan_model <span class="ot">&lt;-</span> <span class="st">&quot;</span></span>
<span id="cb58-2"><a href="from-simulation-to-model-fitting.html#cb58-2" tabindex="-1"></a><span class="st">// This model infers a random bias from a sequences of 1s and 0s (right and left hand choices)</span></span>
<span id="cb58-3"><a href="from-simulation-to-model-fitting.html#cb58-3" tabindex="-1"></a></span>
<span id="cb58-4"><a href="from-simulation-to-model-fitting.html#cb58-4" tabindex="-1"></a><span class="st">// The input (data) for the model. n of trials and the sequence of choices (right as 1, left as 0)</span></span>
<span id="cb58-5"><a href="from-simulation-to-model-fitting.html#cb58-5" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb58-6"><a href="from-simulation-to-model-fitting.html#cb58-6" tabindex="-1"></a><span class="st"> int&lt;lower=1&gt; n; // n of trials</span></span>
<span id="cb58-7"><a href="from-simulation-to-model-fitting.html#cb58-7" tabindex="-1"></a><span class="st"> array[n] int h; // sequence of choices (right as 1, left as 0) as long as n</span></span>
<span id="cb58-8"><a href="from-simulation-to-model-fitting.html#cb58-8" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb58-9"><a href="from-simulation-to-model-fitting.html#cb58-9" tabindex="-1"></a></span>
<span id="cb58-10"><a href="from-simulation-to-model-fitting.html#cb58-10" tabindex="-1"></a><span class="st">// The parameters that the model needs to estimate (theta)</span></span>
<span id="cb58-11"><a href="from-simulation-to-model-fitting.html#cb58-11" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb58-12"><a href="from-simulation-to-model-fitting.html#cb58-12" tabindex="-1"></a><span class="st">    real theta; // note it is unbounded as we now work on log odds</span></span>
<span id="cb58-13"><a href="from-simulation-to-model-fitting.html#cb58-13" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb58-14"><a href="from-simulation-to-model-fitting.html#cb58-14" tabindex="-1"></a></span>
<span id="cb58-15"><a href="from-simulation-to-model-fitting.html#cb58-15" tabindex="-1"></a><span class="st">// The model to be estimated (a bernoulli, parameter theta, prior on the theta)</span></span>
<span id="cb58-16"><a href="from-simulation-to-model-fitting.html#cb58-16" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb58-17"><a href="from-simulation-to-model-fitting.html#cb58-17" tabindex="-1"></a><span class="st">  // The prior for theta on a log odds scale is a normal distribution with a mean of 0 and a sd of 1.</span></span>
<span id="cb58-18"><a href="from-simulation-to-model-fitting.html#cb58-18" tabindex="-1"></a><span class="st">  // This covers most of the probability space between 0 and 1, after being converted to probability.</span></span>
<span id="cb58-19"><a href="from-simulation-to-model-fitting.html#cb58-19" tabindex="-1"></a><span class="st">  target += normal_lpdf(theta | 0, 1);</span></span>
<span id="cb58-20"><a href="from-simulation-to-model-fitting.html#cb58-20" tabindex="-1"></a><span class="st">  // as before the parameters of the prior could be fed as variables</span></span>
<span id="cb58-21"><a href="from-simulation-to-model-fitting.html#cb58-21" tabindex="-1"></a><span class="st">  // target += normal_lpdf(theta | normal_mu, normal_sigma);</span></span>
<span id="cb58-22"><a href="from-simulation-to-model-fitting.html#cb58-22" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb58-23"><a href="from-simulation-to-model-fitting.html#cb58-23" tabindex="-1"></a><span class="st">  // The model consists of a bernoulli distribution (binomial w 1 trial only) with a rate theta,</span></span>
<span id="cb58-24"><a href="from-simulation-to-model-fitting.html#cb58-24" tabindex="-1"></a><span class="st">  // note we specify it uses a logit link (theta is in logodds)</span></span>
<span id="cb58-25"><a href="from-simulation-to-model-fitting.html#cb58-25" tabindex="-1"></a><span class="st">  target += bernoulli_logit_lpmf(h | theta);</span></span>
<span id="cb58-26"><a href="from-simulation-to-model-fitting.html#cb58-26" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb58-27"><a href="from-simulation-to-model-fitting.html#cb58-27" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb58-28"><a href="from-simulation-to-model-fitting.html#cb58-28" tabindex="-1"></a><span class="st">&quot;</span></span>
<span id="cb58-29"><a href="from-simulation-to-model-fitting.html#cb58-29" tabindex="-1"></a><span class="fu">write_stan_file</span>(</span>
<span id="cb58-30"><a href="from-simulation-to-model-fitting.html#cb58-30" tabindex="-1"></a>  stan_model,</span>
<span id="cb58-31"><a href="from-simulation-to-model-fitting.html#cb58-31" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">&quot;stan/&quot;</span>,</span>
<span id="cb58-32"><a href="from-simulation-to-model-fitting.html#cb58-32" tabindex="-1"></a>  <span class="at">basename =</span> <span class="st">&quot;W3_SimpleBernoulli_logodds.stan&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;/Users/au209589/Dropbox/Teaching/AdvancedCognitiveModeling23_book/stan/W3_SimpleBernoulli_logodds.stan&quot;</code></pre>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="from-simulation-to-model-fitting.html#cb60-1" tabindex="-1"></a><span class="do">## With the logit format</span></span>
<span id="cb60-2"><a href="from-simulation-to-model-fitting.html#cb60-2" tabindex="-1"></a><span class="do">## Specify where the model is</span></span>
<span id="cb60-3"><a href="from-simulation-to-model-fitting.html#cb60-3" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">&quot;stan/W3_SimpleBernoulli_logodds.stan&quot;</span>)</span>
<span id="cb60-4"><a href="from-simulation-to-model-fitting.html#cb60-4" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(file, </span>
<span id="cb60-5"><a href="from-simulation-to-model-fitting.html#cb60-5" tabindex="-1"></a>                     <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">TRUE</span>),</span>
<span id="cb60-6"><a href="from-simulation-to-model-fitting.html#cb60-6" tabindex="-1"></a>                     <span class="at">stanc_options =</span> <span class="fu">list</span>(<span class="st">&quot;O1&quot;</span>))</span>
<span id="cb60-7"><a href="from-simulation-to-model-fitting.html#cb60-7" tabindex="-1"></a></span>
<span id="cb60-8"><a href="from-simulation-to-model-fitting.html#cb60-8" tabindex="-1"></a><span class="co"># The following command calls Stan with specific options.</span></span>
<span id="cb60-9"><a href="from-simulation-to-model-fitting.html#cb60-9" tabindex="-1"></a>samples <span class="ot">&lt;-</span> mod<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb60-10"><a href="from-simulation-to-model-fitting.html#cb60-10" tabindex="-1"></a>  <span class="at">data =</span> data,</span>
<span id="cb60-11"><a href="from-simulation-to-model-fitting.html#cb60-11" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb60-12"><a href="from-simulation-to-model-fitting.html#cb60-12" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb60-13"><a href="from-simulation-to-model-fitting.html#cb60-13" tabindex="-1"></a>  <span class="at">parallel_chains =</span> <span class="dv">2</span>,</span>
<span id="cb60-14"><a href="from-simulation-to-model-fitting.html#cb60-14" tabindex="-1"></a>  <span class="at">threads_per_chain =</span> <span class="dv">2</span>,</span>
<span id="cb60-15"><a href="from-simulation-to-model-fitting.html#cb60-15" tabindex="-1"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb60-16"><a href="from-simulation-to-model-fitting.html#cb60-16" tabindex="-1"></a>  <span class="at">iter_sampling =</span> <span class="dv">2000</span>,</span>
<span id="cb60-17"><a href="from-simulation-to-model-fitting.html#cb60-17" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">0</span>,</span>
<span id="cb60-18"><a href="from-simulation-to-model-fitting.html#cb60-18" tabindex="-1"></a>  <span class="at">output_dir =</span> <span class="st">&quot;simmodels&quot;</span>,</span>
<span id="cb60-19"><a href="from-simulation-to-model-fitting.html#cb60-19" tabindex="-1"></a>  <span class="at">max_treedepth =</span> <span class="dv">20</span>,</span>
<span id="cb60-20"><a href="from-simulation-to-model-fitting.html#cb60-20" tabindex="-1"></a>  <span class="at">adapt_delta =</span> <span class="fl">0.99</span>,</span>
<span id="cb60-21"><a href="from-simulation-to-model-fitting.html#cb60-21" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Running MCMC with 2 parallel chains, with 2 thread(s) per chain...
## 
## Chain 1 finished in 0.0 seconds.
## Chain 2 finished in 0.1 seconds.
## 
## Both chains finished successfully.
## Mean chain execution time: 0.0 seconds.
## Total execution time: 0.4 seconds.</code></pre>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="from-simulation-to-model-fitting.html#cb62-1" tabindex="-1"></a><span class="co"># Same the fitted model</span></span>
<span id="cb62-2"><a href="from-simulation-to-model-fitting.html#cb62-2" tabindex="-1"></a>samples<span class="sc">$</span><span class="fu">save_object</span>(<span class="st">&quot;simmodels/W3_SimpleBernoulli_logodds.rds&quot;</span>)</span></code></pre></div>
</div>
<div id="summarizing-the-results" class="section level3 hasAnchor" number="5.4.6">
<h3><span class="header-section-number">5.4.6</span> Summarizing the results<a href="from-simulation-to-model-fitting.html#summarizing-the-results" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="from-simulation-to-model-fitting.html#cb63-1" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;simmodels/W3_SimpleBernoulli_logodds.rds&quot;</span>)</span>
<span id="cb63-2"><a href="from-simulation-to-model-fitting.html#cb63-2" tabindex="-1"></a><span class="co"># Diagnostics</span></span>
<span id="cb63-3"><a href="from-simulation-to-model-fitting.html#cb63-3" tabindex="-1"></a>samples<span class="sc">$</span><span class="fu">cmdstan_diagnose</span>()</span></code></pre></div>
<pre><code>## Checking sampler transitions treedepth.
## Treedepth satisfactory for all transitions.
## 
## Checking sampler transitions for divergences.
## No divergent transitions found.
## 
## Checking E-BFMI - sampler transitions HMC potential energy.
## E-BFMI satisfactory.
## 
## Rank-normalized split effective sample size satisfactory for all parameters.
## 
## Rank-normalized split R-hat values satisfactory for all parameters.
## 
## Processing complete, no problems detected.</code></pre>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="from-simulation-to-model-fitting.html#cb65-1" tabindex="-1"></a><span class="co"># Extract posterior samples and include sampling of the prior:</span></span>
<span id="cb65-2"><a href="from-simulation-to-model-fitting.html#cb65-2" tabindex="-1"></a>draws_df <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(samples<span class="sc">$</span><span class="fu">draws</span>()) </span>
<span id="cb65-3"><a href="from-simulation-to-model-fitting.html#cb65-3" tabindex="-1"></a></span>
<span id="cb65-4"><a href="from-simulation-to-model-fitting.html#cb65-4" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df, <span class="fu">aes</span>(.iteration, theta, <span class="at">group =</span> .chain, <span class="at">color =</span> .chain)) <span class="sc">+</span></span>
<span id="cb65-5"><a href="from-simulation-to-model-fitting.html#cb65-5" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb65-6"><a href="from-simulation-to-model-fitting.html#cb65-6" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="series_files/figure-html/03%20biased%20model%20log-odds%20quality%20assessment-1.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="from-simulation-to-model-fitting.html#cb66-1" tabindex="-1"></a><span class="co"># add a prior for theta (ugly, but we&#39;ll do better soon)</span></span>
<span id="cb66-2"><a href="from-simulation-to-model-fitting.html#cb66-2" tabindex="-1"></a>draws_df <span class="ot">&lt;-</span> draws_df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb66-3"><a href="from-simulation-to-model-fitting.html#cb66-3" tabindex="-1"></a>  <span class="at">theta_prior =</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(draws_df), <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb66-4"><a href="from-simulation-to-model-fitting.html#cb66-4" tabindex="-1"></a>)</span>
<span id="cb66-5"><a href="from-simulation-to-model-fitting.html#cb66-5" tabindex="-1"></a></span>
<span id="cb66-6"><a href="from-simulation-to-model-fitting.html#cb66-6" tabindex="-1"></a><span class="co"># Now let&#39;s plot the density for theta (prior and posterior)</span></span>
<span id="cb66-7"><a href="from-simulation-to-model-fitting.html#cb66-7" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df) <span class="sc">+</span></span>
<span id="cb66-8"><a href="from-simulation-to-model-fitting.html#cb66-8" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(theta), <span class="at">fill =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb66-9"><a href="from-simulation-to-model-fitting.html#cb66-9" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(theta_prior), <span class="at">fill =</span> <span class="st">&quot;red&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb66-10"><a href="from-simulation-to-model-fitting.html#cb66-10" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">1.38</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb66-11"><a href="from-simulation-to-model-fitting.html#cb66-11" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Rate&quot;</span>) <span class="sc">+</span></span>
<span id="cb66-12"><a href="from-simulation-to-model-fitting.html#cb66-12" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Posterior Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb66-13"><a href="from-simulation-to-model-fitting.html#cb66-13" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="series_files/figure-html/03%20biased%20model%20log-odds%20quality%20assessment-2.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="from-simulation-to-model-fitting.html#cb67-1" tabindex="-1"></a><span class="co"># Summary</span></span>
<span id="cb67-2"><a href="from-simulation-to-model-fitting.html#cb67-2" tabindex="-1"></a>samples<span class="sc">$</span><span class="fu">summary</span>()</span></code></pre></div>
<pre><code>## # A tibble: 2 × 10
##   variable   mean median    sd   mad     q5    q95  rhat ess_bulk ess_tail
##   &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
## 1 lp__     -59.6  -59.4  0.672 0.319 -60.9  -59.1   1.00    1371.    1245.
## 2 theta      1.42   1.41 0.221 0.230   1.06   1.78  1.00    1088.    1391.</code></pre>
<p>We can see that the results are very similar.</p>
</div>
</div>
<div id="parameter-recovery" class="section level2 hasAnchor" number="5.5">
<h2><span class="header-section-number">5.5</span> Parameter recovery<a href="from-simulation-to-model-fitting.html#parameter-recovery" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Now that we see that the model works in one case, we can run it throughout all possible rate and noise levels in the simulation. N.B. here is using loops, parallelized version in the next code chunk.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="from-simulation-to-model-fitting.html#cb69-1" tabindex="-1"></a><span class="co"># Now we need to scale it up to all possible rates and noises</span></span>
<span id="cb69-2"><a href="from-simulation-to-model-fitting.html#cb69-2" tabindex="-1"></a><span class="co"># recovery_df &lt;- NULL</span></span>
<span id="cb69-3"><a href="from-simulation-to-model-fitting.html#cb69-3" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb69-4"><a href="from-simulation-to-model-fitting.html#cb69-4" tabindex="-1"></a><span class="co"># for (noiseLvl in unique(d$noise)) {</span></span>
<span id="cb69-5"><a href="from-simulation-to-model-fitting.html#cb69-5" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb69-6"><a href="from-simulation-to-model-fitting.html#cb69-6" tabindex="-1"></a><span class="co">#   for (rateLvl in unique(d$rate)) {</span></span>
<span id="cb69-7"><a href="from-simulation-to-model-fitting.html#cb69-7" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb69-8"><a href="from-simulation-to-model-fitting.html#cb69-8" tabindex="-1"></a><span class="co">#     dd &lt;- d %&gt;% subset(</span></span>
<span id="cb69-9"><a href="from-simulation-to-model-fitting.html#cb69-9" tabindex="-1"></a><span class="co">#       noise == noiseLvl  &amp; rate == rateLvl</span></span>
<span id="cb69-10"><a href="from-simulation-to-model-fitting.html#cb69-10" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb69-11"><a href="from-simulation-to-model-fitting.html#cb69-11" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb69-12"><a href="from-simulation-to-model-fitting.html#cb69-12" tabindex="-1"></a><span class="co">#     data &lt;- list(</span></span>
<span id="cb69-13"><a href="from-simulation-to-model-fitting.html#cb69-13" tabindex="-1"></a><span class="co">#       n = 120,</span></span>
<span id="cb69-14"><a href="from-simulation-to-model-fitting.html#cb69-14" tabindex="-1"></a><span class="co">#       h = dd$choice</span></span>
<span id="cb69-15"><a href="from-simulation-to-model-fitting.html#cb69-15" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb69-16"><a href="from-simulation-to-model-fitting.html#cb69-16" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb69-17"><a href="from-simulation-to-model-fitting.html#cb69-17" tabindex="-1"></a><span class="co">#     samples &lt;- mod$sample(</span></span>
<span id="cb69-18"><a href="from-simulation-to-model-fitting.html#cb69-18" tabindex="-1"></a><span class="co">#       data = data,</span></span>
<span id="cb69-19"><a href="from-simulation-to-model-fitting.html#cb69-19" tabindex="-1"></a><span class="co">#       seed = 123,</span></span>
<span id="cb69-20"><a href="from-simulation-to-model-fitting.html#cb69-20" tabindex="-1"></a><span class="co">#       chains = 1,</span></span>
<span id="cb69-21"><a href="from-simulation-to-model-fitting.html#cb69-21" tabindex="-1"></a><span class="co">#       parallel_chains = 1,</span></span>
<span id="cb69-22"><a href="from-simulation-to-model-fitting.html#cb69-22" tabindex="-1"></a><span class="co">#       threads_per_chain = 1,</span></span>
<span id="cb69-23"><a href="from-simulation-to-model-fitting.html#cb69-23" tabindex="-1"></a><span class="co">#       iter_warmup = 1000,</span></span>
<span id="cb69-24"><a href="from-simulation-to-model-fitting.html#cb69-24" tabindex="-1"></a><span class="co">#       iter_sampling = 2000,</span></span>
<span id="cb69-25"><a href="from-simulation-to-model-fitting.html#cb69-25" tabindex="-1"></a><span class="co">#       refresh = 0,</span></span>
<span id="cb69-26"><a href="from-simulation-to-model-fitting.html#cb69-26" tabindex="-1"></a><span class="co">#       max_treedepth = 20,</span></span>
<span id="cb69-27"><a href="from-simulation-to-model-fitting.html#cb69-27" tabindex="-1"></a><span class="co">#       adapt_delta = 0.99,</span></span>
<span id="cb69-28"><a href="from-simulation-to-model-fitting.html#cb69-28" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb69-29"><a href="from-simulation-to-model-fitting.html#cb69-29" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb69-30"><a href="from-simulation-to-model-fitting.html#cb69-30" tabindex="-1"></a><span class="co">#     draws_df &lt;- as_draws_df(samples$draws()) </span></span>
<span id="cb69-31"><a href="from-simulation-to-model-fitting.html#cb69-31" tabindex="-1"></a><span class="co">#     temp &lt;- tibble(biasEst = inv_logit_scaled(draws_df$theta), </span></span>
<span id="cb69-32"><a href="from-simulation-to-model-fitting.html#cb69-32" tabindex="-1"></a><span class="co">#                    biasTrue = rateLvl, noise = noiseLvl)</span></span>
<span id="cb69-33"><a href="from-simulation-to-model-fitting.html#cb69-33" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb69-34"><a href="from-simulation-to-model-fitting.html#cb69-34" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb69-35"><a href="from-simulation-to-model-fitting.html#cb69-35" tabindex="-1"></a><span class="co">#     if (exists(&quot;recovery_df&quot;)) {recovery_df &lt;- rbind(recovery_df, temp)} else {recovery_df &lt;- temp}</span></span>
<span id="cb69-36"><a href="from-simulation-to-model-fitting.html#cb69-36" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb69-37"><a href="from-simulation-to-model-fitting.html#cb69-37" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb69-38"><a href="from-simulation-to-model-fitting.html#cb69-38" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb69-39"><a href="from-simulation-to-model-fitting.html#cb69-39" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb69-40"><a href="from-simulation-to-model-fitting.html#cb69-40" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb69-41"><a href="from-simulation-to-model-fitting.html#cb69-41" tabindex="-1"></a><span class="co"># write_csv(recovery_df, &quot;simdata/W3_recoverydf_simple.csv&quot;)</span></span></code></pre></div>
<p>Now we can look at the relation between the “true” bias value we inputted in the simulation and the inferred bias value - the posterior estimates of bias.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="from-simulation-to-model-fitting.html#cb70-1" tabindex="-1"></a>recovery_df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;simdata/W3_recoverydf_simple.csv&quot;</span>)</span>
<span id="cb70-2"><a href="from-simulation-to-model-fitting.html#cb70-2" tabindex="-1"></a></span>
<span id="cb70-3"><a href="from-simulation-to-model-fitting.html#cb70-3" tabindex="-1"></a><span class="fu">ggplot</span>(recovery_df, <span class="fu">aes</span>(biasTrue, biasEst)) <span class="sc">+</span></span>
<span id="cb70-4"><a href="from-simulation-to-model-fitting.html#cb70-4" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb70-5"><a href="from-simulation-to-model-fitting.html#cb70-5" tabindex="-1"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb70-6"><a href="from-simulation-to-model-fitting.html#cb70-6" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(.<span class="sc">~</span>noise) <span class="sc">+</span></span>
<span id="cb70-7"><a href="from-simulation-to-model-fitting.html#cb70-7" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="series_files/figure-html/03%20plot%20parameter%20recovery-1.png" width="80%" style="display: block; margin: auto;" /></p>
<p>There’s much to be said about the final plot, but for now let’s just say that it looks good. We can reconstruct in a nice ordered way true rate values. However, our ability to do so decreases with the increase in noise. So far no surprises. Wait, you say, shouldn’t we actually model the generative process, that is, include noise in the Stan model? Gold star, there! But let’s wait a bit before we get there, we’ll need mixture models.</p>
<p>One final note before moving to the memory model: what if we parallelized the parameter recovery, so that different models / datasets run on different cores? This was not necessary above (it ran in a few minutes anyway), but will become crucial with more complex models.</p>
<p>To parallelize, we rely on furrr, a neat R package that distributes parallel operations across cores.
First we need to define the function that will define the operations to be run on each core separately, here we simulate the data according to a seed, a n of trials, a rate and a noise, and then we fit the model to them.
Second, we need to create a tibble of the seeds, n of trials, rate and noise values that should be simulated.
Third, we use future_pmap_dfr to run the function on each row of the tibble above separately on a different core. Note that I set the system to split across 4 parallel cores (to work on my computer without clogging it). Do change it according to the system you are using. Note that if you have 40 “jobs” (rows of the tibble, sets of parameter values to run), using e.g. 32 cores will not substantially speed things more than using 20.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="from-simulation-to-model-fitting.html#cb71-1" tabindex="-1"></a><span class="co"># pacman::p_load(future, purrr, furrr)</span></span>
<span id="cb71-2"><a href="from-simulation-to-model-fitting.html#cb71-2" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb71-3"><a href="from-simulation-to-model-fitting.html#cb71-3" tabindex="-1"></a><span class="co"># plan(multisession, workers = 4)</span></span>
<span id="cb71-4"><a href="from-simulation-to-model-fitting.html#cb71-4" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb71-5"><a href="from-simulation-to-model-fitting.html#cb71-5" tabindex="-1"></a><span class="co"># sim_d_and_fit &lt;- function(seed, trials, rateLvl, noiseLvl) {</span></span>
<span id="cb71-6"><a href="from-simulation-to-model-fitting.html#cb71-6" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb71-7"><a href="from-simulation-to-model-fitting.html#cb71-7" tabindex="-1"></a><span class="co">#     for (t in seq(trials)) { # looping through trials (to make it homologous to more reactive models)</span></span>
<span id="cb71-8"><a href="from-simulation-to-model-fitting.html#cb71-8" tabindex="-1"></a><span class="co">#       randomChoice[t] &lt;- RandomAgentNoise_f(rateLvl, noiseLvl)</span></span>
<span id="cb71-9"><a href="from-simulation-to-model-fitting.html#cb71-9" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb71-10"><a href="from-simulation-to-model-fitting.html#cb71-10" tabindex="-1"></a><span class="co">#     temp &lt;- tibble(trial = seq(trials), choice = randomChoice, rate, noise)</span></span>
<span id="cb71-11"><a href="from-simulation-to-model-fitting.html#cb71-11" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb71-12"><a href="from-simulation-to-model-fitting.html#cb71-12" tabindex="-1"></a><span class="co">#     data &lt;- list(</span></span>
<span id="cb71-13"><a href="from-simulation-to-model-fitting.html#cb71-13" tabindex="-1"></a><span class="co">#       n = 120,</span></span>
<span id="cb71-14"><a href="from-simulation-to-model-fitting.html#cb71-14" tabindex="-1"></a><span class="co">#       h = temp$choice</span></span>
<span id="cb71-15"><a href="from-simulation-to-model-fitting.html#cb71-15" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb71-16"><a href="from-simulation-to-model-fitting.html#cb71-16" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb71-17"><a href="from-simulation-to-model-fitting.html#cb71-17" tabindex="-1"></a><span class="co">#     samples &lt;- mod$sample(</span></span>
<span id="cb71-18"><a href="from-simulation-to-model-fitting.html#cb71-18" tabindex="-1"></a><span class="co">#       data = data,</span></span>
<span id="cb71-19"><a href="from-simulation-to-model-fitting.html#cb71-19" tabindex="-1"></a><span class="co">#       seed = 1000,</span></span>
<span id="cb71-20"><a href="from-simulation-to-model-fitting.html#cb71-20" tabindex="-1"></a><span class="co">#       chains = 1,</span></span>
<span id="cb71-21"><a href="from-simulation-to-model-fitting.html#cb71-21" tabindex="-1"></a><span class="co">#       parallel_chains = 1,</span></span>
<span id="cb71-22"><a href="from-simulation-to-model-fitting.html#cb71-22" tabindex="-1"></a><span class="co">#       threads_per_chain = 1,</span></span>
<span id="cb71-23"><a href="from-simulation-to-model-fitting.html#cb71-23" tabindex="-1"></a><span class="co">#       iter_warmup = 1000,</span></span>
<span id="cb71-24"><a href="from-simulation-to-model-fitting.html#cb71-24" tabindex="-1"></a><span class="co">#       iter_sampling = 2000,</span></span>
<span id="cb71-25"><a href="from-simulation-to-model-fitting.html#cb71-25" tabindex="-1"></a><span class="co">#       refresh = 0,</span></span>
<span id="cb71-26"><a href="from-simulation-to-model-fitting.html#cb71-26" tabindex="-1"></a><span class="co">#       max_treedepth = 20,</span></span>
<span id="cb71-27"><a href="from-simulation-to-model-fitting.html#cb71-27" tabindex="-1"></a><span class="co">#       adapt_delta = 0.99,</span></span>
<span id="cb71-28"><a href="from-simulation-to-model-fitting.html#cb71-28" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb71-29"><a href="from-simulation-to-model-fitting.html#cb71-29" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb71-30"><a href="from-simulation-to-model-fitting.html#cb71-30" tabindex="-1"></a><span class="co">#     draws_df &lt;- as_draws_df(samples$draws()) </span></span>
<span id="cb71-31"><a href="from-simulation-to-model-fitting.html#cb71-31" tabindex="-1"></a><span class="co">#     temp &lt;- tibble(biasEst = inv_logit_scaled(draws_df$theta), </span></span>
<span id="cb71-32"><a href="from-simulation-to-model-fitting.html#cb71-32" tabindex="-1"></a><span class="co">#                    biasTrue = rateLvl, noise = noiseLvl)</span></span>
<span id="cb71-33"><a href="from-simulation-to-model-fitting.html#cb71-33" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb71-34"><a href="from-simulation-to-model-fitting.html#cb71-34" tabindex="-1"></a><span class="co">#     return(temp)</span></span>
<span id="cb71-35"><a href="from-simulation-to-model-fitting.html#cb71-35" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb71-36"><a href="from-simulation-to-model-fitting.html#cb71-36" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb71-37"><a href="from-simulation-to-model-fitting.html#cb71-37" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb71-38"><a href="from-simulation-to-model-fitting.html#cb71-38" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb71-39"><a href="from-simulation-to-model-fitting.html#cb71-39" tabindex="-1"></a><span class="co"># temp &lt;- tibble(unique(d[,c(&quot;rate&quot;, &quot;noise&quot;)])) %&gt;% </span></span>
<span id="cb71-40"><a href="from-simulation-to-model-fitting.html#cb71-40" tabindex="-1"></a><span class="co">#   mutate(seed = 1000, trials = 120) %&gt;%</span></span>
<span id="cb71-41"><a href="from-simulation-to-model-fitting.html#cb71-41" tabindex="-1"></a><span class="co">#   rename(rateLvl = rate, noiseLvl = noise)</span></span>
<span id="cb71-42"><a href="from-simulation-to-model-fitting.html#cb71-42" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb71-43"><a href="from-simulation-to-model-fitting.html#cb71-43" tabindex="-1"></a><span class="co"># recovery_df &lt;- future_pmap_dfr(temp, sim_d_and_fit, .options = furrr_options(seed = TRUE))</span></span>
<span id="cb71-44"><a href="from-simulation-to-model-fitting.html#cb71-44" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb71-45"><a href="from-simulation-to-model-fitting.html#cb71-45" tabindex="-1"></a><span class="co"># write_csv(recovery_df, &quot;simdata/W3_recoverydf_parallel.csv&quot;)</span></span>
<span id="cb71-46"><a href="from-simulation-to-model-fitting.html#cb71-46" tabindex="-1"></a></span>
<span id="cb71-47"><a href="from-simulation-to-model-fitting.html#cb71-47" tabindex="-1"></a>recovery_df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;simdata/W3_recoverydf_parallel.csv&quot;</span>)</span></code></pre></div>
<p>And now we load the data and visualize it as before.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="from-simulation-to-model-fitting.html#cb72-1" tabindex="-1"></a><span class="fu">ggplot</span>(recovery_df, <span class="fu">aes</span>(biasTrue, biasEst)) <span class="sc">+</span></span>
<span id="cb72-2"><a href="from-simulation-to-model-fitting.html#cb72-2" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb72-3"><a href="from-simulation-to-model-fitting.html#cb72-3" tabindex="-1"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb72-4"><a href="from-simulation-to-model-fitting.html#cb72-4" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(.<span class="sc">~</span>noise) <span class="sc">+</span></span>
<span id="cb72-5"><a href="from-simulation-to-model-fitting.html#cb72-5" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="series_files/figure-html/03%20visualizing%20the%20parallelization-1.png" width="80%" style="display: block; margin: auto;" /></p>
</div>
<div id="the-memory-model-conditioning-theta" class="section level2 hasAnchor" number="5.6">
<h2><span class="header-section-number">5.6</span> The memory model: conditioning theta<a href="from-simulation-to-model-fitting.html#the-memory-model-conditioning-theta" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Now that we fitted the base model, we can move onto more complex models. For instance a memory model (including all previous trials). Here we rely on a generalized linear model kind of thinking: the theta is the expression of a linear model (bias + b1 * PreviousRate). To make the variable more intuitive we code previous rate - which is bound to a probability 0-1 space - into log-odds via a logit link/transformation. In this way a previous rate with more left than right choices will result in a negative value, thereby decreasing our propensity to choose right; and one with more right than left choices will result in a positive value, thereby increasing our propensity to choose right.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="from-simulation-to-model-fitting.html#cb73-1" tabindex="-1"></a><span class="co"># We subset to only include no noise and a specific rate</span></span>
<span id="cb73-2"><a href="from-simulation-to-model-fitting.html#cb73-2" tabindex="-1"></a>d1 <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb73-3"><a href="from-simulation-to-model-fitting.html#cb73-3" tabindex="-1"></a>  <span class="fu">subset</span>(noise <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> rate <span class="sc">==</span> <span class="fl">0.8</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb73-4"><a href="from-simulation-to-model-fitting.html#cb73-4" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Other =</span> choice) <span class="sc">%&gt;%</span> </span>
<span id="cb73-5"><a href="from-simulation-to-model-fitting.html#cb73-5" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cumulativerate =</span> <span class="fu">lag</span>(cumulativerate, <span class="dv">1</span>))</span>
<span id="cb73-6"><a href="from-simulation-to-model-fitting.html#cb73-6" tabindex="-1"></a></span>
<span id="cb73-7"><a href="from-simulation-to-model-fitting.html#cb73-7" tabindex="-1"></a>d1<span class="sc">$</span>cumulativerate[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="co"># no prior info at first trial</span></span>
<span id="cb73-8"><a href="from-simulation-to-model-fitting.html#cb73-8" tabindex="-1"></a>d1<span class="sc">$</span>cumulativerate[d1<span class="sc">$</span>cumulativerate <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="fl">0.01</span></span>
<span id="cb73-9"><a href="from-simulation-to-model-fitting.html#cb73-9" tabindex="-1"></a>d1<span class="sc">$</span>cumulativerate[d1<span class="sc">$</span>cumulativerate <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fl">0.99</span></span>
<span id="cb73-10"><a href="from-simulation-to-model-fitting.html#cb73-10" tabindex="-1"></a></span>
<span id="cb73-11"><a href="from-simulation-to-model-fitting.html#cb73-11" tabindex="-1"></a><span class="co"># Now we create the memory agent with a coefficient of 1 (in log odds)</span></span>
<span id="cb73-12"><a href="from-simulation-to-model-fitting.html#cb73-12" tabindex="-1"></a>MemoryAgent_f <span class="ot">&lt;-</span> <span class="cf">function</span>(bias, beta, cumulativerate){</span>
<span id="cb73-13"><a href="from-simulation-to-model-fitting.html#cb73-13" tabindex="-1"></a>    choice <span class="ot">=</span> <span class="fu">rbinom</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="fu">inv_logit_scaled</span>(bias <span class="sc">+</span> beta <span class="sc">*</span> <span class="fu">logit_scaled</span>(cumulativerate)))</span>
<span id="cb73-14"><a href="from-simulation-to-model-fitting.html#cb73-14" tabindex="-1"></a>  <span class="fu">return</span>(choice)</span>
<span id="cb73-15"><a href="from-simulation-to-model-fitting.html#cb73-15" tabindex="-1"></a>}</span>
<span id="cb73-16"><a href="from-simulation-to-model-fitting.html#cb73-16" tabindex="-1"></a></span>
<span id="cb73-17"><a href="from-simulation-to-model-fitting.html#cb73-17" tabindex="-1"></a>d1<span class="sc">$</span>Self[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">RandomAgentNoise_f</span>(<span class="fl">0.5</span>, <span class="dv">0</span>)</span>
<span id="cb73-18"><a href="from-simulation-to-model-fitting.html#cb73-18" tabindex="-1"></a></span>
<span id="cb73-19"><a href="from-simulation-to-model-fitting.html#cb73-19" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>trials) {</span>
<span id="cb73-20"><a href="from-simulation-to-model-fitting.html#cb73-20" tabindex="-1"></a>  d1<span class="sc">$</span>Self[i] <span class="ot">&lt;-</span> <span class="fu">MemoryAgent_f</span>(<span class="at">bias =</span> <span class="dv">0</span>, <span class="at">beta =</span> <span class="dv">1</span>, d1<span class="sc">$</span>cumulativerate[i])</span>
<span id="cb73-21"><a href="from-simulation-to-model-fitting.html#cb73-21" tabindex="-1"></a>}</span>
<span id="cb73-22"><a href="from-simulation-to-model-fitting.html#cb73-22" tabindex="-1"></a></span>
<span id="cb73-23"><a href="from-simulation-to-model-fitting.html#cb73-23" tabindex="-1"></a><span class="do">## Create the data</span></span>
<span id="cb73-24"><a href="from-simulation-to-model-fitting.html#cb73-24" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb73-25"><a href="from-simulation-to-model-fitting.html#cb73-25" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">120</span>,</span>
<span id="cb73-26"><a href="from-simulation-to-model-fitting.html#cb73-26" tabindex="-1"></a>  <span class="at">h =</span> d1<span class="sc">$</span>Self,</span>
<span id="cb73-27"><a href="from-simulation-to-model-fitting.html#cb73-27" tabindex="-1"></a>  <span class="at">memory =</span> d1<span class="sc">$</span>cumulativerate <span class="co"># this creates the new parameter: the rate of right hands so far in log-odds</span></span>
<span id="cb73-28"><a href="from-simulation-to-model-fitting.html#cb73-28" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="from-simulation-to-model-fitting.html#cb74-1" tabindex="-1"></a>stan_model <span class="ot">&lt;-</span> <span class="st">&quot;</span></span>
<span id="cb74-2"><a href="from-simulation-to-model-fitting.html#cb74-2" tabindex="-1"></a><span class="st">// The input (data) for the model. n of trials and h for (right and left) hand</span></span>
<span id="cb74-3"><a href="from-simulation-to-model-fitting.html#cb74-3" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb74-4"><a href="from-simulation-to-model-fitting.html#cb74-4" tabindex="-1"></a><span class="st"> int&lt;lower=1&gt; n;</span></span>
<span id="cb74-5"><a href="from-simulation-to-model-fitting.html#cb74-5" tabindex="-1"></a><span class="st"> array[n] int h;</span></span>
<span id="cb74-6"><a href="from-simulation-to-model-fitting.html#cb74-6" tabindex="-1"></a><span class="st"> vector[n] memory; // here we add the new variable between 0.01 and .99</span></span>
<span id="cb74-7"><a href="from-simulation-to-model-fitting.html#cb74-7" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb74-8"><a href="from-simulation-to-model-fitting.html#cb74-8" tabindex="-1"></a></span>
<span id="cb74-9"><a href="from-simulation-to-model-fitting.html#cb74-9" tabindex="-1"></a><span class="st">// The parameters accepted by the model. </span></span>
<span id="cb74-10"><a href="from-simulation-to-model-fitting.html#cb74-10" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb74-11"><a href="from-simulation-to-model-fitting.html#cb74-11" tabindex="-1"></a><span class="st">  real bias; // how likely is the agent to pick right when the previous rate has no information (50-50)?</span></span>
<span id="cb74-12"><a href="from-simulation-to-model-fitting.html#cb74-12" tabindex="-1"></a><span class="st">  real beta; // how strongly is previous rate impacting the decision?</span></span>
<span id="cb74-13"><a href="from-simulation-to-model-fitting.html#cb74-13" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb74-14"><a href="from-simulation-to-model-fitting.html#cb74-14" tabindex="-1"></a></span>
<span id="cb74-15"><a href="from-simulation-to-model-fitting.html#cb74-15" tabindex="-1"></a></span>
<span id="cb74-16"><a href="from-simulation-to-model-fitting.html#cb74-16" tabindex="-1"></a></span>
<span id="cb74-17"><a href="from-simulation-to-model-fitting.html#cb74-17" tabindex="-1"></a><span class="st">// The model to be estimated. </span></span>
<span id="cb74-18"><a href="from-simulation-to-model-fitting.html#cb74-18" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb74-19"><a href="from-simulation-to-model-fitting.html#cb74-19" tabindex="-1"></a><span class="st">  // priors</span></span>
<span id="cb74-20"><a href="from-simulation-to-model-fitting.html#cb74-20" tabindex="-1"></a><span class="st">  target += normal_lpdf(bias | 0, .3);</span></span>
<span id="cb74-21"><a href="from-simulation-to-model-fitting.html#cb74-21" tabindex="-1"></a><span class="st">  target += normal_lpdf(beta | 0, .5);</span></span>
<span id="cb74-22"><a href="from-simulation-to-model-fitting.html#cb74-22" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb74-23"><a href="from-simulation-to-model-fitting.html#cb74-23" tabindex="-1"></a><span class="st">  // model</span></span>
<span id="cb74-24"><a href="from-simulation-to-model-fitting.html#cb74-24" tabindex="-1"></a><span class="st">  target += bernoulli_logit_lpmf(h | bias + beta * logit(memory));</span></span>
<span id="cb74-25"><a href="from-simulation-to-model-fitting.html#cb74-25" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb74-26"><a href="from-simulation-to-model-fitting.html#cb74-26" tabindex="-1"></a></span>
<span id="cb74-27"><a href="from-simulation-to-model-fitting.html#cb74-27" tabindex="-1"></a><span class="st">&quot;</span></span>
<span id="cb74-28"><a href="from-simulation-to-model-fitting.html#cb74-28" tabindex="-1"></a><span class="fu">write_stan_file</span>(</span>
<span id="cb74-29"><a href="from-simulation-to-model-fitting.html#cb74-29" tabindex="-1"></a>  stan_model,</span>
<span id="cb74-30"><a href="from-simulation-to-model-fitting.html#cb74-30" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">&quot;stan/&quot;</span>,</span>
<span id="cb74-31"><a href="from-simulation-to-model-fitting.html#cb74-31" tabindex="-1"></a>  <span class="at">basename =</span> <span class="st">&quot;W3_MemoryBernoulli.stan&quot;</span>)</span>
<span id="cb74-32"><a href="from-simulation-to-model-fitting.html#cb74-32" tabindex="-1"></a></span>
<span id="cb74-33"><a href="from-simulation-to-model-fitting.html#cb74-33" tabindex="-1"></a><span class="do">## Specify where the model is</span></span>
<span id="cb74-34"><a href="from-simulation-to-model-fitting.html#cb74-34" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">&quot;stan/W3_MemoryBernoulli.stan&quot;</span>)</span>
<span id="cb74-35"><a href="from-simulation-to-model-fitting.html#cb74-35" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(file, <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">TRUE</span>),</span>
<span id="cb74-36"><a href="from-simulation-to-model-fitting.html#cb74-36" tabindex="-1"></a>                     <span class="at">stanc_options =</span> <span class="fu">list</span>(<span class="st">&quot;O1&quot;</span>))</span>
<span id="cb74-37"><a href="from-simulation-to-model-fitting.html#cb74-37" tabindex="-1"></a></span>
<span id="cb74-38"><a href="from-simulation-to-model-fitting.html#cb74-38" tabindex="-1"></a><span class="co"># The following command calls Stan with specific options.</span></span>
<span id="cb74-39"><a href="from-simulation-to-model-fitting.html#cb74-39" tabindex="-1"></a>samples <span class="ot">&lt;-</span> mod<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb74-40"><a href="from-simulation-to-model-fitting.html#cb74-40" tabindex="-1"></a>  <span class="at">data =</span> data,</span>
<span id="cb74-41"><a href="from-simulation-to-model-fitting.html#cb74-41" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb74-42"><a href="from-simulation-to-model-fitting.html#cb74-42" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb74-43"><a href="from-simulation-to-model-fitting.html#cb74-43" tabindex="-1"></a>  <span class="at">parallel_chains =</span> <span class="dv">2</span>,</span>
<span id="cb74-44"><a href="from-simulation-to-model-fitting.html#cb74-44" tabindex="-1"></a>  <span class="at">threads_per_chain =</span> <span class="dv">2</span>,</span>
<span id="cb74-45"><a href="from-simulation-to-model-fitting.html#cb74-45" tabindex="-1"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb74-46"><a href="from-simulation-to-model-fitting.html#cb74-46" tabindex="-1"></a>  <span class="at">iter_sampling =</span> <span class="dv">1000</span>,</span>
<span id="cb74-47"><a href="from-simulation-to-model-fitting.html#cb74-47" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">0</span>,</span>
<span id="cb74-48"><a href="from-simulation-to-model-fitting.html#cb74-48" tabindex="-1"></a>  <span class="at">output_dir =</span> <span class="st">&quot;simmodels&quot;</span>,</span>
<span id="cb74-49"><a href="from-simulation-to-model-fitting.html#cb74-49" tabindex="-1"></a>  <span class="at">max_treedepth =</span> <span class="dv">20</span>,</span>
<span id="cb74-50"><a href="from-simulation-to-model-fitting.html#cb74-50" tabindex="-1"></a>  <span class="at">adapt_delta =</span> <span class="fl">0.99</span>,</span>
<span id="cb74-51"><a href="from-simulation-to-model-fitting.html#cb74-51" tabindex="-1"></a>)</span>
<span id="cb74-52"><a href="from-simulation-to-model-fitting.html#cb74-52" tabindex="-1"></a></span>
<span id="cb74-53"><a href="from-simulation-to-model-fitting.html#cb74-53" tabindex="-1"></a></span>
<span id="cb74-54"><a href="from-simulation-to-model-fitting.html#cb74-54" tabindex="-1"></a><span class="co"># Same the fitted model</span></span>
<span id="cb74-55"><a href="from-simulation-to-model-fitting.html#cb74-55" tabindex="-1"></a>samples<span class="sc">$</span><span class="fu">save_object</span>(<span class="st">&quot;simmodels/W3_MemoryBernoulli.rds&quot;</span>)</span></code></pre></div>
<div id="summarizing-the-results-1" class="section level3 hasAnchor" number="5.6.1">
<h3><span class="header-section-number">5.6.1</span> Summarizing the results<a href="from-simulation-to-model-fitting.html#summarizing-the-results-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="from-simulation-to-model-fitting.html#cb75-1" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;simmodels/W3_MemoryBernoulli.rds&quot;</span>)</span>
<span id="cb75-2"><a href="from-simulation-to-model-fitting.html#cb75-2" tabindex="-1"></a></span>
<span id="cb75-3"><a href="from-simulation-to-model-fitting.html#cb75-3" tabindex="-1"></a><span class="co"># Diagnostics</span></span>
<span id="cb75-4"><a href="from-simulation-to-model-fitting.html#cb75-4" tabindex="-1"></a>samples<span class="sc">$</span><span class="fu">cmdstan_diagnose</span>()</span></code></pre></div>
<pre><code>## Checking sampler transitions treedepth.
## Treedepth satisfactory for all transitions.
## 
## Checking sampler transitions for divergences.
## No divergent transitions found.
## 
## Checking E-BFMI - sampler transitions HMC potential energy.
## E-BFMI satisfactory.
## 
## Rank-normalized split effective sample size satisfactory for all parameters.
## 
## Rank-normalized split R-hat values satisfactory for all parameters.
## 
## Processing complete, no problems detected.</code></pre>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="from-simulation-to-model-fitting.html#cb77-1" tabindex="-1"></a><span class="co"># Extract posterior samples and include sampling of the prior:</span></span>
<span id="cb77-2"><a href="from-simulation-to-model-fitting.html#cb77-2" tabindex="-1"></a>draws_df <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(samples<span class="sc">$</span><span class="fu">draws</span>()) </span>
<span id="cb77-3"><a href="from-simulation-to-model-fitting.html#cb77-3" tabindex="-1"></a></span>
<span id="cb77-4"><a href="from-simulation-to-model-fitting.html#cb77-4" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df, <span class="fu">aes</span>(.iteration, bias, <span class="at">group =</span> .chain, <span class="at">color =</span> .chain)) <span class="sc">+</span></span>
<span id="cb77-5"><a href="from-simulation-to-model-fitting.html#cb77-5" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb77-6"><a href="from-simulation-to-model-fitting.html#cb77-6" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="series_files/figure-html/03%20memory%20model%20log-odds%20quality%20assessment-1.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="from-simulation-to-model-fitting.html#cb78-1" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df, <span class="fu">aes</span>(.iteration, beta, <span class="at">group =</span> .chain, <span class="at">color =</span> .chain)) <span class="sc">+</span></span>
<span id="cb78-2"><a href="from-simulation-to-model-fitting.html#cb78-2" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb78-3"><a href="from-simulation-to-model-fitting.html#cb78-3" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="series_files/figure-html/03%20memory%20model%20log-odds%20quality%20assessment-2.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="from-simulation-to-model-fitting.html#cb79-1" tabindex="-1"></a><span class="co"># add a prior for theta (ugly, but we&#39;ll do better soon)</span></span>
<span id="cb79-2"><a href="from-simulation-to-model-fitting.html#cb79-2" tabindex="-1"></a>draws_df <span class="ot">&lt;-</span> draws_df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb79-3"><a href="from-simulation-to-model-fitting.html#cb79-3" tabindex="-1"></a>  <span class="at">bias_prior =</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(draws_df), <span class="dv">0</span>, .<span class="dv">3</span>),</span>
<span id="cb79-4"><a href="from-simulation-to-model-fitting.html#cb79-4" tabindex="-1"></a>  <span class="at">beta_prior =</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(draws_df), <span class="dv">0</span>, .<span class="dv">5</span>),</span>
<span id="cb79-5"><a href="from-simulation-to-model-fitting.html#cb79-5" tabindex="-1"></a>)</span>
<span id="cb79-6"><a href="from-simulation-to-model-fitting.html#cb79-6" tabindex="-1"></a></span>
<span id="cb79-7"><a href="from-simulation-to-model-fitting.html#cb79-7" tabindex="-1"></a><span class="co"># Now let&#39;s plot the density for theta (prior and posterior)</span></span>
<span id="cb79-8"><a href="from-simulation-to-model-fitting.html#cb79-8" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df) <span class="sc">+</span></span>
<span id="cb79-9"><a href="from-simulation-to-model-fitting.html#cb79-9" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(bias), <span class="at">fill =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb79-10"><a href="from-simulation-to-model-fitting.html#cb79-10" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(bias_prior), <span class="at">fill =</span> <span class="st">&quot;red&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb79-11"><a href="from-simulation-to-model-fitting.html#cb79-11" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb79-12"><a href="from-simulation-to-model-fitting.html#cb79-12" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Bias&quot;</span>) <span class="sc">+</span></span>
<span id="cb79-13"><a href="from-simulation-to-model-fitting.html#cb79-13" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Posterior Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb79-14"><a href="from-simulation-to-model-fitting.html#cb79-14" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="series_files/figure-html/03%20memory%20model%20log-odds%20quality%20assessment-3.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="from-simulation-to-model-fitting.html#cb80-1" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df) <span class="sc">+</span></span>
<span id="cb80-2"><a href="from-simulation-to-model-fitting.html#cb80-2" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(beta), <span class="at">fill =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb80-3"><a href="from-simulation-to-model-fitting.html#cb80-3" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(beta_prior), <span class="at">fill =</span> <span class="st">&quot;red&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb80-4"><a href="from-simulation-to-model-fitting.html#cb80-4" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb80-5"><a href="from-simulation-to-model-fitting.html#cb80-5" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Beta&quot;</span>) <span class="sc">+</span></span>
<span id="cb80-6"><a href="from-simulation-to-model-fitting.html#cb80-6" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Posterior Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb80-7"><a href="from-simulation-to-model-fitting.html#cb80-7" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="series_files/figure-html/03%20memory%20model%20log-odds%20quality%20assessment-4.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="from-simulation-to-model-fitting.html#cb81-1" tabindex="-1"></a>samples<span class="sc">$</span><span class="fu">summary</span>() </span></code></pre></div>
<pre><code>## # A tibble: 3 × 10
##   variable    mean  median    sd   mad      q5     q95  rhat ess_bulk ess_tail
##   &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
## 1 lp__     -47.4   -47.1   0.964 0.706 -49.4   -46.5    1.01     719.     918.
## 2 bias       0.230   0.222 0.270 0.268  -0.202   0.682  1.00     610.     904.
## 3 beta       0.926   0.920 0.203 0.201   0.597   1.26   1.00     567.     763.</code></pre>
<p>We can see that the model has now estimated both the bias and the role of previous memory. Bias should reflect the bias in the setup (0.5 which in log odds is 0), and the beta coefficient for memory (roughly 1). More on the quality checks of the models in the next chapter.</p>
</div>
</div>
<div id="memory-agent-with-internal-parameter" class="section level2 hasAnchor" number="5.7">
<h2><span class="header-section-number">5.7</span> Memory agent with internal parameter<a href="from-simulation-to-model-fitting.html#memory-agent-with-internal-parameter" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>So far we behaved like in GLM: we keep feeding to the model an external variable of memory, but what if we coded memory as an internal parameter? This opens up to further possibilities to model how long memory is kept and weighted by distance from the current moment, etc.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="from-simulation-to-model-fitting.html#cb83-1" tabindex="-1"></a><span class="do">## Create the data</span></span>
<span id="cb83-2"><a href="from-simulation-to-model-fitting.html#cb83-2" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb83-3"><a href="from-simulation-to-model-fitting.html#cb83-3" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">120</span>,</span>
<span id="cb83-4"><a href="from-simulation-to-model-fitting.html#cb83-4" tabindex="-1"></a>  <span class="at">h =</span> d1<span class="sc">$</span>Self,</span>
<span id="cb83-5"><a href="from-simulation-to-model-fitting.html#cb83-5" tabindex="-1"></a>  <span class="at">other =</span> d1<span class="sc">$</span>Other</span>
<span id="cb83-6"><a href="from-simulation-to-model-fitting.html#cb83-6" tabindex="-1"></a>)</span>
<span id="cb83-7"><a href="from-simulation-to-model-fitting.html#cb83-7" tabindex="-1"></a></span>
<span id="cb83-8"><a href="from-simulation-to-model-fitting.html#cb83-8" tabindex="-1"></a>stan_model <span class="ot">&lt;-</span> <span class="st">&quot;</span></span>
<span id="cb83-9"><a href="from-simulation-to-model-fitting.html#cb83-9" tabindex="-1"></a><span class="st">// Memory-based choice model with prior and posterior predictions</span></span>
<span id="cb83-10"><a href="from-simulation-to-model-fitting.html#cb83-10" tabindex="-1"></a></span>
<span id="cb83-11"><a href="from-simulation-to-model-fitting.html#cb83-11" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb83-12"><a href="from-simulation-to-model-fitting.html#cb83-12" tabindex="-1"></a><span class="st"> int&lt;lower=1&gt; n;</span></span>
<span id="cb83-13"><a href="from-simulation-to-model-fitting.html#cb83-13" tabindex="-1"></a><span class="st"> array[n] int h;</span></span>
<span id="cb83-14"><a href="from-simulation-to-model-fitting.html#cb83-14" tabindex="-1"></a><span class="st"> array[n] int other;</span></span>
<span id="cb83-15"><a href="from-simulation-to-model-fitting.html#cb83-15" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb83-16"><a href="from-simulation-to-model-fitting.html#cb83-16" tabindex="-1"></a></span>
<span id="cb83-17"><a href="from-simulation-to-model-fitting.html#cb83-17" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb83-18"><a href="from-simulation-to-model-fitting.html#cb83-18" tabindex="-1"></a><span class="st">  real bias;</span></span>
<span id="cb83-19"><a href="from-simulation-to-model-fitting.html#cb83-19" tabindex="-1"></a><span class="st">  real beta;</span></span>
<span id="cb83-20"><a href="from-simulation-to-model-fitting.html#cb83-20" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb83-21"><a href="from-simulation-to-model-fitting.html#cb83-21" tabindex="-1"></a></span>
<span id="cb83-22"><a href="from-simulation-to-model-fitting.html#cb83-22" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb83-23"><a href="from-simulation-to-model-fitting.html#cb83-23" tabindex="-1"></a><span class="st">  vector[n] memory;</span></span>
<span id="cb83-24"><a href="from-simulation-to-model-fitting.html#cb83-24" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb83-25"><a href="from-simulation-to-model-fitting.html#cb83-25" tabindex="-1"></a><span class="st">  for (trial in 1:n) {</span></span>
<span id="cb83-26"><a href="from-simulation-to-model-fitting.html#cb83-26" tabindex="-1"></a><span class="st">    if (trial == 1) {</span></span>
<span id="cb83-27"><a href="from-simulation-to-model-fitting.html#cb83-27" tabindex="-1"></a><span class="st">      memory[trial] = 0.5;</span></span>
<span id="cb83-28"><a href="from-simulation-to-model-fitting.html#cb83-28" tabindex="-1"></a><span class="st">    } </span></span>
<span id="cb83-29"><a href="from-simulation-to-model-fitting.html#cb83-29" tabindex="-1"></a><span class="st">    if (trial &lt; n) {</span></span>
<span id="cb83-30"><a href="from-simulation-to-model-fitting.html#cb83-30" tabindex="-1"></a><span class="st">      memory[trial + 1] = memory[trial] + ((other[trial] - memory[trial]) / (trial + 1));</span></span>
<span id="cb83-31"><a href="from-simulation-to-model-fitting.html#cb83-31" tabindex="-1"></a><span class="st">      if (memory[trial + 1] == 0) { memory[trial + 1] = 0.01; }</span></span>
<span id="cb83-32"><a href="from-simulation-to-model-fitting.html#cb83-32" tabindex="-1"></a><span class="st">      if (memory[trial + 1] == 1) { memory[trial + 1] = 0.99; }</span></span>
<span id="cb83-33"><a href="from-simulation-to-model-fitting.html#cb83-33" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb83-34"><a href="from-simulation-to-model-fitting.html#cb83-34" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb83-35"><a href="from-simulation-to-model-fitting.html#cb83-35" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb83-36"><a href="from-simulation-to-model-fitting.html#cb83-36" tabindex="-1"></a></span>
<span id="cb83-37"><a href="from-simulation-to-model-fitting.html#cb83-37" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb83-38"><a href="from-simulation-to-model-fitting.html#cb83-38" tabindex="-1"></a><span class="st">  // Priors</span></span>
<span id="cb83-39"><a href="from-simulation-to-model-fitting.html#cb83-39" tabindex="-1"></a><span class="st">  target += normal_lpdf(bias | 0, .3);</span></span>
<span id="cb83-40"><a href="from-simulation-to-model-fitting.html#cb83-40" tabindex="-1"></a><span class="st">  target += normal_lpdf(beta | 0, .5);</span></span>
<span id="cb83-41"><a href="from-simulation-to-model-fitting.html#cb83-41" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb83-42"><a href="from-simulation-to-model-fitting.html#cb83-42" tabindex="-1"></a><span class="st">  // Likelihood</span></span>
<span id="cb83-43"><a href="from-simulation-to-model-fitting.html#cb83-43" tabindex="-1"></a><span class="st">  for (trial in 1:n) {</span></span>
<span id="cb83-44"><a href="from-simulation-to-model-fitting.html#cb83-44" tabindex="-1"></a><span class="st">    target += bernoulli_logit_lpmf(h[trial] | bias + beta * logit(memory[trial]));</span></span>
<span id="cb83-45"><a href="from-simulation-to-model-fitting.html#cb83-45" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb83-46"><a href="from-simulation-to-model-fitting.html#cb83-46" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb83-47"><a href="from-simulation-to-model-fitting.html#cb83-47" tabindex="-1"></a></span>
<span id="cb83-48"><a href="from-simulation-to-model-fitting.html#cb83-48" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb83-49"><a href="from-simulation-to-model-fitting.html#cb83-49" tabindex="-1"></a><span class="st">  // Generate prior samples</span></span>
<span id="cb83-50"><a href="from-simulation-to-model-fitting.html#cb83-50" tabindex="-1"></a><span class="st">  real bias_prior = normal_rng(0, .3);</span></span>
<span id="cb83-51"><a href="from-simulation-to-model-fitting.html#cb83-51" tabindex="-1"></a><span class="st">  real beta_prior = normal_rng(0, .5);</span></span>
<span id="cb83-52"><a href="from-simulation-to-model-fitting.html#cb83-52" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb83-53"><a href="from-simulation-to-model-fitting.html#cb83-53" tabindex="-1"></a><span class="st">  // Variables for predictions</span></span>
<span id="cb83-54"><a href="from-simulation-to-model-fitting.html#cb83-54" tabindex="-1"></a><span class="st">  array[n] int prior_preds;</span></span>
<span id="cb83-55"><a href="from-simulation-to-model-fitting.html#cb83-55" tabindex="-1"></a><span class="st">  array[n] int posterior_preds;</span></span>
<span id="cb83-56"><a href="from-simulation-to-model-fitting.html#cb83-56" tabindex="-1"></a><span class="st">  vector[n] memory_prior;</span></span>
<span id="cb83-57"><a href="from-simulation-to-model-fitting.html#cb83-57" tabindex="-1"></a><span class="st">  vector[n] log_lik;</span></span>
<span id="cb83-58"><a href="from-simulation-to-model-fitting.html#cb83-58" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb83-59"><a href="from-simulation-to-model-fitting.html#cb83-59" tabindex="-1"></a><span class="st">  // Generate predictions at different memory levels</span></span>
<span id="cb83-60"><a href="from-simulation-to-model-fitting.html#cb83-60" tabindex="-1"></a><span class="st">  array[3] real memory_levels = {0.2, 0.5, 0.8}; // Low, neutral, and high memory</span></span>
<span id="cb83-61"><a href="from-simulation-to-model-fitting.html#cb83-61" tabindex="-1"></a><span class="st">  array[3] int prior_preds_memory;</span></span>
<span id="cb83-62"><a href="from-simulation-to-model-fitting.html#cb83-62" tabindex="-1"></a><span class="st">  array[3] int posterior_preds_memory;</span></span>
<span id="cb83-63"><a href="from-simulation-to-model-fitting.html#cb83-63" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb83-64"><a href="from-simulation-to-model-fitting.html#cb83-64" tabindex="-1"></a><span class="st">  // Generate predictions from prior for each memory level</span></span>
<span id="cb83-65"><a href="from-simulation-to-model-fitting.html#cb83-65" tabindex="-1"></a><span class="st">  for (i in 1:3) {</span></span>
<span id="cb83-66"><a href="from-simulation-to-model-fitting.html#cb83-66" tabindex="-1"></a><span class="st">    real logit_memory = logit(memory_levels[i]);</span></span>
<span id="cb83-67"><a href="from-simulation-to-model-fitting.html#cb83-67" tabindex="-1"></a><span class="st">    prior_preds_memory[i] = bernoulli_logit_rng(bias_prior + beta_prior * logit_memory);</span></span>
<span id="cb83-68"><a href="from-simulation-to-model-fitting.html#cb83-68" tabindex="-1"></a><span class="st">    posterior_preds_memory[i] = bernoulli_logit_rng(bias + beta * logit_memory);</span></span>
<span id="cb83-69"><a href="from-simulation-to-model-fitting.html#cb83-69" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb83-70"><a href="from-simulation-to-model-fitting.html#cb83-70" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb83-71"><a href="from-simulation-to-model-fitting.html#cb83-71" tabindex="-1"></a><span class="st">  // Generate predictions from prior</span></span>
<span id="cb83-72"><a href="from-simulation-to-model-fitting.html#cb83-72" tabindex="-1"></a><span class="st">  memory_prior[1] = 0.5;</span></span>
<span id="cb83-73"><a href="from-simulation-to-model-fitting.html#cb83-73" tabindex="-1"></a><span class="st">  for (trial in 1:n) {</span></span>
<span id="cb83-74"><a href="from-simulation-to-model-fitting.html#cb83-74" tabindex="-1"></a><span class="st">    if (trial == 1) {</span></span>
<span id="cb83-75"><a href="from-simulation-to-model-fitting.html#cb83-75" tabindex="-1"></a><span class="st">      prior_preds[trial] = bernoulli_logit_rng(bias_prior + beta_prior * logit(memory_prior[trial]));</span></span>
<span id="cb83-76"><a href="from-simulation-to-model-fitting.html#cb83-76" tabindex="-1"></a><span class="st">    } else {</span></span>
<span id="cb83-77"><a href="from-simulation-to-model-fitting.html#cb83-77" tabindex="-1"></a><span class="st">      memory_prior[trial] = memory_prior[trial-1] + ((other[trial-1] - memory_prior[trial-1]) / trial);</span></span>
<span id="cb83-78"><a href="from-simulation-to-model-fitting.html#cb83-78" tabindex="-1"></a><span class="st">      if (memory_prior[trial] == 0) { memory_prior[trial] = 0.01; }</span></span>
<span id="cb83-79"><a href="from-simulation-to-model-fitting.html#cb83-79" tabindex="-1"></a><span class="st">      if (memory_prior[trial] == 1) { memory_prior[trial] = 0.99; }</span></span>
<span id="cb83-80"><a href="from-simulation-to-model-fitting.html#cb83-80" tabindex="-1"></a><span class="st">      prior_preds[trial] = bernoulli_logit_rng(bias_prior + beta_prior * logit(memory_prior[trial]));</span></span>
<span id="cb83-81"><a href="from-simulation-to-model-fitting.html#cb83-81" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb83-82"><a href="from-simulation-to-model-fitting.html#cb83-82" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb83-83"><a href="from-simulation-to-model-fitting.html#cb83-83" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb83-84"><a href="from-simulation-to-model-fitting.html#cb83-84" tabindex="-1"></a><span class="st">  // Generate predictions from posterior</span></span>
<span id="cb83-85"><a href="from-simulation-to-model-fitting.html#cb83-85" tabindex="-1"></a><span class="st">  for (trial in 1:n) {</span></span>
<span id="cb83-86"><a href="from-simulation-to-model-fitting.html#cb83-86" tabindex="-1"></a><span class="st">    posterior_preds[trial] = bernoulli_logit_rng(bias + beta * logit(memory[trial]));</span></span>
<span id="cb83-87"><a href="from-simulation-to-model-fitting.html#cb83-87" tabindex="-1"></a><span class="st">    log_lik[trial] = bernoulli_logit_lpmf(h[trial] | bias + beta * logit(memory[trial]));</span></span>
<span id="cb83-88"><a href="from-simulation-to-model-fitting.html#cb83-88" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb83-89"><a href="from-simulation-to-model-fitting.html#cb83-89" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb83-90"><a href="from-simulation-to-model-fitting.html#cb83-90" tabindex="-1"></a></span>
<span id="cb83-91"><a href="from-simulation-to-model-fitting.html#cb83-91" tabindex="-1"></a><span class="st">&quot;</span></span>
<span id="cb83-92"><a href="from-simulation-to-model-fitting.html#cb83-92" tabindex="-1"></a></span>
<span id="cb83-93"><a href="from-simulation-to-model-fitting.html#cb83-93" tabindex="-1"></a><span class="fu">write_stan_file</span>(</span>
<span id="cb83-94"><a href="from-simulation-to-model-fitting.html#cb83-94" tabindex="-1"></a>  stan_model,</span>
<span id="cb83-95"><a href="from-simulation-to-model-fitting.html#cb83-95" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">&quot;stan/&quot;</span>,</span>
<span id="cb83-96"><a href="from-simulation-to-model-fitting.html#cb83-96" tabindex="-1"></a>  <span class="at">basename =</span> <span class="st">&quot;W3_InternalMemory.stan&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;/Users/au209589/Dropbox/Teaching/AdvancedCognitiveModeling23_book/stan/W3_InternalMemory.stan&quot;</code></pre>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="from-simulation-to-model-fitting.html#cb85-1" tabindex="-1"></a><span class="do">## Specify where the model is</span></span>
<span id="cb85-2"><a href="from-simulation-to-model-fitting.html#cb85-2" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">&quot;stan/W3_InternalMemory.stan&quot;</span>)</span>
<span id="cb85-3"><a href="from-simulation-to-model-fitting.html#cb85-3" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(file, <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">TRUE</span>),</span>
<span id="cb85-4"><a href="from-simulation-to-model-fitting.html#cb85-4" tabindex="-1"></a>                     <span class="at">stanc_options =</span> <span class="fu">list</span>(<span class="st">&quot;O1&quot;</span>))</span>
<span id="cb85-5"><a href="from-simulation-to-model-fitting.html#cb85-5" tabindex="-1"></a></span>
<span id="cb85-6"><a href="from-simulation-to-model-fitting.html#cb85-6" tabindex="-1"></a><span class="co"># The following command calls Stan with specific options.</span></span>
<span id="cb85-7"><a href="from-simulation-to-model-fitting.html#cb85-7" tabindex="-1"></a>samples <span class="ot">&lt;-</span> mod<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb85-8"><a href="from-simulation-to-model-fitting.html#cb85-8" tabindex="-1"></a>  <span class="at">data =</span> data,</span>
<span id="cb85-9"><a href="from-simulation-to-model-fitting.html#cb85-9" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb85-10"><a href="from-simulation-to-model-fitting.html#cb85-10" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">1</span>,</span>
<span id="cb85-11"><a href="from-simulation-to-model-fitting.html#cb85-11" tabindex="-1"></a>  <span class="at">parallel_chains =</span> <span class="dv">2</span>,</span>
<span id="cb85-12"><a href="from-simulation-to-model-fitting.html#cb85-12" tabindex="-1"></a>  <span class="at">threads_per_chain =</span> <span class="dv">2</span>,</span>
<span id="cb85-13"><a href="from-simulation-to-model-fitting.html#cb85-13" tabindex="-1"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb85-14"><a href="from-simulation-to-model-fitting.html#cb85-14" tabindex="-1"></a>  <span class="at">iter_sampling =</span> <span class="dv">1000</span>,</span>
<span id="cb85-15"><a href="from-simulation-to-model-fitting.html#cb85-15" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">0</span>,</span>
<span id="cb85-16"><a href="from-simulation-to-model-fitting.html#cb85-16" tabindex="-1"></a>  <span class="at">max_treedepth =</span> <span class="dv">20</span>,</span>
<span id="cb85-17"><a href="from-simulation-to-model-fitting.html#cb85-17" tabindex="-1"></a>  <span class="at">adapt_delta =</span> <span class="fl">0.99</span>,</span>
<span id="cb85-18"><a href="from-simulation-to-model-fitting.html#cb85-18" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Running MCMC with 1 chain, with 2 thread(s) per chain...
## 
## Chain 1 finished in 0.6 seconds.</code></pre>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="from-simulation-to-model-fitting.html#cb87-1" tabindex="-1"></a>samples<span class="sc">$</span><span class="fu">summary</span>() </span></code></pre></div>
<pre><code>## # A tibble: 614 × 10
##    variable     mean  median    sd   mad      q5     q95  rhat ess_bulk ess_tail
##    &lt;chr&gt;       &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1 lp__      -52.7   -52.3   1.14  0.763 -55.0   -51.7    1.01     224.     259.
##  2 bias        0.320   0.312 0.281 0.280  -0.152   0.803  1.00     271.     219.
##  3 beta        0.945   0.945 0.240 0.222   0.551   1.33   1.01     265.     339.
##  4 memory[1]   0.5     0.5   0     0       0.5     0.5   NA         NA       NA 
##  5 memory[2]   0.75    0.75  0     0       0.75    0.75  NA         NA       NA 
##  6 memory[3]   0.5     0.5   0     0       0.5     0.5   NA         NA       NA 
##  7 memory[4]   0.625   0.625 0     0       0.625   0.625 NA         NA       NA 
##  8 memory[5]   0.5     0.5   0     0       0.5     0.5   NA         NA       NA 
##  9 memory[6]   0.417   0.417 0     0       0.417   0.417 NA         NA       NA 
## 10 memory[7]   0.5     0.5   0     0       0.5     0.5   NA         NA       NA 
## # ℹ 604 more rows</code></pre>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="from-simulation-to-model-fitting.html#cb89-1" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb89-2"><a href="from-simulation-to-model-fitting.html#cb89-2" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb89-3"><a href="from-simulation-to-model-fitting.html#cb89-3" tabindex="-1"></a></span>
<span id="cb89-4"><a href="from-simulation-to-model-fitting.html#cb89-4" tabindex="-1"></a>draws_df <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(samples<span class="sc">$</span><span class="fu">draws</span>())</span>
<span id="cb89-5"><a href="from-simulation-to-model-fitting.html#cb89-5" tabindex="-1"></a></span>
<span id="cb89-6"><a href="from-simulation-to-model-fitting.html#cb89-6" tabindex="-1"></a><span class="co"># 1. Check chain convergence</span></span>
<span id="cb89-7"><a href="from-simulation-to-model-fitting.html#cb89-7" tabindex="-1"></a><span class="co"># Plot traces for main parameters</span></span>
<span id="cb89-8"><a href="from-simulation-to-model-fitting.html#cb89-8" tabindex="-1"></a><span class="fu">mcmc_trace</span>(draws_df, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;bias&quot;</span>, <span class="st">&quot;beta&quot;</span>)) <span class="sc">+</span></span>
<span id="cb89-9"><a href="from-simulation-to-model-fitting.html#cb89-9" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb89-10"><a href="from-simulation-to-model-fitting.html#cb89-10" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Parameter Traces Across Chains&quot;</span>)</span></code></pre></div>
<p><img src="series_files/figure-html/unnamed-chunk-14-1.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="from-simulation-to-model-fitting.html#cb90-1" tabindex="-1"></a><span class="co"># Plot rank histograms to check mixing</span></span>
<span id="cb90-2"><a href="from-simulation-to-model-fitting.html#cb90-2" tabindex="-1"></a><span class="fu">mcmc_rank_hist</span>(draws_df, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;bias&quot;</span>, <span class="st">&quot;beta&quot;</span>))</span></code></pre></div>
<p><img src="series_files/figure-html/unnamed-chunk-14-2.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="from-simulation-to-model-fitting.html#cb91-1" tabindex="-1"></a><span class="co"># 2. Prior-Posterior Update Check</span></span>
<span id="cb91-2"><a href="from-simulation-to-model-fitting.html#cb91-2" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb91-3"><a href="from-simulation-to-model-fitting.html#cb91-3" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> draws_df, <span class="fu">aes</span>(bias, <span class="at">fill =</span> <span class="st">&quot;Posterior&quot;</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb91-4"><a href="from-simulation-to-model-fitting.html#cb91-4" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> draws_df, <span class="fu">aes</span>(bias_prior, <span class="at">fill =</span> <span class="st">&quot;Prior&quot;</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb91-5"><a href="from-simulation-to-model-fitting.html#cb91-5" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb91-6"><a href="from-simulation-to-model-fitting.html#cb91-6" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Prior&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>, <span class="st">&quot;Posterior&quot;</span> <span class="ot">=</span> <span class="st">&quot;blue&quot;</span>)) <span class="sc">+</span></span>
<span id="cb91-7"><a href="from-simulation-to-model-fitting.html#cb91-7" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb91-8"><a href="from-simulation-to-model-fitting.html#cb91-8" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Prior-Posterior Update: Bias Parameter&quot;</span>)</span>
<span id="cb91-9"><a href="from-simulation-to-model-fitting.html#cb91-9" tabindex="-1"></a></span>
<span id="cb91-10"><a href="from-simulation-to-model-fitting.html#cb91-10" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb91-11"><a href="from-simulation-to-model-fitting.html#cb91-11" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> draws_df, <span class="fu">aes</span>(beta, <span class="at">fill =</span> <span class="st">&quot;Posterior&quot;</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb91-12"><a href="from-simulation-to-model-fitting.html#cb91-12" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> draws_df, <span class="fu">aes</span>(beta_prior, <span class="at">fill =</span> <span class="st">&quot;Prior&quot;</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb91-13"><a href="from-simulation-to-model-fitting.html#cb91-13" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb91-14"><a href="from-simulation-to-model-fitting.html#cb91-14" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Prior&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>, <span class="st">&quot;Posterior&quot;</span> <span class="ot">=</span> <span class="st">&quot;blue&quot;</span>)) <span class="sc">+</span></span>
<span id="cb91-15"><a href="from-simulation-to-model-fitting.html#cb91-15" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb91-16"><a href="from-simulation-to-model-fitting.html#cb91-16" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Prior-Posterior Update: Beta Parameter&quot;</span>)</span>
<span id="cb91-17"><a href="from-simulation-to-model-fitting.html#cb91-17" tabindex="-1"></a></span>
<span id="cb91-18"><a href="from-simulation-to-model-fitting.html#cb91-18" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb91-19"><a href="from-simulation-to-model-fitting.html#cb91-19" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> draws_df, <span class="fu">aes</span>(bias, beta), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb91-20"><a href="from-simulation-to-model-fitting.html#cb91-20" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb91-21"><a href="from-simulation-to-model-fitting.html#cb91-21" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Correlation&quot;</span>)</span>
<span id="cb91-22"><a href="from-simulation-to-model-fitting.html#cb91-22" tabindex="-1"></a></span>
<span id="cb91-23"><a href="from-simulation-to-model-fitting.html#cb91-23" tabindex="-1"></a>p1 <span class="sc">+</span> p2 <span class="sc">+</span> p3</span></code></pre></div>
<p><img src="series_files/figure-html/unnamed-chunk-14-3.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="from-simulation-to-model-fitting.html#cb92-1" tabindex="-1"></a><span class="co"># First let&#39;s properly extract and organize our posterior predictions</span></span>
<span id="cb92-2"><a href="from-simulation-to-model-fitting.html#cb92-2" tabindex="-1"></a>posterior_predictions <span class="ot">&lt;-</span> draws_df <span class="sc">%&gt;%</span></span>
<span id="cb92-3"><a href="from-simulation-to-model-fitting.html#cb92-3" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;posterior_preds[&quot;</span>)) <span class="sc">%&gt;%</span> <span class="co"># Select all posterior prediction columns</span></span>
<span id="cb92-4"><a href="from-simulation-to-model-fitting.html#cb92-4" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), </span>
<span id="cb92-5"><a href="from-simulation-to-model-fitting.html#cb92-5" tabindex="-1"></a>              <span class="at">names_to =</span> <span class="st">&quot;trial&quot;</span>,</span>
<span id="cb92-6"><a href="from-simulation-to-model-fitting.html#cb92-6" tabindex="-1"></a>              <span class="at">values_to =</span> <span class="st">&quot;prediction&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb92-7"><a href="from-simulation-to-model-fitting.html#cb92-7" tabindex="-1"></a>  <span class="co"># Clean up the trial number from the Stan array notation</span></span>
<span id="cb92-8"><a href="from-simulation-to-model-fitting.html#cb92-8" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trial =</span> <span class="fu">as.numeric</span>(<span class="fu">str_extract</span>(trial, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">d+&quot;</span>)))</span>
<span id="cb92-9"><a href="from-simulation-to-model-fitting.html#cb92-9" tabindex="-1"></a></span>
<span id="cb92-10"><a href="from-simulation-to-model-fitting.html#cb92-10" tabindex="-1"></a><span class="co"># Calculate summary statistics for posterior predictions</span></span>
<span id="cb92-11"><a href="from-simulation-to-model-fitting.html#cb92-11" tabindex="-1"></a>posterior_summary <span class="ot">&lt;-</span> posterior_predictions <span class="sc">%&gt;%</span></span>
<span id="cb92-12"><a href="from-simulation-to-model-fitting.html#cb92-12" tabindex="-1"></a>  <span class="fu">group_by</span>(trial) <span class="sc">%&gt;%</span></span>
<span id="cb92-13"><a href="from-simulation-to-model-fitting.html#cb92-13" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb92-14"><a href="from-simulation-to-model-fitting.html#cb92-14" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(prediction),</span>
<span id="cb92-15"><a href="from-simulation-to-model-fitting.html#cb92-15" tabindex="-1"></a>    <span class="at">lower =</span> <span class="fu">quantile</span>(prediction, <span class="fl">0.025</span>),</span>
<span id="cb92-16"><a href="from-simulation-to-model-fitting.html#cb92-16" tabindex="-1"></a>    <span class="at">upper =</span> <span class="fu">quantile</span>(prediction, <span class="fl">0.975</span>)</span>
<span id="cb92-17"><a href="from-simulation-to-model-fitting.html#cb92-17" tabindex="-1"></a>  )</span>
<span id="cb92-18"><a href="from-simulation-to-model-fitting.html#cb92-18" tabindex="-1"></a></span>
<span id="cb92-19"><a href="from-simulation-to-model-fitting.html#cb92-19" tabindex="-1"></a><span class="co"># Do the same for prior predictions</span></span>
<span id="cb92-20"><a href="from-simulation-to-model-fitting.html#cb92-20" tabindex="-1"></a>prior_predictions <span class="ot">&lt;-</span> draws_df <span class="sc">%&gt;%</span></span>
<span id="cb92-21"><a href="from-simulation-to-model-fitting.html#cb92-21" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;prior_preds[&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb92-22"><a href="from-simulation-to-model-fitting.html#cb92-22" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), </span>
<span id="cb92-23"><a href="from-simulation-to-model-fitting.html#cb92-23" tabindex="-1"></a>              <span class="at">names_to =</span> <span class="st">&quot;trial&quot;</span>,</span>
<span id="cb92-24"><a href="from-simulation-to-model-fitting.html#cb92-24" tabindex="-1"></a>              <span class="at">values_to =</span> <span class="st">&quot;prediction&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb92-25"><a href="from-simulation-to-model-fitting.html#cb92-25" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trial =</span> <span class="fu">as.numeric</span>(<span class="fu">str_extract</span>(trial, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">d+&quot;</span>)))</span>
<span id="cb92-26"><a href="from-simulation-to-model-fitting.html#cb92-26" tabindex="-1"></a></span>
<span id="cb92-27"><a href="from-simulation-to-model-fitting.html#cb92-27" tabindex="-1"></a>prior_summary <span class="ot">&lt;-</span> prior_predictions <span class="sc">%&gt;%</span></span>
<span id="cb92-28"><a href="from-simulation-to-model-fitting.html#cb92-28" tabindex="-1"></a>  <span class="fu">group_by</span>(trial) <span class="sc">%&gt;%</span></span>
<span id="cb92-29"><a href="from-simulation-to-model-fitting.html#cb92-29" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb92-30"><a href="from-simulation-to-model-fitting.html#cb92-30" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(prediction),</span>
<span id="cb92-31"><a href="from-simulation-to-model-fitting.html#cb92-31" tabindex="-1"></a>    <span class="at">lower =</span> <span class="fu">quantile</span>(prediction, <span class="fl">0.025</span>),</span>
<span id="cb92-32"><a href="from-simulation-to-model-fitting.html#cb92-32" tabindex="-1"></a>    <span class="at">upper =</span> <span class="fu">quantile</span>(prediction, <span class="fl">0.975</span>)</span>
<span id="cb92-33"><a href="from-simulation-to-model-fitting.html#cb92-33" tabindex="-1"></a>  )</span>
<span id="cb92-34"><a href="from-simulation-to-model-fitting.html#cb92-34" tabindex="-1"></a></span>
<span id="cb92-35"><a href="from-simulation-to-model-fitting.html#cb92-35" tabindex="-1"></a><span class="co"># Now let&#39;s create our visualization</span></span>
<span id="cb92-36"><a href="from-simulation-to-model-fitting.html#cb92-36" tabindex="-1"></a><span class="co"># First the prior predictive check</span></span>
<span id="cb92-37"><a href="from-simulation-to-model-fitting.html#cb92-37" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb92-38"><a href="from-simulation-to-model-fitting.html#cb92-38" tabindex="-1"></a>  <span class="co"># Add prior prediction interval</span></span>
<span id="cb92-39"><a href="from-simulation-to-model-fitting.html#cb92-39" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> prior_summary,</span>
<span id="cb92-40"><a href="from-simulation-to-model-fitting.html#cb92-40" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> trial, <span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper),</span>
<span id="cb92-41"><a href="from-simulation-to-model-fitting.html#cb92-41" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">fill =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb92-42"><a href="from-simulation-to-model-fitting.html#cb92-42" tabindex="-1"></a>  <span class="co"># Add mean prior prediction</span></span>
<span id="cb92-43"><a href="from-simulation-to-model-fitting.html#cb92-43" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> prior_summary,</span>
<span id="cb92-44"><a href="from-simulation-to-model-fitting.html#cb92-44" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> trial, <span class="at">y =</span> mean),</span>
<span id="cb92-45"><a href="from-simulation-to-model-fitting.html#cb92-45" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb92-46"><a href="from-simulation-to-model-fitting.html#cb92-46" tabindex="-1"></a>  <span class="co"># Add actual data points</span></span>
<span id="cb92-47"><a href="from-simulation-to-model-fitting.html#cb92-47" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">trial =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(data<span class="sc">$</span>h), </span>
<span id="cb92-48"><a href="from-simulation-to-model-fitting.html#cb92-48" tabindex="-1"></a>                          <span class="at">choice =</span> data<span class="sc">$</span>h),</span>
<span id="cb92-49"><a href="from-simulation-to-model-fitting.html#cb92-49" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> trial, <span class="at">y =</span> choice),</span>
<span id="cb92-50"><a href="from-simulation-to-model-fitting.html#cb92-50" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb92-51"><a href="from-simulation-to-model-fitting.html#cb92-51" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Prior Predictive Check&quot;</span>,</span>
<span id="cb92-52"><a href="from-simulation-to-model-fitting.html#cb92-52" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Trial&quot;</span>,</span>
<span id="cb92-53"><a href="from-simulation-to-model-fitting.html#cb92-53" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Choice (0/1)&quot;</span>) <span class="sc">+</span></span>
<span id="cb92-54"><a href="from-simulation-to-model-fitting.html#cb92-54" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb92-55"><a href="from-simulation-to-model-fitting.html#cb92-55" tabindex="-1"></a></span>
<span id="cb92-56"><a href="from-simulation-to-model-fitting.html#cb92-56" tabindex="-1"></a><span class="co"># Then the posterior predictive check</span></span>
<span id="cb92-57"><a href="from-simulation-to-model-fitting.html#cb92-57" tabindex="-1"></a>p5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb92-58"><a href="from-simulation-to-model-fitting.html#cb92-58" tabindex="-1"></a>  <span class="co"># Add posterior prediction interval</span></span>
<span id="cb92-59"><a href="from-simulation-to-model-fitting.html#cb92-59" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="at">data =</span> posterior_summary,</span>
<span id="cb92-60"><a href="from-simulation-to-model-fitting.html#cb92-60" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> trial, <span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper),</span>
<span id="cb92-61"><a href="from-simulation-to-model-fitting.html#cb92-61" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">fill =</span> <span class="st">&quot;blue&quot;</span>) <span class="sc">+</span></span>
<span id="cb92-62"><a href="from-simulation-to-model-fitting.html#cb92-62" tabindex="-1"></a>  <span class="co"># Add mean posterior prediction</span></span>
<span id="cb92-63"><a href="from-simulation-to-model-fitting.html#cb92-63" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> posterior_summary,</span>
<span id="cb92-64"><a href="from-simulation-to-model-fitting.html#cb92-64" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> trial, <span class="at">y =</span> mean),</span>
<span id="cb92-65"><a href="from-simulation-to-model-fitting.html#cb92-65" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>) <span class="sc">+</span></span>
<span id="cb92-66"><a href="from-simulation-to-model-fitting.html#cb92-66" tabindex="-1"></a>  <span class="co"># Add actual data points</span></span>
<span id="cb92-67"><a href="from-simulation-to-model-fitting.html#cb92-67" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">tibble</span>(<span class="at">trial =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(data<span class="sc">$</span>h), </span>
<span id="cb92-68"><a href="from-simulation-to-model-fitting.html#cb92-68" tabindex="-1"></a>                          <span class="at">choice =</span> data<span class="sc">$</span>h),</span>
<span id="cb92-69"><a href="from-simulation-to-model-fitting.html#cb92-69" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> trial, <span class="at">y =</span> choice),</span>
<span id="cb92-70"><a href="from-simulation-to-model-fitting.html#cb92-70" tabindex="-1"></a>             <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb92-71"><a href="from-simulation-to-model-fitting.html#cb92-71" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Posterior Predictive Check&quot;</span>,</span>
<span id="cb92-72"><a href="from-simulation-to-model-fitting.html#cb92-72" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Trial&quot;</span>,</span>
<span id="cb92-73"><a href="from-simulation-to-model-fitting.html#cb92-73" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Choice (0/1)&quot;</span>) <span class="sc">+</span></span>
<span id="cb92-74"><a href="from-simulation-to-model-fitting.html#cb92-74" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb92-75"><a href="from-simulation-to-model-fitting.html#cb92-75" tabindex="-1"></a></span>
<span id="cb92-76"><a href="from-simulation-to-model-fitting.html#cb92-76" tabindex="-1"></a><span class="co"># Display plots side by side</span></span>
<span id="cb92-77"><a href="from-simulation-to-model-fitting.html#cb92-77" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb92-78"><a href="from-simulation-to-model-fitting.html#cb92-78" tabindex="-1"></a>p4 <span class="sc">+</span> p5</span></code></pre></div>
<p><img src="series_files/figure-html/unnamed-chunk-14-4.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="from-simulation-to-model-fitting.html#cb93-1" tabindex="-1"></a><span class="co"># First, let&#39;s calculate the total number of 1s predicted in each posterior sample</span></span>
<span id="cb93-2"><a href="from-simulation-to-model-fitting.html#cb93-2" tabindex="-1"></a>posterior_totals <span class="ot">&lt;-</span> draws_df <span class="sc">%&gt;%</span></span>
<span id="cb93-3"><a href="from-simulation-to-model-fitting.html#cb93-3" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;posterior_preds[&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb93-4"><a href="from-simulation-to-model-fitting.html#cb93-4" tabindex="-1"></a>  <span class="co"># Sum across rows to get total 1s per sample</span></span>
<span id="cb93-5"><a href="from-simulation-to-model-fitting.html#cb93-5" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_ones =</span> <span class="fu">rowSums</span>(.)) </span>
<span id="cb93-6"><a href="from-simulation-to-model-fitting.html#cb93-6" tabindex="-1"></a></span>
<span id="cb93-7"><a href="from-simulation-to-model-fitting.html#cb93-7" tabindex="-1"></a><span class="co"># Do the same for prior predictions</span></span>
<span id="cb93-8"><a href="from-simulation-to-model-fitting.html#cb93-8" tabindex="-1"></a>prior_totals <span class="ot">&lt;-</span> draws_df <span class="sc">%&gt;%</span></span>
<span id="cb93-9"><a href="from-simulation-to-model-fitting.html#cb93-9" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;prior_preds[&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb93-10"><a href="from-simulation-to-model-fitting.html#cb93-10" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">total_ones =</span> <span class="fu">rowSums</span>(.))</span>
<span id="cb93-11"><a href="from-simulation-to-model-fitting.html#cb93-11" tabindex="-1"></a></span>
<span id="cb93-12"><a href="from-simulation-to-model-fitting.html#cb93-12" tabindex="-1"></a><span class="co"># Calculate actual number of 1s in the data</span></span>
<span id="cb93-13"><a href="from-simulation-to-model-fitting.html#cb93-13" tabindex="-1"></a>actual_ones <span class="ot">&lt;-</span> <span class="fu">sum</span>(data<span class="sc">$</span>h)</span>
<span id="cb93-14"><a href="from-simulation-to-model-fitting.html#cb93-14" tabindex="-1"></a></span>
<span id="cb93-15"><a href="from-simulation-to-model-fitting.html#cb93-15" tabindex="-1"></a><span class="co"># Create visualization comparing distributions</span></span>
<span id="cb93-16"><a href="from-simulation-to-model-fitting.html#cb93-16" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb93-17"><a href="from-simulation-to-model-fitting.html#cb93-17" tabindex="-1"></a>  <span class="co"># Prior predictive distribution</span></span>
<span id="cb93-18"><a href="from-simulation-to-model-fitting.html#cb93-18" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> prior_totals, </span>
<span id="cb93-19"><a href="from-simulation-to-model-fitting.html#cb93-19" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> total_ones, <span class="at">fill =</span> <span class="st">&quot;Prior&quot;</span>), </span>
<span id="cb93-20"><a href="from-simulation-to-model-fitting.html#cb93-20" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb93-21"><a href="from-simulation-to-model-fitting.html#cb93-21" tabindex="-1"></a>  <span class="co"># Posterior predictive distribution</span></span>
<span id="cb93-22"><a href="from-simulation-to-model-fitting.html#cb93-22" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">data =</span> posterior_totals, </span>
<span id="cb93-23"><a href="from-simulation-to-model-fitting.html#cb93-23" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> total_ones, <span class="at">fill =</span> <span class="st">&quot;Posterior&quot;</span>), </span>
<span id="cb93-24"><a href="from-simulation-to-model-fitting.html#cb93-24" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb93-25"><a href="from-simulation-to-model-fitting.html#cb93-25" tabindex="-1"></a>  <span class="co"># Vertical line for actual data</span></span>
<span id="cb93-26"><a href="from-simulation-to-model-fitting.html#cb93-26" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> actual_ones, </span>
<span id="cb93-27"><a href="from-simulation-to-model-fitting.html#cb93-27" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, </span>
<span id="cb93-28"><a href="from-simulation-to-model-fitting.html#cb93-28" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb93-29"><a href="from-simulation-to-model-fitting.html#cb93-29" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb93-30"><a href="from-simulation-to-model-fitting.html#cb93-30" tabindex="-1"></a>  <span class="co"># Aesthetics</span></span>
<span id="cb93-31"><a href="from-simulation-to-model-fitting.html#cb93-31" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Prior&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>, <span class="st">&quot;Posterior&quot;</span> <span class="ot">=</span> <span class="st">&quot;blue&quot;</span>),</span>
<span id="cb93-32"><a href="from-simulation-to-model-fitting.html#cb93-32" tabindex="-1"></a>                   <span class="at">name =</span> <span class="st">&quot;Distribution&quot;</span>) <span class="sc">+</span></span>
<span id="cb93-33"><a href="from-simulation-to-model-fitting.html#cb93-33" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Distribution of Predicted Successes (1s) out of 120 Trials&quot;</span>,</span>
<span id="cb93-34"><a href="from-simulation-to-model-fitting.html#cb93-34" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">&quot;Comparing Prior, Posterior and Actual Data&quot;</span>,</span>
<span id="cb93-35"><a href="from-simulation-to-model-fitting.html#cb93-35" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Number of 1s&quot;</span>,</span>
<span id="cb93-36"><a href="from-simulation-to-model-fitting.html#cb93-36" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb93-37"><a href="from-simulation-to-model-fitting.html#cb93-37" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb93-38"><a href="from-simulation-to-model-fitting.html#cb93-38" tabindex="-1"></a>  <span class="co"># Add annotation for actual value</span></span>
<span id="cb93-39"><a href="from-simulation-to-model-fitting.html#cb93-39" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">&quot;text&quot;</span>, </span>
<span id="cb93-40"><a href="from-simulation-to-model-fitting.html#cb93-40" tabindex="-1"></a>           <span class="at">x =</span> actual_ones, </span>
<span id="cb93-41"><a href="from-simulation-to-model-fitting.html#cb93-41" tabindex="-1"></a>           <span class="at">y =</span> <span class="dv">0</span>, </span>
<span id="cb93-42"><a href="from-simulation-to-model-fitting.html#cb93-42" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">&quot;Actual:&quot;</span>, actual_ones),</span>
<span id="cb93-43"><a href="from-simulation-to-model-fitting.html#cb93-43" tabindex="-1"></a>           <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>)</span></code></pre></div>
<p><img src="series_files/figure-html/unnamed-chunk-14-5.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="from-simulation-to-model-fitting.html#cb94-1" tabindex="-1"></a><span class="co"># Let&#39;s also print summary statistics</span></span>
<span id="cb94-2"><a href="from-simulation-to-model-fitting.html#cb94-2" tabindex="-1"></a>prior_summary <span class="ot">&lt;-</span> prior_totals <span class="sc">%&gt;%</span></span>
<span id="cb94-3"><a href="from-simulation-to-model-fitting.html#cb94-3" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb94-4"><a href="from-simulation-to-model-fitting.html#cb94-4" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(total_ones),</span>
<span id="cb94-5"><a href="from-simulation-to-model-fitting.html#cb94-5" tabindex="-1"></a>    <span class="at">sd =</span> <span class="fu">sd</span>(total_ones),</span>
<span id="cb94-6"><a href="from-simulation-to-model-fitting.html#cb94-6" tabindex="-1"></a>    <span class="at">q025 =</span> <span class="fu">quantile</span>(total_ones, <span class="fl">0.025</span>),</span>
<span id="cb94-7"><a href="from-simulation-to-model-fitting.html#cb94-7" tabindex="-1"></a>    <span class="at">q975 =</span> <span class="fu">quantile</span>(total_ones, <span class="fl">0.975</span>)</span>
<span id="cb94-8"><a href="from-simulation-to-model-fitting.html#cb94-8" tabindex="-1"></a>  )</span>
<span id="cb94-9"><a href="from-simulation-to-model-fitting.html#cb94-9" tabindex="-1"></a></span>
<span id="cb94-10"><a href="from-simulation-to-model-fitting.html#cb94-10" tabindex="-1"></a>posterior_summary <span class="ot">&lt;-</span> posterior_totals <span class="sc">%&gt;%</span></span>
<span id="cb94-11"><a href="from-simulation-to-model-fitting.html#cb94-11" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb94-12"><a href="from-simulation-to-model-fitting.html#cb94-12" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">mean</span>(total_ones),</span>
<span id="cb94-13"><a href="from-simulation-to-model-fitting.html#cb94-13" tabindex="-1"></a>    <span class="at">sd =</span> <span class="fu">sd</span>(total_ones),</span>
<span id="cb94-14"><a href="from-simulation-to-model-fitting.html#cb94-14" tabindex="-1"></a>    <span class="at">q025 =</span> <span class="fu">quantile</span>(total_ones, <span class="fl">0.025</span>),</span>
<span id="cb94-15"><a href="from-simulation-to-model-fitting.html#cb94-15" tabindex="-1"></a>    <span class="at">q975 =</span> <span class="fu">quantile</span>(total_ones, <span class="fl">0.975</span>)</span>
<span id="cb94-16"><a href="from-simulation-to-model-fitting.html#cb94-16" tabindex="-1"></a>  )</span>
<span id="cb94-17"><a href="from-simulation-to-model-fitting.html#cb94-17" tabindex="-1"></a></span>
<span id="cb94-18"><a href="from-simulation-to-model-fitting.html#cb94-18" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&quot;Prior predictive summary:&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;Prior predictive summary:&quot;</code></pre>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="from-simulation-to-model-fitting.html#cb96-1" tabindex="-1"></a><span class="fu">print</span>(prior_summary)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 4
##    mean    sd  q025  q975
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  60.0  20.0    23  98.0</code></pre>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="from-simulation-to-model-fitting.html#cb98-1" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&quot;Posterior predictive summary:&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;Posterior predictive summary:&quot;</code></pre>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="from-simulation-to-model-fitting.html#cb100-1" tabindex="-1"></a><span class="fu">print</span>(posterior_summary)</span></code></pre></div>
<pre><code>## # A tibble: 1 × 4
##    mean    sd  q025  q975
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  98.6  5.40    87  108.</code></pre>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="from-simulation-to-model-fitting.html#cb102-1" tabindex="-1"></a><span class="co"># First let&#39;s calculate predicted probabilities for each draw and memory level</span></span>
<span id="cb102-2"><a href="from-simulation-to-model-fitting.html#cb102-2" tabindex="-1"></a>predicted_probs <span class="ot">&lt;-</span> draws_df <span class="sc">%&gt;%</span></span>
<span id="cb102-3"><a href="from-simulation-to-model-fitting.html#cb102-3" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb102-4"><a href="from-simulation-to-model-fitting.html#cb102-4" tabindex="-1"></a>    <span class="co"># Calculate probability of choosing right for each memory level</span></span>
<span id="cb102-5"><a href="from-simulation-to-model-fitting.html#cb102-5" tabindex="-1"></a>    <span class="co"># using the logistic function on our parameter estimates</span></span>
<span id="cb102-6"><a href="from-simulation-to-model-fitting.html#cb102-6" tabindex="-1"></a>    <span class="at">prob_low =</span> <span class="fu">inv_logit_scaled</span>(bias <span class="sc">+</span> beta <span class="sc">*</span> <span class="fu">logit_scaled</span>(<span class="fl">0.2</span>)),</span>
<span id="cb102-7"><a href="from-simulation-to-model-fitting.html#cb102-7" tabindex="-1"></a>    <span class="at">prob_mid =</span> <span class="fu">inv_logit_scaled</span>(bias <span class="sc">+</span> beta <span class="sc">*</span> <span class="fu">logit_scaled</span>(<span class="fl">0.5</span>)),</span>
<span id="cb102-8"><a href="from-simulation-to-model-fitting.html#cb102-8" tabindex="-1"></a>    <span class="at">prob_high =</span> <span class="fu">inv_logit_scaled</span>(bias <span class="sc">+</span> beta <span class="sc">*</span> <span class="fu">logit_scaled</span>(<span class="fl">0.8</span>))</span>
<span id="cb102-9"><a href="from-simulation-to-model-fitting.html#cb102-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb102-10"><a href="from-simulation-to-model-fitting.html#cb102-10" tabindex="-1"></a>  <span class="co"># Reshape to long format for easier plotting</span></span>
<span id="cb102-11"><a href="from-simulation-to-model-fitting.html#cb102-11" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb102-12"><a href="from-simulation-to-model-fitting.html#cb102-12" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">&quot;prob_&quot;</span>),</span>
<span id="cb102-13"><a href="from-simulation-to-model-fitting.html#cb102-13" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">&quot;memory_level&quot;</span>,</span>
<span id="cb102-14"><a href="from-simulation-to-model-fitting.html#cb102-14" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">&quot;probability&quot;</span></span>
<span id="cb102-15"><a href="from-simulation-to-model-fitting.html#cb102-15" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb102-16"><a href="from-simulation-to-model-fitting.html#cb102-16" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb102-17"><a href="from-simulation-to-model-fitting.html#cb102-17" tabindex="-1"></a>    <span class="at">memory_value =</span> <span class="fu">case_when</span>(</span>
<span id="cb102-18"><a href="from-simulation-to-model-fitting.html#cb102-18" tabindex="-1"></a>      memory_level <span class="sc">==</span> <span class="st">&quot;prob_low&quot;</span> <span class="sc">~</span> <span class="fl">0.2</span>,</span>
<span id="cb102-19"><a href="from-simulation-to-model-fitting.html#cb102-19" tabindex="-1"></a>      memory_level <span class="sc">==</span> <span class="st">&quot;prob_mid&quot;</span> <span class="sc">~</span> <span class="fl">0.5</span>,</span>
<span id="cb102-20"><a href="from-simulation-to-model-fitting.html#cb102-20" tabindex="-1"></a>      memory_level <span class="sc">==</span> <span class="st">&quot;prob_high&quot;</span> <span class="sc">~</span> <span class="fl">0.8</span></span>
<span id="cb102-21"><a href="from-simulation-to-model-fitting.html#cb102-21" tabindex="-1"></a>    )</span>
<span id="cb102-22"><a href="from-simulation-to-model-fitting.html#cb102-22" tabindex="-1"></a>  )</span>
<span id="cb102-23"><a href="from-simulation-to-model-fitting.html#cb102-23" tabindex="-1"></a></span>
<span id="cb102-24"><a href="from-simulation-to-model-fitting.html#cb102-24" tabindex="-1"></a><span class="co"># Do the same for prior predictions</span></span>
<span id="cb102-25"><a href="from-simulation-to-model-fitting.html#cb102-25" tabindex="-1"></a>prior_probs <span class="ot">&lt;-</span> draws_df <span class="sc">%&gt;%</span></span>
<span id="cb102-26"><a href="from-simulation-to-model-fitting.html#cb102-26" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb102-27"><a href="from-simulation-to-model-fitting.html#cb102-27" tabindex="-1"></a>    <span class="at">prob_low =</span> <span class="fu">inv_logit_scaled</span>(bias_prior <span class="sc">+</span> beta_prior <span class="sc">*</span> <span class="fu">logit_scaled</span>(<span class="fl">0.2</span>)),</span>
<span id="cb102-28"><a href="from-simulation-to-model-fitting.html#cb102-28" tabindex="-1"></a>    <span class="at">prob_mid =</span> <span class="fu">inv_logit_scaled</span>(bias_prior <span class="sc">+</span> beta_prior <span class="sc">*</span> <span class="fu">logit_scaled</span>(<span class="fl">0.5</span>)),</span>
<span id="cb102-29"><a href="from-simulation-to-model-fitting.html#cb102-29" tabindex="-1"></a>    <span class="at">prob_high =</span> <span class="fu">inv_logit_scaled</span>(bias_prior <span class="sc">+</span> beta_prior <span class="sc">*</span> <span class="fu">logit_scaled</span>(<span class="fl">0.8</span>))</span>
<span id="cb102-30"><a href="from-simulation-to-model-fitting.html#cb102-30" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb102-31"><a href="from-simulation-to-model-fitting.html#cb102-31" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb102-32"><a href="from-simulation-to-model-fitting.html#cb102-32" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">&quot;prob_&quot;</span>),</span>
<span id="cb102-33"><a href="from-simulation-to-model-fitting.html#cb102-33" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">&quot;memory_level&quot;</span>,</span>
<span id="cb102-34"><a href="from-simulation-to-model-fitting.html#cb102-34" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">&quot;probability&quot;</span></span>
<span id="cb102-35"><a href="from-simulation-to-model-fitting.html#cb102-35" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb102-36"><a href="from-simulation-to-model-fitting.html#cb102-36" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb102-37"><a href="from-simulation-to-model-fitting.html#cb102-37" tabindex="-1"></a>    <span class="at">memory_value =</span> <span class="fu">case_when</span>(</span>
<span id="cb102-38"><a href="from-simulation-to-model-fitting.html#cb102-38" tabindex="-1"></a>      memory_level <span class="sc">==</span> <span class="st">&quot;prob_low&quot;</span> <span class="sc">~</span> <span class="fl">0.2</span>,</span>
<span id="cb102-39"><a href="from-simulation-to-model-fitting.html#cb102-39" tabindex="-1"></a>      memory_level <span class="sc">==</span> <span class="st">&quot;prob_mid&quot;</span> <span class="sc">~</span> <span class="fl">0.5</span>,</span>
<span id="cb102-40"><a href="from-simulation-to-model-fitting.html#cb102-40" tabindex="-1"></a>      memory_level <span class="sc">==</span> <span class="st">&quot;prob_high&quot;</span> <span class="sc">~</span> <span class="fl">0.8</span></span>
<span id="cb102-41"><a href="from-simulation-to-model-fitting.html#cb102-41" tabindex="-1"></a>    )</span>
<span id="cb102-42"><a href="from-simulation-to-model-fitting.html#cb102-42" tabindex="-1"></a>  )</span>
<span id="cb102-43"><a href="from-simulation-to-model-fitting.html#cb102-43" tabindex="-1"></a></span>
<span id="cb102-44"><a href="from-simulation-to-model-fitting.html#cb102-44" tabindex="-1"></a><span class="co"># Create visualization with density plots</span></span>
<span id="cb102-45"><a href="from-simulation-to-model-fitting.html#cb102-45" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb102-46"><a href="from-simulation-to-model-fitting.html#cb102-46" tabindex="-1"></a>  <span class="co"># Add prior distributions</span></span>
<span id="cb102-47"><a href="from-simulation-to-model-fitting.html#cb102-47" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> prior_probs,</span>
<span id="cb102-48"><a href="from-simulation-to-model-fitting.html#cb102-48" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> probability, <span class="at">fill =</span> <span class="st">&quot;Prior&quot;</span>),</span>
<span id="cb102-49"><a href="from-simulation-to-model-fitting.html#cb102-49" tabindex="-1"></a>               <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb102-50"><a href="from-simulation-to-model-fitting.html#cb102-50" tabindex="-1"></a>  <span class="co"># Add posterior distributions</span></span>
<span id="cb102-51"><a href="from-simulation-to-model-fitting.html#cb102-51" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">data =</span> predicted_probs,</span>
<span id="cb102-52"><a href="from-simulation-to-model-fitting.html#cb102-52" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> probability, <span class="at">fill =</span> <span class="st">&quot;Posterior&quot;</span>),</span>
<span id="cb102-53"><a href="from-simulation-to-model-fitting.html#cb102-53" tabindex="-1"></a>               <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb102-54"><a href="from-simulation-to-model-fitting.html#cb102-54" tabindex="-1"></a>  <span class="co"># Separate by memory level</span></span>
<span id="cb102-55"><a href="from-simulation-to-model-fitting.html#cb102-55" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>memory_value, </span>
<span id="cb102-56"><a href="from-simulation-to-model-fitting.html#cb102-56" tabindex="-1"></a>             <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">memory_value =</span> <span class="fu">c</span>(</span>
<span id="cb102-57"><a href="from-simulation-to-model-fitting.html#cb102-57" tabindex="-1"></a>               <span class="st">&quot;0.2&quot;</span> <span class="ot">=</span> <span class="st">&quot;Low Memory (20% Right)&quot;</span>,</span>
<span id="cb102-58"><a href="from-simulation-to-model-fitting.html#cb102-58" tabindex="-1"></a>               <span class="st">&quot;0.5&quot;</span> <span class="ot">=</span> <span class="st">&quot;Neutral Memory (50% Right)&quot;</span>,</span>
<span id="cb102-59"><a href="from-simulation-to-model-fitting.html#cb102-59" tabindex="-1"></a>               <span class="st">&quot;0.8&quot;</span> <span class="ot">=</span> <span class="st">&quot;High Memory (80% Right)&quot;</span></span>
<span id="cb102-60"><a href="from-simulation-to-model-fitting.html#cb102-60" tabindex="-1"></a>             ))) <span class="sc">+</span></span>
<span id="cb102-61"><a href="from-simulation-to-model-fitting.html#cb102-61" tabindex="-1"></a>  <span class="co"># Aesthetics</span></span>
<span id="cb102-62"><a href="from-simulation-to-model-fitting.html#cb102-62" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Prior&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>, <span class="st">&quot;Posterior&quot;</span> <span class="ot">=</span> <span class="st">&quot;blue&quot;</span>),</span>
<span id="cb102-63"><a href="from-simulation-to-model-fitting.html#cb102-63" tabindex="-1"></a>                   <span class="at">name =</span> <span class="st">&quot;Distribution&quot;</span>) <span class="sc">+</span></span>
<span id="cb102-64"><a href="from-simulation-to-model-fitting.html#cb102-64" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Distribution of Predicted Probabilities at Different Memory Levels&quot;</span>,</span>
<span id="cb102-65"><a href="from-simulation-to-model-fitting.html#cb102-65" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Probability of Choosing Right&quot;</span>,</span>
<span id="cb102-66"><a href="from-simulation-to-model-fitting.html#cb102-66" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb102-67"><a href="from-simulation-to-model-fitting.html#cb102-67" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb102-68"><a href="from-simulation-to-model-fitting.html#cb102-68" tabindex="-1"></a></span>
<span id="cb102-69"><a href="from-simulation-to-model-fitting.html#cb102-69" tabindex="-1"></a><span class="co"># Alternative visualization using violin plots</span></span>
<span id="cb102-70"><a href="from-simulation-to-model-fitting.html#cb102-70" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb102-71"><a href="from-simulation-to-model-fitting.html#cb102-71" tabindex="-1"></a>  <span class="co"># Add prior distributions</span></span>
<span id="cb102-72"><a href="from-simulation-to-model-fitting.html#cb102-72" tabindex="-1"></a>  <span class="fu">geom_violin</span>(<span class="at">data =</span> prior_probs,</span>
<span id="cb102-73"><a href="from-simulation-to-model-fitting.html#cb102-73" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(memory_value), <span class="at">y =</span> probability, <span class="at">fill =</span> <span class="st">&quot;Prior&quot;</span>),</span>
<span id="cb102-74"><a href="from-simulation-to-model-fitting.html#cb102-74" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb102-75"><a href="from-simulation-to-model-fitting.html#cb102-75" tabindex="-1"></a>  <span class="co"># Add posterior distributions</span></span>
<span id="cb102-76"><a href="from-simulation-to-model-fitting.html#cb102-76" tabindex="-1"></a>  <span class="fu">geom_violin</span>(<span class="at">data =</span> predicted_probs,</span>
<span id="cb102-77"><a href="from-simulation-to-model-fitting.html#cb102-77" tabindex="-1"></a>              <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(memory_value), <span class="at">y =</span> probability, <span class="at">fill =</span> <span class="st">&quot;Posterior&quot;</span>),</span>
<span id="cb102-78"><a href="from-simulation-to-model-fitting.html#cb102-78" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb102-79"><a href="from-simulation-to-model-fitting.html#cb102-79" tabindex="-1"></a>  <span class="co"># Aesthetics</span></span>
<span id="cb102-80"><a href="from-simulation-to-model-fitting.html#cb102-80" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Prior&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>, <span class="st">&quot;Posterior&quot;</span> <span class="ot">=</span> <span class="st">&quot;blue&quot;</span>),</span>
<span id="cb102-81"><a href="from-simulation-to-model-fitting.html#cb102-81" tabindex="-1"></a>                   <span class="at">name =</span> <span class="st">&quot;Distribution&quot;</span>) <span class="sc">+</span></span>
<span id="cb102-82"><a href="from-simulation-to-model-fitting.html#cb102-82" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Low</span><span class="sc">\n</span><span class="st">(20% Right)&quot;</span>, <span class="st">&quot;Neutral</span><span class="sc">\n</span><span class="st">(50% Right)&quot;</span>, <span class="st">&quot;High</span><span class="sc">\n</span><span class="st">(80% Right)&quot;</span>)) <span class="sc">+</span></span>
<span id="cb102-83"><a href="from-simulation-to-model-fitting.html#cb102-83" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Distribution of Predicted Probabilities by Memory Level&quot;</span>,</span>
<span id="cb102-84"><a href="from-simulation-to-model-fitting.html#cb102-84" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Memory Level&quot;</span>,</span>
<span id="cb102-85"><a href="from-simulation-to-model-fitting.html#cb102-85" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Probability of Choosing Right&quot;</span>) <span class="sc">+</span></span>
<span id="cb102-86"><a href="from-simulation-to-model-fitting.html#cb102-86" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb102-87"><a href="from-simulation-to-model-fitting.html#cb102-87" tabindex="-1"></a></span>
<span id="cb102-88"><a href="from-simulation-to-model-fitting.html#cb102-88" tabindex="-1"></a><span class="co"># Display both visualizations</span></span>
<span id="cb102-89"><a href="from-simulation-to-model-fitting.html#cb102-89" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb102-90"><a href="from-simulation-to-model-fitting.html#cb102-90" tabindex="-1"></a>p1 <span class="sc">/</span> p2</span></code></pre></div>
<p><img src="series_files/figure-html/unnamed-chunk-14-6.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="from-simulation-to-model-fitting.html#cb103-1" tabindex="-1"></a><span class="co"># 4. Check for divergences</span></span>
<span id="cb103-2"><a href="from-simulation-to-model-fitting.html#cb103-2" tabindex="-1"></a><span class="co"># Extract divergent transitions</span></span>
<span id="cb103-3"><a href="from-simulation-to-model-fitting.html#cb103-3" tabindex="-1"></a>n_div <span class="ot">&lt;-</span> <span class="fu">sum</span>(draws_df<span class="sc">$</span>.divergent)</span>
<span id="cb103-4"><a href="from-simulation-to-model-fitting.html#cb103-4" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&quot;Number of divergent transitions:&quot;</span>, n_div))</span></code></pre></div>
<pre><code>## [1] &quot;Number of divergent transitions: 0&quot;</code></pre>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="from-simulation-to-model-fitting.html#cb105-1" tabindex="-1"></a><span class="co"># Plot divergent transitions in parameter space</span></span>
<span id="cb105-2"><a href="from-simulation-to-model-fitting.html#cb105-2" tabindex="-1"></a><span class="co"># ggplot(draws_df, aes(bias, beta)) +</span></span>
<span id="cb105-3"><a href="from-simulation-to-model-fitting.html#cb105-3" tabindex="-1"></a><span class="co">#   geom_point(aes(color = factor(.divergent)), alpha = 0.5) +</span></span>
<span id="cb105-4"><a href="from-simulation-to-model-fitting.html#cb105-4" tabindex="-1"></a><span class="co">#   scale_color_manual(values = c(&quot;black&quot;, &quot;red&quot;)) +</span></span>
<span id="cb105-5"><a href="from-simulation-to-model-fitting.html#cb105-5" tabindex="-1"></a><span class="co">#   theme_minimal() +</span></span>
<span id="cb105-6"><a href="from-simulation-to-model-fitting.html#cb105-6" tabindex="-1"></a><span class="co">#   ggtitle(&quot;Divergent Transitions in Parameter Space&quot;)</span></span></code></pre></div>
<p>Now that we know how to model memory as an internal state, we can play with making the update discount the past, setting a parameter that indicates after how many trials memory is lost, etc.</p>
<div id="trying-out-a-more-complex-memory-model-with-a-rate-of-forgetting-that-exponentially-discounts-the-past" class="section level3 hasAnchor" number="5.7.1">
<h3><span class="header-section-number">5.7.1</span> Trying out a more complex memory model, with a rate of forgetting that exponentially discounts the past<a href="from-simulation-to-model-fitting.html#trying-out-a-more-complex-memory-model-with-a-rate-of-forgetting-that-exponentially-discounts-the-past" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="from-simulation-to-model-fitting.html#cb106-1" tabindex="-1"></a>stan_model <span class="ot">&lt;-</span> <span class="st">&quot;</span></span>
<span id="cb106-2"><a href="from-simulation-to-model-fitting.html#cb106-2" tabindex="-1"></a><span class="st">// The input (data) for the model. n of trials and h for (right and left) hand</span></span>
<span id="cb106-3"><a href="from-simulation-to-model-fitting.html#cb106-3" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb106-4"><a href="from-simulation-to-model-fitting.html#cb106-4" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;</span></span>
<span id="cb106-5"><a href="from-simulation-to-model-fitting.html#cb106-5" tabindex="-1"></a><span class="st">  array[n] int h;</span></span>
<span id="cb106-6"><a href="from-simulation-to-model-fitting.html#cb106-6" tabindex="-1"></a><span class="st">  array[n] int other;</span></span>
<span id="cb106-7"><a href="from-simulation-to-model-fitting.html#cb106-7" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb106-8"><a href="from-simulation-to-model-fitting.html#cb106-8" tabindex="-1"></a></span>
<span id="cb106-9"><a href="from-simulation-to-model-fitting.html#cb106-9" tabindex="-1"></a><span class="st">// The parameters accepted by the model. </span></span>
<span id="cb106-10"><a href="from-simulation-to-model-fitting.html#cb106-10" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb106-11"><a href="from-simulation-to-model-fitting.html#cb106-11" tabindex="-1"></a><span class="st">  real bias; // how likely is the agent to pick right when the previous rate has no information (50-50)?</span></span>
<span id="cb106-12"><a href="from-simulation-to-model-fitting.html#cb106-12" tabindex="-1"></a><span class="st">  real beta; // how strongly is previous rate impacting the decision?</span></span>
<span id="cb106-13"><a href="from-simulation-to-model-fitting.html#cb106-13" tabindex="-1"></a><span class="st">  real&lt;lower=0, upper=1&gt; forgetting;</span></span>
<span id="cb106-14"><a href="from-simulation-to-model-fitting.html#cb106-14" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb106-15"><a href="from-simulation-to-model-fitting.html#cb106-15" tabindex="-1"></a></span>
<span id="cb106-16"><a href="from-simulation-to-model-fitting.html#cb106-16" tabindex="-1"></a><span class="st">// The model to be estimated. </span></span>
<span id="cb106-17"><a href="from-simulation-to-model-fitting.html#cb106-17" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb106-18"><a href="from-simulation-to-model-fitting.html#cb106-18" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb106-19"><a href="from-simulation-to-model-fitting.html#cb106-19" tabindex="-1"></a><span class="st">  vector[n] memory;</span></span>
<span id="cb106-20"><a href="from-simulation-to-model-fitting.html#cb106-20" tabindex="-1"></a><span class="st">  // Priors</span></span>
<span id="cb106-21"><a href="from-simulation-to-model-fitting.html#cb106-21" tabindex="-1"></a><span class="st">  target += beta_lpdf(forgetting | 1, 1);</span></span>
<span id="cb106-22"><a href="from-simulation-to-model-fitting.html#cb106-22" tabindex="-1"></a><span class="st">  target += normal_lpdf(bias | 0, .3);</span></span>
<span id="cb106-23"><a href="from-simulation-to-model-fitting.html#cb106-23" tabindex="-1"></a><span class="st">  target += normal_lpdf(beta | 0, .5);</span></span>
<span id="cb106-24"><a href="from-simulation-to-model-fitting.html#cb106-24" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb106-25"><a href="from-simulation-to-model-fitting.html#cb106-25" tabindex="-1"></a><span class="st">  // Model, looping to keep track of memory</span></span>
<span id="cb106-26"><a href="from-simulation-to-model-fitting.html#cb106-26" tabindex="-1"></a><span class="st">  for (trial in 1:n) {</span></span>
<span id="cb106-27"><a href="from-simulation-to-model-fitting.html#cb106-27" tabindex="-1"></a><span class="st">    if (trial == 1) {</span></span>
<span id="cb106-28"><a href="from-simulation-to-model-fitting.html#cb106-28" tabindex="-1"></a><span class="st">      memory[trial] = 0.5;</span></span>
<span id="cb106-29"><a href="from-simulation-to-model-fitting.html#cb106-29" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb106-30"><a href="from-simulation-to-model-fitting.html#cb106-30" tabindex="-1"></a><span class="st">    target += bernoulli_logit_lpmf(h[trial] | bias + beta * logit(memory[trial]));</span></span>
<span id="cb106-31"><a href="from-simulation-to-model-fitting.html#cb106-31" tabindex="-1"></a><span class="st">    if (trial &lt; n){</span></span>
<span id="cb106-32"><a href="from-simulation-to-model-fitting.html#cb106-32" tabindex="-1"></a><span class="st">      memory[trial + 1] = (1 - forgetting) * memory[trial] + forgetting * other[trial];</span></span>
<span id="cb106-33"><a href="from-simulation-to-model-fitting.html#cb106-33" tabindex="-1"></a><span class="st">      if (memory[trial + 1] == 0){memory[trial + 1] = 0.01;}</span></span>
<span id="cb106-34"><a href="from-simulation-to-model-fitting.html#cb106-34" tabindex="-1"></a><span class="st">      if (memory[trial + 1] == 1){memory[trial + 1] = 0.99;}</span></span>
<span id="cb106-35"><a href="from-simulation-to-model-fitting.html#cb106-35" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb106-36"><a href="from-simulation-to-model-fitting.html#cb106-36" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb106-37"><a href="from-simulation-to-model-fitting.html#cb106-37" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb106-38"><a href="from-simulation-to-model-fitting.html#cb106-38" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb106-39"><a href="from-simulation-to-model-fitting.html#cb106-39" tabindex="-1"></a><span class="st">&quot;</span></span>
<span id="cb106-40"><a href="from-simulation-to-model-fitting.html#cb106-40" tabindex="-1"></a><span class="fu">write_stan_file</span>(</span>
<span id="cb106-41"><a href="from-simulation-to-model-fitting.html#cb106-41" tabindex="-1"></a>  stan_model,</span>
<span id="cb106-42"><a href="from-simulation-to-model-fitting.html#cb106-42" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">&quot;stan/&quot;</span>,</span>
<span id="cb106-43"><a href="from-simulation-to-model-fitting.html#cb106-43" tabindex="-1"></a>  <span class="at">basename =</span> <span class="st">&quot;W3_InternalMemory2.stan&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;/Users/au209589/Dropbox/Teaching/AdvancedCognitiveModeling23_book/stan/W3_InternalMemory2.stan&quot;</code></pre>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="from-simulation-to-model-fitting.html#cb108-1" tabindex="-1"></a><span class="do">## Specify where the model is</span></span>
<span id="cb108-2"><a href="from-simulation-to-model-fitting.html#cb108-2" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">&quot;stan/W3_InternalMemory2.stan&quot;</span>)</span>
<span id="cb108-3"><a href="from-simulation-to-model-fitting.html#cb108-3" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(file, <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">TRUE</span>),</span>
<span id="cb108-4"><a href="from-simulation-to-model-fitting.html#cb108-4" tabindex="-1"></a>                     <span class="at">stanc_options =</span> <span class="fu">list</span>(<span class="st">&quot;O1&quot;</span>))</span>
<span id="cb108-5"><a href="from-simulation-to-model-fitting.html#cb108-5" tabindex="-1"></a></span>
<span id="cb108-6"><a href="from-simulation-to-model-fitting.html#cb108-6" tabindex="-1"></a><span class="co"># The following command calls Stan with specific options.</span></span>
<span id="cb108-7"><a href="from-simulation-to-model-fitting.html#cb108-7" tabindex="-1"></a>samples <span class="ot">&lt;-</span> mod<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb108-8"><a href="from-simulation-to-model-fitting.html#cb108-8" tabindex="-1"></a>  <span class="at">data =</span> data,</span>
<span id="cb108-9"><a href="from-simulation-to-model-fitting.html#cb108-9" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb108-10"><a href="from-simulation-to-model-fitting.html#cb108-10" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">1</span>,</span>
<span id="cb108-11"><a href="from-simulation-to-model-fitting.html#cb108-11" tabindex="-1"></a>  <span class="at">parallel_chains =</span> <span class="dv">2</span>,</span>
<span id="cb108-12"><a href="from-simulation-to-model-fitting.html#cb108-12" tabindex="-1"></a>  <span class="at">threads_per_chain =</span> <span class="dv">2</span>,</span>
<span id="cb108-13"><a href="from-simulation-to-model-fitting.html#cb108-13" tabindex="-1"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb108-14"><a href="from-simulation-to-model-fitting.html#cb108-14" tabindex="-1"></a>  <span class="at">iter_sampling =</span> <span class="dv">1000</span>,</span>
<span id="cb108-15"><a href="from-simulation-to-model-fitting.html#cb108-15" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">0</span>,</span>
<span id="cb108-16"><a href="from-simulation-to-model-fitting.html#cb108-16" tabindex="-1"></a>  <span class="at">max_treedepth =</span> <span class="dv">20</span>,</span>
<span id="cb108-17"><a href="from-simulation-to-model-fitting.html#cb108-17" tabindex="-1"></a>  <span class="at">adapt_delta =</span> <span class="fl">0.99</span>,</span>
<span id="cb108-18"><a href="from-simulation-to-model-fitting.html#cb108-18" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Running MCMC with 1 chain, with 2 thread(s) per chain...
## 
## Chain 1 finished in 0.7 seconds.</code></pre>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="from-simulation-to-model-fitting.html#cb110-1" tabindex="-1"></a>samples<span class="sc">$</span><span class="fu">summary</span>() </span></code></pre></div>
<pre><code>## # A tibble: 4 × 10
##   variable       mean   median     sd    mad       q5     q95  rhat ess_bulk ess_tail
##   &lt;chr&gt;         &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
## 1 lp__       -58.0    -57.7    1.28   0.943  -60.6    -56.7   0.999     297.     374.
## 2 bias         0.479    0.475  0.246  0.249    0.0792   0.879 1.00      363.     489.
## 3 beta         0.810    0.804  0.270  0.253    0.361    1.24  1.00      425.     455.
## 4 forgetting   0.0660   0.0536 0.0515 0.0288   0.0221   0.147 0.999     557.     411.</code></pre>
<p>The memory model we’ve implemented can be seen as part of a broader family of models that track and update beliefs based on incoming evidence. Let’s explore how it relates to some key frameworks.</p>
</div>
<div id="connection-to-kalman-filters" class="section level3 hasAnchor" number="5.7.2">
<h3><span class="header-section-number">5.7.2</span> Connection to Kalman Filters<a href="from-simulation-to-model-fitting.html#connection-to-kalman-filters" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Our memory model updates beliefs about the probability of right-hand choices using a weighted average of past observations. This is conceptually similar to how a Kalman filter works, though simpler:</p>
<ul>
<li><p>Kalman filters maintain both an estimate and uncertainty about that estimate</p></li>
<li><p>They optimally weight new evidence based on relative uncertainty</p></li>
<li><p>Our model uses a fixed weighting scheme (1/trial or the forgetting parameter)</p></li>
</ul>
<p>The key difference is that Kalman filters dynamically adjust how much they learn from new evidence based on uncertainty, while our model uses a fixed learning scheme.</p>
</div>
</div>
<div id="relationship-to-rescorla-wagner" class="section level2 hasAnchor" number="5.8">
<h2><span class="header-section-number">5.8</span> Relationship to Rescorla-Wagner<a href="from-simulation-to-model-fitting.html#relationship-to-rescorla-wagner" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The Rescorla-Wagner model of learning follows the form:</p>
<p>V(t+1) = V(t) + α(λ - V(t))</p>
<p>where:</p>
<ul>
<li><p>V(t) is the current estimate</p></li>
<li><p>α is the learning rate</p></li>
<li><p>λ is the observed outcome</p></li>
<li><p>(λ - V(t)) is the prediction error</p></li>
</ul>
<p>Our memory model with forgetting parameter follows a very similar structure:</p>
<p>memory(t+1) = (1-forgetting) * memory(t) + forgetting * outcome(t)</p>
<p>This can be rewritten as:</p>
<p>memory(t+1) = memory(t) + forgetting * (outcome(t) - memory(t))</p>
<p>Making the parallel clear: our forgetting parameter acts as the learning rate α in Rescorla-Wagner.</p>
<div id="connection-to-hierarchical-gaussian-filter-hgf" class="section level3 hasAnchor" number="5.8.1">
<h3><span class="header-section-number">5.8.1</span> Connection to Hierarchical Gaussian Filter (HGF)<a href="from-simulation-to-model-fitting.html#connection-to-hierarchical-gaussian-filter-hgf" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The HGF extends these ideas by:</p>
<ul>
<li><p>Tracking beliefs at multiple levels</p></li>
<li><p>Allowing learning rates to vary over time</p></li>
<li><p>Explicitly modeling environmental volatility</p></li>
</ul>
<p>Our model could be seen as the simplest case of an HGF where:</p>
<ul>
<li><p>We only track one level (probability of right-hand choice)</p></li>
<li><p>Have a fixed learning rate (forgetting parameter)</p></li>
<li><p>Don’t explicitly model environmental volatility</p></li>
</ul>
</div>
<div id="implications-for-model-development" class="section level3 hasAnchor" number="5.8.2">
<h3><span class="header-section-number">5.8.2</span> Implications for Model Development<a href="from-simulation-to-model-fitting.html#implications-for-model-development" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Understanding these relationships helps us think about how models relate to each other and to extend our model:</p>
<ul>
<li><p>We could add uncertainty estimates to get Kalman-like behavior</p></li>
<li><p>We could make the forgetting parameter dynamic to capture changing learning rates</p></li>
<li><p>We could add multiple levels to track both immediate probabilities and longer-term trends</p></li>
</ul>
<p>Each extension would make the model more flexible but also more complex to fit to data. The choice depends on our specific research questions and available data.</p>
</div>
</div>
<div id="bayesian-memory-agent" class="section level2 hasAnchor" number="5.9">
<h2><span class="header-section-number">5.9</span> Bayesian memory agent<a href="from-simulation-to-model-fitting.html#bayesian-memory-agent" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We can also model the memory agent in a Bayesian framework. This allows us to model the agent as (optimally) estimating a possible distribution of rates from the other’s behavior and keep all the uncertainty.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="from-simulation-to-model-fitting.html#cb112-1" tabindex="-1"></a>stan_model <span class="ot">&lt;-</span> <span class="st">&quot;</span></span>
<span id="cb112-2"><a href="from-simulation-to-model-fitting.html#cb112-2" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb112-3"><a href="from-simulation-to-model-fitting.html#cb112-3" tabindex="-1"></a><span class="st">  int&lt;lower=1&gt; n;  // number of trials</span></span>
<span id="cb112-4"><a href="from-simulation-to-model-fitting.html#cb112-4" tabindex="-1"></a><span class="st">  array[n] int h;  // agent&#39;s choices (0 or 1)</span></span>
<span id="cb112-5"><a href="from-simulation-to-model-fitting.html#cb112-5" tabindex="-1"></a><span class="st">  array[n] int other;  // other player&#39;s choices (0 or 1)</span></span>
<span id="cb112-6"><a href="from-simulation-to-model-fitting.html#cb112-6" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb112-7"><a href="from-simulation-to-model-fitting.html#cb112-7" tabindex="-1"></a></span>
<span id="cb112-8"><a href="from-simulation-to-model-fitting.html#cb112-8" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb112-9"><a href="from-simulation-to-model-fitting.html#cb112-9" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; alpha_prior;  // Prior alpha parameter</span></span>
<span id="cb112-10"><a href="from-simulation-to-model-fitting.html#cb112-10" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; beta_prior;   // Prior beta parameter</span></span>
<span id="cb112-11"><a href="from-simulation-to-model-fitting.html#cb112-11" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb112-12"><a href="from-simulation-to-model-fitting.html#cb112-12" tabindex="-1"></a></span>
<span id="cb112-13"><a href="from-simulation-to-model-fitting.html#cb112-13" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb112-14"><a href="from-simulation-to-model-fitting.html#cb112-14" tabindex="-1"></a><span class="st">  vector[n] alpha;  // Alpha parameter at each trial</span></span>
<span id="cb112-15"><a href="from-simulation-to-model-fitting.html#cb112-15" tabindex="-1"></a><span class="st">  vector[n] beta;   // Beta parameter at each trial</span></span>
<span id="cb112-16"><a href="from-simulation-to-model-fitting.html#cb112-16" tabindex="-1"></a><span class="st">  vector[n] rate;   // Expected rate at each trial</span></span>
<span id="cb112-17"><a href="from-simulation-to-model-fitting.html#cb112-17" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb112-18"><a href="from-simulation-to-model-fitting.html#cb112-18" tabindex="-1"></a><span class="st">  // Initialize with prior</span></span>
<span id="cb112-19"><a href="from-simulation-to-model-fitting.html#cb112-19" tabindex="-1"></a><span class="st">  alpha[1] = alpha_prior;</span></span>
<span id="cb112-20"><a href="from-simulation-to-model-fitting.html#cb112-20" tabindex="-1"></a><span class="st">  beta[1] = beta_prior;</span></span>
<span id="cb112-21"><a href="from-simulation-to-model-fitting.html#cb112-21" tabindex="-1"></a><span class="st">  rate[1] = alpha[1] / (alpha[1] + beta[1]);</span></span>
<span id="cb112-22"><a href="from-simulation-to-model-fitting.html#cb112-22" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb112-23"><a href="from-simulation-to-model-fitting.html#cb112-23" tabindex="-1"></a><span class="st">  // Sequential updating of Beta distribution</span></span>
<span id="cb112-24"><a href="from-simulation-to-model-fitting.html#cb112-24" tabindex="-1"></a><span class="st">  for(t in 2:n) {</span></span>
<span id="cb112-25"><a href="from-simulation-to-model-fitting.html#cb112-25" tabindex="-1"></a><span class="st">    // Update Beta parameters based on previous observation</span></span>
<span id="cb112-26"><a href="from-simulation-to-model-fitting.html#cb112-26" tabindex="-1"></a><span class="st">    alpha[t] = alpha[t-1] + other[t-1];</span></span>
<span id="cb112-27"><a href="from-simulation-to-model-fitting.html#cb112-27" tabindex="-1"></a><span class="st">    beta[t] = beta[t-1] + (1 - other[t-1]);</span></span>
<span id="cb112-28"><a href="from-simulation-to-model-fitting.html#cb112-28" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb112-29"><a href="from-simulation-to-model-fitting.html#cb112-29" tabindex="-1"></a><span class="st">    // Calculate expected rate</span></span>
<span id="cb112-30"><a href="from-simulation-to-model-fitting.html#cb112-30" tabindex="-1"></a><span class="st">    rate[t] = alpha[t] / (alpha[t] + beta[t]);</span></span>
<span id="cb112-31"><a href="from-simulation-to-model-fitting.html#cb112-31" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb112-32"><a href="from-simulation-to-model-fitting.html#cb112-32" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb112-33"><a href="from-simulation-to-model-fitting.html#cb112-33" tabindex="-1"></a></span>
<span id="cb112-34"><a href="from-simulation-to-model-fitting.html#cb112-34" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb112-35"><a href="from-simulation-to-model-fitting.html#cb112-35" tabindex="-1"></a><span class="st">  // Priors on hyperparameters</span></span>
<span id="cb112-36"><a href="from-simulation-to-model-fitting.html#cb112-36" tabindex="-1"></a><span class="st">  target += gamma_lpdf(alpha_prior | 2, 1);</span></span>
<span id="cb112-37"><a href="from-simulation-to-model-fitting.html#cb112-37" tabindex="-1"></a><span class="st">  target += gamma_lpdf(beta_prior | 2, 1);</span></span>
<span id="cb112-38"><a href="from-simulation-to-model-fitting.html#cb112-38" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb112-39"><a href="from-simulation-to-model-fitting.html#cb112-39" tabindex="-1"></a><span class="st">  // Agent&#39;s choices follow current rate estimates</span></span>
<span id="cb112-40"><a href="from-simulation-to-model-fitting.html#cb112-40" tabindex="-1"></a><span class="st">  for(t in 1:n) {</span></span>
<span id="cb112-41"><a href="from-simulation-to-model-fitting.html#cb112-41" tabindex="-1"></a><span class="st">    target += bernoulli_lpmf(h[t] | rate[t]);</span></span>
<span id="cb112-42"><a href="from-simulation-to-model-fitting.html#cb112-42" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb112-43"><a href="from-simulation-to-model-fitting.html#cb112-43" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb112-44"><a href="from-simulation-to-model-fitting.html#cb112-44" tabindex="-1"></a></span>
<span id="cb112-45"><a href="from-simulation-to-model-fitting.html#cb112-45" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb112-46"><a href="from-simulation-to-model-fitting.html#cb112-46" tabindex="-1"></a><span class="st">  array[n] int prior_preds;</span></span>
<span id="cb112-47"><a href="from-simulation-to-model-fitting.html#cb112-47" tabindex="-1"></a><span class="st">  array[n] int posterior_preds;</span></span>
<span id="cb112-48"><a href="from-simulation-to-model-fitting.html#cb112-48" tabindex="-1"></a><span class="st">  real initial_rate = alpha_prior / (alpha_prior + beta_prior);</span></span>
<span id="cb112-49"><a href="from-simulation-to-model-fitting.html#cb112-49" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb112-50"><a href="from-simulation-to-model-fitting.html#cb112-50" tabindex="-1"></a><span class="st">  // Prior predictions use initial rate</span></span>
<span id="cb112-51"><a href="from-simulation-to-model-fitting.html#cb112-51" tabindex="-1"></a><span class="st">  for(t in 1:n) {</span></span>
<span id="cb112-52"><a href="from-simulation-to-model-fitting.html#cb112-52" tabindex="-1"></a><span class="st">    prior_preds[t] = bernoulli_rng(initial_rate);</span></span>
<span id="cb112-53"><a href="from-simulation-to-model-fitting.html#cb112-53" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb112-54"><a href="from-simulation-to-model-fitting.html#cb112-54" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb112-55"><a href="from-simulation-to-model-fitting.html#cb112-55" tabindex="-1"></a><span class="st">  // Posterior predictions use sequentially updated rates</span></span>
<span id="cb112-56"><a href="from-simulation-to-model-fitting.html#cb112-56" tabindex="-1"></a><span class="st">  for(t in 1:n) {</span></span>
<span id="cb112-57"><a href="from-simulation-to-model-fitting.html#cb112-57" tabindex="-1"></a><span class="st">    posterior_preds[t] = bernoulli_rng(rate[t]);</span></span>
<span id="cb112-58"><a href="from-simulation-to-model-fitting.html#cb112-58" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb112-59"><a href="from-simulation-to-model-fitting.html#cb112-59" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb112-60"><a href="from-simulation-to-model-fitting.html#cb112-60" tabindex="-1"></a><span class="st">&quot;</span></span>
<span id="cb112-61"><a href="from-simulation-to-model-fitting.html#cb112-61" tabindex="-1"></a><span class="fu">write_stan_file</span>(</span>
<span id="cb112-62"><a href="from-simulation-to-model-fitting.html#cb112-62" tabindex="-1"></a>  stan_model,</span>
<span id="cb112-63"><a href="from-simulation-to-model-fitting.html#cb112-63" tabindex="-1"></a>  <span class="at">dir =</span> <span class="st">&quot;stan/&quot;</span>,</span>
<span id="cb112-64"><a href="from-simulation-to-model-fitting.html#cb112-64" tabindex="-1"></a>  <span class="at">basename =</span> <span class="st">&quot;W3_BayesianMemory.stan&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;/Users/au209589/Dropbox/Teaching/AdvancedCognitiveModeling23_book/stan/W3_BayesianMemory.stan&quot;</code></pre>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="from-simulation-to-model-fitting.html#cb114-1" tabindex="-1"></a><span class="do">## Specify where the model is</span></span>
<span id="cb114-2"><a href="from-simulation-to-model-fitting.html#cb114-2" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">&quot;stan/W3_BayesianMemory.stan&quot;</span>)</span>
<span id="cb114-3"><a href="from-simulation-to-model-fitting.html#cb114-3" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(file, <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">TRUE</span>),</span>
<span id="cb114-4"><a href="from-simulation-to-model-fitting.html#cb114-4" tabindex="-1"></a>                     <span class="at">stanc_options =</span> <span class="fu">list</span>(<span class="st">&quot;O1&quot;</span>))</span>
<span id="cb114-5"><a href="from-simulation-to-model-fitting.html#cb114-5" tabindex="-1"></a></span>
<span id="cb114-6"><a href="from-simulation-to-model-fitting.html#cb114-6" tabindex="-1"></a><span class="co"># The following command calls Stan with specific options.</span></span>
<span id="cb114-7"><a href="from-simulation-to-model-fitting.html#cb114-7" tabindex="-1"></a>samples <span class="ot">&lt;-</span> mod<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb114-8"><a href="from-simulation-to-model-fitting.html#cb114-8" tabindex="-1"></a>  <span class="at">data =</span> data,</span>
<span id="cb114-9"><a href="from-simulation-to-model-fitting.html#cb114-9" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb114-10"><a href="from-simulation-to-model-fitting.html#cb114-10" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">1</span>,</span>
<span id="cb114-11"><a href="from-simulation-to-model-fitting.html#cb114-11" tabindex="-1"></a>  <span class="at">parallel_chains =</span> <span class="dv">2</span>,</span>
<span id="cb114-12"><a href="from-simulation-to-model-fitting.html#cb114-12" tabindex="-1"></a>  <span class="at">threads_per_chain =</span> <span class="dv">2</span>,</span>
<span id="cb114-13"><a href="from-simulation-to-model-fitting.html#cb114-13" tabindex="-1"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb114-14"><a href="from-simulation-to-model-fitting.html#cb114-14" tabindex="-1"></a>  <span class="at">iter_sampling =</span> <span class="dv">1000</span>,</span>
<span id="cb114-15"><a href="from-simulation-to-model-fitting.html#cb114-15" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">0</span>,</span>
<span id="cb114-16"><a href="from-simulation-to-model-fitting.html#cb114-16" tabindex="-1"></a>  <span class="at">max_treedepth =</span> <span class="dv">20</span>,</span>
<span id="cb114-17"><a href="from-simulation-to-model-fitting.html#cb114-17" tabindex="-1"></a>  <span class="at">adapt_delta =</span> <span class="fl">0.99</span>,</span>
<span id="cb114-18"><a href="from-simulation-to-model-fitting.html#cb114-18" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Running MCMC with 1 chain, with 2 thread(s) per chain...
## 
## Chain 1 finished in 0.3 seconds.</code></pre>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="from-simulation-to-model-fitting.html#cb116-1" tabindex="-1"></a>samples<span class="sc">$</span><span class="fu">summary</span>() </span></code></pre></div>
<pre><code>## # A tibble: 604 × 10
##    variable       mean  median    sd   mad      q5    q95  rhat ess_bulk ess_tail
##    &lt;chr&gt;         &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1 lp__        -53.0   -52.7   0.993 0.760 -55.0   -52.0   1.00     306.     442.
##  2 alpha_prior   2.67    2.32  1.65  1.43    0.675   5.83  1.01     280.     456.
##  3 beta_prior    0.916   0.783 0.641 0.559   0.174   2.13  1.00     365.     379.
##  4 alpha[1]      2.67    2.32  1.65  1.43    0.675   5.83  1.01     280.     456.
##  5 alpha[2]      3.67    3.32  1.65  1.43    1.68    6.83  1.01     280.     456.
##  6 alpha[3]      3.67    3.32  1.65  1.43    1.68    6.83  1.01     280.     456.
##  7 alpha[4]      4.67    4.32  1.65  1.43    2.68    7.83  1.01     280.     456.
##  8 alpha[5]      4.67    4.32  1.65  1.43    2.68    7.83  1.01     280.     456.
##  9 alpha[6]      4.67    4.32  1.65  1.43    2.68    7.83  1.01     280.     456.
## 10 alpha[7]      5.67    5.32  1.65  1.43    3.68    8.83  1.01     280.     456.
## # ℹ 594 more rows</code></pre>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="from-simulation-to-model-fitting.html#cb118-1" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb118-2"><a href="from-simulation-to-model-fitting.html#cb118-2" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb118-3"><a href="from-simulation-to-model-fitting.html#cb118-3" tabindex="-1"></a></span>
<span id="cb118-4"><a href="from-simulation-to-model-fitting.html#cb118-4" tabindex="-1"></a><span class="co"># Extract draws</span></span>
<span id="cb118-5"><a href="from-simulation-to-model-fitting.html#cb118-5" tabindex="-1"></a>draws_df <span class="ot">&lt;-</span> <span class="fu">as_draws_df</span>(samples<span class="sc">$</span><span class="fu">draws</span>())</span>
<span id="cb118-6"><a href="from-simulation-to-model-fitting.html#cb118-6" tabindex="-1"></a></span>
<span id="cb118-7"><a href="from-simulation-to-model-fitting.html#cb118-7" tabindex="-1"></a><span class="co"># First let&#39;s look at the priors</span></span>
<span id="cb118-8"><a href="from-simulation-to-model-fitting.html#cb118-8" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df) <span class="sc">+</span></span>
<span id="cb118-9"><a href="from-simulation-to-model-fitting.html#cb118-9" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(alpha_prior), <span class="at">fill =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb118-10"><a href="from-simulation-to-model-fitting.html#cb118-10" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(beta_prior), <span class="at">fill =</span> <span class="st">&quot;red&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb118-11"><a href="from-simulation-to-model-fitting.html#cb118-11" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb118-12"><a href="from-simulation-to-model-fitting.html#cb118-12" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Prior Distributions&quot;</span>,</span>
<span id="cb118-13"><a href="from-simulation-to-model-fitting.html#cb118-13" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Parameter Value&quot;</span>,</span>
<span id="cb118-14"><a href="from-simulation-to-model-fitting.html#cb118-14" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>)</span></code></pre></div>
<p><img src="series_files/figure-html/unnamed-chunk-16-1.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="from-simulation-to-model-fitting.html#cb119-1" tabindex="-1"></a><span class="co"># Now let&#39;s look at how the rate evolves over trials</span></span>
<span id="cb119-2"><a href="from-simulation-to-model-fitting.html#cb119-2" tabindex="-1"></a><span class="co"># First melt the rate values across trials into long format</span></span>
<span id="cb119-3"><a href="from-simulation-to-model-fitting.html#cb119-3" tabindex="-1"></a>rate_df <span class="ot">&lt;-</span> draws_df <span class="sc">%&gt;%</span></span>
<span id="cb119-4"><a href="from-simulation-to-model-fitting.html#cb119-4" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;rate[&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb119-5"><a href="from-simulation-to-model-fitting.html#cb119-5" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), </span>
<span id="cb119-6"><a href="from-simulation-to-model-fitting.html#cb119-6" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">&quot;trial&quot;</span>,</span>
<span id="cb119-7"><a href="from-simulation-to-model-fitting.html#cb119-7" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">&quot;rate&quot;</span>,</span>
<span id="cb119-8"><a href="from-simulation-to-model-fitting.html#cb119-8" tabindex="-1"></a>               <span class="at">names_pattern =</span> <span class="st">&quot;rate</span><span class="sc">\\</span><span class="st">[(</span><span class="sc">\\</span><span class="st">d+)</span><span class="sc">\\</span><span class="st">]&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb119-9"><a href="from-simulation-to-model-fitting.html#cb119-9" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trial =</span> <span class="fu">as.numeric</span>(trial))</span>
<span id="cb119-10"><a href="from-simulation-to-model-fitting.html#cb119-10" tabindex="-1"></a></span>
<span id="cb119-11"><a href="from-simulation-to-model-fitting.html#cb119-11" tabindex="-1"></a><span class="co"># Calculate summary statistics for each trial</span></span>
<span id="cb119-12"><a href="from-simulation-to-model-fitting.html#cb119-12" tabindex="-1"></a>rate_summary <span class="ot">&lt;-</span> rate_df <span class="sc">%&gt;%</span></span>
<span id="cb119-13"><a href="from-simulation-to-model-fitting.html#cb119-13" tabindex="-1"></a>  <span class="fu">group_by</span>(trial) <span class="sc">%&gt;%</span></span>
<span id="cb119-14"><a href="from-simulation-to-model-fitting.html#cb119-14" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb119-15"><a href="from-simulation-to-model-fitting.html#cb119-15" tabindex="-1"></a>    <span class="at">mean_rate =</span> <span class="fu">mean</span>(rate),</span>
<span id="cb119-16"><a href="from-simulation-to-model-fitting.html#cb119-16" tabindex="-1"></a>    <span class="at">lower =</span> <span class="fu">quantile</span>(rate, <span class="fl">0.025</span>),</span>
<span id="cb119-17"><a href="from-simulation-to-model-fitting.html#cb119-17" tabindex="-1"></a>    <span class="at">upper =</span> <span class="fu">quantile</span>(rate, <span class="fl">0.975</span>)</span>
<span id="cb119-18"><a href="from-simulation-to-model-fitting.html#cb119-18" tabindex="-1"></a>  )</span>
<span id="cb119-19"><a href="from-simulation-to-model-fitting.html#cb119-19" tabindex="-1"></a></span>
<span id="cb119-20"><a href="from-simulation-to-model-fitting.html#cb119-20" tabindex="-1"></a></span>
<span id="cb119-21"><a href="from-simulation-to-model-fitting.html#cb119-21" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">trial =</span> <span class="fu">seq</span>(<span class="dv">120</span>), <span class="at">choices =</span> data<span class="sc">$</span>other)</span>
<span id="cb119-22"><a href="from-simulation-to-model-fitting.html#cb119-22" tabindex="-1"></a></span>
<span id="cb119-23"><a href="from-simulation-to-model-fitting.html#cb119-23" tabindex="-1"></a><span class="co"># Plot the evolution of rate estimates</span></span>
<span id="cb119-24"><a href="from-simulation-to-model-fitting.html#cb119-24" tabindex="-1"></a><span class="fu">ggplot</span>(rate_summary, <span class="fu">aes</span>(<span class="at">x =</span> trial)) <span class="sc">+</span></span>
<span id="cb119-25"><a href="from-simulation-to-model-fitting.html#cb119-25" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper), <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb119-26"><a href="from-simulation-to-model-fitting.html#cb119-26" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean_rate), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>) <span class="sc">+</span></span>
<span id="cb119-27"><a href="from-simulation-to-model-fitting.html#cb119-27" tabindex="-1"></a>  <span class="co"># Add true data points</span></span>
<span id="cb119-28"><a href="from-simulation-to-model-fitting.html#cb119-28" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> plot_data, </span>
<span id="cb119-29"><a href="from-simulation-to-model-fitting.html#cb119-29" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> trial, <span class="at">y =</span> choices), <span class="at">color =</span> <span class="st">&quot;orange&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb119-30"><a href="from-simulation-to-model-fitting.html#cb119-30" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb119-31"><a href="from-simulation-to-model-fitting.html#cb119-31" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Evolution of Rate Estimates&quot;</span>,</span>
<span id="cb119-32"><a href="from-simulation-to-model-fitting.html#cb119-32" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Trial&quot;</span>,</span>
<span id="cb119-33"><a href="from-simulation-to-model-fitting.html#cb119-33" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Rate&quot;</span>,</span>
<span id="cb119-34"><a href="from-simulation-to-model-fitting.html#cb119-34" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">&quot;Blue line: posterior mean, Gray band: 95% CI&quot;</span>) <span class="sc">+</span></span>
<span id="cb119-35"><a href="from-simulation-to-model-fitting.html#cb119-35" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span></code></pre></div>
<p><img src="series_files/figure-html/unnamed-chunk-16-2.png" width="80%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="from-simulation-to-model-fitting.html#cb120-1" tabindex="-1"></a><span class="co"># Let&#39;s also look at the correlation between alpha and beta parameters</span></span>
<span id="cb120-2"><a href="from-simulation-to-model-fitting.html#cb120-2" tabindex="-1"></a><span class="fu">ggplot</span>(draws_df) <span class="sc">+</span></span>
<span id="cb120-3"><a href="from-simulation-to-model-fitting.html#cb120-3" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(alpha_prior, beta_prior), <span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb120-4"><a href="from-simulation-to-model-fitting.html#cb120-4" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb120-5"><a href="from-simulation-to-model-fitting.html#cb120-5" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Correlation between Alpha and Beta Parameters&quot;</span>,</span>
<span id="cb120-6"><a href="from-simulation-to-model-fitting.html#cb120-6" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Alpha&quot;</span>,</span>
<span id="cb120-7"><a href="from-simulation-to-model-fitting.html#cb120-7" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Beta&quot;</span>)</span></code></pre></div>
<p><img src="series_files/figure-html/unnamed-chunk-16-3.png" width="80%" style="display: block; margin: auto;" /></p>
</div>
<div id="conclusion-from-simple-models-to-complex-cognitive-processes" class="section level2 hasAnchor" number="5.10">
<h2><span class="header-section-number">5.10</span> Conclusion: From Simple Models to Complex Cognitive Processes<a href="from-simulation-to-model-fitting.html#conclusion-from-simple-models-to-complex-cognitive-processes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Throughout this chapter, we’ve progressed from basic parameter estimation to increasingly sophisticated models of decision-making. We began with a simple biased agent model, demonstrating how Bayesian inference allows us to recover underlying parameters from observed behavior. We saw how we can transform parameters from one scale to another - here from probability-scale to log-odds parameterizations -, thus gaining flexibility that will prove valuable for more complex models.</p>
<p>The transition to memory-based models illustrated how we can incorporate psychological theory into our statistical framework. We explored different approaches to modeling memory - from treating it as an external predictor to implementing it as an internal state variable that evolves over time. The final exploration of exponential forgetting demonstrated how we can capture more nuanced cognitive processes while maintaining mathematical tractability. This progression sets the stage for Chapter 12, where we’ll explore how these memory updating mechanisms relate to reinforcement learning models. The exponential discounting of past events we implemented here represents a simplified version of the learning mechanisms we’ll encounter in reinforcement learning.</p>
<p>Several key principles emerged that will guide our future modeling work:</p>
<ul>
<li><p>The importance of systematic model validation through parameter recovery studies and prior-posterior checks. These techniques help ensure our models can meaningfully capture the processes we aim to study.</p></li>
<li><p>The value of starting simple and gradually adding complexity. Each model we implemented built upon previous ones, allowing us to understand the impact of new components while maintaining a solid foundation. This principle will become particularly important when we tackle reinforcement learning models, where multiple parameters interact in complex ways to produce learning behavior.</p></li>
<li><p>The relationship between mathematical convenience and psychological reality. The log-odds transformation, for instance, provides both computational benefits and psychological insights about how humans might represent probabilities. Similarly, the memory updating rules we explored here foreshadow the prediction error calculations central to reinforcement learning and relates very tightly to other popular models like the Kalman filter and the Hierarchical Gaussian Filter.</p></li>
</ul>
<p>In the next chapters, we will build upon these foundations to tackle even more sophisticated cognitive models. Chapter 5 will introduce multilevel modeling, allowing us to capture individual differences while maintaining population-level insights. This will set the stage for exploring how different individuals might employ different strategies or show varying levels of memory decay in their decision-making processes. These individual differences become again relevant in future models where parameters like learning rate, or bias for social information can vary substantially across individuals.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="from-verbal-descriptions-to-formal-models.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="model-quality-assessment.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/fusaroli/AdvancedCognitiveModeling/edit/master/04-InferringRates.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["series.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
